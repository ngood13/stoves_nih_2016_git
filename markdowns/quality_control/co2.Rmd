---
title: "Process co2 data"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r load_libraries, echo=FALSE, message=FALSE}
  if (!require("pacman")) install.packages("pacman")
  pacman::p_load(tidyverse, kableExtra)
```

```{r global_options, echo=FALSE}
  knitr::opts_chunk$set(fig.path ='figures/', 
                        warning = FALSE, message = FALSE, cache = FALSE)
```

# tidy data

## load files

load scripts

```{r}
  source("../../scripts/tidy.R")
  source("../../scripts/functions.R")
```

load data

```{r}
  co2_lab <- readRDS("../../r_data/co2_lab.RDS")
  co2_sample <- readRDS("../../r_data/co2_sample.RDS")
  co2_volts <- readRDS("../../r_data/co2_lab_sample.RDS")
  cal <- readRDS("../../r_data/cal_2.RDS")
  notes <- readRDS("../../r_data/notes.RDS")
  samples <- readRDS("../../r_data/samples.RDS")
  pol_properties <- readRDS("../../r_data/pol_properties.RDS")
  times <- readRDS("../../r_data/test_times.RDS")
```

load schemes

```{r}
  qc_colors <- readRDS("../../r_data/qc_colors.RDS")
  lod_shapes <- readRDS("../../r_data/lod_shapes.RDS")
```

## tidy variables

```{r}
  co2_lab <- 
    co2_lab %>%
    dplyr::select(id, datetime, date, time, co2) %>%
    dplyr::mutate(loc = "lab")  %>%
    dplyr::rename(val = co2)
```

```{r}
  co2_sample <- 
    co2_sample %>%
    dplyr::select(id, datetime, date, time, co2) %>%
    dplyr::mutate(loc = "sample") %>%
    dplyr::rename(val = co2)
```

```{r}
  co2_volts <- 
    co2_volts %>%
    dplyr::select(id, datetime, date, time, lab, sample) %>%
    tidyr::gather(loc, val, c(lab, sample))
```

## extract calibration data

```{r}
  co2_lab_cal <- tidy_date(cal, "^sensor_1", "sensor_1_") %>%
                 dplyr::mutate(loc = as.factor("lab"))
  
  co2_sample_cal <- tidy_date(cal, "^sensor_2", "sensor_2_") %>%
                    dplyr::mutate(loc = as.factor("sample"))
   
  co2_cal <- rbind(co2_lab_cal, co2_sample_cal)  # combine lab and sample data
  
  co2_cal <- split_co2_cal(co2_cal)              # reorganize
```

## clean up calibration data

```{r}
  co2_cal_lab <- dplyr::filter(co2_cal,
                         type == "std" & pol == "co2" & !is.na(value) & loc == "lab")
  
  co2_volts_lab <- add_caldate(dplyr::filter(co2_volts, loc == "lab"), co2_cal_lab)
  
  co2_cal_sample <- dplyr::filter(co2_cal,
                           type == "std" & pol == "co2" & !is.na(value) & loc == "sample")
  
  co2_volts_sample <- add_caldate(dplyr::filter(co2_volts,
                                         loc == "sample"), co2_cal_sample)
  
  co2_volts <- rbind(co2_volts_lab, co2_volts_sample)
  
  co2_cal <- rbind(co2_cal_lab, co2_cal_sample)
```

## merge and apply calibration

```{r}
  co2_volts <- dplyr::left_join(co2_volts, 
               dplyr::select(co2_cal, date, pol, loc, value),
                       by = c("cal_date" = "date", "loc" = "loc")) %>%
               dplyr::rename(span = value, volts = val) %>%
               dplyr::mutate(val = volts * span / 5) %>%
               dplyr::select(-cal_date, -volts, -span, -pol)
```

## plot: lab co2 traces

```{r, echo=FALSE, eval=FALSE, fig.width=12, fig.height=20}
  co2_volts %>%
    dplyr::filter(grepl("lab", loc)) %>%
    ggplot(aes_string(x = "datetime", y = "val")) +
      geom_point() + 
      theme_bw() +
      theme(text = element_text(size = 16),
            legend.position = "top") +
      facet_wrap(~id, scales = "free", ncol = 4) +
      ylab("mixing ratio (ppm)") +
      xlab("")
```

notes: 

* observe some weird sensor spikes, investigate later
* 25C: data looks off

## plot: sample co2 traces

```{r, echo=FALSE, eval=FALSE, fig.width=12, fig.height=20}
  co2_volts %>%
    dplyr::filter(grepl("sample", loc)) %>%
    ggplot(aes_string(x = "datetime", y = "val")) +
      geom_point() + 
      theme_bw() +
      theme(text = element_text(size = 16),
            legend.position = "top") +
      facet_wrap(~id, scales = "free", ncol = 4) +
      ylab("mixing ratio (ppm)") +
      xlab("")
```

## combine data

```{r}
  co2_merged <- tibble::as_tibble(rbind(co2_lab, co2_sample, co2_volts)) %>%
                dplyr::mutate(loc = as.factor(loc))
```

## flip location for several tests

```{r}
  # flipped <- dplyr::filter(co2_merged, id == "23B" | id == "G8" | id == "G3") %>%
  #            dplyr::mutate(loc = ifelse(loc == "sample","lab", "sample"))
  # 
  # unflipped <- dplyr::filter(co2_merged, id != "23B" & id != "G8" & id != "G3")
  #   
  # co2_merged <- rbind(flipped, unflipped)
```

## extract sample time

get timestamps

```{r}
  sample_times <- 
    times %>%
    dplyr::filter(grepl("^sample$|shutdown|refuel_1", var)) %>%
    dplyr::mutate(var = as.character(var),
                  var = ifelse(var == "refuel_1", "sample", var)) %>%
    tidyr::spread("var", "value") %>%
    dplyr::select(-date) %>%
    dplyr::rename("start" = "sample",
                  "end" = "shutdown")
```

## filter based on test times

```{r}
  co2_merged <- 
    filter_times(sample_times, co2_merged)
```

## flags

extract flags

```{r}
  notes <- 
    notes %>%
    dplyr::filter(grepl("co2|all", inst) == TRUE)
```

bad preceeds maybe preceeds good

```{r}
  flags <-
    notes %>%
    dplyr::select(id, qc) %>%
    dplyr::group_by(id) %>%
    dplyr::arrange(qc) %>%
    dplyr::summarise(qc = first(qc))
```

add flag by id

```{r}
  co2_merged <-
    co2_merged %>%
    dplyr::mutate(qc = "ok")
```

notes: apply qc values manually for this instrument

# missing and bad data

## table: missing data

```{r, echo = FALSE}
  dplyr::select(samples, id, stove, fuel) %>%
  dplyr::anti_join(co2_merged %>%
                     dplyr::distinct(),
                   by = "id") %>%
  dplyr::filter(!grepl("^27|^28|^29|^30|^G", id)) %>%
  knitr::kable("markdown", align = 'c')
```

notes: 17C data missing for this test

## table: bad data

```{r, echo=FALSE}
  notes %>%
    dplyr::filter(grepl("co2|all", inst) == TRUE,
                  qc != "ok") %>%
    dplyr::select(-inst) %>%
    dplyr::filter(!grepl("^27|^28|^29|^30|^G", id)) %>%
    knitr::kable("markdown", align = 'c')
```

notes: 

* 2C: possible issues with dilution - check if outlier
* 6B: possible clog in sample line - check if outlier
* 6C: pumps turned off - check if outlier

* 1C: dilution clogged - marked as bad
* 8C: clog in sample line - marked as bad
* 24C (lab): issues with sample - mark as bad

## mark additional tests as bad

```{r}
  co2_merged <- 
    co2_merged %>%
    dplyr::mutate(qc = as.character(qc),
                  qc = ifelse(grepl("^1C|^8C", id), "bad", qc),
                  qc = ifelse(id == "24C" & loc == "lab", "bad", qc))
```

## remove bad tests

```{r}
  co2_merged <-
    co2_merged %>% 
    dplyr::filter(qc != "bad")
```

# plot: co2 lab traces

```{r, echo=FALSE, fig.width=12, fig.height=30}
  co2_merged %>%
    dplyr::filter(grepl("lab", loc)) %>%
    ggplot(aes_string(x = "datetime", y = "val", color = "qc")) +
      geom_point() +
      scale_color_manual(values = qc_colors) +
      theme_bw() +
      theme(text = element_text(size = 16),
            legend.position = "top") +
      facet_wrap(~id, scales = "free", ncol = 4) +
      ylab("mixing ratio (ppm)") +
      xlab("")
```

# plot: co2 sample traces

```{r, echo=FALSE, fig.width=12, fig.height=30}
  co2_merged %>%
    dplyr::filter(grepl("sample", loc)) %>%
    ggplot(aes_string(x = "datetime", y = "val", color = "qc")) +
      geom_point() +
      scale_color_manual(values = qc_colors) +
      theme_bw() +
      theme(text = element_text(size = 16),
            legend.position = "top") +
      facet_wrap(~id, scales = "free", ncol = 4) +
      ylab("mixing ratio (ppm)") +
      xlab("")
```

notes: some data look strange - change these files to maybe and explore dilution sensitivity before diving into issues

```{r}
  co2_merged <- 
    co2_merged %>%
    dplyr::mutate(qc = as.character(qc),
                  qc = ifelse(id == "15C" & loc == "lab", "maybe", qc),
                  qc = ifelse(id == "17A" & loc == "lab", "maybe", qc),
                  qc = ifelse(id == "1A" & loc == "lab", "maybe", qc),
                  qc = ifelse(id == "25A" & loc == "lab", "maybe", qc),
                  qc = ifelse(id == "28A" & loc == "lab", "maybe", qc),
                  qc = ifelse(id == "2A" & loc == "lab", "maybe", qc),
                  qc = ifelse(id == "3D" & loc == "lab", "maybe", qc),
                  qc = ifelse(id == "6C" & loc == "lab", "maybe", qc),
                  qc = ifelse(id == "1D" & loc == "lab", "maybe", qc),
                  qc = ifelse(id == "23B" & loc == "lab", "maybe", qc),
                  qc = ifelse(id == "24B" & loc == "lab", "maybe", qc),
                  qc = ifelse(id == "3D" & loc == "lab", "maybe", qc),
                  qc = ifelse(id == "6C" & loc == "lab", "maybe", qc),
                  qc = ifelse(id == "15B" & loc == "sample", "maybe", qc),
                  qc = ifelse(id == "1A" & loc == "sample", "maybe", qc),
                  qc = ifelse(id == "25A" & loc == "sample", "maybe", qc))
```

## save merged file

```{r}
  saveRDS(co2_merged, file = "../../r_data/co2_merged.RDS")
```

# calculate metrics for dilution ratio

## calculate concentration

calculate mass concentrations and average

```{r}
  co2_merged <-
    co2_merged %>%
    dplyr::group_by(id, loc) %>%
    dplyr::summarise(val = mean(val, na.rm = TRUE),
                     qc = first(qc)) %>%
    dplyr::mutate(pol = "co2") #%>%
    #dplyr::left_join(dplyr::select(pol_properties, pol, mw), by = "pol") %>%
    #dplyr::mutate(val = convert_ppmv_ugpmc(val, mw)) %>%
    #dplyr::select(-mw)
```

## plot: average mass concentration

```{r, eval=FALSE}
  co2_merged %>%
    ggplot(aes(x = id, y = val)) + 
      geom_point(aes(color = qc), size = 2) + 
      theme_bw() +
      scale_y_log10() +
      scale_color_manual(values = qc_colors) +
      theme(text = element_text(size = 12),
            legend.position = "top") +
      facet_wrap(~loc, ncol = 1) +
      ylab("concentration (microgram per meter cubed)") +
      xlab("")
```

## save merged file

```{r}
  saveRDS(co2_merged, file = "../../r_data/co2_merged_avg.RDS")
```

## table: missing data at end

missing lab data

```{r, echo=FALSE}
  dplyr::select(samples, id, stove, fuel) %>%
  dplyr::anti_join(co2_merged %>%
                     dplyr::filter(loc == "lab") %>%
                     dplyr::distinct(),
                   by = "id") %>%
  dplyr::filter(!grepl("^G", id)) %>%
  dplyr::filter(!grepl("^27|^28|^29|^30", id)) %>%
  knitr::kable("markdown", align = 'c')
```

missing sample data

```{r, echo = FALSE}
  dplyr::select(samples, id, stove, fuel) %>%
  dplyr::anti_join(co2_merged %>%
                     dplyr::filter(loc == "sample") %>%
                     dplyr::distinct(),
                   by = "id") %>%
  dplyr::filter(!grepl("^G", id)) %>%
  dplyr::filter(!grepl("^27|^28|^29|^30", id)) %>%
  knitr::kable("markdown", align = 'c')
```