---
title: "Process ecoc data"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r load_libraries, echo=FALSE, message=FALSE}
  if (!require("pacman")) install.packages("pacman")
  pacman::p_load(tidyverse, kableExtra)
```

```{r global_options, echo=FALSE}
  knitr::opts_chunk$set(fig.path ='figures/',
                        warning = FALSE, message = FALSE, cache = FALSE)
```

# tidy data

## load files

load scripts

```{r}
  source("../../scripts/functions.R")
```

load data

```{r}
  ecoc <- readRDS("../../r_data/ecoc.RDS")
  filter_area <- readRDS("../../r_data/filter_area.RDS")
  times <- readRDS("../../r_data/filter_times.RDS")
  flows <- readRDS("../../r_data/filter_flows.RDS")
  notes <- readRDS("../../r_data/notes.RDS")
  samples <- readRDS("../../r_data/samples.RDS")
```

load schemes

```{r}
  qc_colors <- readRDS("../../r_data/qc_colors.RDS")
  lod_shapes <- readRDS("../../r_data/lod_shapes.RDS")
```

## fix incorrect ids

```{r}
  ecoc <- 
    ecoc %>%
    dplyr::mutate(id = as.character(id),
                  cassette = as.character(cassette),
                  cassette = ifelse(grepl("blank", id), NA, cassette)) %>%
    dplyr::filter(!grepl("system", id), !is.na(id), type != "pilot")

  ecoc$id[172] <- "11C"
  ecoc$id[173] <- "11C"
  
  ecoc <- ecoc[-130, ]
  ecoc <- ecoc[-142, ]
  ecoc$cassette[118] <- "a"

  ecoc <-
    ecoc %>%
    dplyr::filter(grepl("^[0-9]|^B[0-9]|^G[0-9]",id),
                  !grepl("^27|^28|^29|^30", id))
```

notes: remove outrageously high value for 6D and 8D

## flags

extract flags

```{r}
  notes <- 
    notes %>%
    dplyr::filter(grepl("ecoc|all", inst) == TRUE)
```

bad preceeds maybe preceeds good

```{r}
  flags <-
    notes %>%
    dplyr::select(id, qc) %>%
    dplyr::group_by(id) %>%
    dplyr::arrange(qc) %>%
    dplyr::summarise(qc = first(qc))
```

add flag by id

```{r}
  ecoc <-
    ecoc %>%
    dplyr::left_join(flags, by = "id") %>%
    dplyr::mutate(id = as.factor(id)) %>%
    dplyr::mutate(qc = as.factor(ifelse(is.na(qc), "ok", as.character(qc))))
```

## test type 

define test type variable

```{r}
  ecoc <- 
    ecoc %>%
    dplyr::mutate(test_type = ifelse(grepl("^[0-9]", id), "test", "bg"),
                  test_type = ifelse(grepl("^B", id), "blank", test_type)) %>%
    dplyr::filter(!grepl("MC", id))
```

## calculate mass on filter

```{r}
  ecoc <- 
    ecoc %>%
      dplyr::select(id, oc_ug_sq_cm, ec_ug_sq_cm,
                    cassette, test_type, oc_unc, ec_unc, fid2, qc) %>%
      tidyr::gather("pol", "val", ec_ug_sq_cm, oc_ug_sq_cm, oc_unc, ec_unc) %>%
      dplyr::mutate(pol = ifelse(pol == "ec_ug_sq_cm", "ec", pol),
                    pol = ifelse(pol == "oc_ug_sq_cm", "oc", pol),
                    val = val * filter_area)
```

# missing and bad data

## table: missing E filter data

```{r, echo = FALSE}
  dplyr::select(samples, id, stove, fuel) %>%
  dplyr::anti_join(ecoc %>%
                     dplyr::select(id, cassette) %>%
                     dplyr::filter(cassette == "e") %>%
                     dplyr::distinct(),
                   by = "id") %>%
  dplyr::filter(!grepl("^27|^28|^29|^30", id)) %>%
  knitr::kable("markdown", align = 'c')
```

notes: 

* 8D: removed as a bad test - going to analyze filter again
* 6A: removed originally for too high of loading - going to analyze filter again
* 1A: removed for too high of loading
* 2A: removed for too high of loading


## table: missing A filter data

```{r, echo = FALSE}
  dplyr::select(samples, id, stove, fuel) %>%
  dplyr::anti_join(ecoc %>%
                     dplyr::select(id, cassette) %>%
                     dplyr::filter(cassette == "a") %>%
                     dplyr::distinct(),
                   by = "id") %>%
  dplyr::filter(!grepl("^27|^28|^29|^30", id)) %>%
  knitr::kable("markdown", align = 'c')
```

## table: bad data

```{r, echo=FALSE}
  notes %>%
    dplyr::filter(grepl("ecoc|all", inst) == TRUE,
                  qc != "ok") %>%
    dplyr::select(-inst) %>%
    dplyr::filter(!grepl("^27|^28|^29|^30", id)) %>%
    knitr::kable("markdown", align = 'c')
```

notes:

* 3A: white/orange flow rates unknown for most of test, artifact filter blew out - remove test
* 24A: E fiter ruptured - remove test

* 2A: fire went out, flow rate low - check if outlier
* 8C: potential problems with whole test - check if outlier
* 23A: fire relit with kerosene and match during refuel - check if outlier

* 1A: filter ruptured, not sure which one - check if outlier - artifact filter ruptured - remove artifact filter
* 2C: artifact filter ruptured, start up period twice, post test flow issue - remove artifact filter
* 2E: no post flow for white cartridge, artifact filter blew out - remove artifact filter
* 4C: possible issues with flow rate, artifact filter blew out, possibly after test was over - remove artifact filter
* 8A: filter ruptured, not sure which one - check if outlier - artifact filter ruptured - remove artifact filter
* 17A: quartz filter ruptured, not sure which one - check if outlier - artifact filter ruptured - remove artifact filter

## mark additional tests as bad based on notes

```{r}
  ecoc <- 
    ecoc %>%
    dplyr::mutate(qc = as.character(qc),
                  qc = ifelse(grepl("24A|^3A", id), "bad", qc),
                  qc = ifelse(id == "2E" & cassette == "a", "bad", qc),
                  qc = ifelse(id == "2C" & cassette == "a", "bad", qc),
                  qc = ifelse(id == "1A" & cassette == "a", "bad", qc),
                  qc = ifelse(id == "4C" & cassette == "a", "bad", qc),
                  qc = ifelse(id == "8A" & cassette == "a", "bad", qc),
                  qc = ifelse(id == "17A" & cassette == "a", "bad", qc))
```

## remove filters where fid2 is offscale

```{r}
  ecoc %>%
    dplyr::filter(fid2 != "ok") %>%
    dplyr::select(id) %>%
    dplyr::distinct() %>%
    dplyr::left_join(
      dplyr::select(samples, id, stove, fuel)) %>%
    knitr::kable("markdown", align = 'c')
```

notes:

```{r}
  ecoc <-
    ecoc %>%
    dplyr::mutate(qc = ifelse(fid2 != "ok", "bad", qc)) %>%
    dplyr::select(-fid2)
```

## plot: plot oc and ec uncertainty

```{r}
  ecoc %>%
  dplyr::filter(grepl("unc", pol)) %>%
    ggplot(aes(x = id, y = val)) +
      geom_point(aes(color = qc), size = 2) +
      scale_color_manual(values = qc_colors) +
      theme_bw() +
      theme(text = element_text(size = 16),
            legend.position = "top") +
      facet_wrap(~pol, scales = "free", ncol = 1) +
      ylab("uncertainty") +
      xlab("")
```

notes: bad values already marked bad

```{r}
  ecoc <-
    ecoc %>%
    dplyr::filter(!grepl("unc", pol))
```

## remove bad tests

```{r}
  ecoc_merged <-
    ecoc %>% 
    dplyr::filter(qc != "bad")
```

# blank analysis 

```{r}
  blanks <-
    ecoc_merged %>%
    dplyr::filter(test_type == "blank")
```

## table: lab blank outliers

outliers (z > 3) when blanks are grouped by pollutant

```{r, echo=FALSE}
  blanks %>%
    dplyr::filter(!is.na(val)) %>%
    dplyr::group_by(pol) %>%
    dplyr::mutate(z_score = (val - mean(val, na.rm = TRUE)) / sd(val, na.rm = TRUE)) %>%
    dplyr::select(id, pol, z_score) %>%
    dplyr::filter(z_score > 3) %>%
    knitr::kable("markdown", align = 'c', digits = 2)
```

notes: not substantial - don't remove

## plot: time series of lab blanks

```{r ecoc_blank_timeseries}
 blanks %>%
    dplyr::filter(!is.na(val)) %>%
    dplyr::left_join(dplyr::select(samples, blank, date), by = c('id' = 'blank')) %>%
    ggplot(aes_string(x = "date", y = "val")) +
      geom_point(aes(color = qc), size = 2) +
      scale_color_manual(values = qc_colors) +
      theme_bw() +
      theme(text = element_text(size = 16),
            legend.position = "top") +
      facet_wrap(~pol, scales = "free", ncol = 1) +
      ylab("mass (micrograms)")
```

notes: no substantial outliers - proceed

## table: lab blanks with NA values

percent of lab blanks with NA values

```{r, echo=FALSE}
  blanks %>%
    dplyr::group_by(pol) %>%
    dplyr::do(val = round(nrow(filter(., is.na(val) == TRUE))/nrow(.), 2) * 100) %>%
    dplyr::mutate(val = cell_spec(val, "html", color = ifelse(val > 10, "red", "blue"))) %>%
    knitr::kable("markdown", align = 'c')
```

## summarize blanks

```{r}
  blanks <-
    blanks %>%
    dplyr::group_by(pol) %>%
    dplyr::summarise(mean = mean(val, na.rm = TRUE),
                     median = median(val, na.rm = TRUE),
                     stdev = sd(val, na.rm = TRUE),
                     lod = stdev * 3 + mean,
                     loq = stdev * 10 + mean)
```

## table: blank summary (ug)

```{r, echo=FALSE}
  blanks %>%
    knitr::kable(digits = 3, align = 'c')
```

## save blanks

```{r}
  saveRDS(blanks, file = "../../r_data/ecoc_lod.RDS")
```

remove lab blanks from merged file

```{r}
  ecoc_merged <-
    ecoc_merged %>%
    dplyr::filter(test_type != "blank") # remove blanks
```

## lod

add lod variable and replace values below lod with lod/sqrt(2)

```{r}
  ecoc_merged <-
    ecoc_merged %>%
    dplyr::left_join(dplyr::select(blanks, pol, lod) %>%
                     dplyr::rename("lod_val" = "lod"), by = "pol") %>%
    dplyr::mutate(lod = ifelse(val <= lod_val, "below", "above"),
                  val = ifelse(val <= lod_val, lod_val / sqrt(2), val)) %>%
    dplyr::select(-lod_val)
```

## look at artifact filters

```{r}
  ecoc_artifact <-
    ecoc_merged %>%
    dplyr::filter(cassette == "a") %>%
    dplyr::select(id, pol, val) %>%
    dplyr::rename("artifact" = "val")
```

```{r, echo=FALSE, fig.width=12}
  ecoc_artifact %>%
    ggplot(aes(id, artifact)) + 
      geom_point() +
      facet_wrap(~pol, nrow = 2, scales = "free") +
      theme_bw()
```

notes: no outliers, assume all ec added is due to breakthrough, since little ec is found on the blank filters - do not subtract ec artifacts

## replace ec artifacts with zero

```{r}
  ecoc_merged <-
    ecoc_merged %>%
    dplyr::mutate(val = ifelse(cassette == "a" & pol == "ec", 0, val))
```

# calculate concentrations

## flow data

```{r}
 flows <- 
  flows %>%
  dplyr::select(-date) %>%
  dplyr::filter(colour == "white" | colour == "orange") %>%
  dplyr::group_by(id, type, colour) %>%
  dplyr::summarise(flow = mean(value, na.rm = TRUE)) %>%
  dplyr::group_by(id, colour) %>%
  dplyr::summarise(flow = mean(flow, na.rm = TRUE)) %>%
  dplyr::mutate(colour = as_factor(colour)) %>%
  dplyr::mutate(cassette =  forcats::fct_recode(colour, "a" = "white", "e" = "orange")) %>%
  dplyr::select(-colour)
```

notes: no flow data is missing

## time data

```{r}
  times <-
    times %>%
    dplyr::select(-date) %>%
    dplyr::filter(color == "white" | color == "orange") %>%
    tidyr::spread(type, value) %>%
    dplyr::mutate(cassette = forcats::fct_recode(color, "a" = "white", "e" = "orange")) %>%
    dplyr::select(-color)
```

notes: no time data is missing

## merge flow and time data

```{r}
  ecoc_merged <-
    ecoc_merged %>%
    dplyr::left_join(flows, by = c("id", "cassette")) %>%
    dplyr::left_join(times, by = c("id", "cassette"))
```

notes: no NA data

## calculate concentrations

```{r}
  ecoc_merged <-
    ecoc_merged %>%
    dplyr::mutate(dur = (end - start) / 60,
                  val = (val * 1000) / (flow * dur))
```

# backgrounds

```{r}
  bg <-
    ecoc_merged %>%
    dplyr::filter(test_type == "bg")
```

## table: lab background outliers

outliers (z > 3) when backgrounds are grouped by pollutant and cassette

```{r, echo=FALSE}
  bg %>%
    dplyr::filter(!is.na(val)) %>%
    dplyr::group_by(pol, cassette) %>%
    dplyr::mutate(z_score = (val- mean(val, na.rm = TRUE)) / sd(val, na.rm = TRUE)) %>%
    dplyr::ungroup() %>%
    dplyr::select(id, pol, z_score) %>%
    dplyr::filter(z_score > 3) %>%
    knitr::kable("markdown", align = 'c', digits = 2)
```

notes: no outliers

## plot: time series of lab backgrounds

```{r ecoc_bg_timeseries, echo=FALSE}
  bg %>%
    dplyr::filter(!is.na(val)) %>%
    dplyr::left_join(dplyr::select(samples, id, date), by = 'id') %>%
    ggplot(aes_string(x = "date", y = "val")) +
      geom_point(aes(shape = lod, color = qc), size = 2) +
      scale_shape_manual(values = lod_shapes) +
      scale_color_manual(values = qc_colors) +
      theme_bw() +
      theme(text = element_text(size = 12),
            legend.position = "top") +
      facet_wrap(pol~cassette, scales = "free", ncol = 2) +
      ylab("concentration (microgram per meter cubed)") +
      xlab("")
```

notes: no subtantial outliers, artifact is the same order of magnitude as sample - proceed

## table: percent of lab backgrounds below lab lod

```{r, echo=FALSE}
  bg %>%
    dplyr::group_by(pol, cassette) %>%
    dplyr::do(val = round(nrow(filter(., lod == "below"))/nrow(.), 2) * 100) %>%
    dplyr::mutate(val = cell_spec(val, "html", color = ifelse(val > 10, "red", "blue"))) %>%
    knitr::kable("markdown", align = 'c')
```

## table: percent of lab backgrounds with NA values

```{r, echo=FALSE}
  bg %>%
    dplyr::group_by(pol, cassette) %>%
    dplyr::do(val = round(nrow(filter(., is.na(val) == TRUE))/nrow(.), 2) * 100) %>%
    dplyr::mutate(val = cell_spec(val, "html", color = ifelse(val > 10, "red", "blue"))) %>%
    knitr::kable("markdown", align = 'c')
```

## summarize backgrounds

```{r}
  bg <-
    bg %>%
    dplyr::group_by(pol, cassette) %>%
    dplyr::summarise(mean = mean(val, na.rm = TRUE),
                     median = median(val, na.rm = TRUE),
                     stdev = sd(val, na.rm = TRUE),
                     min = min(val, na.rm = TRUE),
                     max = max(val, na.rm = TRUE),
                     count = n()) %>%
    dplyr::mutate(mean = ifelse(is.nan(mean), NA, mean),
                  median = ifelse(is.nan(median), NA, median),
                  stdev = ifelse(is.nan(stdev), NA, stdev),
                  min = ifelse(is.infinite(min), NA, min),
                  max = ifelse(is.infinite(max), NA, max),
                  count = ifelse(is.nan(count), NA, count))
```

## table: background summary

```{r, echo=FALSE}
  bg %>%
    knitr::kable(digits = 2, align = 'c')
```

## save backgrounds

```{r}
  saveRDS(bg, file = "../../r_data/ecoc_bg.RDS")
```

## plot: background and burn concentrations

```{r ecoc_burn_bg_conc, echo=FALSE}
  ecoc_merged %>%
    dplyr::group_by(id, test_type) %>%
    ggplot(aes_string(y = "val", x = "test_type")) +
      geom_boxplot(outlier.colour = NA) +
      geom_jitter(aes(color = qc, shape = lod), size = 2) +
      theme_bw() +
      scale_shape_manual(values = lod_shapes) +
      scale_color_manual(values = qc_colors) +
      theme(text = element_text(size = 12),
            legend.position = "top") +
      facet_wrap(pol~cassette, scales = "free", ncol = 2) +
      ylab("concentration (microgram per meter cubed)") +
      xlab("")
```

notes: some burns have low concentrations - opt to subtract median background from all burn data

## subtract artifact filters for burn filters

```{r}
  ecoc_merged <-
    ecoc_merged %>%
    dplyr::filter(test_type == "test")
```

extract artifact

```{r}
  ecoc_artifact <-
    ecoc_merged %>%
    dplyr::filter(cassette == "a") %>%
    dplyr::select(id, pol, val, lod) %>%
    dplyr::rename("artifact" = "val",
                  "lod_a" = "lod")
```

## plot: ratio of sample to artifact filters

```{r}
  ecoc_merged %>%
    dplyr::filter(cassette == "e") %>%
    dplyr::left_join(ecoc_artifact, by = c("id", "pol")) %>%
    dplyr::mutate(ratio = artifact / val) %>%
      ggplot(aes(id, ratio)) + 
        geom_point() +
        facet_wrap(~pol, nrow = 2) +
        theme_bw()
```

## table: average ratio of artifact to loaded filter

```{r}
    ecoc_merged %>%
    dplyr::filter(cassette == "e") %>%
    dplyr::left_join(ecoc_artifact, by = c("id", "pol")) %>%
    dplyr::mutate(ratio = artifact / val) %>%
    dplyr::group_by(pol) %>%
    dplyr::summarise(ratio = mean(ratio, na.rm = TRUE)) %>%
    knitr::kable("markdown", align = 'c', digits = 2)
```

```{r}
  oc_ratio <-
    ecoc_merged %>%
    dplyr::filter(cassette == "e") %>%
    dplyr::left_join(ecoc_artifact, by = c("id", "pol")) %>%
    dplyr::mutate(ratio = artifact / val) %>%
    dplyr::group_by(pol) %>%
    dplyr::summarise(ratio = mean(ratio, na.rm = TRUE))
```

## subtract background

```{r}
  ecoc_merged <-
    ecoc_merged %>%
    dplyr::left_join(bg, by = c("pol", "cassette"))
```

```{r}
  ecoc_merged <-
   ecoc_merged %>%
    dplyr::mutate(val = val - median) %>%
    dplyr::select(-min, -max, -count, -mean, -median, -stdev)
```

## table: percentage of measurements below the background median

```{r, echo=FALSE}
  ecoc_merged %>%
    dplyr::group_by(pol) %>%
    dplyr::do(val = round(nrow(filter(., val < 0))/nrow(.), 2) * 100) %>%
    dplyr::mutate(val = cell_spec(val, "html", color = ifelse(val > 10, "red", "blue"))) %>%
    knitr::kable("markdown", align = 'c', digits = 2)
```

notes: one test 25A and 25B (artifact filters) were below background - need to decide if whole measurement is thrown out or not

## create a new below background variable

```{r}
  ecoc_merged <-
    ecoc_merged %>%
    dplyr::mutate(bg = ifelse(val < 0, "below", "above"),
                  val = ifelse(bg == "below", NA, val))
```

```{r}
  ecoc_artifact <-
    ecoc_merged %>%
    dplyr::filter(cassette == "a") %>%
    dplyr::select(-cassette) %>%
    dplyr::rename("artifact" = "val") %>%
    dplyr::select(id, pol, artifact, bg)
```

```{r}
  ecoc_merged <-
    ecoc_merged %>%
    dplyr::filter(cassette == "e") %>%
    dplyr::select(-cassette, -bg) %>%
    dplyr::left_join(ecoc_artifact, by = c("id", "pol")) %>%
    dplyr::mutate(bg = ifelse(is.na(bg), "above", bg),
                  artifact = ifelse(is.na(artifact) & pol == "ec" & bg == "above", 0, artifact),
                  artifact = ifelse(is.na(artifact) & pol == "oc" & bg == "above", val * oc_ratio$ratio[2], artifact),
                  val = val - artifact)
```

notes: 

* replace missing artifact filters with average ratio between sample and artifact
* select artifact background (above/below) keyword, because it is more stringent - check with John

## table: percentage of measurements below artifact

```{r, echo=FALSE}
  ecoc_merged %>%
    dplyr::group_by(pol) %>%
    dplyr::do(val = round(nrow(filter(., val < 0))/nrow(.), 2) * 100) %>%
    dplyr::mutate(val = cell_spec(val, "html", color = ifelse(val > 10, "red", "blue"))) %>%
    knitr::kable("markdown", align = 'c', digits = 2)
```

notes: yes!!!!!!!!

# burn analysis

## plot: time series of burns

```{r ecoc_burn_timeseries, echo=FALSE}
  ecoc_merged %>%
    dplyr::filter(test_type == "test") %>%
    dplyr::filter(!is.na(val)) %>%
    dplyr::left_join(dplyr::select(samples, id, date), by = 'id') %>%
    ggplot(aes_string(x = "date", y = "val")) +
      geom_point(aes(shape = lod, color = qc), size = 2) +
      scale_shape_manual(values = lod_shapes) +
      scale_color_manual(values = qc_colors) +
      theme_bw() +
      theme(text = element_text(size = 16),
            legend.position = "top") +
      labs(shape = "lod") +
      facet_wrap(~pol, scales = "free", ncol = 1) +
      ylab("concentration (microgram per meter cubed)") +
      xlab("")
```

notes: looks reasonable - proceed

## plot: concentrations by stove type

```{r ecoc_stovetype, echo=FALSE, fig.width=10}
  ecoc_merged_p <-
    ecoc_merged %>%
    dplyr::filter(!is.na(val), !grepl("27|28|29|30", id)) %>%
    dplyr::left_join(dplyr::select(samples, id, stove, fuel, stovecat, fuelcat), by = "id")

 ecoc_merged_p %>%
    ggplot(aes_string(x = "stove", y = "val")) +
      geom_boxplot(outlier.colour = NA) +
      geom_jitter(aes(color = qc, shape = lod), size = 2) + 
      scale_shape_manual(values = lod_shapes) +
      scale_color_manual(values = qc_colors) +
      theme_bw() +
      #scale_y_log10() +
      theme(text = element_text(size = 16),
            axis.text.x = element_text(angle = 15, hjust = 1, vjust = 1),
            legend.position = "top") +
      facet_grid(pol~fuelcat, scales = "free", space = "free_x") +
      ylab("concentration (microgram per meter cubed)") +
      xlab("")
```

notes: 

## table: outliers by stove type

outliers (z > 3) when samples are grouped by pollutant and stove type

```{r, echo=FALSE}
  ecoc_merged_p %>%
    dplyr::filter(!is.na(val)) %>%
    dplyr::group_by(stove, pol) %>%
    dplyr::mutate(z_score = (val - mean(val, na.rm = TRUE)) / sd(val, na.rm = TRUE)) %>%
    dplyr::ungroup() %>%
    dplyr::select(id, pol, stove, fuel, z_score) %>%
    dplyr::filter(z_score > 3) %>%
    dplyr::rename("particle type" = "pol") %>%
    knitr::kable("markdown", align = 'c')
```

notes:

## plot: concentrations by fuel type

```{r ecoc_fueltype, echo=FALSE, fig.width=10}
  ecoc_merged_p %>%
    ggplot(aes_string(x = "fuel", y = "val")) +
      geom_boxplot(outlier.colour = NA) +
      geom_jitter(aes(color = qc, shape = lod), size = 2) + 
      theme_bw() +
      #scale_y_log10() +
      scale_shape_manual(values = lod_shapes) +
      scale_color_manual(values = qc_colors) +
      theme(text = element_text(size = 16),
            axis.text.x = element_text(angle = 15, hjust = 1, vjust = 1),
            legend.position = "top") +
      facet_grid(pol~fuelcat, scales = "free", space = "free_x") +
      ylab("concentration (microgram per meter cubed)") +
      xlab("")
```

notes: 

## table: outliers by fuel type

outliers (z > 3) when samples are grouped by pollutant and fuel type

```{r, echo=FALSE}
  ecoc_merged_p %>%
    dplyr::filter(!is.na(val)) %>%
    dplyr::group_by(fuel, pol) %>%
    dplyr::mutate(z_score = (val - mean(val, na.rm = TRUE)) / sd(val, na.rm = TRUE)) %>%
    dplyr::ungroup() %>%
    dplyr::select(id, stove, fuel, z_score) %>%
    dplyr::filter(z_score > 3) %>%
    knitr::kable("markdown", align = 'c')
```

notes: 

## table: burns below lod

percent of burn samples below the lod

```{r, echo=FALSE}
  ecoc_merged %>%
    dplyr::group_by(pol) %>%
    dplyr::do(val = round(nrow(filter(., lod == "below"))/nrow(.), 2) * 100) %>%
    dplyr::mutate(val = cell_spec(val, "html", color = ifelse(val > 10, "red", "blue"))) %>%
    knitr::kable("markdown", align = 'c')
```

## table: burns with NA values

percent of burn samples with NA values

```{r, echo=FALSE}
  ecoc_merged %>%
    dplyr::group_by(pol) %>%
    dplyr::do(val = round(nrow(filter(., is.na(val) == TRUE))/nrow(.), 2) * 100) %>%
    dplyr::mutate(val = cell_spec(val, "html", color = ifelse(val > 10, "red", "blue"))) %>%
    knitr::kable("markdown", align = 'c')
```

## save data

```{r}
  ecoc_merged <-
    ecoc_merged %>%
    dplyr::select(id, pol, val, dur, lod, bg, qc) %>%
    dplyr::mutate(pol_category = pol)

  saveRDS(ecoc_merged, file = "../../r_data/ecoc_merged.RDS")
```

## table: missing data at end

```{r, echo = FALSE}
  dplyr::select(samples, id, stove, fuel) %>%
  dplyr::anti_join(ecoc_merged %>%
                     dplyr::distinct(),
                   by = "id") %>%
  dplyr::filter(!grepl("^G", id)) %>%
  dplyr::filter(!grepl("^27|^28|^29|^30", id)) %>%
  knitr::kable("markdown", align = 'c')
```

## table: percent of data below background

```{r, echo=FALSE}
  ecoc_merged %>%
    dplyr::group_by(pol) %>%
    dplyr::do(val = round(nrow(filter(., bg == "below"))/nrow(.), 2) * 100) %>%
    dplyr::mutate(val = cell_spec(val, "html", color = ifelse(val > 10, "red", "blue"))) %>%
    knitr::kable("markdown", align = 'c')
```