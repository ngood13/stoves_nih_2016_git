---
title: "Process five gas data"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r load_libraries, echo=FALSE, message=FALSE}
  if (!require("pacman")) install.packages("pacman")
  pacman::p_load(tidyverse, kableExtra)
```

```{r global_options, echo=FALSE}
  knitr::opts_chunk$set(fig.path ='figures/', 
                        fig.width = 8, fig.height = 5,
                        warning = FALSE, message = FALSE, cache = FALSE)
```

# tidy data

## load files

load scripts

```{r}
  source("../../scripts/tidy.R")
  source("../../scripts/functions.R")
```

load data

```{r}
  samples <- readRDS("../../r_data/samples.RDS")
  fivegas_conc <- readRDS("../../r_data/fivegas_conc.RDS") 
  fivegas_volts <- readRDS("../../r_data/fivegas_volts.RDS")
  fivegas_calibration <- readRDS("../../r_data/fivegas_calibration.RDS")
  cal_1 <- readRDS("../../r_data/cal_1.RDS")
  notes <- readRDS("../../r_data/notes.RDS")
  samples <- readRDS("../../r_data/samples.RDS")
  pol_properties <- readRDS("../../r_data/pol_properties.RDS")
  times <- readRDS("../../r_data/test_times.RDS")
```

load schemes

```{r}
  qc_colors <- readRDS("../../r_data/qc_colors.RDS")
  lod_shapes <- readRDS("../../r_data/lod_shapes.RDS")
```

## reformat data

convert concentration data to longer format

```{r}
  fivegas_conc <- 
    fivegas_conc %>%
    dplyr::filter(!grepl("^27|^28|^29|^30", id)) %>%
    dplyr::select(-datetime_secs, -time_str) %>%
    tidyr::gather("pol", "val", ch4:co)
```

```{r}
  fivegas_conc <-
    fivegas_conc %>%
    dplyr::mutate(val = ifelse(grepl("co2", pol), val * 1e4, val))
```

convert voltage data to longer format

```{r}
  fivegas_volts <- 
    fivegas_volts %>%
    dplyr::filter(!grepl("^27|^28|^29|^30", id)) %>%
    tidyr::gather("pol", "volts", co2:ch4)
```

convert voltage calibration data to longer format

```{r}
  fivegas_calibration <- 
    fivegas_calibration %>%
    tidyr::gather("pol", "volts", co2:ch4)
```

calibration standard mixing ratios

```{r}
  fivegas_cal_conc <- tidy_date(cal_1, "^conc_", "conc_")
```

calibration timestamps

```{r}
  fivegas_cal_times <- tidy_date(cal_1, "^time_", "time_")

  # add manual calibration for one day
  fivegas_cal_times$value[130]  <- 34350 - 60

  fivegas_cal_times <- split_fivegas_cal_times(fivegas_cal_times)
```

## calculate concentration from voltage data

calculate mean voltage over last 30 seconds of each calibration window

```{r}
  fivegas_cal <- 
    fivegas_cal_times %>%
    tidyr::spread(type, value) %>%
    dplyr::filter(!is.na(start) & pol != "zero")  %>%
    dplyr::rowwise() %>%
    dplyr::mutate(v_mean = 
                    time_window_stats(fivegas_calibration, date, start, end,
                                      pol_var = pol, val_var = "volts",  stat_var = "mean")) %>%
    dplyr::mutate(v_sd =
                    time_window_stats(fivegas_calibration, date, start, end, 
                                      pol_var = pol, val_var = "volts", stat_var = "sd"))
```

extract zero time periods

```{r}
  fivegas_cal_zero <- 
    fivegas_cal_times %>%
    tidyr::spread(type, value) %>%
    dplyr::filter(!is.na(start) & pol == "zero") %>%
    dplyr::select(-pol) %>%
    dplyr::rename(start_zero = start, end_zero = end)
```

join zero time periods with the calibration data 

```{r}
  fivegas_cal <- 
    fivegas_cal %>%
    dplyr::left_join(fivegas_cal_zero, by = "date")
```

calculate mean voltage during last 30 seconds of each zero calibration

```{r}
  fivegas_cal <- 
    fivegas_cal %>%
    dplyr::mutate(v_zero_mean =
                    time_window_stats(fivegas_calibration,
                                      date, start_zero, end_zero,
                                      pol_var = pol, val_var = "volts", stat_var = "mean")) %>%
    dplyr::mutate(v_zero_sd =
                    time_window_stats(fivegas_calibration,
                                      date, start_zero, end_zero,
                                       pol_var = pol, val_var = "volts", stat_var = "sd"))
```

merge measured voltage with standard mixing ratio

```{r}
  fivegas_cal_conc <-
    fivegas_cal_conc %>%
    dplyr::rename(pol = var, standard = value)

  fivegas_cal <- 
    fivegas_cal %>%
    dplyr::left_join(fivegas_cal_conc, by = c("date", "pol"))
```

notes: data missing for 2016-03-09 and 2016-04-01

calibration coefficients

```{r}
  fivegas_cal <- 
    fivegas_cal %>%
    dplyr::mutate(cal_beta = (standard / (v_mean - v_zero_mean))) %>%
    dplyr::mutate(cal_int = - (v_zero_mean * cal_beta))
```

for days with missing cal data, replace with closest date beta and intercept

```{r}
  cal_avg <-
    fivegas_cal %>%
    dplyr::filter(date == "2016-03-11") %>%
    dplyr::select(pol, cal_beta, cal_int)

  fivegas_cal <-
    fivegas_cal %>%
    dplyr::mutate(cal_beta = ifelse(is.na(cal_beta) & pol == "co2", cal_avg$cal_beta[3], cal_beta),
                  cal_beta = ifelse(is.na(cal_beta) & pol == "co", cal_avg$cal_beta[2], cal_beta),
                  cal_beta = ifelse(is.na(cal_beta) & pol == "ch4", cal_avg$cal_beta[1], cal_beta),
                  cal_int = ifelse(is.na(cal_int) & pol == "co2", cal_avg$cal_int[3], cal_int),
                  cal_int = ifelse(is.na(cal_int) & pol == "co", cal_avg$cal_int[2], cal_int),
                  cal_int = ifelse(is.na(cal_int) & pol == "ch4", cal_avg$cal_int[1], cal_int))
```

add calibration date

```{r}
  fivegas_volts <- add_caldate(fivegas_volts, fivegas_cal)

  fivegas_volts <- dplyr::mutate(fivegas_volts, pol = as.factor(pol))
```

## plot: zero and span voltage

```{r, echo=FALSE, fig.width=12, fig.height=6}
  p_df <- tidyr::gather(fivegas_cal,
                        "type", "volts",
                        v_mean, v_zero_mean) %>%
         dplyr::mutate(sd = ifelse(type == "v_mean", v_sd, v_zero_sd)) %>%
         dplyr::select(-v_sd, -v_zero_sd)

  # standard response voltage error bars
  v_limits <- aes(ymax = volts + sd, ymin = volts - sd)  # error bars

  # plot
  ggplot(p_df, aes(x = date, y = volts, group = type, colour = type)) +
    geom_point() +
    geom_errorbar(v_limits, width = 0.2) +
    facet_wrap(~pol, 1, scales = "free") +
    theme_bw() +
    xlab("") +
    ylab("span") +
    theme(legend.position="top")

```

notes: data look reasonable - proceed

## apply calibration

merge voltage data and calibration data, then apply calibration

```{r}
  fivegas_volts <- 
    fivegas_volts %>%
    dplyr::left_join(dplyr::select(fivegas_cal, date, pol, cal_beta, cal_int),
                     by = c("cal_date" = "date", "pol" = "pol")) %>%
    dplyr::mutate(val = volts * cal_beta + cal_int)
```

## remove bad data

unreasonable tail data

```{r}
  fivegas_volts <-
    fivegas_volts %>%
    dplyr::filter(!(val < 300 & pol == "co2"),
                  val > 0)
```

couldn't find a reasonable calibration constant for 15A or 9A for methane

```{r}
  fivegas_volts <-
    fivegas_volts %>%
    dplyr::filter(!(pol == "ch4" & id == "15A"),
                  !(pol == "ch4" & id == "9A"))
```

## plot: carbon dioxide traces

```{r fivegas_volts_trace_co2, eval=FALSE, echo=FALSE, fig.width=12}
 fivegas_volts %>%
    dplyr::filter(grepl("co2", pol)) %>%
    ggplot(aes_string(x = "datetime", y = "val")) +
      geom_point() + 
      theme_bw() +
      theme(text = element_text(size = 16),
            legend.position = "top") +
      facet_wrap(~id, scales = "free", ncol = 4) +
      ylab("mixing ratio (ppm)") +
      xlab("")
```

## plot: carbon monoxide traces

```{r fivegas_volts_trace_co, eval=FALSE, echo=FALSE, fig.width=12}
 fivegas_volts %>%
    dplyr::filter(grepl("co$", pol)) %>%
    ggplot(aes_string(x = "datetime", y = "val")) +
      geom_point() + 
      theme_bw() +
      theme(text = element_text(size = 16),
            legend.position = "top") +
      facet_wrap(~id, scales = "free", ncol = 4) +
      ylab("mixing ratio (ppm)") +
      xlab("")
```

## plot: methane traces

```{r fivegas_volts_trace_ch4, eval=FALSE, echo=FALSE, fig.width=12}
 fivegas_volts %>%
    dplyr::filter(grepl("ch4", pol)) %>%
    ggplot(aes_string(x = "datetime", y = "val")) +
      geom_point() + 
      theme_bw() +
      theme(text = element_text(size = 16),
            legend.position = "top") +
      facet_wrap(~id, scales = "free", ncol = 4) +
      ylab("mixing ratio (ppm)") +
      xlab("")
```

## combine file types

choose only important variables

```{r}
  fivegas_volts <- 
    fivegas_volts %>%
    dplyr::select(datetime, date, time, id, pol, val)
```

merge voltage and mixing ratio data

```{r}
  fivegas <- 
    dplyr::arrange(dplyr::bind_rows(fivegas_volts, fivegas_conc), datetime)
```

## remove oxygen and nox rows (channels not used during study)

```{r}
  fivegas <- 
    fivegas %>%
    dplyr::filter(pol != "o2" & pol != "nox")
```

## extract sample time

get timestamps

```{r}
  sample_times <- 
    times %>%
    dplyr::filter(grepl("^sample$|shutdown|refuel_1", var)) %>%
    dplyr::mutate(var = as.character(var),
                  var = ifelse(var == "refuel_1", "sample", var)) %>%
    tidyr::spread("var", "value") %>%
    dplyr::select(-date) %>%
    dplyr::rename("start" = "sample",
                  "end" = "shutdown")
```

notes: missing a substantial portion of five gas sample times so just use sample to shutdown time for batch stoves and refuel_1 to shutdown for wood stoves

filter times

```{r}
  fivegas_merged <- 
    filter_times(sample_times, fivegas)
```

## add data check if needed

```{r, eval=FALSE, echo=FALSE, fig.width=12}
 fivegas_merged %>%
    dplyr::filter(grepl("co2", pol)) %>%
    ggplot(aes_string(x = "datetime", y = "val")) +
      geom_point() + 
      theme_bw() +
      theme(text = element_text(size = 16),
            legend.position = "top") +
      facet_wrap(~id, scales = "free", ncol = 4) +
      ylab("mixing ratio (ppm)") +
      xlab("")
```

```{r, eval=FALSE, echo=FALSE, fig.width=12}
 fivegas_merged %>%
    dplyr::filter(grepl("co$", pol)) %>%
    ggplot(aes_string(x = "datetime", y = "val")) +
      geom_point() + 
      theme_bw() +
      theme(text = element_text(size = 16),
            legend.position = "top") +
      facet_wrap(~id, scales = "free", ncol = 4) +
      ylab("mixing ratio (ppm)") +
      xlab("")
```

```{r, eval=FALSE, echo=FALSE, fig.width=12}
 fivegas_merged %>%
    dplyr::filter(grepl("ch4", pol)) %>%
    ggplot(aes_string(x = "datetime", y = "val")) +
      geom_point() + 
      theme_bw() +
      theme(text = element_text(size = 16),
            legend.position = "top") +
      facet_wrap(~id, scales = "free", ncol = 4) +
      ylab("mixing ratio (ppm)") +
      xlab("")
```

## flags

extract flags

```{r}
  notes <- 
    notes %>%
    dplyr::filter(grepl("fivegas|all", inst) == TRUE)
```

bad preceeds maybe preceeds good

```{r}
  flags <-
    notes %>%
    dplyr::select(id, qc) %>%
    dplyr::group_by(id) %>%
    dplyr::arrange(qc) %>%
    dplyr::summarise(qc = first(qc))
```

add flag by id

```{r}
  fivegas_merged <-
    fivegas_merged %>%
    dplyr::left_join(flags, by = "id") %>%
    dplyr::mutate(id = as.factor(id)) %>%
    dplyr::mutate(qc = as.factor(ifelse(is.na(qc), "ok", as.character(qc))))
```

# missing and bad data

## table: missing data

```{r, echo = FALSE}
  dplyr::select(samples, id, stove, fuel) %>%
  dplyr::anti_join(fivegas_merged %>%
                   dplyr::select(id) %>%
                   dplyr::distinct(),
                   by = "id") %>%
  dplyr::filter(stove != "background") %>%
  dplyr::filter(!grepl("^27|^28|^29|^30", id)) %>%
  knitr::kable("markdown", align = 'c')
```

notes: data is expected to be missing for: 2A, 4A, and 1B - original data only has calibration file for 17C

## table: bad data

```{r, echo=FALSE}
  notes %>%
    dplyr::filter(grepl("fivegas|all", inst) == TRUE,
                  qc != "ok") %>%
    dplyr::select(-inst) %>%
    dplyr::filter(!grepl("^27|^28|^29|^30", id)) %>%
    knitr::kable("markdown", align = 'c')
```

notes: 

* 6A appears to have data file - ignore

* test where concentration maxed out: 1A, 3A, 8A, 17B, 20A, and 23A - start by checking if outliers

* 2A: fire went out during test - check if outlier
* 2C: start up period twice - check if outlier
* 23A: fire relit with kerosene and match during refuel - check if outlier

* 23B: signal is bad for all pollutants - remove
* 4B: signal is bad for co2 - remove

## mark additional tests as bad

```{r}
  fivegas_merged <- 
    fivegas_merged %>%
    dplyr::mutate(qc = as.character(qc),
                  qc = ifelse(grepl("23B", id), "bad", qc),
                  qc = ifelse(id == "4B" & pol == "co2", "bad", qc))
```

## remove bad tests

```{r}
  fivegas_merged <-
    fivegas_merged %>% 
    dplyr::filter(qc != "bad")
```

## table: fraction of sample missing

```{r, echo=FALSE}
  fivegas_merged %>%
    dplyr::select(id, time) %>%
    dplyr::group_by(id) %>%
    dplyr::summarise(start = min(time),
                     end = max(time)) %>%
    dplyr::left_join(sample_times %>%
                     dplyr::mutate(dur = end - start) %>%
                     dplyr::select(id, dur), by = "id") %>%
    dplyr::mutate(prct_missing = (100 - ((end - start) / dur) * 100)) %>%
    dplyr::filter(prct_missing >= 20) %>%
    dplyr::select(id, prct_missing) %>%
    knitr::kable("markdown", align = 'c', digits = 2)
```

notes: 

* 13B: is missing approx. 48% of test missing - remove
* 13A: leave for now - check if outlier

```{r}
  fivegas_merged <-
    fivegas_merged %>%
    dplyr::filter(id != "13B")
```

```{r}
  fivegas_merged <-
    fivegas_merged %>%
    dplyr::select(id, datetime, pol, val, qc)
```

# background

extract five gas background times - not including first and last minute of sample

```{r}
  times_pre <- 
    times %>%
    dplyr::filter(var == "bg_pre_start_fivegas" | var == "bg_pre_end_fivegas") %>%
    tidyr::spread(var, value) %>%
    dplyr::select(-date) %>%
    dplyr::rename(start = bg_pre_start_fivegas,
                  end = bg_pre_end_fivegas) %>%
    dplyr::mutate(start = start + 60,
                  end = end - 60)

  times_post <- 
    times %>%
    dplyr::filter(var == "bg_post_start_fivegas" | var == "bg_post_end_fivegas") %>%
    tidyr::spread(var, value) %>%
    dplyr::select(-date) %>%
    dplyr::rename(start = bg_post_start_fivegas,
                  end = bg_post_end_fivegas) %>%
    dplyr::mutate(start = start + 60,
                  end = end - 60)
```

extract five minutes before and after start of test

```{r}
  times_pre_5 <- 
    times %>%
    dplyr::filter(var == "ignite") %>%
    tidyr::spread(var, value) %>%
    dplyr::select(-date) %>%
    dplyr::mutate(end = ignite - 5*60) %>%
    dplyr::mutate(start = end - 10*60)

  times_post_5 <-
    times %>%
    dplyr::filter(var == "end") %>%
    tidyr::spread(var, value) %>%
    dplyr::select(-date) %>%
    dplyr::mutate(start = end + 5*60) %>%
    dplyr::mutate(end = start + 10*60)
```

join five minutes before start and stop of test with recorded background time - precedence to recorded times

```{r}
  times_pre <- 
    times_pre_5 %>% 
    dplyr::anti_join(times_pre, by = "id") %>%
    dplyr::bind_rows(times_pre)

  times_post <- 
    times_post_5 %>%
    dplyr::anti_join(times_post, by = "id") %>%
    dplyr::bind_rows(times_post)
```

## extract pre and post backgrounds

```{r}
  pre_bg <- filter_times(times_pre, fivegas)
  pre_bg <- dplyr::mutate(pre_bg, type = "pre_bg")

  post_bg <- filter_times(times_post, fivegas)
  post_bg <- dplyr::mutate(post_bg, type = "post_bg")
```

```{r}
  bg <-
    pre_bg %>%
    dplyr::bind_rows(post_bg)
```

## plot: time series of lab backgrounds

```{r fivegas_bg_ppm, echo=FALSE}
  bg %>%
    ggplot(aes_string(x = "datetime", y = "val")) +
      geom_point(aes(color = type), size = 2, shape = 1) +
      theme_bw() +
      facet_wrap(~pol, scales = "free", ncol = 1) +
      theme(text = element_text(size = 12),
            legend.position = "top") +
      ylab("mixing ratio (ppm)") +
      xlab("")
```

notes: remove unreasonable values including: 

* when co2 is approximately equal to zero
* when co2 is over 1000 ppm
* when ch4 is greater than 40 ppm
* when co is greater than 25 ppm

```{r}
  bg <- 
    bg %>%
    dplyr::filter(pol == "co2" & val > 250 & val < 1000) %>%
    dplyr::bind_rows(bg %>%
                       dplyr::filter(pol == "ch4" & val < 40),
                     bg %>%
                      dplyr::filter(pol == "co" & val  < 25))
```

## plot: averaged concentrations by date

```{r fivegas_bg_ppm_avg, echo=FALSE}
  bg %>%
    dplyr::filter(!is.na(val)) %>%
    dplyr::group_by(date, pol) %>%
    dplyr::summarise(val = mean(val, na.rm = TRUE)) %>%
    ggplot(aes_string(x = "date", y = "val")) +
      geom_point(size = 2, shape = 1) +
      theme_bw() +
      facet_wrap(~pol, scales = "free", ncol = 1) +
      theme(text = element_text(size = 12),
            legend.position = "top") +
      ylab("mixing ratio (ppm)") +
      xlab("")
```

## table: lab background outliers

outliers (z > 3) when backgrounds are grouped by pollutant and filter type

```{r, echo=FALSE}
  bg %>%
    dplyr::filter(!is.na(val)) %>%
    dplyr::group_by(date, pol) %>%
    dplyr::summarise(val = mean(val, na.rm = TRUE)) %>%
    dplyr::filter(!is.na(val)) %>%
    dplyr::group_by(pol) %>%
    dplyr::mutate(z_score = (val- mean(val, na.rm = TRUE)) / sd(val, na.rm = TRUE)) %>%
    dplyr::select(date, z_score) %>%
    dplyr::filter(z_score > 3) %>%
    knitr::kable("markdown", align = 'c', digits = 2)
```

notes: remove co data from this date

```{r}
  bg <-
    bg %>%
    dplyr::filter(!(pol == "co" & grepl("2016-02-03", date)))
```

## summarize backgrounds

```{r}
  bg_summary <-
    bg %>%
    dplyr::group_by(pol) %>%
    dplyr::summarise(mean = mean(val, na.rm = TRUE),
                     median = median(val, na.rm = TRUE),
                     stdev = sd(val, na.rm = TRUE),
                     min = min(val, na.rm = TRUE),
                     max = max(val, na.rm = TRUE),
                     count = n()) %>%
    dplyr::mutate(mean = ifelse(is.nan(mean), NA, mean),
                  median = ifelse(is.nan(median), NA, median),
                  stdev = ifelse(is.nan(stdev), NA, stdev),
                  min = ifelse(is.infinite(min), NA, min),
                  max = ifelse(is.infinite(max), NA, max),
                  count = ifelse(is.nan(count), NA, count))
```

## table: background summary

summary of backgrounds (ppm)

```{r, echo=FALSE}
  bg_summary %>%
    knitr::kable("markdown", digits = 2, align = 'c')
```

notes: reasonable values - proceed

## save backgrounds

```{r}
  saveRDS(bg_summary, file = "../../r_data/fivegas_bg.RDS")
```

## plot: background and burn concentrations

averaged by date

```{r fivegas_burn_bg_conc, echo=FALSE}
  fivegas_merged %>%
  dplyr::mutate(test_type = "test") %>%
  dplyr::left_join(dplyr::select(samples, id, date), by = "id") %>%
  dplyr::select(date, pol, val, qc, test_type) %>%
  dplyr::bind_rows(bg %>%
                     dplyr::mutate(test_type = "bg",
                                   qc = "ok") %>%
                     dplyr::select(date, pol, val, qc, test_type)) %>%
    dplyr::filter(!is.na(val)) %>%
    dplyr::group_by(date, pol, test_type) %>%
    dplyr::summarise(val = mean(val, na.rm = TRUE)) %>%
    ggplot(aes_string(y = "val", x = "test_type")) +
      geom_boxplot(outlier.colour = NA) +
      geom_jitter(size = 2, shape = 1, width = 0.25) +
      theme_bw() +
      scale_y_log10() +
      facet_wrap(~pol, 1, scales = "free") +
      theme(text = element_text(size = 12),
            legend.position = "top") +
      ylab("mixing ratio (ppm)") +
      xlab("")
```

notes: some burns have low concentrations (especially methane) - opt to subtract median background from all burn data

## subtract background

```{r}
  fivegas_merged <-
    fivegas_merged %>%
    dplyr::mutate(test_type = "test")
```

make dilution average variable

```{r}
  fivegas_dilution <-
    fivegas_merged %>%
    dplyr::filter(pol == "co2")

  saveRDS(fivegas_dilution, file = "../../r_data/fivegas_dilution.RDS")

  fivegas_dilution <-
    fivegas_dilution %>%
    dplyr::group_by(id) %>%
    dplyr::summarise(val = mean(val, na.rm = TRUE),
                     qc = first(qc))

  saveRDS(fivegas_dilution, file = "../../r_data/fivegas_dilution_avg.RDS")
```

```{r}
  fivegas_merged <-
    fivegas_merged %>%
    dplyr::mutate(test_type = "test") %>%
    dplyr::left_join(bg_summary, by = c("pol"))
```

```{r}
  fivegas_merged <-
   fivegas_merged %>%
    dplyr::mutate(val = val - median) %>%
    dplyr::select(-min, -max, -count, -mean, -median, -stdev)
```

## table: percentage of measurements below the background median (by pollutant)

```{r, echo=FALSE}
  fivegas_merged %>%
    dplyr::group_by(pol) %>%
    dplyr::do(val = round(nrow(filter(., val < 0))/nrow(.), 2) * 100) %>%
    dplyr::mutate(val = cell_spec(val, "html", color = ifelse(val > 10, "red", "blue"))) %>%
    knitr::kable("markdown", align = 'c', digits = 2)
```

## create a new below background variable

```{r}
  fivegas_merged <-
    fivegas_merged %>%
    dplyr::mutate(bg = ifelse(val < 0, "below", "above"),
                  val = ifelse(bg == "below", NA, val))
```

## table: percentage of measurements below the background median (by test)

```{r, echo=FALSE}
  fivegas_merged %>%
    dplyr::group_by(id, pol) %>%
    dplyr::do(val = round(nrow(filter(., bg == "below"))/nrow(.), 2) * 100) %>%
    dplyr::mutate(val = cell_spec(val, "html", color = ifelse(val > 10, "red", "blue"))) %>%
    tidyr::spread(pol, val) %>%
    knitr::kable("markdown", align = 'c', digits = 2)
```

# concentration calculations

calculate mass concentrations

```{r}
  fivegas_merged <-
    fivegas_merged %>%
    dplyr::left_join(dplyr::select(pol_properties, pol, mw), by = "pol") %>%
    dplyr::mutate(val = convert_ppmv_ugpmc(val, mw),
                  units = "ug per meter cubed") %>%
    dplyr::select(-mw)
```

# burn analysis for real-time data

## plot: carbon dioxide traces

```{r fivegas_trace_co2, echo=FALSE, fig.height=40, fig.width=12}
  fivegas_merged_p <-
    fivegas_merged %>%
    dplyr::left_join(dplyr::select(samples, id, stove, fuel, stovecat, fuelcat), by = "id")

 fivegas_merged_p %>%
    dplyr::filter(grepl("co2", pol)) %>%
    ggplot(aes_string(x = "datetime", y = "val", color = "qc")) +
      geom_point() + 
      scale_color_manual(values = qc_colors) +
      theme_bw() +
      theme(text = element_text(size = 16),
            legend.position = "top") +
      facet_wrap(id~stove, scales = "free", ncol = 4) +
      ylab("concentration (ug per meter cubed)") +
      xlab("")
```

## plot: carbon monoxide traces

```{r fivegas_trace_co, echo=FALSE, fig.height=40, fig.width=12}
 fivegas_merged_p %>%
    dplyr::filter(grepl("^co$", pol)) %>%
    ggplot(aes_string(x = "datetime", y = "val", color = "qc")) +
      geom_point() + 
      scale_color_manual(values = qc_colors) +
      theme_bw() +
      theme(text = element_text(size = 16),
            legend.position = "top") +
      facet_wrap(id~stove, scales = "free", ncol = 4) +
      ylab("concentration (ug per meter cubed)") +
      xlab("")
```

## plot: methane traces

```{r fivegas_trace_ch4, echo=FALSE, fig.height=40, fig.width=12}
 fivegas_merged_p %>%
    dplyr::filter(grepl("ch4", pol)) %>%
    ggplot(aes_string(x = "datetime", y = "val", color = "qc")) +
      geom_point() + 
      scale_color_manual(values = qc_colors) +
      theme_bw() +
      theme(text = element_text(size = 16),
            legend.position = "top") +
      facet_wrap(id~stove, scales = "free", ncol = 4) +
      ylab("concentration (ug per meter cubed)") +
      xlab("")
```

## save data

```{r}
  fivegas_merged <-
    fivegas_merged %>%
    dplyr::select(id, datetime, pol, val, qc, bg, units) %>%
    dplyr::mutate(pol_category = "five gas")

  saveRDS(fivegas_merged, file = "../../r_data/fivegas_merged.RDS")
```

# burn analysis for averaged data

remove test with more that 40% of data missing for below background

```{r}
  bb_tests <-
  fivegas_merged %>%
    dplyr::group_by(id, pol) %>%
    dplyr::do(bb = round(nrow(filter(., bg == "below"))/nrow(.), 2) * 100) %>%
    dplyr::mutate(bg = ifelse(bb > 40, "below", "above")) %>%
    dplyr::select(-bb)
```

notes: background is below if more than 40% of data in the calculation is below background

```{r}
  fivegas_merged <-
    fivegas_merged %>%
    dplyr::group_by(id, pol) %>%
    dplyr::summarise(val = mean(val, na.rm = TRUE),
                     qc = first(qc)) %>%
    dplyr::left_join(bb_tests, by = c("pol", "id"))
```

change below background values with NA

```{r}
  fivegas_merged <-
    fivegas_merged %>%
    dplyr::mutate(val = ifelse(bg == "below", NA, val))
```

## plot: concentrations by stove type

```{r fivegas_stovetype_avg, echo=FALSE}
  fivegas_merged_p <-
    fivegas_merged %>%
    dplyr::left_join(dplyr::select(samples, id, stove, fuel, stovecat, fuelcat), by = "id")

 fivegas_merged_p %>%
    ggplot(aes_string(x = "stove", y = "val")) +
      geom_boxplot(outlier.colour = NA) +
      geom_jitter(aes(color = qc), size = 2) + 
      scale_color_manual(values = qc_colors) +
      theme_bw() +
      theme(text = element_text(size = 16),
            axis.text.x = element_text(angle = 15, hjust = 1, vjust = 1),
            legend.position = "top") +
      facet_grid(pol~fuelcat, scales = "free", space = "free_x") +
      ylab("concentration (microgram per meter cubed)") +
      xlab("")
```

notes: 

## table: outliers by stove type

outliers (z > 3) when samples are grouped by pollutant and stove type

```{r, echo=FALSE}
  fivegas_merged_p %>%
    dplyr::filter(!is.na(val)) %>%
    dplyr::group_by(stove) %>%
    dplyr::mutate(z_score = (val - mean(val, na.rm = TRUE)) / sd(val, na.rm = TRUE)) %>%
    dplyr::ungroup() %>%
    dplyr::select(id, stove, fuel, z_score) %>%
    dplyr::filter(z_score > 3) %>%
    knitr::kable("markdown", align = 'c')
```

notes:

## plot: concentrations by fuel type

```{r fivegas_merged_fueltype, echo=FALSE}
  fivegas_merged_p %>%
    ggplot(aes_string(x = "fuel", y = "val")) +
      geom_boxplot(outlier.colour = NA) +
      geom_jitter(aes(color = qc), size = 2) + 
      theme_bw() +
      scale_y_log10() +
      scale_color_manual(values = qc_colors) +
      theme(text = element_text(size = 16),
            axis.text.x = element_text(angle = 15, hjust = 1, vjust = 1),
            legend.position = "top") +
      facet_grid(pol~fuelcat, scales = "free", space = "free_x") +
      ylab("concentration (microgram per meter cubed)") +
      xlab("")
```

notes: 

## table: outliers by fuel type

outliers (z > 3) when samples are grouped by pollutant and fuel type

```{r, echo=FALSE}
  fivegas_merged_p %>%
    dplyr::filter(!is.na(val)) %>%
    dplyr::group_by(fuel) %>%
    dplyr::mutate(z_score = (val - mean(val, na.rm = TRUE)) / sd(val, na.rm = TRUE)) %>%
    dplyr::ungroup() %>%
    dplyr::select(id, stove, fuel, z_score) %>%
    dplyr::filter(z_score > 3) %>%
    knitr::kable("markdown", align = 'c')
```

notes: 

## save data

```{r}
  fivegas_merged <-
    fivegas_merged %>%
    dplyr::left_join(sample_times %>%
                     dplyr::mutate(dur = (end - start) / 60) %>%
                     dplyr::select(id, dur), by = "id") %>%
    dplyr::select(id, pol, val, dur, qc, bg) %>%
    dplyr::mutate(lod = NA,
                  pol_category = pol)

  saveRDS(fivegas_merged, file = "../../r_data/fivegas_merged_avg.RDS")
```

## calculate mce

```{r}
  mce <-
    fivegas_merged %>%
    dplyr::filter(grepl("co", pol)) %>%
    dplyr::select(id, pol, val) %>%
    tidyr::spread(pol, val) %>%
    dplyr::mutate(mce = co2 / (co + co2)) %>%
    dplyr::left_join(sample_times %>%
                     dplyr::mutate(dur = (end - start) / 60) %>%
                     dplyr::select(id, dur), by = "id") %>%
    dplyr::select(id, mce, dur)

  saveRDS(mce, file = "../../r_data/mce_avg.RDS")
```

## table: missing data at end

missing carbon dioxide data

```{r, echo = FALSE}
  dplyr::select(samples, id, stove, fuel) %>%
  dplyr::anti_join(fivegas_merged %>%
                     dplyr::filter(pol == "co2") %>%
                     dplyr::distinct(),
                   by = "id") %>%
  dplyr::filter(!grepl("^G", id)) %>%
  dplyr::filter(!grepl("^27|^28|^29|^30", id)) %>%
  knitr::kable("markdown", align = 'c')
```

missing carbon monoxide data

```{r, echo = FALSE}
  dplyr::select(samples, id, stove, fuel) %>%
  dplyr::anti_join(fivegas_merged %>%
                     dplyr::filter(pol == "co") %>%
                     dplyr::distinct(),
                   by = "id") %>%
  dplyr::filter(!grepl("^G", id)) %>%
  dplyr::filter(!grepl("^27|^28|^29|^30", id)) %>%
  knitr::kable("markdown", align = 'c')
```

missing methane data

```{r, echo = FALSE}
  dplyr::select(samples, id, stove, fuel) %>%
  dplyr::anti_join(fivegas_merged %>%
                     dplyr::filter(pol == "ch4") %>%
                     dplyr::distinct(),
                   by = "id") %>%
  dplyr::filter(!grepl("^G", id)) %>%
  dplyr::filter(!grepl("^27|^28|^29|^30", id)) %>%
  knitr::kable("markdown", align = 'c')
```

## table: percent of data below background

```{r, echo=FALSE}
  fivegas_merged %>%
    dplyr::group_by(pol) %>%
    dplyr::do(val = round(nrow(filter(., bg == "below"))/nrow(.), 2) * 100) %>%
    dplyr::mutate(val = cell_spec(val, "html", color = ifelse(val > 10, "red", "blue"))) %>%
    knitr::kable("markdown", align = 'c')
```