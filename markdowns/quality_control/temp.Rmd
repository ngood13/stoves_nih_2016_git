---
title: "temp"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r load_libraries, echo=FALSE, message=FALSE}
  if (!require("pacman")) install.packages("pacman")
  pacman::p_load(tidyverse)
```

```{r global_options, echo=FALSE}
  knitr::opts_chunk$set(fig.path ='figures/',
                        warning = FALSE, message = FALSE, cache = FALSE)
```

# tidy data

## load data

```{r}
  temp <- readRDS("../../r_data/temp.RDS")
  samples <- readRDS("../../r_data/samples.RDS")
  notes <- readRDS("../../r_data/notes.RDS")
  times <- readRDS("../../r_data/test_times.RDS")
```

load schemes

```{r}
  qc_colors <- readRDS("../../r_data/qc_colors.RDS")
  lod_shapes <- readRDS("../../r_data/lod_shapes.RDS")
```

convert to long format

```{r}
  temp_merged <- tidyr::gather(temp, loc, t_oc,
                               t_1, t_2, t_3, t_4) %>%
                 dplyr::arrange(id) %>%
  dplyr::filter(!grepl("^27|^28|^29|^30", id))
```

## fix probe locations

* standard set-up is `t_1 = t_pot` and `t_4 = flue`
* test `10x, 11x and 12x` have two pots
* fix stove data where probe location is not standard

```{r}
  flipped_25a <- dplyr::filter(temp_merged,
                           id =="25A") %>%
             dplyr::mutate(loc = ifelse(loc == "t_1", "flue", loc),
                           loc = ifelse(loc == "t_4", "front", loc))

  flipped_25bc <- dplyr::filter(temp_merged,
                           id =="25B" |id =="25C") %>%
             dplyr::mutate(loc = ifelse(loc == "t_1", "flue", loc),
                           loc = ifelse(loc == "t_2", "front", loc))

  regular <- dplyr::filter(temp_merged,
                          id !="25A" & id !="25B" & id !="25C" &
                          grepl("^10[A-Z]|^11[A-Z]|^12[A-Z]", id) == FALSE) %>%
             dplyr::mutate(loc = ifelse(loc == "t_1", "front", loc),
                           loc = ifelse(loc == "t_4", "flue", loc))

```

```{r}
  temp_10a <- dplyr::filter(temp_merged, id == "10A") %>%
              dplyr::mutate(loc = ifelse(loc == "t_1", "front", loc),
                            loc = ifelse(loc == "t_2", "back", loc),
                            loc = ifelse(loc == "t_4", "flue", loc))

  temp_10b <- dplyr::filter(temp_merged, id == "10B") %>%
              dplyr::mutate(loc = ifelse(loc == "t_1", "flue", loc),
                            loc = ifelse(loc == "t_3", "front", loc),
                            loc = ifelse(loc == "t_4", "back", loc))

  temp_10c <- dplyr::filter(temp_merged, id == "10C") %>%
              dplyr::mutate(loc = ifelse(loc == "t_1", "front", loc),
                            loc = ifelse(loc == "t_2", "back", loc),
                            loc = ifelse(loc == "t_4", "flue", loc))
  
  temp_11a <- dplyr::filter(temp_merged, id == "11A") %>%
              dplyr::mutate(loc = ifelse(loc == "t_1", "front", loc),
                            loc = ifelse(loc == "t_2", "back", loc),
                            loc = ifelse(loc == "t_4", "flue", loc))

  temp_11b <- dplyr::filter(temp_merged, id == "11B") %>%
              dplyr::mutate(loc = ifelse(loc == "t_1", "front", loc),
                            loc = ifelse(loc == "t_2", "back", loc),
                            loc = ifelse(loc == "t_4", "flue", loc))

  temp_11c <- dplyr::filter(temp_merged, id == "11C") %>%
              dplyr::mutate(loc = ifelse(loc == "t_1", "front", loc),
                            loc = ifelse(loc == "t_2", "back", loc),
                            loc = ifelse(loc == "t_4", "flue", loc))

  temp_12a <- dplyr::filter(temp_merged, id == "12A") %>%
              dplyr::mutate(loc = ifelse(loc == "t_1", "front", loc),
                            loc = ifelse(loc == "t_2", "back", loc),
                            loc = ifelse(loc == "t_4", "flue", loc))

  temp_12b <- dplyr::filter(temp_merged, id == "12B") %>%
              dplyr::mutate(loc = ifelse(loc == "t_1", "flue", loc),
                            loc = ifelse(loc == "t_3", "back", loc),
                            loc = ifelse(loc == "t_4", "front", loc))

  temp_12c <- dplyr::filter(temp_merged, id == "12C") %>%
              dplyr::mutate(loc = ifelse(loc == "t_1", "front", loc),
                            loc = ifelse(loc == "t_2", "back", loc),
                            loc = ifelse(loc == "t_4", "flue", loc))
```

## merge all temp data

```{r}
  temp_merged <- dplyr::bind_rows(regular,
                                  flipped_25a,
                                  flipped_25bc,
                                  temp_10a, temp_10b, temp_10c,
                                  temp_11a, temp_11b, temp_11c,
                                  temp_12a, temp_12b, temp_12c) %>%
                 dplyr::filter(grepl("^t_", loc) != TRUE)
```

## fix daylight savings issues

```{r}
  summer_time <- as.POSIXct("2016/03/13 02:00:00", tz = "MST") 
  temp_merged <- dplyr::mutate(temp_merged,
                               datetime = if_else(datetime > summer_time, (datetime + 60 * 60), datetime),
                               datetime = as.POSIXct(datetime, origin = "1970-01-01"),
                               time = if_else(datetime > summer_time, (time + 60 * 60), time))
```

## flags

extract notes

```{r}
  notes <- dplyr::filter(notes, grepl("temp|all", inst) == TRUE)
```

apply flags: bad preceeds maybe preceeds good

```{r}
  flags <- dplyr::select(notes, id, qc) %>%
           dplyr::group_by(id) %>%
           dplyr::arrange(qc) %>%
           dplyr::summarise(qc = first(qc))
```

merge flags with data

```{r}
  temp_merged <- 
    temp_merged %>%
    dplyr::mutate(qc = "ok")
```

notes: manual flag assignment

# missing and bad data

## table: missing data

```{r, echo = FALSE}
  dplyr::select(samples, id, stove, fuel) %>%
    dplyr::anti_join(temp_merged %>%
                     dplyr::select(id) %>%
                     dplyr::distinct(),
                   by = "id") %>%
    dplyr::filter(!grepl("G", id)) %>%
    dplyr::filter(!grepl("^27|^28|^29|^30", id)) %>%
    knitr::kable("markdown", align = 'c')
```

notes: 

* test data was lost for: 13A, 2A, and 6A (the three tests conducted on 1/5/2016), 18B, 21A (conducted on 2/10/2016), 22A (conducted on 1/13/2016), and 3A, and 7A (conducted on 2/26/2016)

## table: tests with bad measurements

```{r, echo=FALSE}
  notes %>%
    dplyr::filter(grepl("temp|all", inst) == TRUE,
                  qc != "ok") %>%
    dplyr::select(-inst) %>%
    dplyr::filter(!grepl("^27|^28|^29|^30", id)) %>%
    knitr::kable("markdown", align = 'c')
```

notes: none affect temperature

## remove bad tests

```{r}
  temp_merged <-
    temp_merged %>% 
    dplyr::filter(qc != "bad")
```

## mark unrealistic temperature spikes and negative data as NA

```{r}
  temp_merged <-
    temp_merged %>%
    dplyr::filter(t_oc > 0,
                  !(loc != "flue" & t_oc > 100)) 
```

## table: fraction of sample missing

get timestamps

```{r}
  sample_times <- 
    times %>%
    dplyr::filter(grepl("^sample$|shutdown|refuel_1", var)) %>%
    dplyr::mutate(var = as.character(var),
                  var = ifelse(var == "refuel_1", "sample", var)) %>%
    tidyr::spread("var", "value") %>%
    dplyr::select(-date) %>%
    dplyr::rename("start" = "sample",
                  "end" = "shutdown")
```

missing flue data

```{r, echo=FALSE}
  temp_merged %>%
    dplyr::filter(loc == "flue") %>%
    dplyr::select(id, time) %>%
    dplyr::group_by(id) %>%
    dplyr::summarise(start = min(time),
                     end = max(time)) %>%
    dplyr::left_join(sample_times %>%
                     dplyr::mutate(dur = end - start) %>%
                     dplyr::select(id, dur), by = "id") %>%
    dplyr::mutate(prct_missing = (100 - ((end - start) / dur) * 100)) %>%
    dplyr::filter(prct_missing >= 20) %>%
    dplyr::select(id, prct_missing) %>%
    knitr::kable("markdown", align = 'c', digits = 2)
```

missing pot data

```{r, echo=FALSE}
  temp_merged %>%
    dplyr::filter(loc == "front") %>%
    dplyr::select(id, time) %>%
    dplyr::group_by(id) %>%
    dplyr::summarise(start = min(time),
                     end = max(time)) %>%
    dplyr::left_join(sample_times %>%
                     dplyr::mutate(dur = end - start) %>%
                     dplyr::select(id, dur), by = "id") %>%
    dplyr::mutate(prct_missing = (100 - ((end - start) / dur) * 100)) %>%
    dplyr::filter(prct_missing >= 20) %>%
    dplyr::select(id, prct_missing) %>%
    knitr::kable("markdown", align = 'c', digits = 2)
```

notes: remove 10A, 75% of test is missing

```{r}
  temp_merged <-
    temp_merged %>%
    dplyr::filter(id != "10A")
```

## plot: temperature flue data

```{r, echo=FALSE, fig.height=25, fig.width=12}
  temp_merged %>%
  dplyr::left_join(samples) %>%
  dplyr::filter(loc == "flue") %>%
  ggplot(aes(datetime, t_oc, color = qc)) +
    geom_point(size = 0.5) +
    scale_color_manual(values = qc_colors) +
    facet_wrap(id~stove, ncol = 6, scales = "free") +
    theme_bw() +
    theme(legend.position = "top") +
    ylab("temperature (degress celsius)") +
    xlab("")
```

## plot: temperature pot data

```{r, echo=FALSE, fig.height=25, fig.width=12}
  temp_merged %>%
  dplyr::left_join(samples) %>%
  dplyr::filter(loc != "flue") %>%
  ggplot(aes(datetime, t_oc, color = qc)) +
    geom_point(size = 0.5) +
    scale_color_manual(values = qc_colors) +
    facet_wrap(id~stove, ncol = 6, scales = "free") +
    theme_bw() +
    theme(legend.position = "top") +
    ylab("temperature (degress celsius)") +
    xlab("")
```

# save

```{r}
  saveRDS(temp_merged, file = "../../r_data/temp_merged.RDS")
```

# table: missing data at end

missing flue temperature data

```{r, echo = FALSE}
  dplyr::select(samples, id, stove, fuel) %>%
  dplyr::anti_join(temp_merged %>%
                     dplyr::filter(loc == "flue") %>%
                     dplyr::distinct(),
                   by = "id") %>%
  dplyr::filter(!grepl("^G", id)) %>%
  dplyr::filter(!grepl("^27|^28|^29|^30", id)) %>%
  knitr::kable("markdown", align = 'c')
```

missing pot temperature data

```{r, echo = FALSE}
  dplyr::select(samples, id, stove, fuel) %>%
  dplyr::anti_join(temp_merged %>%
                     dplyr::filter(loc == "front") %>%
                     dplyr::distinct(),
                   by = "id") %>%
  dplyr::filter(!grepl("^G", id)) %>%
  dplyr::filter(!grepl("^27|^28|^29|^30", id)) %>%
  knitr::kable("markdown", align = 'c')
```