---
title: "Process voc data"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r load_libraries, echo=FALSE, message=FALSE}
  if (!require("pacman")) install.packages("pacman")
  pacman::p_load(tidyverse, kableExtra)
```

```{r global_options, echo=FALSE}
  knitr::opts_chunk$set(fig.path ='figures/', 
                        fig.width = 12, fig.height = 5,
                        warning = FALSE, message = FALSE, cache = FALSE)
```

# tidy data

## load files

load scripts

```{r}
  source("../../scripts/tidy.R")
  source("../../scripts/functions.R")
```

load data

```{r}
  fivegas_conc <- readRDS("../../r_data/fivegas_conc.RDS") 
  fivegas_volts <- readRDS("../../r_data/fivegas_volts.RDS")
  fivegas_calibration <- readRDS("../../r_data/fivegas_calibration.RDS")
  cal_1 <- readRDS("../../r_data/cal_1.RDS")
  notes <- readRDS("../../r_data/notes.RDS")
  samples <- readRDS("../../r_data/samples.RDS")
  pol_properties <- readRDS("../../r_data/pol_properties.RDS")
```

## reformat data

convert concentration data to longer format

```{r}
  fivegas_conc <- 
    fivegas_conc %>%
    dplyr::select(-datetime_secs, -time_str) %>%
    tidyr::gather("pol", "val", ch4:co)
```

convert voltage data to longer format

```{r}
  fivegas_volts <- 
    fivegas_volts %>%
    tidyr::gather("pol", "volts", co2:ch4)
```

convert voltage calibration data to longer format

```{r}
  fivegas_calibration <- 
    fivegas_calibration %>%
    tidyr::gather("pol", "volts", co2:ch4)
```

calibration standard mixing ratios

```{r}
  fivegas_cal_conc <- tidy_date(cal_1, "^conc_", "conc_")
```

calibration timestamps

```{r}
  fivegas_cal_times <- tidy_date(cal_1, "^time_", "time_")

  fivegas_cal_times <- split_fivegas_cal_times(fivegas_cal_times)
```

## calculate concentration from voltage data

calculate mean voltage over last 30 seconds of each calibration window

```{r}
  fivegas_cal <- 
    fivegas_cal_times %>%
    tidyr::spread(type, value) %>%
    dplyr::filter(!is.na(start) & pol != "zero")  %>%
    dplyr::rowwise() %>%
    dplyr::mutate(v_mean = 
                    time_window_stats(fivegas_calibration, date, start, end,
                                      pol_var = pol, val_var = "volts",  stat_var = "mean")) %>%
    dplyr::mutate(v_sd =
                    time_window_stats(fivegas_calibration, date, start, end, 
                                      pol_var = pol, val_var = "volts", stat_var = "sd"))
```

extract zero time periods

```{r}
  fivegas_cal_zero <- 
    fivegas_cal_times %>%
    tidyr::spread(type, value) %>%
    dplyr::filter(!is.na(start) & pol == "zero") %>%
    dplyr::select(-pol) %>%
    dplyr::rename(start_zero = start, end_zero = end)
```

join zero time periods with the calibration data 

```{r}
  fivegas_cal <- 
    fivegas_cal %>%
    dplyr::left_join(fivegas_cal_zero, by = "date")
```

calculate mean voltage during last 30 seconds of each zero calibration

```{r}
  fivegas_cal <- 
    fivegas_cal %>%
    dplyr::mutate(v_zero_mean =
                    time_window_stats(fivegas_calibration,
                                      date, start_zero, end_zero,
                                      pol_var = pol, val_var = "volts", stat_var = "mean")) %>%
    dplyr::mutate(v_zero_sd =
                    time_window_stats(fivegas_calibration,
                                      date, start_zero, end_zero,
                                       pol_var = pol, val_var = "volts", stat_var = "sd"))
```

merge measured voltage with standard mixing ratio

```{r}
  fivegas_cal_conc <-
    fivegas_cal_conc %>%
    dplyr::rename(pol = var, standard = value)

  fivegas_cal <- 
    fivegas_cal %>%
    dplyr::left_join(fivegas_cal_conc, by = c("date", "pol"))
```

calibration coefficients

```{r}
  fivegas_cal <- 
    fivegas_cal %>%
    dplyr::mutate(cal_beta = (standard / (v_mean - v_zero_mean))) %>%
    dplyr::mutate(cal_int = - (v_zero_mean * cal_beta))
```

add calibration date

```{r}
  fivegas_volts <- add_caldate(fivegas_volts, fivegas_cal)

  fivegas_volts <- dplyr::mutate(fivegas_volts, pol = as.factor(pol))
```

## plot: zero and span voltage

```{r, echo=FALSE, fig.width=12, fig.height=6}
 p_df <- tidyr::gather(fivegas_cal,
                       "type", "volts",
                       v_mean, v_zero_mean) %>%
         dplyr::mutate(sd = ifelse(type == "v_mean", v_sd, v_zero_sd)) %>%
         dplyr::select(-v_sd, -v_zero_sd)

 # standard response voltage error bars
  v_limits <- aes(ymax = volts + sd, ymin = volts - sd)  # error bars

 # plot
  ggplot(p_df, aes(x = date, y = volts, group = type, colour = type)) +
    geom_point() +
    geom_errorbar(v_limits, width = 0.2) +
    facet_wrap(~pol, 1, scales = "free") +
    theme_bw() +
    xlab("") +
    ylab("span") +
    theme(legend.position="top")

```

notes: data look reasonable - proceed

## apply calibration

merge voltage data and calibration data, then apply calibration

```{r}
  fivegas_volts <- 
    fivegas_volts %>%
    dplyr::left_join(dplyr::select(fivegas_cal, date, pol, cal_beta, cal_int),
                     by = c("cal_date" = "date", "pol" = "pol")) %>%
  dplyr::mutate(val = volts * cal_beta + cal_int) %>%
  dplyr::mutate(pol = as.factor(pol))
```

## combine file types

choose only important variables

```{r}
  fivegas_volts <- 
    fivegas_volts %>%
    dplyr::select(datetime, date, time, id, pol, ppm)
```

merge voltage and mixing ratio data

```{r}
  fivegas_merged <- 
    dplyr::arrange(dplyr::bind_rows(fivegas_volts, fivegas_conc), datetime)
```

remove oxygen and nox rows (channels not used during study)

```{r}
  fivegas_merged <- 
    fivegas_merged %>%
    dplyr::filter(pol != "o2" & pol != "nox")
```

## extract sample time

get timestamps

```{r}
  times <- 
    times %>%
    dplyr::filter(type == "sample") %>%
    tidyr::spread(time_point, value) %>%
    dplyr::select(-date)
```


filter times

```{r}
  smps <- 
    filter_times(times, smps)
```

## flags

extract flags

```{r}
  notes <- 
    notes %>%
    dplyr::filter(grepl("fivegas|all", inst) == TRUE)
```

bad preceeds maybe preceeds good

```{r}
  flags <-
    notes %>%
    dplyr::select(id, qc) %>%
    dplyr::group_by(id) %>%
    dplyr::arrange(qc) %>%
    dplyr::summarise(qc = first(qc))
```

add flag by id

```{r}
  fivegas_merged <-
    fivegas_merged %>%
    dplyr::left_join(flags, by = "id") %>%
    dplyr::mutate(id = as.factor(id)) %>%
    dplyr::mutate(qc = as.factor(ifelse(is.na(qc), "ok", as.character(qc))))
```

# missing and bad data

## table: missing data

```{r, echo = FALSE}
  dplyr::select(samples, id, stove, fuel) %>%
  dplyr::anti_join(fivegas_merged %>%
                   dplyr::select(id) %>%
                   dplyr::distinct(),
                   by = "id") %>%
  dplyr::filter(stove != "background") %>%
  knitr::kable("markdown", align = 'c')
```

notes: data is expected to be missing for: 2A, 4A, and 1B - proceed

## table: bad data

```{r, echo=FALSE}
  notes %>%
    dplyr::filter(grepl("fivegas|all", inst) == TRUE,
                  qc != "ok") %>%
    dplyr::select(-inst) %>%
    knitr::kable("markdown", align = 'c')
```

## remove bad tests

```{r}
  fivegas_merged <-
    fivegas_merged %>% 
    dplyr::filter(qc != "bad")
```

## table: fraction of scans missing

```{r, echo=FALSE}
  fivegas_merged %>%
    dplyr::select(id, time) %>%
    dplyr::group_by(id) %>%
    dplyr::summarise(start = min(time),
                     end = max(time)) %>%
    dplyr::left_join(times %>%
                     dplyr::mutate(dur = end - start) %>%
                     dplyr::select(id, dur), by = "id") %>%
    dplyr::mutate(prct_missing = (100 - ((end - start) / dur) * 100)) %>%
    dplyr::filter(prct_missing >= 75) %>%
    dplyr::select(id, prct_missing) %>%
    knitr::kable("markdown", align = 'c', digits = 2)
    
```

notes: 11A is missing approx. 88% of test - remove

```{r}
  smps_merged <-
    smps_merged %>%
    dplyr::filter(id != "11A")
```
