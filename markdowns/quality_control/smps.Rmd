---
title: "Process smps data"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---


```{r load_libraries, echo=FALSE, message=FALSE}
  if (!require("pacman")) install.packages("pacman")
  pacman::p_load(tidyverse, kableExtra)
```

```{r global_options, echo=FALSE}
  knitr::opts_chunk$set(fig.path ='figures/', 
                        warning = FALSE, message = FALSE, cache = FALSE)
```

# tidy data

## load files

load scripts

```{r}
  source("../../scripts/tidy.R")
  source("../../scripts/functions.R")
```

load data

```{r}
  smps <- readRDS("../../r_data/smps.RDS")
  samples <- readRDS("../../r_data/samples.RDS")
  cal_2 <- readRDS("../../r_data/cal_2.RDS")
  notes <- readRDS("../../r_data/notes.RDS")
  times <- readRDS("../../r_data/smps_pax_times.RDS")
```

load schemes

```{r}
  qc_colors <- readRDS("../../r_data/qc_colors.RDS")
  lod_shapes <- readRDS("../../r_data/lod_shapes.RDS")
```

## test type

```{r}
  smps <- 
    smps %>%
    dplyr::mutate(type = ifelse(grepl("^[0-9]", id), "test", NA),
                  type = ifelse(grepl("^G", id), "bg", type))
```

## fix id

```{r}
  smps <-
    smps %>%
    dplyr::mutate(id = as.character(id),
                  id = ifelse(grepl("^29B", id), "29B", id))
```

## flags

extract flags

```{r}
  notes <- 
    notes %>%
    dplyr::filter(grepl("smps|all", inst) == TRUE)
```

bad preceeds maybe preceeds good

```{r}
  flags <-
    notes %>%
    dplyr::select(id, qc) %>%
    dplyr::group_by(id) %>%
    dplyr::arrange(qc) %>%
    dplyr::summarise(qc = first(qc))
```

add flag by id

```{r}
  smps_merged <-
    smps %>%
    dplyr::left_join(flags, by = "id") %>%
    dplyr::mutate(id = as.factor(id)) %>%
    dplyr::mutate(qc = as.factor(ifelse(is.na(qc), "ok", as.character(qc))))
```

## flows

extract and average flows

```{r}
  smps_flows <-
    tidy_date(cal_2, "^preflow_smps|^postflow_smps", "")

  smps_flows <-
    split_flows(smps_flows)
  
  smps_flows <-
    smps_flows %>%
    dplyr::group_by(date, type) %>%
    dplyr::summarise(val = mean(value, na.rm = TRUE))
```

## plot: smps flow rates

```{r smps_flows}
  smps_flows %>%
  ggplot(aes(x = date, y = val, colour = type)) +
    geom_point(size = 2) +
    theme_bw() +
    theme(text = element_text(size = 12),
          legend.position = "top") +
    ylab("flow (liters per minute)")
```

notes: look reasonable - proceed

# missing and bad data

## table: missing data

```{r, echo = FALSE}
  dplyr::select(samples, id, stove, fuel) %>%
  dplyr::anti_join(smps %>%
                   dplyr::select(id) %>%
                   dplyr::distinct(),
                   by = "id") %>%
  knitr::kable("markdown", align = 'c')
```

notes: data is expected to be missing for 13A, 23A, G1, G3, 17A, 20A, G4 18A, 19A, 28A, 29B

## table: bad data

```{r, echo=FALSE}
  notes %>%
    dplyr::filter(grepl("smps|all", inst) == TRUE,
                  qc != "ok") %>%
    dplyr::select(-inst) %>%
    knitr::kable("markdown", align = 'c')
```

## remove bad tests

```{r}
  smps_merged <-
    smps_merged %>% 
    dplyr::filter(qc != "bad")
```

# calculate concentration

select sub-100nm data

```{r}
  smps_ultrafine <- 
    smps_merged %>%
    dplyr::select(id, value, size, time, sample, qc) %>%
    dplyr::filter(size <= 100)
```

get timestamps

```{r}
  times <- 
    times %>%
    dplyr::filter(type == "sample") %>%
    tidyr::spread(time_point, value) %>%
    dplyr::select(-date)
```

filter by test time window

```{r}
  smps_ultrafine <- 
    filter_times(times, smps_ultrafine)
```

## table: fraction of scans missing

```{r}
  smps_ultrafine %>%
    dplyr::select(id, time) %>%
    dplyr::group_by(id) %>%
    dplyr::summarise(start = min(time),
                     end = max(time)) %>%
    dplyr::left_join(times %>%
                     dplyr::mutate(dur = end - start) %>%
                     dplyr::select(id, dur), by = "id") %>%
    dplyr::mutate(prct_missing = (100 - ((end - start) / dur) * 100)) %>%
    dplyr::filter(prct_missing >= 75) %>%
    dplyr::select(id, prct_missing) %>%
    knitr::kable("markdown", align = 'c', digits = 2)
    
```

notes: 11A is missing approx. 88% of test - remove

```{r}
  smps_ultrafine <-
    smps_ultrafine %>%
    dplyr::filter(id != "11A")
```

## table: fraction of scans missing

```{r}
  smps_ultrafine <- 
    smps_ultrafine %>%
    dplyr::group_by(id, sample) %>%
    dplyr::summarise(val = sum(value) * 0.015625355,
                     qc = first(qc))
```

# backgrounds