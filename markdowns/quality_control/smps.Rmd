---
title: "Process smps data"
output:
  html_document:
    toc: true
    toc_float: true
---


```{r load_libraries, echo=FALSE, message=FALSE}
  if (!require("pacman")) install.packages("pacman")
  pacman::p_load(tidyverse, kableExtra)
```

```{r global_options, echo=FALSE}
  knitr::opts_chunk$set(fig.path ='figures/', 
                        warning = FALSE, message = FALSE, cache = FALSE)
```

# tidy data

## load files

load scripts

```{r}
  source("../../scripts/tidy.R")
  source("../../scripts/functions.R")
```

load data

```{r}
  smps <- readRDS("../../r_data/smps.RDS")
  samples <- readRDS("../../r_data/samples.RDS")
  cal_2 <- readRDS("../../r_data/cal_2.RDS")
  notes <- readRDS("../../r_data/notes.RDS")
  smps_times <- readRDS("../../r_data/smps_pax_times.RDS")
  test_times <- readRDS("../../r_data/test_times.RDS")
  smps_constant <-readRDS("../../r_data/smps_constant.RdS")
```

load schemes

```{r}
  qc_colors <- readRDS("../../r_data/qc_colors.RDS")
  lod_shapes <- readRDS("../../r_data/lod_shapes.RDS")
```

## test type

```{r}
  smps <- 
    smps %>%
    dplyr::mutate(test_type = ifelse(grepl("^[0-9]", id), "test", NA),
                  test_type = ifelse(grepl("^G", id), "bg", test_type)) 
```

## fix id

```{r}
  smps <-
    smps %>%
    dplyr::mutate(id = as.character(id),
                  id = ifelse(grepl("^29B", id), "29B", id)) %>%
    dplyr::filter(!grepl("^27|^28|^29|^30", id))
```

## reformat

rename columns

```{r}
  smps <-
    smps %>%
    dplyr::rename("temp" = "sample_temp_c",
                  "pressure" = "sample_pressure_kpa",
                  "humidity" = "relative_humidity",
                  "scan" = "sample",
                  "errors" = "instrument_errors",
                  "val" = "value",
                  "aerosol_flow" = "aerosol_flow_l_min",
                  "bypass_flow" = "bypass_flow_l_min",
                  "inlet_flow" = "detector_inlet_flow_(l/min)",
                  "detector_flow" = "detector_sample_flow_(l/min)",
                  "scan_time" = "scan_time_s",
                  "retrace_time" = "retrace_time_s",
                  "channel_decade" = "channels/decade")
```

remove extra columns

```{r}
  smps <-
    smps %>%
    dplyr::select(id, scan,  time, size, val, size, time, temp, pressure, humidity, errors, test_type,
                  aerosol_flow, bypass_flow, inlet_flow, detector_flow, scan_time, retrace_time, channel_decade,
                  multiple_charge_correction, diffusion_correction)
```

## extract sample time

get time stamps for smps

```{r}
  smps_times <- 
    smps_times %>%
    dplyr::filter(type == "sample") %>%
    tidyr::spread(time_point, value) %>%
    dplyr::select(-date, -type) %>%
    dplyr::filter(!is.na(end), !is.na(start))
```

get time stamps for smps burns

```{r}
  sample_times <- 
    test_times %>%
    dplyr::filter(grepl("^sample$|shutdown|refuel_1", var)) %>%
    dplyr::mutate(var = as.character(var),
                  var = ifelse(var == "refuel_1", "sample", var)) %>%
    tidyr::spread("var", "value") %>%
    dplyr::select(-date) %>%
    dplyr::rename("start" = "sample",
                  "end" = "shutdown")
```

join both time stamp sets priority to smps time stamps

```{r}
  sample_times <-
    sample_times %>%
    dplyr::anti_join(smps_times, by = "id")
  
  smps_times <-
    smps_times %>%
    dplyr::bind_rows(sample_times)
```

filter times

```{r}
  smps <- 
    filter_times(smps_times, smps)
```

## flags

extract flags

```{r}
  notes <- 
    notes %>%
    dplyr::filter(grepl("smps|all", inst) == TRUE)
```

bad preceeds maybe preceeds good

```{r}
  flags <-
    notes %>%
    dplyr::select(id, qc) %>%
    dplyr::group_by(id) %>%
    dplyr::arrange(qc) %>%
    dplyr::summarise(qc = first(qc))
```

add flag by id

```{r}
  smps_merged <-
    smps %>%
    dplyr::left_join(flags, by = "id") %>%
    dplyr::mutate(id = as.factor(id)) %>%
    dplyr::mutate(qc = as.factor(ifelse(is.na(qc), "ok", as.character(qc))))
```

# quality control

## flows

extract and average flows

```{r}
  smps_flows <-
    tidy_date(cal_2, "^preflow_smps|^postflow_smps", "")

  smps_flows <-
    split_flows(smps_flows)
  
  smps_flows <-
    smps_flows %>%
    dplyr::group_by(date, type) %>%
    dplyr::summarise(val = mean(value, na.rm = TRUE))
```

## plot: smps flow rates - measured

```{r smps_flows_measured}
  smps_flows %>%
  ggplot(aes(x = date, y = val, colour = type)) +
    geom_point(size = 2) +
    theme_bw() +
    theme(text = element_text(size = 12),
          legend.position = "top") +
    ylab("flow (liters per minute)")
```

notes: look reasonable - proceed

## plot: smps flow rates - instrument

```{r smps_flows}
  smps_merged %>%
    dplyr::left_join(dplyr::select(samples, id, date), by = 'id') %>%
    dplyr::select(date, aerosol_flow, bypass_flow, inlet_flow, detector_flow, qc) %>%
    tidyr::gather("var", "val", 2:5) %>%
    ggplot(aes(x = date, y = val, colour = qc)) +
      geom_point(size = 2, shape = 1) +
      theme_bw() +
      facet_wrap(~var, scales = "free") +
      theme(text = element_text(size = 12),
            legend.position = "top") +
      ylab("flow (liters per minute)")
```

notes: look reasonable - proceed

## plot: scan parameters

```{r smps_scan_parameters}
  smps_merged %>%
    dplyr::left_join(dplyr::select(samples, id, date), by = 'id') %>%
    dplyr::select(date, multiple_charge_correction, diffusion_correction, channel_decade, retrace_time, scan_time, qc) %>%
    tidyr::gather("var", "val", 2:6) %>%
    ggplot(aes(x = date, y = val, colour = qc)) +
      geom_point(size = 2, shape = 1) +
      theme_bw() +
      facet_wrap(~var, scales = "free") +
      theme(text = element_text(size = 12),
            legend.position = "top") +
      ylab("flow (liters per minute)")
```

notes: look reasonable, except some data points did not have diffusion correction

## table: diffusion correction

```{r}
  smps_merged %>%
    dplyr::left_join(dplyr::select(samples, id, date), by = 'id') %>%
    dplyr::select(date, id, diffusion_correction) %>%
    dplyr::filter(diffusion_correction == "FALSE") %>%
    dplyr::distinct()%>%
    knitr::kable(digits = 2, align = 'c')
```

notes: this setting corrects for diffusion of particles in the smps - big problem for particles less than 100 nm - remove these tests (note none of the scans during the above tests were diffusion corrected)

```{r}
 smps_merged <- 
  smps_merged %>%
  dplyr::mutate(qc = ifelse(grepl("TRUE", diffusion_correction), as.character(qc), "bad"))
```

## plot: temperature

```{r, echo=FALSE}
  smps_merged %>%
    dplyr::filter(!is.na(val)) %>%
    dplyr::left_join(dplyr::select(samples, id, date), by = 'id') %>%
    ggplot(aes_string(x = "date", y = "temp")) +
      geom_point(aes( color = qc), size = 2, shape = 1) +
      scale_color_manual(values = qc_colors) +
      theme_bw() +
      theme(text = element_text(size = 16),
            legend.position = "top") +
      labs(shape = "lod") +
      ylab("temperature (degrees Celsius)") +
      xlab("")
```

notes: all scans look within range (inst range: 10 - 35 C) - proceed

## plot: pressure

```{r, echo=FALSE}
  smps_merged %>%
    dplyr::filter(!is.na(val)) %>%
    dplyr::left_join(dplyr::select(samples, id, date), by = 'id') %>%
    ggplot(aes_string(x = "date", y = "pressure")) +
      geom_point(aes( color = qc), size = 2, shape = 1) +
      scale_color_manual(values = qc_colors) +
      theme_bw() +
      theme(text = element_text(size = 16),
            legend.position = "top") +
      labs(shape = "lod") +
      ylab("pressure (kilopascals)") +
      xlab("")
```

notes: all scans look within range  (inst range: 75 - 105 kPa) - proceed

## plot: humidity

```{r, echo=FALSE}
  smps_merged %>%
    dplyr::filter(!is.na(val)) %>%
    dplyr::left_join(dplyr::select(samples, id, date), by = 'id') %>%
    ggplot(aes_string(x = "date", y = "humidity")) +
      geom_point(aes( color = qc), size = 2, shape = 1) +
      scale_color_manual(values = qc_colors) +
      theme_bw() +
      theme(text = element_text(size = 16),
            legend.position = "top") +
      labs(shape = "lod") +
      ylab("relative humidity (%)") +
      xlab("")
```

notes: all scans look within range (inst range: 0 - 90%) - proceed

## look at scan errors

```{r, echo=FALSE}
  smps_merged %>%
    dplyr::select(id, scan, errors) %>%
    dplyr::distinct() %>%
  dplyr::mutate(bad_scan = ifelse(grepl("^Normal Scan$", errors), 0, 1),
                scan_count = 1) %>%
  dplyr::group_by(id) %>%
  dplyr::summarise(bad_scan = sum(bad_scan),
                   scan_count = sum(scan_count),
                   errors = first(errors)) %>%
  dplyr::mutate(prct_bad = (bad_scan / scan_count) * 100) %>%
  dplyr::filter(!grepl("^Normal Scan$", errors)) %>%
  knitr::kable(align = 'c', digits = 2)
```

notes:

* sheath flow error: (possible causes - reading not stablilizing, flowmeter not functioning, blower not functioning)
* sheath flow warning: sheath flow has been changed in last 30 seconds and is stabilizing
* Detector laser error:
* Detector growth tube temp error:

all errors only happened for one or two scans - remove 

```{r}
 smps_merged <- 
  smps_merged %>%
  dplyr::mutate(qc = ifelse(grepl("^Normal Scan$", errors), as.character(qc), "bad"))
```

# missing and bad data

## table: missing data

```{r, echo = FALSE}
  dplyr::select(samples, id, stove, fuel) %>%
  dplyr::anti_join(smps %>%
                   dplyr::select(id) %>%
                   dplyr::distinct(),
                   by = "id") %>%
  dplyr::filter(!grepl("^27|^28|^29|^30", id)) %>%
  knitr::kable("markdown", align = 'c')
```

notes: 

* data is expected to be missing for 13A, 23A, G1, G3, 17A, 20A, G4 18A, 19A - lost data
* data G17 & G18 have missing sample time data - ignore for now, not important

## table: bad data

```{r, echo=FALSE}
  notes %>%
    dplyr::filter(grepl("smps|all", inst) == TRUE,
                  qc != "ok") %>%
    dplyr::select(-inst) %>%
    dplyr::filter(!grepl("^27|^28|^29|^30", id)) %>%
    knitr::kable("markdown", align = 'c')
```

notes: 

* 2A: fire went out during test - check if outlier
* 2C: possible issues with dilution - check if outlier
* 6B: unclear note - check if outlier
* 6C: possibly lost data - check how much is missing and check if outlier - <20%
* 8A: real-time pumps turned off during test - check if outlier
* 21C: double check that time was fixed - check if outlier
* 22B: may have lost some data - check how much was missing - <20%
* 23A: fire relit with kerosene and match during refuel - check if outlier
* 24A: check how much data is missing - 29% leave for now
* G2: bleed flow closed completely, unclear comment - check if outlier

* 8C: clog in sample line - bad
* 1C: clog in real-time data - check if outlier - bad

## remove bad tests

```{r}
  smps_merged <-
    smps_merged %>% 
    dplyr::filter(qc != "bad")
```

## table: fraction of scans missing

```{r, echo=FALSE}
  smps_merged %>%
    dplyr::select(id, time) %>%
    dplyr::group_by(id) %>%
    dplyr::summarise(start = min(time),
                     end = max(time)) %>%
    dplyr::left_join(smps_times %>%
                     dplyr::mutate(dur = end - start) %>%
                     dplyr::select(id, dur), by = "id") %>%
    dplyr::mutate(prct_missing = (100 - ((end - start) / dur) * 100)) %>%
    dplyr::filter(prct_missing >= 20) %>%
    dplyr::select(id, prct_missing) %>%
    knitr::kable("markdown", align = 'c', digits = 2)
    
```

notes: 11A is missing approx. 88% of test - remove

```{r}
  smps_merged <-
    smps_merged %>%
    dplyr::filter(id != "11A")
```

# backgrounds

```{r}
  smps_merged <-
    smps_merged %>%
    dplyr::select(id, scan, size, val, qc, test_type)
```

```{r}
  bg <-
    smps_merged %>%
    dplyr::filter(test_type == "bg")
```

## plot: time series of lab backgrounds

```{r smps_bg_conc, echo=FALSE}
  bg %>%
    dplyr::left_join(dplyr::select(samples, id, date), by = 'id') %>%
    dplyr::group_by(id, scan) %>%
    dplyr::summarise(val = sum(val, na.rm = TRUE),
                     qc = first(qc),
                     date = first(date)) %>%
    ggplot(aes_string(x = "date", y = "val")) +
      geom_point(aes(color = qc), size = 2, shape = 1) +
      scale_color_manual(values = qc_colors) +
      theme_bw() +
      theme(text = element_text(size = 12),
            legend.position = "top") +
      ylab("dN (# per cubic centimeter)") +
      xlab("")
```

notes: scans with high number concentration - removed below

## table: lab background outliers

outliers (z > 3) 

```{r, echo=FALSE}
  bg %>%
    dplyr::left_join(dplyr::select(samples, id, date), by = 'id') %>%
    dplyr::group_by(id, scan) %>%
    dplyr::summarise(val = sum(val, na.rm = TRUE),
                     qc = first(qc),
                     date = first(date)) %>%
    dplyr::filter(!is.na(val)) %>%
    dplyr::mutate(z_score = (val- mean(val, na.rm = TRUE)) / sd(val, na.rm = TRUE)) %>%
    dplyr::ungroup() %>%
    dplyr::select(id, z_score) %>%
    dplyr::filter(z_score > 3) %>%
    knitr::kable("markdown", align = 'c', digits = 2)
```

notes: remove scan G6

```{r}
  bg <-
    bg %>%
    dplyr::filter(!grepl("^G6$", id))
```

## summarize backgrounds

```{r}
  bg <-
    bg %>%
    dplyr::group_by(size) %>%
    dplyr::summarise(mean = mean(val, na.rm = TRUE),
                     median = median(val, na.rm = TRUE),
                     stdev = sd(val, na.rm = TRUE),
                     min = min(val, na.rm = TRUE),
                     max = max(val, na.rm = TRUE),
                     count = n()) %>%
    dplyr::mutate(mean = ifelse(is.nan(mean), NA, mean),
                  median = ifelse(is.nan(median), NA, median),
                  stdev = ifelse(is.nan(stdev), NA, stdev),
                  min = ifelse(is.infinite(min), NA, min),
                  max = ifelse(is.infinite(max), NA, max),
                  count = ifelse(is.nan(count), NA, count))
```

## plot: background summary

* black - mean
* blue - median

```{r smps_bg_distribution, echo=FALSE}
  bg %>%
    ggplot(aes_string(x = "size", y = "mean")) +
      geom_line(color = "blue") +
      geom_line(aes_string(x = "size", y = "median")) +
      scale_color_manual(values = qc_colors) +
      theme_bw() +
      scale_x_log10() +
      theme(text = element_text(size = 12),
            legend.position = "top") +
      ylab("dN/dlogDp (# per cubic centimeter)") +
      xlab("")
```

## save backgrounds

```{r}
  saveRDS(bg, file = "../../r_data/smps_bg.RDS")
```

## plot: background and burn concentrations

summed over each scan

```{r smps_burn_bg_conc, echo=FALSE}
  smps_merged %>%
    dplyr::filter(!is.na(val)) %>%
    dplyr::left_join(dplyr::select(samples, id, date), by = 'id') %>%
    dplyr::group_by(id, scan, test_type) %>%
    dplyr::summarise(val = sum(val, na.rm = TRUE),
                     qc = first(qc)) %>%
    ggplot(aes_string(y = "val", x = "test_type")) +
      geom_boxplot(outlier.colour = NA) +
      geom_jitter(aes(color = qc), size = 2, shape = 1) +
      theme_bw() +
      scale_color_manual(values = qc_colors) +
      scale_y_log10() +
      theme(text = element_text(size = 12),
            legend.position = "top") +
      ylab("dN/dlogDp (# per cubic centimeter)") +
      xlab("")
```

notes: some burns have low concentrations - opt to subtract median background from all burn data

## subtract background

```{r}
  smps_merged <-
    smps_merged %>%
    dplyr::filter(test_type == "test")
```

```{r}
  smps_merged <-
    smps_merged %>%
    dplyr::left_join(bg, by = c("size")) %>%
    dplyr::mutate(median = ifelse(is.na(median), 0, median))
```

notes: a few size bins do not have background value - set these bins to zero based on median values of other bins in that size range 

```{r}
  smps_merged <-
   smps_merged %>%
    dplyr::mutate(val = val - median) %>%
    dplyr::select(-min, -max, -count, -mean, -median, -stdev)
```

## table: percentage of measurements below the background median

```{r, echo=FALSE}
  smps_merged %>%
    dplyr::group_by(size) %>%
    dplyr::do(val = round(nrow(filter(., val < 0))/nrow(.), 2) * 100) %>%
    dplyr::mutate(val = cell_spec(val, "html", color = ifelse(val > 10, "red", "blue"))) %>%
    knitr::kable("markdown", align = 'c', digits = 2)
```

notes: the negative concentration is small and mostly at large size bins that have low statistics - set these values to zero

## create a new below background variable

```{r}
  smps_merged <-
    smps_merged %>%
    dplyr::mutate(bg = ifelse(val < 0, "below", "above"),
                  val = ifelse(bg == "below", NA, val))
```

# burn analysis for size distribution data

## plot: size distribution by stove type

```{r size_distribution_stovetype, echo=FALSE, fig.height=10, fig.width=10}
  smps_merged_p <-
    smps_merged %>%
    dplyr::left_join(dplyr::select(samples, id, stove, fuel, stovecat, fuelcat), by = "id")

 smps_merged_p %>%
    ggplot(aes_string(x = "size", y = "val", group = c("scan"))) +
      geom_point(aes(color = qc), alpha = 0.5, size = 0.25) + 
      scale_color_manual(values = qc_colors) +
      theme_bw() +
      scale_x_log10() +
      theme(text = element_text(size = 16),
            legend.position = "top") +
      facet_wrap(~stove, scales = "free", nrow = 3) +
      ylab("dN/dlogDp (# per meter cubed)") +
      xlab("")
```

notes: 

## plot: concentrations by fuel type

```{r size_distribution_fueltype, echo=FALSE, fig.height=10, fig.width=10}
  smps_merged_p %>%
    ggplot(aes_string(x = "size", y = "val", group = c("scan"))) +
      geom_point(aes(color = qc), alpha = 0.5, size = 0.25) + 
      scale_color_manual(values = qc_colors) +
      theme_bw() +
      scale_x_log10() +
      theme(text = element_text(size = 16),
            legend.position = "top") +
      facet_wrap(~fuel, scales = "free", nrow = 3) +
      ylab("dN/dlogDp (# per meter cubed)") +
      xlab("")
```

notes: 

## save data

```{r}
  smps_merged <-
    smps_merged %>%
    dplyr::mutate(pol = "size distribution") %>%
    dplyr::select(id, scan, pol, size, val, qc, bg) %>%
    dplyr::mutate(pol_category = "smps")

  saveRDS(smps, file = "../../r_data/smps_merged.RDS")
```

## table: missing data at end

```{r, echo = FALSE}
  dplyr::select(samples, id, stove, fuel) %>%
  dplyr::anti_join(smps_merged %>%
                     dplyr::distinct(),
                   by = "id") %>%
  dplyr::filter(!grepl("^G", id)) %>%
  dplyr::filter(!grepl("^27|^28|^29|^30", id)) %>%
  knitr::kable("markdown", align = 'c')
```

# burn analysis for ultrafines

remove test with more that 40% of data missing for below background

```{r}
  bb_tests <-
  smps_merged %>%
    dplyr::group_by(id) %>%
    dplyr::do(bb = round(nrow(filter(., bg == "below"))/nrow(.), 2) * 100) %>%
    dplyr::mutate(bg = ifelse(bb > 40, "below", "above")) %>%
    dplyr::select(-bb)
```

notes: background is below if more than 40% of data in the calculation is below background - should be none

```{r}
  ultrafines <-
    smps_merged %>%
    dplyr::filter(size <= 100) %>%
    dplyr::group_by(id) %>%
    dplyr::summarise(val = sum(val, na.rm = TRUE) * smps_constant,
                     qc = first(qc)) %>%
    dplyr::left_join(bb_tests, by = c("id")) %>%
    dplyr::mutate(val = ifelse(bg == "below", NA, val))
```

## plot: time series of burns

```{r ultrafines_burn_timeseries, echo=FALSE}
  ultrafines %>%
    dplyr::filter(!is.na(val)) %>%
    dplyr::left_join(dplyr::select(samples, id, date), by = 'id') %>%
    ggplot(aes_string(x = "date", y = "val")) +
      geom_point(aes(color = qc), size = 2) +
      scale_color_manual(values = qc_colors) +
      theme_bw() +
      theme(text = element_text(size = 16),
            legend.position = "top") +
      ylab("concentration number per meter cubed)") +
      xlab("")
```

notes: seems reasonable

## plot: concentrations by stove type

```{r ultrafines_stovetype, echo=FALSE, fig.width=10}
  ultrafines_p <-
    ultrafines %>%
    dplyr::left_join(dplyr::select(samples, id, stove, fuel, stovecat, fuelcat), by = "id")

 ultrafines_p %>%
    ggplot(aes_string(x = "stove", y = "val")) +
      geom_boxplot(outlier.colour = NA) +
      geom_jitter(aes(color = qc), size = 2) + 
      scale_color_manual(values = qc_colors) +
      theme_bw() +
      scale_y_log10() +
      theme(text = element_text(size = 16),
            axis.text.x = element_text(angle = 15, hjust = 1, vjust = 1),
            legend.position = "top") +
      facet_grid(~fuelcat, scales = "free", space = "free_x") +
      ylab("concentration (microgram per meter cubed)") +
      xlab("")
```

notes: 

## table: outliers by stove type

outliers (z > 3) when samples are grouped by pollutant and stove type

```{r, echo=FALSE}
  ultrafines_p %>%
    dplyr::filter(!is.na(val)) %>%
    dplyr::group_by(stove) %>%
    dplyr::mutate(z_score = (val - mean(val, na.rm = TRUE)) / sd(val, na.rm = TRUE)) %>%
    dplyr::ungroup() %>%
    dplyr::select(id, stove, fuel, z_score) %>%
    dplyr::filter(z_score > 3) %>%
    knitr::kable("markdown", align = 'c')
```

notes:

## plot: concentrations by fuel type

```{r ultrafines_fueltype, echo=FALSE, fig.width=10}
  ultrafines_p %>%
    ggplot(aes_string(x = "fuel", y = "val")) +
      geom_boxplot(outlier.colour = NA) +
      geom_jitter(aes(color = qc), size = 2) + 
      theme_bw() +
      scale_y_log10() +
      scale_color_manual(values = qc_colors) +
      theme(text = element_text(size = 16),
            axis.text.x = element_text(angle = 15, hjust = 1, vjust = 1),
            legend.position = "top") +
      facet_grid(~fuelcat, scales = "free", space = "free_x") +
      ylab("concentration (microgram per meter cubed)") +
      xlab("")
```

notes: 

## table: outliers by fuel type

outliers (z > 3) when samples are grouped by pollutant and fuel type

```{r, echo=FALSE}
  ultrafines_p %>%
    dplyr::filter(!is.na(val)) %>%
    dplyr::group_by(fuel) %>%
    dplyr::mutate(z_score = (val - mean(val, na.rm = TRUE)) / sd(val, na.rm = TRUE)) %>%
    dplyr::ungroup() %>%
    dplyr::select(id, stove, fuel, z_score) %>%
    dplyr::filter(z_score > 3) %>%
    knitr::kable("markdown", align = 'c')
```

notes: 

## save data

```{r}
  ultrafines <-
    ultrafines %>%
    dplyr::mutate(pol = "ultrafines") %>%
    dplyr::select(id, pol, val, qc, bg) %>%
    dplyr::mutate(pol_category = "smps")

  saveRDS(ultrafines, file = "../../r_data/ultrafines_merged.RDS")
```

## table: missing data at end

```{r, echo = FALSE}
  dplyr::select(samples, id, stove, fuel) %>%
  dplyr::anti_join(smps_merged %>%
                     dplyr::distinct(),
                   by = "id") %>%
  dplyr::filter(!grepl("^G", id)) %>%
  dplyr::filter(!grepl("^27|^28|^29|^30", id)) %>%
  knitr::kable("markdown", align = 'c')
```

## table: percent of data below background

```{r, echo=FALSE}
  ultrafines %>%
    dplyr::group_by(pol) %>%
    dplyr::do(val = round(nrow(filter(., bg == "below"))/nrow(.), 2) * 100) %>%
    dplyr::mutate(val = cell_spec(val, "html", color = ifelse(val > 10, "red", "blue"))) %>%
    knitr::kable("markdown", align = 'c')
```