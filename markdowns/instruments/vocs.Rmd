---
title: "Process voc data"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r load_libraries, echo=FALSE, message=FALSE}
  if (!require("pacman")) install.packages("pacman")
  pacman::p_load(tidyverse, kableExtra)
```

```{r global_options, echo=FALSE}
  knitr::opts_chunk$set(fig.path ='figures/',
                        fig.height = 12, fig.width = 12,
                        warning = FALSE, message = FALSE, cache = FALSE)
```

# tidy data

## load files

load scripts

```{r}
  source("../../scripts/functions.R")
```

load data

```{r}
  vocs <- readRDS("../../r_data/voc.RDS")
  voc_lod <- readRDS("../../r_data/voc_lod.RDS")
  flow <- readRDS("../../r_data/voc_flow.RDS")
  notes <- readRDS("../../r_data/notes.RDS")
  samples <- readRDS("../../r_data/samples.RDS")
  pol_properties <- readRDS("../../r_data/pol_properties.RDS")
```

load schemes

```{r}
  qc_colors <- readRDS("../../r_data/qc_colors.RDS")
  lod_shapes <- readRDS("../../r_data/lod_shapes.RDS")
```

## extract times

```{r}
  times <- 
    vocs %>%
    dplyr::select(id, datetime_start, datetime_end, type) %>%
    dplyr::filter(type == "test" | type == "bg", id != "P8") %>%
    dplyr::select(-type)
```

fix transcription errors

```{r}
  # 21C
  times$datetime_start[36] <- "2016-04-06 11:33:30 GMT"
  times$datetime_end[36] <- "2016-04-06 13:12:00 GMT"

  # 8D
  times$datetime_start[72] <- "2016-06-15 9:43:00 GMT"
  times$datetime_end[72] <- "2016-06-15 10:51:00 GMT"

  # 6D
  times$datetime_start[77] <- "2016-06-15 14:15:30 GMT"
  times$datetime_end[77] <- "2016-06-15 15:33:10 GMT"
```

## extract vocs 

```{r}
  vocs <- 
    vocs %>%
    dplyr::select(id, type, 5:59) %>%
    dplyr::filter(type == "test" | type == "bg", id != "P8") %>%
    dplyr::rename("voc_n_nonane" = "voc_n_no_8888ne")
```

## reformat

convert to long format

```{r}
  vocs <- 
    vocs %>%
    tidyr::gather("pol", "val",
                  -id, -type) %>%
    dplyr::filter(!is.na(pol)) %>%
    dplyr::mutate(pol = as.factor(pol)) %>%
    dplyr::select(id, pol, val, type) %>%
    dplyr::mutate(pol = gsub("voc_", "", pol))
        
```

## lod

```{r}
  vocs <-
    vocs %>%
    dplyr::left_join(voc_lod, by = c("pol" = "voc")) %>%
    dplyr::rename("voc_lod" = "lod") %>%
    dplyr::mutate(lod = as.factor(ifelse(val == -8888, "below", "above"))) %>%
    dplyr::mutate(val = ifelse(val == -8888, voc_lod / sqrt(2), val)) %>%
    dplyr::select(-voc_lod)
```

## flags

extract flags

```{r}
  notes <- 
    notes %>%
    dplyr::filter(grepl("vocs|all", inst) == TRUE)
```

bad preceeds maybe preceeds good

```{r}
  flags <-
    notes %>%
    dplyr::select(id, qc) %>%
    dplyr::group_by(id) %>%
    dplyr::arrange(qc) %>%
    dplyr::summarise(qc = first(qc))
```

add flag by id

```{r}
  vocs <-
    vocs %>%
    dplyr::left_join(flags, by = "id") %>%
    dplyr::mutate(id = as.factor(id)) %>%
    dplyr::mutate(qc = as.factor(ifelse(is.na(qc), "ok", as.character(qc))))
```

## test type 

define test type variable

```{r}
  vocs <- 
    vocs %>%
    dplyr::rename("test_type" = "type")
```

# missing and bad data

## table: missing data

```{r, echo = FALSE}
  dplyr::select(samples, id, stove, fuel) %>%
    dplyr::anti_join(vocs %>%
                     dplyr::select(id) %>%
                     dplyr::distinct(),
                   by = "id") %>%
    knitr::kable("markdown", align = 'c')
```

## table: tests with bad measurements

```{r, echo=FALSE}
  notes %>%
    dplyr::filter(grepl("voc|all", inst) == TRUE,
                  qc != "ok") %>%
    dplyr::select(-inst) %>%
    knitr::kable("markdown", align = 'c')
```

## remove bad tests

```{r}
  vocs_merged <-
    vocs %>% 
    dplyr::filter(qc != "bad")
```

# concentration calculations

## extract data

extract time data

```{r}
  times <- 
    times %>%
    dplyr::mutate(dur = difftime(datetime_end, datetime_start)) %>%
    dplyr::select(id, dur)
```

## merge and calculate

merge data with flows and times

```{r}
  vocs_merged <-
    vocs_merged %>%
    dplyr::mutate(flow = flow) %>%
    dplyr::left_join(times, by = "id")
```

calculate concentrations

```{r}
  vocs_merged <-
    vocs_merged %>%
    dplyr::left_join(dplyr::select(pol_properties, pol, mw), by = "pol") %>%
    dplyr::mutate(val = convert_ppmv_ugpmc(val / 1000, mw, 25, 85),
                  units = "ug per meter cubed") %>%
    dplyr::select(-mw)
```

# backgrounds

extract background

```{r}
  bg <-
    vocs_merged %>%
    dplyr::filter(test_type == "bg")
```

## table: lab background outliers

outliers (z > 3) when backgrounds are grouped by pollutant and filter type

```{r, echo=FALSE}
  bg %>%
    dplyr::filter(!is.na(val)) %>%
    dplyr::group_by(pol) %>%
    dplyr::mutate(z_score = (val - mean(val, na.rm = TRUE)) / sd(val, na.rm = TRUE)) %>%
    dplyr::ungroup() %>%
    dplyr::select(id, pol, z_score) %>%
    dplyr::filter(z_score > 3) %>%
    dplyr::rename("voc type" = "pol") %>%
    knitr::kable("markdown", align = 'c', digits = 2)
```

conclusions: 

## plot: time series of lab backgrounds


```{r vocs_bg_timeseries, echo=FALSE}
 bg %>%
    dplyr::filter(!is.na(val)) %>%
    dplyr::left_join(dplyr::select(samples, id, date), by = 'id') %>%
    ggplot(aes_string(x = "date", y = "val")) +
      geom_point(aes(color = qc, shape = lod), size = 2) +
      scale_shape_manual(values = lod_shapes) +
      scale_color_manual(values = qc_colors) +
      theme_bw() +
      theme(text = element_text(size = 12),
            legend.position = "top") +
      facet_wrap(~pol, ncol = 6, scales = "free") +
      ylab("concentration (micrograms per meters cubed)") +
      xlab("")
```

conclusions: 

## table: percent of lab blanks below lod

```{r, echo=FALSE}
  bg %>%
    dplyr::group_by(pol) %>%
    dplyr::do(val = round(nrow(filter(., lod == "below"))/nrow(.), 2) * 100) %>%
    dplyr::mutate(val = cell_spec(val, "html", color = ifelse(val > 10, "red", "blue"))) %>%
    dplyr::rename("voc type" = "pol") %>%
    knitr::kable("markdown", align = 'c', digits = 2)
```

## table: percent of lab backgrounds with NA values

```{r, echo=FALSE}
  bg %>%
    dplyr::group_by(pol) %>%
    dplyr::do(val = round(nrow(filter(., is.na(val) == TRUE))/nrow(.), 2) * 100) %>%
    dplyr::mutate(val = cell_spec(val, "html", color = ifelse(val > 10, "red", "blue"))) %>%
    dplyr::rename("voc type" = "pol") %>%
    knitr::kable("markdown", align = 'c')
```

## table: background summary

summarize backgrounds

```{r}
  bg <-
    bg %>%
    dplyr::group_by(pol) %>%
    dplyr::summarise(mean = mean(val, na.rm = TRUE),
                     median = median(val, na.rm = TRUE),
                     stdev = sd(val, na.rm = TRUE),
                     min = min(val, na.rm = TRUE),
                     max = max(val, na.rm = TRUE),
                     count = n()) %>%
    dplyr::mutate(mean = ifelse(is.nan(mean), NA, mean),
                  median = ifelse(is.nan(median), NA, median),
                  stdev = ifelse(is.nan(stdev), NA, stdev),
                  min = ifelse(is.infinite(min), NA, min),
                  max = ifelse(is.infinite(max), NA, max),
                  count = ifelse(is.nan(count), NA, count))
```

summary of backgrounds (ug per meter cubed)

```{r, echo=FALSE}
  bg %>%
    knitr::kable(digits = 2, align = 'c')
```

## save backgrounds

```{r}
  saveRDS(bg, file = "../../r_data/vocs_bg.RDS")
```

# burn analysis

## plot: time series of burns

```{r vocs_samples_timeseries, echo=FALSE}
 vocs_merged %>%
    dplyr::filter(test_type == "test") %>%
    dplyr::filter(!is.na(val)) %>%
    dplyr::left_join(dplyr::select(samples, id, date), by = 'id') %>%
    ggplot(aes_string(x = "date", y = "val")) +
      geom_point(aes(color = qc, shape = lod), size = 2) +
      scale_shape_manual(values = lod_shapes) +
      scale_color_manual(values = qc_colors) +
      theme_bw() +
      theme(text = element_text(size = 12),
            legend.position = "top") +
      facet_wrap(~pol, ncol = 6, scales = "free") +
      ylab("concentration (micrograms per cubic meter)") +
      xlab("")
```

conclusions:

## plot: comparing background and sample concentrations

```{r ions_test_bg_conc, echo=FALSE}
  vocs_merged %>%
    dplyr::group_by(id, pol, test_type) %>%
    ggplot(aes_string(y = "val", x = "test_type")) +
      geom_jitter(aes(color = qc, shape = lod), size = 2) + 
      geom_boxplot(outlier.colour = NA, alpha = 0.0) +
      scale_shape_manual(values = lod_shapes) +
      scale_color_manual(values = qc_colors) +
      #scale_y_log10() +
      theme_bw() +
      facet_wrap(~pol, ncol = 6, scales = "free") +
      theme(text = element_text(size = 12),
            legend.position = "top") +
      ylab("concentration (micrograms per cubic meter)") +
      xlab("")
```

conclusions: need to investigate ways to account for background measurements (for now, subtract the median)

extract burn data

```{r}
  vocs_merged <-
    vocs_merged %>%
    dplyr::filter(test_type == "test")
```

```{r}
  vocs_merged <-
    vocs_merged %>%
    dplyr::left_join(bg, by = c("pol"))
```

## table: percentage of measurements below the background median

```{r, echo=FALSE}
  vocs_merged %>%
    dplyr::left_join(dplyr::select(samples, id, stove, fuel), by = "id") %>%
    #dplyr::filter(stove == "lpg") %>%
    dplyr::group_by(pol) %>%
    dplyr::do(val = round(nrow(filter(., val < 0))/nrow(.), 2) * 100) %>%
    dplyr::mutate(val = cell_spec(val, "html", color = ifelse(val > 10, "red", "blue"))) %>%
    dplyr::rename("voc type" = "pol") %>%
    knitr::kable("markdown", align = 'c', digits = 2)
```

## plot: concentrations by stove type

```{r vocs_stovetype, echo=FALSE, fig.height=35}
  vocs_merged_p <-
    vocs_merged %>%
    dplyr::left_join(dplyr::select(samples, id, stove, fuel, stovecat, fuelcat), by = "id")

  vocs_merged_p %>%
    ggplot(aes_string(x = "stove", y = "val")) +
      geom_jitter(aes(color = qc, shape = lod), size = 2) + 
      geom_boxplot(outlier.colour = NA, alpha = 0.0) +
      scale_shape_manual(values = lod_shapes) +
      scale_color_manual(values = qc_colors) +
      theme_bw() +
      theme(text = element_text(size = 12),
            axis.text.x = element_text(angle = 15, hjust = 1, vjust = 1),
            legend.position = "top") +
      facet_grid(pol~fuelcat, scales = "free", space = "free_x") +
      ylab("concentration (micrograms per cubic meter)") +
      xlab("")
```

conclusions:

## table: outliers by stove type

outliers (z > 3) when samples are grouped by pollutant and stove type

```{r, echo=FALSE}
  vocs_merged_p %>%
    dplyr::filter(!is.na(val)) %>%
    dplyr::group_by(pol, stove) %>%
    dplyr::mutate(z_score = (val - mean(val, na.rm = TRUE))/ sd(val, na.rm = TRUE)) %>%
    dplyr::ungroup() %>%
    dplyr::select(id, pol, stove, fuel, z_score) %>%
    dplyr::filter(z_score > 3) %>%
    dplyr::rename("voc type" = "pol") %>%
    knitr::kable("markdown", align = 'c')
```

conclusions:

## plot: concentrations by fuel type

```{r vocs_fueltype, echo=FALSE, fig.height=35}
  vocs_merged_p %>%
    ggplot(aes_string(x = "fuel", y = "val")) +
      geom_jitter(aes(color = qc, shape = lod), size = 2) + 
      geom_boxplot(outlier.colour = NA, alpha = 0.0) +
      scale_shape_manual(values = lod_shapes) +
      scale_color_manual(values = qc_colors) +
      theme_bw() +
      theme(text = element_text(size = 12),
            axis.text.x = element_text(angle = 15, hjust = 1, vjust = 1),
            legend.position = "top") +
      facet_grid(pol~fuelcat, scales = "free", space = "free_x") +
      ylab("concentration (micrograms per cubic meter)") +
      xlab("")
```

conclusions:

## table: outliers by fuel type

outliers (z > 3) when samples are grouped by pollutant and fuel type

```{r, echo=FALSE}
  vocs_merged_p %>%
    dplyr::filter(!is.na(val)) %>%
    dplyr::group_by(pol, fuel) %>%
    dplyr::mutate(z_score = (val - mean(val, na.rm = TRUE))/ sd(val, na.rm = TRUE)) %>%
    dplyr::ungroup() %>%
    dplyr::select(id, pol, stove, fuel, z_score) %>%
    dplyr::filter(z_score > 3) %>%
    dplyr::rename("voc type" = "pol") %>%
    knitr::kable("markdown", align = 'c', digits = 2)
```

conclusions: 

## table: percent of burns with NA values

```{r, echo=FALSE}
  vocs_merged %>%
    dplyr::group_by(pol) %>%
    dplyr::do(val = round(nrow(filter(., is.na(val) == TRUE))/nrow(.), 2) * 100) %>%
    dplyr::mutate(val = cell_spec(val, "html", color = ifelse(val > 10, "red", "blue"))) %>%
    dplyr::rename("voc type" = "pol") %>%
    knitr::kable("markdown", align = 'c')
```

## save data

```{r}
  vocs_merged <-
    vocs_merged %>%
    dplyr::select(id, pol, val, dur, lod, qc) %>%
    dplyr::mutate(pol_category = "vocs")

  saveRDS(vocs_merged, file = "../../r_data/vocs_merged.RDS")
```
