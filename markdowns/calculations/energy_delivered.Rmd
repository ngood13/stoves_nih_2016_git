---
title: "Energy applied"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r load_libraries, echo=FALSE, message=FALSE}
  if (!require("pacman")) install.packages("pacman")
  pacman::p_load(tidyverse)
```

```{r global_options, echo=FALSE}
  knitr::opts_chunk$set(fig.path ='figures/',
                        warning = FALSE, message = FALSE, cache = FALSE)
```

# tidy data

## load files

load data

```{r}
  temp_merged <- readRDS("../../r_data/temp_merged.RDS")
  samples <- readRDS("../../r_data/samples.RDS")
  test_times <- readRDS("../../r_data/test_times.RDS")
  wood_wgts <- readRDS("../../r_data/wood_wgts.RDS")
  wood_pot <- readRDS("../../r_data/wood_pot.RDS")
  batch_pot <- readRDS("../../r_data/batch_pot.RDS")
  batch_wgts <- readRDS("../../r_data/batch_wgts.RDS")
```

load water properties

```{r}
  c_water <- readRDS("../../r_data/c_water.RDS")
  hfg_water <- readRDS("../../r_data/hfg_water.RDS")
```

load scripts

```{r}
  source("../../scripts/functions.R")
```

## organize metadata

extract test times

```{r}
  times <- 
    test_times %>%
    dplyr::filter(var == "start_1" | var == "shutdown") %>%
    tidyr::spread(var, value) %>%
    dplyr::select(-date) %>%
    dplyr::rename(start = start_1, end = shutdown)
```

pot time stamps

```{r}
  e_times <- 
    test_times %>%
    dplyr::filter(grepl("^start_[0-9]|^end_[0-9]", var)) %>%
    dplyr::select(-date) %>%
    tidyr::separate(var, c("var", "rep")) %>%
    tidyr::spread(var, value)
```

remove redundant reps added for two pot stoves

```{r}
  e_times <- 
    e_times %>%
    dplyr::group_by(id, start) %>% 
    dplyr::filter(row_number(rep) == 1) %>%
    dplyr::ungroup() %>%
    dplyr::filter(!grepl("27|28|29|30", id))
```

create file with pot and rep identifiers

```{r}
  e_pot <- 
    wood_pot %>%
    dplyr::select(-date) %>%
    dplyr::bind_rows(batch_pot %>%
                      dplyr::select(-date)) %>%
    dplyr::filter(!grepl("27|28|29|30", id))
```

create variable with pot mass data

```{r}
  e_pot_mass <- 
    wood_wgts %>%
    dplyr::filter(grepl("^pot", var)) %>%
    tidyr::separate(var, c("var", "pot")) %>%
    dplyr::select(-var, -date) %>%
    tidyr::spread(pot, value)

  e_pot_mass <- 
    e_pot_mass %>%
    dplyr::bind_rows(batch_wgts %>%
                       dplyr::filter(grepl("^pot", var)) %>%
                       tidyr::separate(var, c("var", "pot")) %>%
                       dplyr::select(-var, -date) %>%
                       tidyr::spread(pot, value)) %>%
    tidyr::gather("pot", "pot_mass" , 2:3) %>%
    dplyr::filter(!grepl("27|28|29|30", id))
```

tidy pot mass + water mass data

```{r}
  e_pot_water_mass <- 
    wood_wgts %>%
    dplyr::filter(grepl("^on_[0-9]|^off_[0-9]", var)) %>%
    tidyr::separate(var, c("var", "rep")) %>%
    tidyr::spread(var, value) %>%
    dplyr::select(-date) %>%
    dplyr::rename(mass_on = on, mass_off = off)

  e_pot_water_mass <- 
    e_pot_water_mass %>%
    dplyr::bind_rows(batch_wgts %>%
                      dplyr::filter(grepl("^on_[0-9]|^off_[0-9]", var)) %>%
                      tidyr::separate(var, c("var", "rep")) %>%
                      tidyr::spread(var, value) %>%
                      dplyr::select(-date) %>%
                      dplyr::rename(mass_on = on, mass_off = off)) %>%
    dplyr::filter(!grepl("27|28|29|30", id))
```

## fix time issues

create data frame with time changes

```{r}
  time_tweak <- data_frame(id = unique(temp_merged$id), dt = 0)
  time_tweak$dt[which(time_tweak$id == "13C")] <- 70
  time_tweak$dt[which(time_tweak$id == "13B")] <- 15
  time_tweak$dt[which(time_tweak$id == "16A")] <- 100
  time_tweak$dt[which(time_tweak$id == "25A")] <- -90
  time_tweak$dt[which(time_tweak$id == "25B")] <- -90
  time_tweak$dt[which(time_tweak$id == "20C")] <- -30
  time_tweak$dt[which(time_tweak$id == "21B")] <- 30
  time_tweak$dt[which(time_tweak$id == "25A")] <- -90
  time_tweak$dt[which(time_tweak$id == "25B")] <- -90
  time_tweak$dt[which(time_tweak$id == "26B")] <- -90
  time_tweak$dt[which(time_tweak$id == "2E")] <- -90
  time_tweak$dt[which(time_tweak$id == "6E")] <- -90
  time_tweak$dt[which(time_tweak$id == "8D")] <- -90
  time_tweak$dt[which(time_tweak$id == "8C")] <- -50
  time_tweak$dt[which(time_tweak$id == "9B")] <- -50
  time_tweak$dt[which(time_tweak$id == "5A")] <- 60
  time_tweak$dt[which(time_tweak$id == "3D")] <- -60
  time_tweak$dt[which(time_tweak$id == "29A")] <- -60
```

adjust temperature times

```{r}
  temp_merged <- 
    temp_merged %>%
    dplyr::left_join(time_tweak, by = "id") %>%
    dplyr::mutate(time = time - 130,
                  datetime = datetime - 130,
                  time = time + dt,
                  datetime = datetime + dt)
```

## extract test data only

```{r}
  e_temp <- dplyr::filter(temp_merged, loc != "flue")

  e_temp <- filter_temp(e_times, e_temp) # adds rep
```

## filter unrealistic values

data should be betwen 10 and 100 degrees Celsius

```{r}
  e_temp <- 
    e_temp %>%
    dplyr::filter(t_oc < 100, t_oc > 10)
```

## calculate min and max temp for each pot

```{r}
  t_range <- dplyr::group_by(e_temp, id, rep, loc) %>%
             dplyr::summarise(t_min = quantile(t_oc, 0.025, na.rm = TRUE) - 2,
                              t_max = quantile(t_oc, 0.975, na.rm = TRUE) + 2)
```

fix temp issues

```{r}
  # missing data from start of 2nd rep
  t_range$t_min[which(t_range$id == "1B" & t_range$rep == 2)] <- 20.18
```

## merge data

```{r}
  e_data <- 
    e_pot_water_mass %>%
    dplyr::left_join(e_pot, by = c("id", "rep")) %>%
    dplyr::left_join(e_pot_mass, by = c("id", "pot")) %>%
    dplyr::left_join(t_range %>%
                       dplyr::filter(loc == "front"), by = c("id", "rep"))
```

# calculate energy delivered

```{r}
  e_data <- 
    e_data %>%
    dplyr::mutate(mass_evap = mass_on - mass_off,
                  mass_h2o = mass_on - mass_pot,
                  dt = t_max - t_min,
                  j_heat = mass_h2o * c_water * dt, # g * J/(g.oC) * oC
                  j_vap = mass_evap * hfg_water,
                  joules = j_heat + j_vap)
```

energy delivered per test

```{r}
  energy <- 
    e_data %>%
    dplyr::select(id, joules) %>%
    dplyr::group_by(id) %>%
    dplyr::summarise(joules = sum(joules))
```

# summary data

## plot: temperature (id & loc)

```{r, echo=FALSE, fig.width=12, fig.height=50}
  e_temp %>%
    dplyr::filter(loc != "flue") %>%
    ggplot(aes(datetime, t_oc, color = loc)) +
      geom_line() +
      geom_point() +
      facet_wrap(~id, ncol = 3, scales = "free") +
      theme_bw() +
      theme(legend.position = "top") +
      ylab("temperature (degress celsius)")
```

## plot: temperature (id & rep)

```{r, echo=FALSE, fig.width=12, fig.height=80}
  e_temp %>% 
    dplyr::left_join(t_range, by = c("id", "rep", "loc")) %>%
    ggplot(aes(datetime, t_oc, group = loc, colour = rep)) +
      geom_point() +
      geom_line(aes(datetime, t_min, colour = rep)) +
      geom_line(aes(datetime, t_max, colour = rep)) +
      facet_wrap(~id, scales = "free", ncol = 3) +
      theme_minimal() +
      theme(legend.position = "top") +
      ylab("temperature (degress celsius)")
```

## plot energy delivered

```{r, echo=FALSE, fig.width=12, fig.height=8}
  energy %>%
    dplyr::left_join(dplyr::filter(samples, type == "SF"), by = "id") %>%
    ggplot(p_data, aes(id, joules, colour = qc)) +
    geom_point() +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
    theme(legend.position = "top") +
    ylab("energy delivered to pot (Joules)")
```

# missing and bad data

## table: missing data

```{r, echo = FALSE}
  dplyr::select(samples, id, stove, fuel) %>%
    dplyr::anti_join(energy %>%
                     dplyr::filter(!is.na(joules)) %>%
                     dplyr::select(id) %>%
                     dplyr::distinct(),
                   by = "id") %>%
    dplyr::filter(!grepl("^G", id)) %>%
    knitr::kable("markdown", align = 'c')
```

Conclusions: temperature data (and therefore energy data) is expected to be missing for: 13A, 2A, and 6A (the three tests conducted on 1/5/2016), 18B, 21A (conducted on 2/10/2016), 22A (conducted on 1/13/2016), and 3A, and 7A (conducted on 2/26/2016): test data was lost

# save data

```{r}
  saveRDS(energy, "../r_files/energy.RDS")
```
