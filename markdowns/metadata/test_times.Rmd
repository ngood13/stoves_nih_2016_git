---
title: "Process test times"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r load_libraries, echo=FALSE, message=FALSE}
  if (!require("pacman")) install.packages("pacman")
  pacman::p_load(tidyverse, knitr, forcats, gridExtra)
```

```{r global_options, echo=FALSE}
  knitr::opts_chunk$set(fig.path ='figures/', warning = FALSE, message = FALSE, cache = FALSE)
```

```{r, echo=FALSE}
  source("../../scripts/plots.R")
```

# load data

* sample, wood and batch test metadata

```{r}
  samples <- readRDS("../../r_data/samples.RDS")
  batch_times <- readRDS("../../r_data/batch_times.RDS")
  wood_times <- readRDS("../../r_data/wood_times.RDS")
```

* pre and post experiment background times for online instruments

```{r}
  data_1 <- readRDS("../../r_data/data_1.RDS")
  data_2 <- readRDS("../../r_data/data_2.RDS")
```

# combine time data

* wood and batch times

```{r}
  wood_batch_times <- dplyr::bind_rows(dplyr::select(wood_times, -date),
                                       dplyr::select(batch_times, -date)) %>%
                      dplyr::inner_join(dplyr::select(samples, id, date),
                                                      test_times, by = "id") %>%
                      dplyr::filter(is.na(value)==FALSE) %>%
                      dplyr::mutate(id = as.factor(id))
```

* fivegas background times

```{r}
  times_bg_fivegas <- dplyr::select(data_1, id, 
                                    time_start_fivegas_prebg,
                                    time_end_fivegas_prebg,
                                    time_start_fivegas_post_bg,
                                    time_end_fivegas_post_bg) %>%
                      dplyr::rename(bg_pre_start_fivegas = time_start_fivegas_prebg,
                                    bg_pre_end_fivegas = time_end_fivegas_prebg,
                                    bg_post_start_fivegas = time_start_fivegas_post_bg,
                                    bg_post_end_fivegas = time_end_fivegas_post_bg) %>%
                      tidyr::gather("var", "value", 2:5) %>%
                      dplyr::inner_join(dplyr::select(samples, id, date),
                                        by = "id") %>%
                      dplyr::filter(is.na(value) == FALSE) %>%
                      dplyr::mutate(id = as.factor(id))
```

* pax/smps background times

```{r}
  times_bg_pax_smps <- dplyr::select(data_2, id, 
                                     time_start_smps_pax_bg_pre,
                                     time_end_smps_pax_bg_pre,
                                     time_start_smps_pax_bg_post,
                                     time_end_smps_pax_bg_post) %>%
                       dplyr::rename(bg_pre_start_pax_smps = time_start_smps_pax_bg_pre,
                                     bg_pre_end_pax_smps = time_end_smps_pax_bg_pre,
                                     bg_post_start_pax_smps = time_start_smps_pax_bg_post,
                                     bg_post_end_pax_smps = time_end_smps_pax_bg_post) %>%
                      tidyr::gather("var", "value", 2:5) %>%
                      dplyr::inner_join(dplyr::select(samples, id, date),
                                        by = "id") %>%
                      dplyr::filter(is.na(value) == FALSE) %>%
                      dplyr::mutate(id = as.factor(id))
```

* combine times

```{r}
  test_times <- dplyr::bind_rows(wood_batch_times,
                                 times_bg_fivegas,
                                 times_bg_pax_smps) %>%
                dplyr::mutate(id = as.factor(id)) %>%
                dplyr::mutate(var = as.factor(var)) %>%
                tibble::as_data_frame()
```

# save data

```{r}
  saveRDS(test_times, file = "../../r_data/test_times.RDS")
```

# summary

```{r, echo=FALSE}
  # sample info
  samples <- dplyr::select(samples, id, stove, fuel)
```

```{r, echo=FALSE}
  # sample durations (minutes)
  times <- dplyr::filter(test_times, var == "start_1" | var == "shutdown") %>%
           tidyr::spread(var, value) %>%
           dplyr::mutate(dur = (shutdown - start_1) / 60)
```

```{r, echo=FALSE}
  # merge with full test list
  times <- dplyr::left_join(dplyr::select(samples, id) %>%
                            dplyr::filter(grepl("^[0-9]", id) == TRUE), 
                            times,
                            by = "id")
```

```{r test_times, fig.width=12, fig.height=8, echo=FALSE}
  p_hist <- ggplot(times, aes(x = dur)) +
            geom_histogram(binwidth = 15) +
            theme_minimal() +
            xlab("test duration (min)")

  p_data <- dplyr::mutate(times,
                          value_norm = (dur - mean(dur, na.rm = TRUE)) / sd(dur, na.rm = TRUE),
                          outlier = ifelse(is_outlier(dur), as.character(id), ""))

  p_box <- ggplot(p_data, aes(x = "duration", y = value_norm)) +
           geom_boxplot() +
           geom_text(aes(label = outlier), na.rm = TRUE, hjust = -0.3, size = 4) +
           theme_minimal() +
           ylab("z score normalized value") +
           xlab("") +
           theme(axis.text.x = element_text(angle = 35, hjust = 0.95, size = 30)) +
           theme(axis.text.y = element_text(size = 30),
           axis.title=element_text(size=40))

  gridExtra::grid.arrange(p_hist, p_box, ncol = 2)
```

There is `r sum(is.na(times$dur))` test with missing sample duration data, these are: `r times$id[is.na(times$dur)]`.
