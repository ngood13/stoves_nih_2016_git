---
title: "figure 4: correlation plots"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r load_libraries, echo=FALSE, message=FALSE}
  if (!require("pacman")) install.packages("pacman")
  pacman::p_load(tidyverse, lme4, kableExtra, stats4, broom)
```

```{r global_options, echo=FALSE}
  knitr::opts_chunk$set(fig.path ='figures/',
                        warning = FALSE, message = FALSE, cache = FALSE)
```

# tidy data

load data

```{r}
  emissions <- readRDS("../../../r_data/emissions_factors.RDS")
  samples <- readRDS("../../../r_data/samples.RDS")
```

## add stove fuel info

```{r}
  emissions <-
    emissions %>%
    dplyr::left_join(samples %>%
                       dplyr::select(id, stove, fuel, stovecat, fuelcat), by = "id")
```

## filter out values below background, NA values, and select metric

```{r}
  emissions <-
    emissions %>%
    dplyr::filter(bg != "below", !is.na(val), metric == "energy_delivered_ef", !(val <= 0)) %>%
    dplyr::filter(pol != "ec_unc", pol != "oc_unc", pol != "cyclopenta[ce]phenanthrylene")
```

## rename pollutants

```{r}
  emissions <-
    emissions %>%
    dplyr::mutate(pol_subcategory = as.character(pol_subcategory),
                  pol_subcategory = ifelse(grepl("organic matter", pol_subcategory), "particle-phase organic matter", pol_subcategory),
                  pol_subcategory = ifelse(grepl("ions", pol_subcategory), "inorganic ions", pol_subcategory),
                  pol_subcategory = ifelse(grepl("^co2$", pol_subcategory), "carbon dioxide", pol_subcategory),
                  pol_subcategory = ifelse(grepl("^ch4$", pol_subcategory), "methane", pol_subcategory),
                  pol_subcategory = ifelse(grepl("ultrafines", pol_subcategory), "ultrafine particles", pol_subcategory),
                  pol_subcategory = ifelse(grepl("alkanes", pol_subcategory), "gas-phase alkanes", pol_subcategory),
                  pol_subcategory = ifelse(grepl("alkenes", pol_subcategory), "gas-phase alkenes", pol_subcategory),
                  pol_subcategory = ifelse(grepl("alkynes", pol_subcategory), "gas-phase alkynes", pol_subcategory),
                  pol_subcategory = ifelse(grepl("aromatics", pol_subcategory), "gas-phase aromatics", pol_subcategory),
                  pol_subcategory = gsub(" rings", "-ring PAHs", pol_subcategory),
                  pol_subcategory = ifelse(grepl("carbohydrates", pol_subcategory), "carbohydrates", pol_subcategory),
                  pol_subcategory = ifelse(grepl("carbonyls", pol_subcategory), "carbonyls", pol_subcategory)) %>%
    dplyr::mutate(pol = gsub("indeno\\(1,2,3\\) cd pyrene", "indeno\\[1,2,3-cd\\]pyrene", pol),
                  pol = gsub("\\(ah\\)",  "\\[a,h\\]", pol),
                  pol = gsub("b\\[",  "benzo\\[", pol),
                  pol = gsub("b\\[",  "benzo\\[", pol),
                  pol = gsub("benz\\[",  "benzo\\[", pol),
                  pol = gsub("benzo\\[a\\]anthracene",  "benz\\[a\\]anthracene", pol))
```

## check number of data points

```{r, echo=FALSE, eval=FALSE}
  emissions %>%
    dplyr::group_by(pol) %>% 
    dplyr::do(val = round(nrow(.), 2)) %>%
    dplyr::mutate(val = cell_spec(val, "html", color = ifelse(val < 20, "blue", "blue"))) %>%
    dplyr::arrange(val) %>%
    knitr::kable("markdown", align = 'c')
```

notes: 

* total number of burn tests were 87
* temperature data missing for 10 tests - brings total down to 77

## number of data points for liquid-fuel stoves (only three replicates of each test)

```{r, echo=FALSE, eval=FALSE}
  emissions %>%
    dplyr::group_by(pol, stove) %>%
    dplyr::filter(grepl("pressure|lpg|wick", stove)) %>%
    dplyr::do(val = round(nrow(.), 2)) %>%
    dplyr::mutate(val = cell_spec(val, "html", color = ifelse(val <= 2, "red", "blue"))) %>%
    dplyr::arrange(val) %>%
    tidyr::spread(stove, val) %>%
    knitr::kable("markdown", align = 'c')
```

notes: 

* the smallest number of total data points is 19 which seems like enough to run a regression analysis
* should there be a minimum number by stove type?

## log transform pollutants

```{r}
  all <-
    emissions %>%
    dplyr::select(id, pol, val, stove) %>%
    tidyr::spread(pol, val) %>%
    tidyr::gather("pol", "val", -id, -stove, -pm_mass, -co) %>%
    dplyr::mutate(pm_mass = log(pm_mass),
                  co = log(co),
                  val = log(val)) %>%
    na.omit
```

notes:

* only complete observations retained

## check number of data points

```{r, echo=FALSE}
  liquid_num <-
    all %>%
    dplyr::group_by(pol, stove) %>%
    dplyr::filter(grepl("pressure|lpg|wick", stove)) %>%
    dplyr::do(val = round(nrow(.), 2)) %>%
    dplyr::mutate(val = as.numeric(val)) %>%
    tidyr::spread(stove, val)

  num_data_points <-
    all %>%
    dplyr::group_by(pol) %>% 
    dplyr::count() %>%
    dplyr::ungroup() %>%
    dplyr::left_join(liquid_num, by = "pol") %>%
    dplyr::arrange(n) %>%
    dplyr::rename("pol" = "pol",
                  "all stoves" = "n")

  readr::write_csv(num_data_points,
                   "../../../qaqc_files/num_data_points_all.csv",
                   append = FALSE)
```

## subset

```{r}
  gases <-
    emissions %>%
    dplyr::filter(grepl("^benzene|formaldehyde|styrene|acetaldehyde|isoprene", pol)) %>%
    dplyr::filter(metric == "energy_delivered_ef") %>%
    dplyr::select(id, pol, val, stove, stovecat)

  particles <-
    emissions %>%
    dplyr::filter(grepl("b.a.pyrene|dibenzo.*anthracene|cyclopenta.*pyrene|b.*anthracene|b...fluoranthene|indeno", pol)) %>%
    dplyr::filter(metric == "energy_delivered_ef") %>%
    dplyr::select(id, pol, val, stove, stovecat)

  subcat <-
    emissions %>%
    dplyr::filter(!grepl("^oc$", pol), !grepl("unc", pol)) %>%
    dplyr::select(id, pol_subcategory, val, stove, stovecat) %>%
    dplyr::ungroup() %>%
    dplyr::group_by(id, pol_subcategory) %>%
    dplyr::mutate(val = sum(val, na.rm = TRUE)) %>%
    dplyr::rename("pol" = "pol_subcategory") %>%
    dplyr::distinct() %>%
    dplyr::bind_rows(gases) %>%
    dplyr::bind_rows(particles) %>%
    tidyr::spread(pol, val) %>%
    tidyr::gather("pol", "val", -id, -stove, -pm_mass, -co, -stovecat) %>%
    dplyr::mutate(pm_mass = log(pm_mass),
                  co = log(co),
                  val = log(val)) %>%
    na.omit
```

```{r, echo=FALSE}
  liquid_num <-
    subcat %>%
    dplyr::group_by(pol, stove) %>%
    dplyr::filter(grepl("pressure|lpg|wick", stove)) %>%
    dplyr::do(val = round(nrow(.), 2)) %>%
    dplyr::mutate(val = as.numeric(val)) %>%
    tidyr::spread(stove, val)

  num_data_points <-
    subcat %>%
    dplyr::group_by(pol) %>% 
    dplyr::count() %>%
    dplyr::ungroup() %>%
    dplyr::left_join(liquid_num, by = "pol") %>%
    dplyr::arrange(n) %>%
    dplyr::rename("pol" = "pol",
                  "all stoves" = "n")

  readr::write_csv(num_data_points,
                   "../../../qaqc_files/num_data_points_subcat.csv",
                   append = FALSE)
```

# subcat models

## run

```{r}
  subcat_m <-
    subcat %>%
    dplyr::group_by(pol) %>%
    dplyr::do(mod_1 = lm(val ~ stove, data = .),
              mod_2 = lm(val ~ pm_mass, data = .),
              mod_3 = lm(val ~ co, data = .),
              mod_4 = lm(val ~ pm_mass + co, data = .),
              mod_5 = lm(val ~ pm_mass + stove, data = .),
              mod_6 = lm(val ~ co + stove, data = .),
              mod_7 = lm(val ~ pm_mass + co + stove, data = .)) %>%
    dplyr::mutate("stove type only" = summary(mod_1)$r.squared,
                  "pm only" = summary(mod_2)$r.squared,
                  "co only" = summary(mod_3)$r.squared,
                  "pm and co" = summary(mod_4)$r.squared,
                  "pm and stove type" = summary(mod_5)$r.squared,
                  "co and stove type" = summary(mod_6)$r.squared,
                  "pm, co, and stove type" = summary(mod_7)$r.squared) %>%
    tidyr::gather("model", "val", -pol) %>%
    dplyr::filter(!grepl("mod", model)) %>%
    dplyr::mutate(val = as.numeric(val))
```

## plot

* plot is sorted by R2-value of top model
* pollutants are colored by pollutant cateogry

```{r models_subcat, echo=FALSE, fig.height=6, fig.width=8}
  subcat_m %>%
  dplyr::mutate(model = 
                  model %>%
                  factor %>%
                  forcats::fct_relevel("stove type only",
                                       "pm only",
                                       "co only",
                                       "pm and co",
                                       "pm and stove type",
                                       "co and stove type",
                                       "pm, co, and stove type")) %>%
    ggplot(aes(x = reorder(pol, val, max), y = val)) +
      geom_point(aes(color = model, shape = model), size = 2, stroke = 1, alpha = 0.75) +
      scale_color_manual(values = c("blueviolet", "orange", "orange", "orange",
                                    "turquoise3", "turquoise3", "turquoise3")) +
      scale_shape_manual(values = c(1, 2, 3, 4, 2, 3, 4)) +
      coord_flip() +
      theme_minimal() +
    scale_y_continuous(limits = c(0, 1)) +
    theme(text = element_text(size = 12),
          axis.title.y = element_blank(),
          legend.position = "right",
          legend.title = element_blank()) +
    ylab("R-squared value")
```

```{r}
  subcat <-
    subcat %>%
    dplyr::filter(!grepl("acetaldehyde|formaldehyde|\\[|benzene|isoprene|styrene|elemental|dioxide|organic matter|ultrafine|methane", pol))
```

## coefficients

```{r}
  mod1_est <-
    subcat %>%
    dplyr::group_by(pol) %>%
    dplyr::do(est = tidy(lm(val ~ stove - 1, data = .))) %>%
    tidyr::unnest(est) %>%
    dplyr::rename("stove" = "term") %>%
    dplyr::mutate(stove = gsub("stove", "", stove)) %>%
    dplyr::select(pol, stove, estimate) %>%
    dplyr::mutate(estimate = format(round(estimate, digits = 2), nsmall = 2))

  mod1_conf <-
    subcat %>%
    dplyr::group_by(pol) %>%
    dplyr::do(conf = as_tibble(confint(lm(val ~ stove - 1, data = .)), rownames = "stove")) %>%
    tidyr::unnest(conf) %>%
    dplyr::mutate(stove = gsub("stove", "", stove)) %>%
    dplyr::rename("lower" = "2.5 %",
                  "upper" = "97.5 %") %>%
    dplyr::mutate(lower = format(round(lower, digits = 2), nsmall = 2),
                  upper = format(round(upper, digits = 2), nsmall = 2))
  
  mod_1 <-
    mod1_est %>%
    dplyr::left_join(mod1_conf, by = c("pol", "stove")) %>%
    dplyr::mutate(val = paste0(estimate, " (", lower, ", ", upper,")"))
  
  saveRDS(mod_1 %>%
            dplyr::select(pol, stove, val), "model_confint/mod_1.RDS")
```

```{r}
  mod2_est <-
    subcat %>%
    dplyr::group_by(pol) %>%
    dplyr::do(est = tidy(lm(val ~ pm_mass, data = .))) %>%
    tidyr::unnest(est) %>%
    dplyr::select(pol, term, estimate) %>%
    dplyr::mutate(estimate = format(round(estimate, digits = 2), nsmall = 2))

  mod2_conf <-
    subcat %>%
    dplyr::group_by(pol) %>%
    dplyr::do(conf = as_tibble(confint(lm(val ~ pm_mass , data = .)), rownames = "term")) %>%
    tidyr::unnest(conf) %>%
    dplyr::rename("lower" = "2.5 %",
                  "upper" = "97.5 %") %>%
    dplyr::select(pol, term, lower, upper) %>%
    dplyr::mutate(lower = format(round(lower, digits = 2), nsmall = 2),
                  upper = format(round(upper, digits = 2), nsmall = 2))
  
  mod_2 <-
    mod2_est %>%
    dplyr::left_join(mod2_conf, by = c("pol", "term")) %>%
    dplyr::mutate(val = paste0(estimate, " (", lower, ", ", upper,")")) %>%
    dplyr::select(pol, term, val) %>%
    tidyr::spread(term, val)
  
  saveRDS(mod_2, "model_confint/mod_2.RDS")
```

```{r}
  mod3_est <-
    subcat %>%
    dplyr::group_by(pol) %>%
    dplyr::do(est = tidy(lm(val ~ co, data = .))) %>%
    tidyr::unnest(est) %>%
    dplyr::select(pol, term, estimate) %>%
    dplyr::mutate(estimate = format(round(estimate, digits = 2), nsmall = 2))

  mod3_conf <-
    subcat %>%
    dplyr::group_by(pol) %>%
    dplyr::do(conf = as_tibble(confint(lm(val ~ co, data = .)), rownames = "term")) %>%
    tidyr::unnest(conf) %>%
    dplyr::rename("lower" = "2.5 %",
                  "upper" = "97.5 %") %>%
    dplyr::select(pol, term, lower, upper) %>%
    dplyr::mutate(lower = format(round(lower, digits = 2), nsmall = 2),
                  upper = format(round(upper, digits = 2), nsmall = 2))
  
  mod_3 <-
    mod3_est %>%
    dplyr::left_join(mod3_conf, by = c("pol", "term")) %>%
    dplyr::mutate(val = paste0(estimate, " (", lower, ", ", upper,")")) %>%
    dplyr::select(pol, term, val) %>%
    tidyr::spread(term, val)
  
  saveRDS(mod_3, "model_confint/mod_3.RDS")
```

```{r}
  mod4_est <-
    subcat %>%
    dplyr::group_by(pol) %>%
    dplyr::do(est = tidy(lm(val ~ pm_mass + co, data = .))) %>%
    tidyr::unnest(est) %>%
    dplyr::select(pol, term, estimate) %>%
    dplyr::mutate(estimate = format(round(estimate, digits = 2), nsmall = 2))

  mod4_conf <-
    subcat %>%
    dplyr::group_by(pol) %>%
    dplyr::do(conf = as_tibble(confint(lm(val ~ pm_mass + co, data = .)), rownames = "term")) %>%
    tidyr::unnest(conf) %>%
    dplyr::rename("lower" = "2.5 %",
                  "upper" = "97.5 %") %>%
    dplyr::select(pol, term, lower, upper) %>%
    dplyr::mutate(lower = format(round(lower, digits = 2), nsmall = 2),
                  upper = format(round(upper, digits = 2), nsmall = 2))
  
  mod_4 <-
    mod4_est %>%
    dplyr::group_by(pol, term) %>%
    dplyr::left_join(mod4_conf, by = c("pol", "term")) %>%
    dplyr::mutate(val = paste0(estimate, " (", lower, ", ", upper,")")) %>%
    dplyr::select(pol, val) %>%
    tidyr::spread(term, val)
  
  saveRDS(mod_4, "model_confint/mod_4.RDS")
```


```{r}
  mod5_est <-
    subcat %>%
    dplyr::group_by(pol) %>%
    dplyr::do(est = tidy(lm(val ~ stove + pm_mass - 1, data = .))) %>%
    tidyr::unnest(est) %>%
    dplyr::rename("stove" = "term") %>%
    dplyr::mutate(stove = gsub("stove", "", stove)) %>%
    dplyr::select(pol, stove, estimate) %>%
    dplyr::mutate(estimate = format(round(estimate, digits = 2), nsmall = 2))

  mod5_conf <-
    subcat %>%
    dplyr::group_by(pol) %>%
    dplyr::do(conf = as_tibble(confint(lm(val ~ stove + pm_mass - 1, data = .)), rownames = "stove")) %>%
    tidyr::unnest(conf) %>%
    dplyr::mutate(stove = gsub("stove", "", stove)) %>%
    dplyr::rename("lower" = "2.5 %",
                  "upper" = "97.5 %") %>%
    dplyr::mutate(lower = format(round(lower, digits = 2), nsmall = 2),
                  upper = format(round(upper, digits = 2), nsmall = 2))
  
  mod_5 <-
    mod5_est %>%
    dplyr::left_join(mod5_conf, by = c("pol", "stove")) %>%
    dplyr::mutate(val = paste0(estimate, " (", lower, ", ", upper,")"))
  
  mod_5_pm <-
    mod_5 %>%
    dplyr::filter(stove == "pm_mass") %>%
    tidyr::spread(stove, val) %>%
    dplyr::select(pol, pm_mass)
  
  mod_5 <-
    mod_5 %>%
    dplyr::filter(stove != "pm_mass") %>%
    dplyr::left_join(mod_5_pm, by = "pol")
  
  saveRDS(mod_5 %>%
            dplyr::select(pol, stove, val, pm_mass), "model_confint/mod_5.RDS")
```

```{r}
  mod6_est <-
    subcat %>%
    dplyr::group_by(pol) %>%
    dplyr::do(est = tidy(lm(val ~ stove + co - 1, data = .))) %>%
    tidyr::unnest(est) %>%
    dplyr::rename("stove" = "term") %>%
    dplyr::mutate(stove = gsub("stove", "", stove)) %>%
    dplyr::select(pol, stove, estimate) %>%
    dplyr::mutate(estimate = format(round(estimate, digits = 2), nsmall = 2))

  mod6_conf <-
    subcat %>%
    dplyr::group_by(pol) %>%
    dplyr::do(conf = as_tibble(confint(lm(val ~ stove + co - 1, data = .)), rownames = "stove")) %>%
    tidyr::unnest(conf) %>%
    dplyr::mutate(stove = gsub("stove", "", stove)) %>%
    dplyr::rename("lower" = "2.5 %",
                  "upper" = "97.5 %") %>%
    dplyr::mutate(lower = format(round(lower, digits = 2), nsmall = 2),
                  upper = format(round(upper, digits = 2), nsmall = 2))
  
  mod_6 <-
    mod6_est %>%
    dplyr::left_join(mod6_conf, by = c("pol", "stove")) %>%
    dplyr::mutate(val = paste0(estimate, " (", lower, ", ", upper,")"))
  
  mod_6_co <-
    mod_6 %>%
    dplyr::filter(stove == "co") %>%
    tidyr::spread(stove, val) %>%
    dplyr::select(pol, co)
  
  mod_6 <-
    mod_6 %>%
    dplyr::filter(stove != "co") %>%
    dplyr::left_join(mod_6_co, by = "pol")
  
  saveRDS(mod_6 %>%
            dplyr::select(pol, stove, val, co), "model_confint/mod_6.RDS")
```

```{r}
  mod7_est <-
    subcat %>%
    dplyr::group_by(pol) %>%
    dplyr::do(est = tidy(lm(val ~ stove + co + pm_mass - 1, data = .))) %>%
    tidyr::unnest(est) %>%
    dplyr::rename("stove" = "term") %>%
    dplyr::mutate(stove = gsub("stove", "", stove)) %>%
    dplyr::select(pol, stove, estimate) %>%
    dplyr::mutate(estimate = format(round(estimate, digits = 2), nsmall = 2))

  mod7_conf <-
    subcat %>%
    dplyr::group_by(pol) %>%
    dplyr::do(conf = as_tibble(confint(lm(val ~ stove + co + pm_mass - 1, data = .)), rownames = "stove")) %>%
    tidyr::unnest(conf) %>%
    dplyr::mutate(stove = gsub("stove", "", stove)) %>%
    dplyr::rename("lower" = "2.5 %",
                  "upper" = "97.5 %") %>%
    dplyr::mutate(lower = format(round(lower, digits = 2), nsmall = 2),
                  upper = format(round(upper, digits = 2), nsmall = 2))
  
  mod_7 <-
    mod7_est %>%
    dplyr::left_join(mod7_conf, by = c("pol", "stove")) %>%
    dplyr::mutate(val = paste0(estimate, " (", lower, ", ", upper,")"))
  
  mod_7_co_pm <-
    mod_7 %>%
    dplyr::filter(grepl("^co|pm", stove)) %>%
    dplyr::select(pol, stove, val) %>%
    tidyr::spread(stove, val) %>%
    dplyr::select(pol, co, pm_mass)
  
  mod_7 <-
    mod_7 %>%
    dplyr::filter(stove != "co", stove != "pm_mass") %>%
    dplyr::left_join(mod_7_co_pm, by = "pol")
  
  saveRDS(mod_7 %>%
            dplyr::select(pol, stove, val, co, pm_mass), "model_confint/mod_7.RDS")
```

# full models

## fix pollutant names

```{r}
  all <-
    all %>%
    dplyr::mutate(pol = ifelse(grepl("^co2$", pol), "carbon dioxide", pol),
                  pol = ifelse(grepl("^ch4$", pol), "methane", pol),
                  pol = ifelse(grepl("ultrafines", pol), "ultrafine particles", pol),
                  pol = ifelse(grepl("^om$", pol), "organic matter", pol),
                  pol = ifelse(grepl("^oc$", pol), "organic carbon", pol),
                  pol = ifelse(grepl("^ec$", pol), "elemental carbon", pol),
                  pol = ifelse(grepl("pinene", pol), "alpha-pinene", pol),
                  pol = ifelse(grepl("2_methyl_2_butene", pol), "2-methyl-2-butene", pol),
                  pol = gsub("([0-9])(_)([0-9])", "\\1,\\3", pol),
                  pol = gsub("([0-9])(_)([0-9])", "\\1,\\3", pol),
                  pol = gsub("([0-9])(_)([a-z])", "\\1-\\3", pol),
                  pol = gsub("([a-z])(_)([0-9])", "\\1,\\3", pol),
                  pol = gsub("(m)(_)(p)", "\\1,\\3", pol),
                  pol = gsub("([a-z])(_)([a-z])", "\\1-\\3", pol))
```


## run

```{r}
  all_m <-
    all %>%
    dplyr::group_by(pol) %>%
    dplyr::do(mod_1 = lm(val ~ stove, data = .),
              mod_2 = lm(val ~ pm_mass, data = .),
              mod_3 = lm(val ~ co, data = .),
              mod_4 = lm(val ~ pm_mass + co, data = .),
              mod_5 = lm(val ~ pm_mass + stove, data = .),
              mod_6 = lm(val ~ co + stove, data = .),
              mod_7 = lm(val ~ pm_mass + co + stove, data = .)) %>%
    dplyr::mutate("stove type only" = summary(mod_1)$r.squared,
                  "pm only" = summary(mod_2)$r.squared,
                  "co only" = summary(mod_3)$r.squared,
                  "pm and co" = summary(mod_4)$r.squared,
                  "pm and stove type" = summary(mod_5)$r.squared,
                  "co and stove type" = summary(mod_6)$r.squared,
                  "pm, co, and stove type" = summary(mod_7)$r.squared) %>%
    tidyr::gather("model", "val", -pol) %>%
    dplyr::filter(!grepl("mod", model)) %>%
    dplyr::mutate(val = as.numeric(val))
```

## plot

* plot is sorted by R2-value of top model
* pollutants are colored by pollutant cateogry

```{r models_all, echo=FALSE, fig.height=18, fig.width=8}
  all_m %>%
  dplyr::mutate(model = 
                  model %>%
                  factor %>%
                  forcats::fct_relevel("stove type only",
                                       "pm only",
                                       "co only",
                                       "pm and co",
                                       "pm and stove type",
                                       "co and stove type",
                                       "pm, co, and stove type")) %>%
    ggplot(aes(x = reorder(pol, val, max), y = val)) +
      geom_point(aes(color = model, shape = model), size = 2, stroke = 1, alpha = 0.75) +
      scale_color_manual(values = c("blueviolet", "orange", "orange", "orange",
                                    "turquoise3", "turquoise3", "turquoise3")) +
      scale_shape_manual(values = c(1, 2, 3, 4, 2, 3, 4)) +
      coord_flip() +
      theme_minimal() +
    scale_y_continuous(limits = c(0, 1)) +
    theme(text = element_text(size = 12),
          axis.title.y = element_blank(),
          legend.position = "right",
          legend.title = element_blank()) +
    ylab("R-squared value")
```

## coefficients

```{r}
  mod1_est <-
    all %>%
    dplyr::group_by(pol) %>%
    dplyr::do(est = tidy(lm(val ~ stove - 1, data = .))) %>%
    tidyr::unnest(est) %>%
    dplyr::rename("stove" = "term") %>%
    dplyr::mutate(stove = gsub("stove", "", stove)) %>%
    dplyr::select(pol, stove, estimate) %>%
    dplyr::mutate(estimate = format(round(estimate, digits = 2), nsmall = 2))

  mod1_conf <-
    all %>%
    dplyr::group_by(pol) %>%
    dplyr::do(conf = as_tibble(confint(lm(val ~ stove - 1, data = .)), rownames = "stove")) %>%
    tidyr::unnest(conf) %>%
    dplyr::mutate(stove = gsub("stove", "", stove)) %>%
    dplyr::rename("lower" = "2.5 %",
                  "upper" = "97.5 %") %>%
    dplyr::mutate(lower = format(round(lower, digits = 2), nsmall = 2),
                  upper = format(round(upper, digits = 2), nsmall = 2))
  
  mod_1_c <-
    mod1_est %>%
    dplyr::left_join(mod1_conf, by = c("pol", "stove")) %>%
    dplyr::mutate(val = paste0(estimate, " (", lower, ", ", upper,")"))
  
  saveRDS(mod_1_c %>%
            dplyr::select(pol, stove, val), "model_confint/mod_1_c.RDS")
```

```{r}
  mod2_est <-
    all %>%
    dplyr::group_by(pol) %>%
    dplyr::do(est = tidy(lm(val ~ pm_mass, data = .))) %>%
    tidyr::unnest(est) %>%
    dplyr::select(pol, term, estimate) %>%
    dplyr::mutate(estimate = format(round(estimate, digits = 2), nsmall = 2))

  mod2_conf <-
    all %>%
    dplyr::group_by(pol) %>%
    dplyr::do(conf = as_tibble(confint(lm(val ~ pm_mass , data = .)), rownames = "term")) %>%
    tidyr::unnest(conf) %>%
    dplyr::rename("lower" = "2.5 %",
                  "upper" = "97.5 %") %>%
    dplyr::select(pol, term, lower, upper) %>%
    dplyr::mutate(lower = format(round(lower, digits = 2), nsmall = 2),
                  upper = format(round(upper, digits = 2), nsmall = 2))
  
  mod_2_c <-
    mod2_est %>%
    dplyr::left_join(mod2_conf, by = c("pol", "term")) %>%
    dplyr::mutate(val = paste0(estimate, " (", lower, ", ", upper,")")) %>%
    dplyr::select(pol, term, val) %>%
    tidyr::spread(term, val)
  
  saveRDS(mod_2_c, "model_confint/mod_2_c.RDS")
```

```{r}
  mod3_est <-
    all %>%
    dplyr::group_by(pol) %>%
    dplyr::do(est = tidy(lm(val ~ co, data = .))) %>%
    tidyr::unnest(est) %>%
    dplyr::select(pol, term, estimate) %>%
    dplyr::mutate(estimate = format(round(estimate, digits = 2), nsmall = 2))

  mod3_conf <-
    all %>%
    dplyr::group_by(pol) %>%
    dplyr::do(conf = as_tibble(confint(lm(val ~ co, data = .)), rownames = "term")) %>%
    tidyr::unnest(conf) %>%
    dplyr::rename("lower" = "2.5 %",
                  "upper" = "97.5 %") %>%
    dplyr::select(pol, term, lower, upper) %>%
    dplyr::mutate(lower = format(round(lower, digits = 2), nsmall = 2),
                  upper = format(round(upper, digits = 2), nsmall = 2))
  
  mod_3_c <-
    mod3_est %>%
    dplyr::left_join(mod3_conf, by = c("pol", "term")) %>%
    dplyr::mutate(val = paste0(estimate, " (", lower, ", ", upper,")")) %>%
    dplyr::select(pol, term, val) %>%
    tidyr::spread(term, val)
  
  saveRDS(mod_3_c, "model_confint/mod_3_c.RDS")
```

```{r}
  mod4_est <-
    all %>%
    dplyr::group_by(pol) %>%
    dplyr::do(est = tidy(lm(val ~ pm_mass + co, data = .))) %>%
    tidyr::unnest(est) %>%
    dplyr::select(pol, term, estimate) %>%
    dplyr::mutate(estimate = format(round(estimate, digits = 2), nsmall = 2))

  mod4_conf <-
    all %>%
    dplyr::group_by(pol) %>%
    dplyr::do(conf = as_tibble(confint(lm(val ~ pm_mass + co, data = .)), rownames = "term")) %>%
    tidyr::unnest(conf) %>%
    dplyr::rename("lower" = "2.5 %",
                  "upper" = "97.5 %") %>%
    dplyr::select(pol, term, lower, upper) %>%
    dplyr::mutate(lower = format(round(lower, digits = 2), nsmall = 2),
                  upper = format(round(upper, digits = 2), nsmall = 2))
  
  mod_4_c <-
    mod4_est %>%
    dplyr::group_by(pol, term) %>%
    dplyr::left_join(mod4_conf, by = c("pol", "term")) %>%
    dplyr::mutate(val = paste0(estimate, " (", lower, ", ", upper,")")) %>%
    dplyr::select(pol, val) %>%
    tidyr::spread(term, val)
  
  saveRDS(mod_4_c, "model_confint/mod_4_c.RDS")
```


```{r}
  mod5_est <-
    all %>%
    dplyr::group_by(pol) %>%
    dplyr::do(est = tidy(lm(val ~ stove + pm_mass - 1, data = .))) %>%
    tidyr::unnest(est) %>%
    dplyr::rename("stove" = "term") %>%
    dplyr::mutate(stove = gsub("stove", "", stove)) %>%
    dplyr::select(pol, stove, estimate) %>%
    dplyr::mutate(estimate = format(round(estimate, digits = 2), nsmall = 2))

  mod5_conf <-
    all %>%
    dplyr::group_by(pol) %>%
    dplyr::do(conf = as_tibble(confint(lm(val ~ stove + pm_mass - 1, data = .)), rownames = "stove")) %>%
    tidyr::unnest(conf) %>%
    dplyr::mutate(stove = gsub("stove", "", stove)) %>%
    dplyr::rename("lower" = "2.5 %",
                  "upper" = "97.5 %") %>%
    dplyr::mutate(lower = format(round(lower, digits = 2), nsmall = 2),
                  upper = format(round(upper, digits = 2), nsmall = 2))
  
  mod_5_c <-
    mod5_est %>%
    dplyr::left_join(mod5_conf, by = c("pol", "stove")) %>%
    dplyr::mutate(val = paste0(estimate, " (", lower, ", ", upper,")"))
  
  mod_5_pm <-
    mod_5_c %>%
    dplyr::filter(stove == "pm_mass") %>%
    tidyr::spread(stove, val) %>%
    dplyr::select(pol, pm_mass)
  
  mod_5_c <-
    mod_5_c %>%
    dplyr::filter(stove != "pm_mass") %>%
    dplyr::left_join(mod_5_pm, by = "pol")
  
  saveRDS(mod_5_c %>%
            dplyr::select(pol, stove, val, pm_mass), "model_confint/mod_5_c.RDS")
```

```{r}
  mod6_est <-
    all %>%
    dplyr::group_by(pol) %>%
    dplyr::do(est = tidy(lm(val ~ stove + co - 1, data = .))) %>%
    tidyr::unnest(est) %>%
    dplyr::rename("stove" = "term") %>%
    dplyr::mutate(stove = gsub("stove", "", stove)) %>%
    dplyr::select(pol, stove, estimate) %>%
    dplyr::mutate(estimate = format(round(estimate, digits = 2), nsmall = 2))

  mod6_conf <-
    all %>%
    dplyr::group_by(pol) %>%
    dplyr::do(conf = as_tibble(confint(lm(val ~ stove + co - 1, data = .)), rownames = "stove")) %>%
    tidyr::unnest(conf) %>%
    dplyr::mutate(stove = gsub("stove", "", stove)) %>%
    dplyr::rename("lower" = "2.5 %",
                  "upper" = "97.5 %") %>%
    dplyr::mutate(lower = format(round(lower, digits = 2), nsmall = 2),
                  upper = format(round(upper, digits = 2), nsmall = 2))
  
  mod_6_c <-
    mod6_est %>%
    dplyr::left_join(mod6_conf, by = c("pol", "stove")) %>%
    dplyr::mutate(val = paste0(estimate, " (", lower, ", ", upper,")"))
  
  mod_6_co <-
    mod_6_c %>%
    dplyr::filter(stove == "co") %>%
    tidyr::spread(stove, val) %>%
    dplyr::select(pol, co)
  
  mod_6_c <-
    mod_6_c %>%
    dplyr::filter(stove != "co") %>%
    dplyr::left_join(mod_6_co, by = "pol")
  
  saveRDS(mod_6_c %>%
            dplyr::select(pol, stove, val, co), "model_confint/mod_6_c.RDS")
```

```{r}
  mod7_est <-
    all %>%
    dplyr::group_by(pol) %>%
    dplyr::do(est = tidy(lm(val ~ stove + co + pm_mass - 1, data = .))) %>%
    tidyr::unnest(est) %>%
    dplyr::rename("stove" = "term") %>%
    dplyr::mutate(stove = gsub("stove", "", stove)) %>%
    dplyr::select(pol, stove, estimate) %>%
    dplyr::mutate(estimate = format(round(estimate, digits = 2), nsmall = 2))

  mod7_conf <-
    all %>%
    dplyr::group_by(pol) %>%
    dplyr::do(conf = as_tibble(confint(lm(val ~ stove + co + pm_mass - 1, data = .)), rownames = "stove")) %>%
    tidyr::unnest(conf) %>%
    dplyr::mutate(stove = gsub("stove", "", stove)) %>%
    dplyr::rename("lower" = "2.5 %",
                  "upper" = "97.5 %") %>%
    dplyr::mutate(lower = format(round(lower, digits = 2), nsmall = 2),
                  upper = format(round(upper, digits = 2), nsmall = 2))
  
  mod_7_c <-
    mod7_est %>%
    dplyr::left_join(mod7_conf, by = c("pol", "stove")) %>%
    dplyr::mutate(val = paste0(estimate, " (", lower, ", ", upper,")"))
  
  mod_7_co_pm <-
    mod_7_c %>%
    dplyr::filter(grepl("^co|pm", stove)) %>%
    dplyr::select(pol, stove, val) %>%
    tidyr::spread(stove, val) %>%
    dplyr::select(pol, co, pm_mass)
  
  mod_7_c <-
    mod_7_c %>%
    dplyr::filter(stove != "co", stove != "pm_mass") %>%
    dplyr::left_join(mod_7_co_pm, by = "pol")
  
  saveRDS(mod_7_c %>%
            dplyr::select(pol, stove, val, co, pm_mass), "model_confint/mod_7_c.RDS")
```