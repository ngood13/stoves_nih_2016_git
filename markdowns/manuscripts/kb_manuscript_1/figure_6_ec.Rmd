---
title: "figure 4: correlation plots"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r load_libraries, echo=FALSE, message=FALSE}
  if (!require("pacman")) install.packages("pacman")
  pacman::p_load(tidyverse, patchwork, lme4, kableExtra, stats4, broom, MuMIn)
```

```{r global_options, echo=FALSE}
  knitr::opts_chunk$set(fig.path ='figures/',
                        warning = FALSE, message = FALSE, cache = FALSE)
```

# Tidy data for models

## load data

```{r}
  emissions <- readRDS("../../../r_data/emissions_factors.RDS")
  samples <- readRDS("../../../r_data/samples.RDS")
```

## add stove fuel info

```{r}
  emissions <-
    emissions %>%
    dplyr::left_join(samples %>%
                       dplyr::select(id, stove, fuel, stovecat, fuelcat), by = "id")
```

## Select metric

```{r}
  emissions <-
    emissions %>%
    dplyr::mutate(val = ifelse(bg == "below", 0, val)) %>%
    dplyr::filter(!is.na(val), metric == "energy_delivered_ef") %>%
    dplyr::filter(pol != "ec_unc", pol != "oc_unc", pol != "om_unc",
                  pol != "oc", 
                  pol != "cyclopenta[ce]phenanthrylene",
                  pol != "inositol")
```

## Rename pollutants

```{r}
  emissions <-
    emissions %>%
    dplyr::mutate(pol = gsub("indeno\\(1,2,3\\) cd pyrene", "indeno\\[1,2,3-cd\\]pyrene", pol),
                  pol = gsub("\\(ah\\)",  "\\[a,h\\]", pol),
                  pol = gsub("b\\[",  "benzo\\[", pol),
                  pol = gsub("b\\[",  "benzo\\[", pol),
                  pol = gsub("benz\\[",  "benzo\\[", pol),
                  pol = gsub("benzo\\[a\\]anthracene",  "benz\\[a\\]anthracene", pol)) %>%
    dplyr::mutate(pol = ifelse(grepl("^co2$", pol), "carbon dioxide", pol),
                  pol = ifelse(grepl("^ch4$", pol), "methane", pol),
                  pol = ifelse(grepl("ultrafines", pol), "ultrafine particles", pol),
                  pol = ifelse(grepl("^om$", pol), "organic aerosol", pol),
                  pol = ifelse(grepl("^oc$", pol), "organic carbon", pol),
                  #pol = ifelse(grepl("^ec$", pol), "elemental carbon", pol),
                  pol = ifelse(grepl("pinene", pol), "alpha-pinene", pol),
                  pol = ifelse(grepl("2_methyl_2_butene", pol), "2-methyl-2-butene", pol),
                  pol = gsub("([0-9])(_)([0-9])", "\\1,\\3", pol),
                  pol = gsub("([0-9])(_)([0-9])", "\\1,\\3", pol),
                  pol = gsub("([0-9])(_)([a-z])", "\\1-\\3", pol),
                  pol = gsub("([a-z])(_)([0-9])", "\\1,\\3", pol),
                  pol = gsub("(m)(_)(p)", "\\1,\\3", pol),
                  pol = gsub("([a-z])(_)([a-z])", "\\1-\\3", pol),
                  pol = gsub("pm-mass", "pm_mass", pol))
```

```{r}
  missing_pm_co <-
    emissions %>%
    dplyr::filter(bg != "below") %>%
    dplyr::select(id, pol, val, stove, fuel) %>%
    tidyr::spread(pol, val) %>%
    dplyr::select(id, pm_mass, co) %>%
    na.omit %>%
    dplyr::select(id)
```

## Print names of pollutants with greater than than 15% of the data missing

```{r}
  bb <-
    emissions %>%
      dplyr::group_by(pol) %>%
      dplyr::summarise(prct_ab = sum(bg == "below") / n()) %>%
      dplyr::filter(prct_ab >= 0.15) %>%
      dplyr::select(-prct_ab)

  bb %>%
    knitr::kable('markdown', align = 'c')
```

## Print names of pollutants less than three data points above background for a particular stove type

```{r}
  missing_stove <-
    emissions %>%
    #dplyr::inner_join(missing_pm_co) %>%
    dplyr::group_by(pol, stove) %>%
    dplyr::summarise(prct_ab = sum(bg == "above")) %>%
    dplyr::filter(prct_ab < 3) %>%
    dplyr::select(-prct_ab) %>%
    dplyr::distinct()

  saveRDS(missing_stove, "../../../r_data/model_info_stove.RDS")

  missing_stove %>%
    knitr::kable('markdown', align = 'c')
```

## Print names of pollutants less than three data points above background for a particular fuel type

```{r}
  missing_fuel <-
    emissions %>%
    #dplyr::inner_join(missing_pm_co) %>%
    dplyr::group_by(pol, fuel) %>%
    dplyr::summarise(prct_ab = sum(bg == "above")) %>%
    dplyr::filter(prct_ab < 3) %>%
    dplyr::select(-prct_ab) %>%
    dplyr::distinct()

  saveRDS(missing_fuel, "../../../r_data/model_info_fuel.RDS")

  missing_stove %>%
    knitr::kable('markdown', align = 'c')
```

# Leave-one-out cross validation

## Tidy data

* Remove data points with greater than 15% of the data missing
* Remove data points with less than three data points per stove type
* Only complete observations retained
* remove data below background

```{r}
  all <-
    emissions %>%
    dplyr::anti_join(bb, by = "pol") %>%
    dplyr::anti_join(missing_stove, by = c("pol", "stove")) %>%
    dplyr::anti_join(missing_fuel, by = c("pol", "fuel")) %>%
    dplyr::filter(bg != "below") %>%
    dplyr::select(id, pol, val, stove, fuel) %>%
    tidyr::spread(pol, val) %>%
    tidyr::gather("pol", "val", -id, -stove, -ec, -fuel) %>%
    dplyr::mutate(ec = log(ec),
                  val = log(val)) %>%
    na.omit
```

## Get list of pollutants for loop

```{r}
  pols <-
    all %>%
    dplyr::select(pol) %>%
    dplyr::distinct() %>%
    dplyr::filter(pol != "pm_mass", pol != "co")
```

## PM2.5 and CO model

```{r}
  pred_metrics <- 
    pols %>%
    dplyr::mutate(rmse_mod = NA,
                  rmse_mean = NA,
                  rrmse = NA)

  for (n in 1:nrow(pols)) {
    
    mod_data <-
      all %>%
      dplyr::filter(pol == pols$pol[n])
    
    obs_mean = mean(mod_data$val)

    obs_mod_sqdiff <- rep(NA, len = nrow(mod_data))
    obs_mean_sqdiff <- rep(NA, len = nrow(mod_data))
  
    for(i in 1:nrow(mod_data)) {
      
      training <- mod_data[-i,]
      prediction <- mod_data[i,]
      
      mdl <- lm(val ~ ec, data = training) # model with i'th observation out
      y_pred <- predict(mdl, newdata = prediction) # predict i'th observation
      obs_mod_sqdiff[i] <- (prediction$val - y_pred)^2 # obs - model squared
      obs_mean_sqdiff[i] <- (prediction$val - obs_mean)^2 # obs - model squared

    }
    pred_metrics$rmse_mod[n] <- sqrt(mean(obs_mod_sqdiff)) # root mean squared error
    pred_metrics$rmse_mean[n] <- sqrt(mean(obs_mean_sqdiff)) # root mean squared error
    pred_metrics$rrmse[n] <- pred_metrics$rmse_mod[n] / pred_metrics$rmse_mean[n] # relative root mean squared error
  }
```

## PM2.5, CO, and stove type model

```{r}
  pred_metrics2 <- 
    pols %>%
    dplyr::mutate(rmse_mod = NA,
                  rmse_mean = NA,
                  rrmse = NA)

  for (n in 1:nrow(pols)) {
    
    mod_data <-
      all %>%
      dplyr::filter(pol == pols$pol[n])
    
    obs_mean = mean(mod_data$val)

    obs_mod_sqdiff <- rep(NA, len = nrow(mod_data))
    obs_mean_sqdiff <- rep(NA, len = nrow(mod_data))
  
    for(i in 1:nrow(mod_data)) {
      
      training <- mod_data[-i,]
      prediction <- mod_data[i,]
      
      mdl <- lm(val ~ ec + stove, data = training) # model with i'th observation out
      y_pred <- predict(mdl, newdata = prediction) # predict i'th observation
      obs_mod_sqdiff[i] <- (prediction$val - y_pred)^2 # obs - model squared
      obs_mean_sqdiff[i] <- (prediction$val - obs_mean)^2 # obs - model squared

    }
    pred_metrics2$rmse_mod[n] <- sqrt(mean(obs_mod_sqdiff)) # root mean squared error
    pred_metrics2$rmse_mean[n] <- sqrt(mean(obs_mean_sqdiff)) # root mean squared error
    pred_metrics2$rrmse[n] <- pred_metrics2$rmse_mod[n] / pred_metrics2$rmse_mean[n] # relative root mean squared error
  }
```

## PM2.5, CO, and fuel type

```{r}
  pred_metrics_3 <- 
    pols %>%
    dplyr::mutate(rmse_mod = NA,
                  rmse_mean = NA,
                  rrmse = NA)

  for (n in 1:nrow(pols)) {
    
    mod_data <-
      all %>%
      dplyr::filter(pol == pols$pol[n])
    
    obs_mean = mean(mod_data$val)

    obs_mod_sqdiff <- rep(NA, len = nrow(mod_data))
    obs_mean_sqdiff <- rep(NA, len = nrow(mod_data))
  
    for(i in 1:nrow(mod_data)) {
      
      training <- mod_data[-i,]
      prediction <- mod_data[i,]
      
      mdl <- lm(val ~ ec + fuel, data = training) # model with i'th observation out
      y_pred <- predict(mdl, newdata = prediction) # predict i'th observation
      obs_mod_sqdiff[i] <- (prediction$val - y_pred)^2 # obs - model squared
      obs_mean_sqdiff[i] <- (prediction$val - obs_mean)^2 # obs - model squared

    }
    pred_metrics_3$rmse_mod[n] <- sqrt(mean(obs_mod_sqdiff)) # root mean squared error
    pred_metrics_3$rmse_mean[n] <- sqrt(mean(obs_mean_sqdiff)) # root mean squared error
    pred_metrics_3$rrmse[n] <- pred_metrics_3$rmse_mod[n] / pred_metrics_3$rmse_mean[n] # relative root mean squared error
  }
```

## Plotting

## Relative root Mean Squared Error

```{r figure_6_ec, fig.height=5, fig.width=12, dpi=400, dev='pdf'}
  #p1 <-
    pred_metrics %>%
    dplyr::mutate(model = 1,
                  model =
                    model %>% 
                    factor %>% 
                    forcats::fct_relevel("1",
                                         "2",
                                         "3")) %>%
      ggplot(aes(x = reorder(pol, rrmse), y = rrmse, color = model, stroke = 1)) +
        geom_hline(yintercept = 0, color = "darkcyan", lwd = 1.5, alpha = 0.8) +
        geom_hline(yintercept = 1, color = "orange", lwd = 1.5, alpha = 0.8) +
        geom_point(stat = "identity") +
        geom_point(data = pred_metrics2  %>%
                         dplyr::mutate(model = 2,
                                          model =
                                            model %>% 
                                            factor %>% 
                                            forcats::fct_relevel("1",
                                                                 "2",
                                                                 "3")), aes(x = pol, y = rrmse, color = model)) +
        geom_point(data = pred_metrics_3  %>%
                         dplyr::mutate(model = 3,
                                          model =
                                            model %>% 
                                            factor %>% 
                                            forcats::fct_relevel("1",
                                                                 "2",
                                                                 "3")), aes(x = pol, y = rrmse, color = model)) +
        scale_color_manual(values = c("dodgerblue2", "yellowgreen", "red"),
                          labels = c(expression(paste('Model 1: EC')),
                                     expression(paste('Model 2: EC and stove type')),
                                     expression(paste('Model 3: EC and fuel type')))) +
        scale_y_continuous(limits = c(0, 1.13), breaks = c(0, 0.25, 0.5, 0.75, 1.0)) +
        guides(color = guide_legend(nrow = 1, byrow = FALSE, override.aes = list(size=2))) +
        theme_bw() +
        theme(text = element_text(size = 18),
              axis.title.x = element_blank(),
              axis.text.x = element_text(angle = 90, hjust=0.95, vjust = 0.2, size = 10),
              legend.position = c(0.5, 0.25),
              legend.title = element_blank()) +
        geom_text(aes(y = 0.0, x = 12, label="highly performing models\n"), colour = "darkcyan", size = 6) +
        geom_text(aes(y = 1, x = 12, label = "poorly performing models\n"), colour = "orange", size = 6) +
        ylab('RMSE ratio')
```

