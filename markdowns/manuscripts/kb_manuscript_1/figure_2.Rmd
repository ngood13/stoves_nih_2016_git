---
title: "Figure 2: PM composition and CO"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r load_libraries, echo=FALSE, message=FALSE}
  if (!require("pacman")) install.packages("pacman")
  pacman::p_load(tidyverse, pals, devtools, patchwork, Hmisc)
  #devtools::install_github("thomasp85/patchwork")
```

```{r global_options, echo=FALSE}
  knitr::opts_chunk$set(fig.path ='figures/',
                        warning = FALSE, message = FALSE, cache = FALSE)
```

# figure 1

## tidy data

load data

```{r}
  emissions <- readRDS("../../../r_data/emissions_factors.RDS")
  samples <- readRDS("../../../r_data/samples.RDS")
```

```{r}
  samples <-
    samples %>%
    dplyr::mutate(stove = 
                    stove %>% 
                    factor %>% 
                    forcats::fct_relevel("three-stone fire",
                                         "chulha",
                                         "rocket elbow",
                                         "built-in plancha",
                                         "fan rocket-elbow",
                                         "forced-draft gasifier",
                                         "ceramic charcoal",
                                         "metal charcoal",
                                         "wick kerosene",
                                         "pressure kerosene",
                                         "lpg") %>%
                    forcats::fct_recode("Three-stone\nfire" = "three-stone fire",
                                         "Mud\nchulha" = "chulha",
                                         "Rocket\nelbow" = "rocket elbow",
                                         "Built-in\nplancha" = "built-in plancha",
                                         "Fan rocket\nelbow" = "fan rocket-elbow",
                                         "Gasifier" = "forced-draft gasifier",
                                         "Ceramic\njiko" = "ceramic charcoal",
                                          "Metal\njiko" = "metal charcoal",
                                          "Wick\nkerosene" = "wick kerosene",
                                         "Pressure\nkerosene" = "pressure kerosene",
                                          "LPG" = "lpg"))
```

## add stove fuel info

```{r}
  emissions <-
    emissions %>%
    dplyr::left_join(samples %>%
                       dplyr::select(id, stove, fuel, stovecat, fuelcat), by = "id")
```

## replace below background values with zero

```{r}
  emissions <-
    emissions %>%
    dplyr::mutate(val = ifelse(bg == "below", 0, val))
```

## rename pollutants

```{r}
  emissions <-
    emissions %>%
    dplyr::mutate(pol_category = ifelse(grepl("^ec$", pol_category), "elemental carbon", pol_category),
                  pol_category = ifelse(grepl("^om$", pol_category), "organic matter", pol_category),
                  pol_category = ifelse(grepl("ions", pol_category), "inorganic ions", pol_category),
                  pol = ifelse(grepl("^co$", pol), "carbon monoxide", pol))
```

## select pollutants

```{r}
  ec_oc_ions <-
    emissions %>%
    dplyr::filter(grepl("inorganic ions|elemental carbon|organic matter", pol_category)) %>%
    dplyr::filter(metric == "energy_delivered_ef")
```

```{r}
  pm_mass <-
    emissions %>%
    dplyr::filter(grepl("pm_mass", pol_category)) %>%
    dplyr::filter(metric == "energy_delivered_ef") %>%
    dplyr::mutate(pol_category = ifelse(grepl("pm_mass", pol_category), "PM2.5 mass", pol_category))
```

```{r}
  co <-
    emissions %>%
    dplyr::filter(grepl("monoxide", pol)) %>%
    dplyr::filter(metric == "energy_delivered_ef")
```

## remove outlier

```{r}
  ec_oc_ions <-
    ec_oc_ions %>%
    dplyr::filter(id != "6E")
```

# calculate range by pollutant

```{r}
  range_pm <-
    pm_mass %>%
    na.omit %>%
    dplyr::group_by(stove, stovecat) %>%
    dplyr::summarise(min = min(val, na.rm = TRUE),
                     max = max(val, na.rm = TRUE)) %>%
    tidyr::gather("var", "val", min, max) %>%
    dplyr::mutate(sym = ifelse(var == "min", "[", "]"))
```

```{r}
  range_co <-
    co %>%
    dplyr::group_by(stove, stovecat) %>%
    dplyr::mutate(val = val / 1000) %>%
    dplyr::summarise(min = min(val, na.rm = TRUE),
                     max = max(val, na.rm = TRUE)) %>%
    tidyr::gather("var", "val", min, max) %>%
    dplyr::mutate(sym = ifelse(var == "min", "[", "]"))
```

# calculate means by pollutant

```{r}
  pm_mass_p <-
    pm_mass %>%
    dplyr::group_by(pol_category, stove, stovecat) %>%
    dplyr::summarise(val = mean(val, na.rm = TRUE)) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(pol = "PM2.5 mass",
                  pol_category = "PM2.5 mass")
```

```{r}
  ec_oc_ions_p <-
    ec_oc_ions %>%
    dplyr::group_by(id, pol_category, stove, fuel, stovecat, fuelcat) %>%
    dplyr::summarise(val = sum(val, na.rm = TRUE)) %>%
    tidyr::spread(pol_category, val) %>%
    na.omit %>%
    tidyr::gather(pol_category, val, 6:8) %>%
    dplyr::group_by(pol_category, stove, stovecat, fuelcat) %>%
    dplyr::summarise(val = mean(val, na.rm = TRUE)) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(pol = pol_category,
                  pol = 
                    pol %>% 
                    factor %>% 
                    forcats::fct_relevel("PM2.5 mass",
                                         "organic matter",
                                         "elemental carbon",
                                         "inorganic ions") %>%
                    forcats::fct_rev(),
                  pol_category = "PM2.5 mass")
```

```{r}
  co_p <-
    co %>%
    dplyr::group_by(pol, stove, stovecat) %>%
    dplyr::mutate(val = val / 1000) %>%
    dplyr::summarise(mean = mean(val, na.rm = TRUE)) %>%
    dplyr::mutate(pol_category = "carbon monoxide")
```

## figure 1

```{r, echo=FALSE}
  p1 <-
    pm_mass_p %>%
    dplyr::mutate(pol_category = "paste(PM[2.5], ' composition')") %>%
      ggplot(aes(x = stove, y = val)) +
      geom_histogram(fill = "#999999", stat = "identity") +
      geom_histogram(data = ec_oc_ions_p %>%
                           dplyr::mutate(pol =
                                           pol %>% 
                                           factor %>%
                                           forcats::fct_expand("PM2.5 mass"),
                                           forcats::fct_relevel("inorganic ions",
                                                                "elemental carbon",
                                                                "organic matter",
                                                                "PM2.5 mass")),
                     aes(x = stove, y = val, fill = pol, order = pol), stat = "identity", width = 0.6) +
      scale_fill_manual(values = c("#E69F00", "gray30", "snow2", "#999999"),
                        labels = c("inorganic ions", "elemental carbon",
                                   "organic matter", expression(paste(PM[2.5], ' mass'))),
                        drop = FALSE) +
      guides(fill = guide_legend(nrow = 2, byrow = FALSE)) +
      scale_y_continuous(limits = c(0, 1050), breaks = c(0, 250, 500, 750, 1000)) +
      annotate("text", x = 1, y = 1050, label = "1609", size = 5) +
      annotate("text", x = 2, y = 1050, label = "2117", size = 5) +
      geom_text(data = range_pm,
                aes(x = stove, y = val, label = sym), size = 10, angle = 90, nudge_x = -0.05) +
      theme_minimal() +
      theme(legend.text.align = 0,
            text = element_text(size = 18),
            legend.justification = c(1, 1), 
            legend.position = c(1, 1),
            axis.text.y = element_text(size = 16),
            axis.text.x = element_text(size = 14),
            axis.title.x = element_blank(),
            legend.title = element_blank(), 
            legend.spacing.x = unit(0.25, 'cm'), 
            legend.spacing.y = unit(0.25, 'cm')) +
      ylab(expression(atop(paste(PM[2.5], ' composition'), paste('miligrams per Megajoul', e[delivered]))))
```

```{r}
  p2 <-
    co_p %>%
      ggplot(aes(x = stove, y = mean)) +
      geom_histogram(stat = "identity", fill = "cadetblue") +
      geom_text(data = range_co,
                aes(x = stove, y = val, label = sym), stroke = 2, size = 10, angle = 90, nudge_x = -0.05) +
        scale_y_continuous(limits = c(0, 25)) +
        annotate("text", x = 7, y = 25, label = "32.5", size = 5) +
        annotate("text", x = 8, y = 25, label = "30.1", size = 5) +
        theme_minimal() +
      theme(text = element_text(size = 18),
            legend.justification = c(1, 1), 
            legend.position = c(1, 1),
            axis.text.y = element_text(size = 16),
            axis.text.x = element_text(size = 14),
            axis.title.x = element_blank(),
            legend.title = element_blank()) +
      ylab(expression(atop(paste('Carbon monoxide'), paste('grams per Megajoul', e[delivered]))))
```

```{r figure_2, echo=FALSE, fig.width=12, fig.height=8, dpi=400, dev='pdf'}
  p1 + p2 + plot_layout(nrow = 2, heights = c(1, 1))
```

```{r, echo=FALSE, fig.width=12, fig.height=1.75, dpi=400, dev='pdf'}
  p3 <-
    pm_mass_p %>%
    dplyr::mutate(pol_category = "paste(PM[2.5], ' composition')") %>%
      ggplot(aes(x = stove, y = val)) +
      geom_histogram(fill = "#999999", stat = "identity") +
      geom_histogram(data = ec_oc_ions_p %>%
                           dplyr::mutate(pol =
                                           pol %>% 
                                           factor %>%
                                           forcats::fct_expand("PM2.5 mass"),
                                           forcats::fct_relevel("inorganic ions",
                                                                "elemental carbon",
                                                                "organic matter",
                                                                "PM2.5 mass")),
                     aes(x = stove, y = val, fill = pol, order = pol), stat = "identity", width = 0.6) +
      scale_fill_manual(values = c("#E69F00", "gray30", "snow2", "#999999"),
                        labels = c("inorganic ions", "elemental carbon",
                                   "organic matter", expression(paste(PM[2.5], ' mass'))),
                        drop = FALSE) +
      guides(fill = guide_legend(nrow = 2, byrow = FALSE)) +
      scale_y_continuous(limits = c(0, 15), breaks = c(0, 5, 10, 15), position = "right") +
      annotate("text", x = 9, y = 15, label = "22.7", size = 5) +
      geom_text(data = range_pm,
                aes(x = stove, y = val, label = sym), size = 10, angle = 90, nudge_x = -0.05) +
      theme_minimal() +
      theme(legend.text.align = 0,
            text = element_text(size = 18),
            legend.justification = c(1, 1), 
            legend.position = "none",
            axis.text.y = element_text(size = 16),
            axis.text.x = element_blank(),
            axis.title.x = element_blank(),
            legend.title = element_blank(),
            axis.title.y = element_text(colour = "white"),
            legend.spacing.x = unit(0.25, 'cm'), 
            legend.spacing.y = unit(0.25, 'cm')) +
      ylab(expression(atop(paste(PM[2.5], ' composition'), paste('miligrams per Megajoul', e[delivered]))))
```

```{r figure_2a, echo=FALSE, fig.width=12, fig.height=1.75, dpi=400, dev='pdf'}
  p3
```

```{r figure_2b, echo=FALSE, fig.width=12, fig.height=1.75, dpi=400, dev='pdf'}
    co_p %>%
      ggplot(aes(x = stove, y = mean)) +
      geom_histogram(stat = "identity", fill = "cadetblue") +
      geom_text(data = range_co,
                aes(x = stove, y = val, label = sym), stroke = 2, size = 10, angle = 90, nudge_x = -0.05) +
        scale_y_continuous(limits = c(0, 4), position = "right") +
        annotate("text", x = 7, y = 25, label = "32.5", size = 5) +
        annotate("text", x = 8, y = 25, label = "30.1", size = 5) +
        theme_minimal() +
      theme(text = element_text(size = 18),
            legend.justification = c(1, 1), 
            legend.position = c(1, 1),
            axis.text.x = element_blank(),
            axis.text.y = element_text(size = 16),
            axis.title.y = element_text(colour = "white"),
            axis.title.x = element_blank(),
            legend.title = element_blank()) +
      ylab(expression(atop(paste('Carbon monoxide'), paste('grams per Megajoul', e[delivered]))))
```

# summary information

## percent reduction

PM2.5

```{r, echo=FALSE}
  three_stone <- 
    pm_mass_p %>%
    dplyr::filter(stove == "Three-stone\nfire")

  pm_mass_p %>%
    dplyr::mutate(three_stone = three_stone$val[1]) %>%
    dplyr::mutate(prct_decrease = ((three_stone - val) / three_stone) * 100) %>%
    dplyr::select(stove, prct_decrease) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(stove = gsub("\n", " ", stove)) %>%
    knitr::kable("markdown", digits = 0, align = 'c')
```

Elemental carbon

```{r, echo=FALSE}
  three_stone <- 
    ec_oc_ions_p %>%
    dplyr::filter(stove == "Three-stone\nfire")
    

  ec_oc_ions_p %>%
    dplyr::filter(pol == "elemental carbon") %>%
    dplyr::mutate(three_stone = three_stone$val[1]) %>%
    dplyr::mutate(prct_decrease = ((three_stone - val) / three_stone) * 100) %>%
    dplyr::select(stove, prct_decrease) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(stove = gsub("\n", " ", stove)) %>%
    knitr::kable("markdown", digits = 0, align = 'c')
```

Organic matter

```{r, echo=FALSE}
  three_stone <- 
    ec_oc_ions_p %>%
    dplyr::filter(stove == "Three-stone\nfire")
    

  ec_oc_ions_p %>%
    dplyr::filter(pol == "organic matter") %>%
    dplyr::mutate(three_stone = three_stone$val[3]) %>%
    dplyr::mutate(prct_decrease = ((three_stone - val) / three_stone) * 100) %>%
    dplyr::select(stove, prct_decrease) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(stove = gsub("\n", " ", stove)) %>%
    knitr::kable("markdown", digits = 3, align = 'c')
```

Inorganic ions

```{r, echo=FALSE}
  three_stone <- 
    ec_oc_ions_p %>%
    dplyr::filter(stove == "Three-stone\nfire")
    

  ec_oc_ions_p %>%
    dplyr::filter(pol == "inorganic ions") %>%
    dplyr::mutate(three_stone = three_stone$val[2]) %>%
    dplyr::mutate(prct_decrease = ((three_stone - val) / three_stone) * 100) %>%
    dplyr::select(stove, prct_decrease) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(stove = gsub("\n", " ", stove)) %>%
    knitr::kable("markdown", digits = 0, align = 'c')
```

Carbon monoxide

```{r, echo=FALSE}
  three_stone <- 
    co_p %>%
    dplyr::filter(stove == "Three-stone\nfire")
    

  co_p %>%
    dplyr::mutate(three_stone = three_stone$mean[1]) %>%
    dplyr::mutate(prct_decrease = ((three_stone - mean) / three_stone) * 100) %>%
    dplyr::select(stove, prct_decrease) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(stove = gsub("\n", " ", stove)) %>%
    knitr::kable("markdown", digits = 0, align = 'c')
```

## carbon monoxide

average carbon monoxide by stove type

```{r, echo=FALSE}
  co %>%
    dplyr::group_by(stove) %>%
    dplyr::mutate(val = val / 1000) %>%
    dplyr::summarise(mean = mean(val, na.rm = TRUE),
                     min = min(val, na.rm = TRUE),
                     max = max(val, na.rm = TRUE)) %>%
    dplyr::mutate(stove = gsub("\n", " ", stove)) %>%
    dplyr::arrange(mean) %>%
    knitr::kable("markdown", digits = 1, align = 'c')
```

## pm mass

average pm mass by stove type

```{r, echo=FALSE}
  pm_mass %>%
    dplyr::group_by(stove) %>%
    dplyr::summarise(mean = mean(val, na.rm = TRUE),
                     min = min(val, na.rm = TRUE),
                     max = max(val, na.rm = TRUE)) %>%
    dplyr::mutate(stove = gsub("\n", " ", stove)) %>% 
    knitr::kable("markdown", digits = 1, align = 'c')
```

## pm composition

average pm composition by stove type

```{r, echo=FALSE}
  ec_oc_ions %>%
    dplyr::group_by(id, pol_category, stove) %>%
    dplyr::summarise(val = sum(val, na.rm = TRUE)) %>%
    tidyr::spread(pol_category, val) %>%
    na.omit %>%
    tidyr::gather(pol_category, val, 3:5) %>%
    dplyr::group_by(pol_category, stove) %>%
    dplyr::summarise(mean = mean(val, na.rm = TRUE),
                     min = min(val, na.rm = TRUE),
                     max = max(val, na.rm = TRUE)) %>%
    dplyr::mutate(stove = gsub("\n", " ", stove)) %>% 
    dplyr::arrange(mean) %>%
    knitr::kable("markdown", digits = 2, align = 'c')
```
