---
title: "figure 4: correlation plots"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r load_libraries, echo=FALSE, message=FALSE}
  if (!require("pacman")) install.packages("pacman")
  pacman::p_load(tidyverse, lme4, kableExtra, stats4, broom)
```

```{r global_options, echo=FALSE}
  knitr::opts_chunk$set(fig.path ='figures/',
                        warning = FALSE, message = FALSE, cache = FALSE)
```

# tidy data

load data

```{r}
  emissions <- readRDS("../../../r_data/emissions_factors.RDS")
  samples <- readRDS("../../../r_data/samples.RDS")
```

## add stove fuel info

```{r}
  emissions <-
    emissions %>%
    dplyr::left_join(samples %>%
                       dplyr::select(id, stove, fuel, stovecat, fuelcat), by = "id")
```

## filter out values below background, NA values, and select metric

```{r}
  emissions <-
    emissions %>%
    dplyr::filter(bg != "below", !is.na(val), metric == "energy_delivered_ef", !(val <= 0)) %>%
    dplyr::filter(pol != "ec_unc", pol != "oc_unc", pol != "cyclopenta[ce]phenanthrylene")
```

## rename pollutants

```{r}
  emissions <-
    emissions %>%
    dplyr::mutate(pol_subcategory = as.character(pol_subcategory),
                  pol_subcategory = ifelse(grepl("organic matter", pol_subcategory), "particle-phase organic matter", pol_subcategory),
                  pol_subcategory = ifelse(grepl("ions", pol_subcategory), "inorganic ions", pol_subcategory),
                  pol_subcategory = ifelse(grepl("^co2$", pol_subcategory), "carbon dioxide", pol_subcategory),
                  pol_subcategory = ifelse(grepl("^ch4$", pol_subcategory), "methane", pol_subcategory),
                  pol_subcategory = ifelse(grepl("ultrafines", pol_subcategory), "ultrafine particles", pol_subcategory),
                  pol_subcategory = ifelse(grepl("alkanes", pol_subcategory), "gas-phase alkanes", pol_subcategory),
                  pol_subcategory = ifelse(grepl("alkenes", pol_subcategory), "gas-phase alkenes", pol_subcategory),
                  pol_subcategory = ifelse(grepl("alkynes", pol_subcategory), "gas-phase alkynes", pol_subcategory),
                  pol_subcategory = ifelse(grepl("aromatics", pol_subcategory), "gas-phase aromatics", pol_subcategory),
                  pol_subcategory = gsub(" rings", "-ring PAHs", pol_subcategory)) %>%
    dplyr::mutate(pol = gsub("indeno\\(1,2,3\\) cd pyrene", "indeno\\[1,2,3-cd\\]pyrene", pol),
                  pol = gsub("\\(ah\\)",  "\\[a,h\\]", pol),
                  pol = gsub("b\\[",  "benzo\\[", pol),
                  pol = gsub("b\\[",  "benzo\\[", pol),
                  pol = gsub("benz\\[",  "benzo\\[", pol),
                  pol = gsub("benzo\\[a\\]anthracene",  "benz\\[a\\]anthracene", pol))
```

## check number of data points by stove type

```{r, echo=FALSE}
  emissions %>%
    dplyr::group_by(pol, stove) %>% 
    dplyr::do(val = round(nrow(.), 2)) %>%
    dplyr::mutate(val = cell_spec(val, "html", color = ifelse(val < 3, "red", "blue"))) %>%
    dplyr::arrange(val) %>%
    knitr::kable("markdown", align = 'c')
```

```{r, echo=FALSE}
  small_samples <- 
    emissions %>%
    dplyr::group_by(pol, stove) %>% 
    dplyr::do(val = round(nrow(.), 2)) %>%
    dplyr::filter(val <= 1) %>%
    dplyr::select(-val)
```

notes: 

* total number of burn tests were 87
* temperature data missing for 10 tests - brings total down to 77

## number of data points for liquid-fuel stoves (only three replicates of each test)

```{r, echo=FALSE, eval=FALSE}
  emissions %>%
    dplyr::group_by(pol, stove) %>%
    dplyr::filter(grepl("pressure|lpg|wick", stove)) %>%
    dplyr::do(val = round(nrow(.), 2)) %>%
    dplyr::mutate(val = cell_spec(val, "html", color = ifelse(val <= 2, "red", "blue"))) %>%
    dplyr::arrange(val) %>%
    tidyr::spread(stove, val) %>%
    knitr::kable("markdown", align = 'c')
```

notes: 

* the smallest number of total data points is 19 which seems like enough to run a regression analysis
* should there be a minimum number by stove type?

## log transform pollutants

```{r}
  all <-
    emissions %>%
    dplyr::select(id, pol, val, stove) %>%
    dplyr::anti_join(small_samples, by = c("stove", "pol")) %>%
    tidyr::spread(pol, val) %>%
    tidyr::gather("pol", "val", -id, -stove, -pm_mass, -co) %>%
    dplyr::mutate(pm_mass = log(pm_mass),
                  co = log(co),
                  val = log(val)) %>%
    na.omit
```

notes:

* only complete observations retained

## check number of data points

```{r, echo=FALSE}
  liquid_num <-
    all %>%
    dplyr::group_by(pol, stove) %>%
    dplyr::filter(grepl("pressure|lpg|wick", stove)) %>%
    dplyr::do(val = round(nrow(.), 2)) %>%
    dplyr::mutate(val = as.numeric(val)) %>%
    tidyr::spread(stove, val)

  num_data_points <-
    all %>%
    dplyr::group_by(pol) %>% 
    dplyr::count() %>%
    dplyr::ungroup() %>%
    dplyr::left_join(liquid_num, by = "pol") %>%
    dplyr::arrange(n) %>%
    dplyr::rename("pol" = "pol",
                  "all stoves" = "n")

  readr::write_csv(num_data_points,
                   "../../../qaqc_files/num_data_points_all.csv",
                   append = FALSE)
```

## subset

```{r}
  gases <-
    emissions %>%
    dplyr::filter(grepl("^benzene|formaldehyde|styrene|acetaldehyde|isoprene", pol)) %>%
    dplyr::filter(metric == "energy_delivered_ef") %>%
    dplyr::select(id, pol, val, stove, stovecat)

  particles <-
    emissions %>%
    dplyr::filter(grepl("b.a.pyrene|dibenzo.*anthracene|cyclopenta.*pyrene|b.*anthracene|b...fluoranthene|indeno", pol)) %>%
    dplyr::filter(metric == "energy_delivered_ef") %>%
    dplyr::select(id, pol, val, stove, stovecat)

  subcat <-
    emissions %>%
    dplyr::filter(!grepl("^oc$", pol), !grepl("unc", pol)) %>%
    dplyr::select(id, pol_subcategory, val, stove, stovecat) %>%
    dplyr::ungroup() %>%
    dplyr::group_by(id, pol_subcategory) %>%
    dplyr::mutate(val = sum(val, na.rm = TRUE)) %>%
    dplyr::rename("pol" = "pol_subcategory") %>%
    dplyr::distinct() %>%
    dplyr::bind_rows(gases) %>%
    dplyr::bind_rows(particles) %>%
    tidyr::spread(pol, val) %>%
    tidyr::gather("pol", "val", -id, -stove, -pm_mass, -co, -stovecat) %>%
    dplyr::mutate(pm_mass = log(pm_mass),
                  co = log(co),
                  val = log(val)) %>%
    na.omit
```

```{r, echo=FALSE}
  liquid_num <-
    subcat %>%
    dplyr::group_by(pol, stove) %>%
    dplyr::filter(grepl("pressure|lpg|wick", stove)) %>%
    dplyr::do(val = round(nrow(.), 2)) %>%
    dplyr::mutate(val = as.numeric(val)) %>%
    tidyr::spread(stove, val)

  num_data_points <-
    subcat %>%
    dplyr::group_by(pol) %>% 
    dplyr::count() %>%
    dplyr::ungroup() %>%
    dplyr::left_join(liquid_num, by = "pol") %>%
    dplyr::arrange(n) %>%
    dplyr::rename("pol" = "pol",
                  "all stoves" = "n")

  readr::write_csv(num_data_points,
                   "../../../qaqc_files/num_data_points_subcat.csv",
                   append = FALSE)
```

# subcat models

## run

```{r}
  subcat_m <-
    subcat %>%
    dplyr::group_by(pol) %>%
    dplyr::do(mod_1 = lm(val ~ stove, data = .),
              mod_2 = lm(val ~ pm_mass, data = .),
              mod_3 = lm(val ~ co, data = .),
              mod_4 = lm(val ~ pm_mass + co, data = .),
              mod_5 = lm(val ~ pm_mass + stove, data = .),
              mod_6 = lm(val ~ co + stove, data = .),
              mod_7 = lm(val ~ pm_mass + co + stove, data = .)) %>%
    dplyr::mutate("stove type only" = summary(mod_1)$r.squared,
                  "pm only" = summary(mod_2)$r.squared,
                  "co only" = summary(mod_3)$r.squared,
                  "pm and co" = summary(mod_4)$r.squared,
                  "pm and stove type" = summary(mod_5)$r.squared,
                  "co and stove type" = summary(mod_6)$r.squared,
                  "pm, co, and stove type" = summary(mod_7)$r.squared) %>%
    tidyr::gather("model", "val", -pol) %>%
    dplyr::filter(!grepl("mod", model)) %>%
    dplyr::mutate(val = as.numeric(val))
```

## plot

* plot is sorted by R2-value of top model
* pollutants are colored by pollutant cateogry

```{r models_subcat, echo=FALSE, fig.height=6, fig.width=12}
  subcat_m %>%
  dplyr::mutate(model = 
                  model %>%
                  factor %>%
                  forcats::fct_relevel("stove type only",
                                       "pm only",
                                       "co only",
                                       "pm and co",
                                       "pm and stove type",
                                       "co and stove type",
                                       "pm, co, and stove type")) %>%
    ggplot(aes(x = reorder(pol, val, max), y = val)) +
      geom_point(aes(color = model, shape = model), size = 2, stroke = 1, alpha = 0.75) +
      scale_color_manual(values = c("blueviolet", "orange", "orange", "orange",
                                    "turquoise3", "turquoise3", "turquoise3"),
                        labels = c("Stove type only", expression(paste(PM[2.5], ' mass only')),
                                   "CO only", expression(paste(PM[2.5], ' mass and CO')),
                                   expression(paste(PM[2.5], ' mass and stove type')),
                                   "CO and stove type",
                                   expression(paste(PM[2.5], ' mass, CO, and stove type')))) +
      scale_shape_manual(values = c(1, 2, 3, 4, 2, 3, 4),
                        labels = c("Stove type only", expression(paste(PM[2.5], ' mass only')),
                                   "CO only", expression(paste(PM[2.5], ' mass and CO')),
                                   expression(paste(PM[2.5], ' mass and stove type')),
                                   "CO and stove type",
                                   expression(paste(PM[2.5], ' mass, CO, and stove type')))) +
      coord_flip() +
      theme_minimal() +
    scale_y_continuous(limits = c(0, 1)) +
    theme(legend.text.align = 0,
          text = element_text(size = 14),
          axis.title.y = element_blank(),
          legend.position = "right",
          legend.title = element_blank()) +
    ylab("R-squared value")
```

