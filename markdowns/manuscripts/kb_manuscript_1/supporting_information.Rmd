---
output:
  pdf_document:
    toc: yes
---

```{r load_libraries, echo=FALSE, message=FALSE}
  if (!require("pacman")) install.packages("pacman")
  pacman::p_load(tidyverse, patchwork, knitr, kableExtra, forcats, patchwork, RColorBrewer)
```

```{r global_options, include=FALSE}
  knitr::opts_chunk$set(fig.path='figures/', warning=FALSE, message=FALSE, cache=FALSE, echo=FALSE)
```

```{r, echo=FALSE}
  emissions <- readRDS("../../../r_data/emissions_factors.RDS")
  samples <- readRDS("../../../r_data/samples.RDS")
  fuels <- readRDS("../../../r_data/fuel_properties.RDS")
  pol_properties <- readRDS("../../../r_data/pol_properties.RDS")
```

# 1. Stove-fuel test matrix

```{r, fig.width=22, fig.height=10}
  samples %>%
    dplyr::select(id, stove, fuel, type) %>%
    dplyr::mutate(stove = as.character(stove),
                  stove = ifelse(stove == "lpg", "pressure lpg", stove)) %>%
    dplyr::mutate(stove = 
                    stove %>% 
                    factor %>% 
                    forcats::fct_relevel("three stone fire",
                                         "clay ring",
                                         "rocket elbow",
                                         "built-in plancha",
                                         "fan rocket elbow",
                                         "ceramic charcoal",
                                         "metal charcoal",
                                         "gasifier",
                                         "pressure lpg",
                                         "pressure kerosene",
                                         "wick kerosene"),
                  fuel = 
                    fuel %>% 
                    factor %>% 
                    forcats::fct_relevel("oak",
                                         "eucalyptus",
                                         "douglas fir",
                                         "lump hardwood (med.)",
                                         "lump hardwood (sm.)",
                                         "coconut charcoal",
                                         "west slope pellets",
                                         "eucalyptus pellets",
                                         "lpg",
                                         "kerosene")) %>%
    dplyr::filter(type == "SF") %>%
                 dplyr::group_by(stove, fuel) %>%
                 dplyr::filter(!grepl("^27|^28|^29|^30", id)) %>%
                 dplyr::summarise(id = paste(id, collapse = ", ")) %>%
    ggplot(aes(x = stove, y = fuel)) + 
      geom_tile(colour = "white", width = 0.9, height = 0.9, aes(fill = id)) +
      theme_bw() +
      theme(legend.position = "none") +
      theme(axis.text.x = element_text(angle = 35, hjust = 1, vjust = 0.75)) +
      theme(axis.text = element_text(size = 20)) +
      geom_text(aes(label = id, size = 5)) +
      xlab("") +
      ylab("")
```

# 2. Fuel properties

```{r}
  fuels %>%
    dplyr::mutate(carbon_fraction = format(round(carbon_fraction, 2), nsmall = 2, scientific = FALSE),
                  carbon_fraction = ifelse(carbon_fraction == "0.82", "0.82$^+$", carbon_fraction),
                  lhv = ifelse(grepl("00", lhv), paste0(lhv, "$^+$"), lhv)) %>%
    dplyr::rename("lower heating value*" = "lhv",
                  "fraction of carbon in fuel" = "carbon_fraction") %>%
    kable(escape = FALSE, booktabs = TRUE, align = "c",
          longtable = TRUE) %>%
    kable_styling(position = "center", font_size = 10,
                  latex_options = "repeat_header") %>%
    footnote(general = "*in units of kilojoules per kilogram; $^+$estimated values", escape = FALSE)
```

# 3. Intrumentation

# 4. Linear regression models

## Extended R-squared plot

## Model coefficients and confidence intervals

# 5. Disaggregated data tables

```{r}
  emissions <- 
    emissions %>%
    dplyr::mutate(pol = ifelse(grepl("^ec$", pol), "elemental carbon", pol),
                  pol = ifelse(grepl("^oc$", pol), "organic carbon", pol),
                  pol = ifelse(grepl("^om$", pol), "organic matter", pol),
                  pol = ifelse(grepl("^co$", pol), "carbon monoxide", pol),
                  pol = ifelse(grepl("^co2$", pol), "carbon dioxide", pol),
                  pol = ifelse(grepl("^ch4$", pol), "methane", pol),
                  pol = ifelse(grepl("pm_mass", pol), "PM$_{2.5}$ mass", pol),
                  pol = ifelse(grepl("ultrafines", pol), "ultrafine particles", pol))
```

```{r, echo=FALSE}
  emissions <-
    emissions %>%
    dplyr::filter(grepl("energy_delivered_ef|mass_fuel_ef", metric)) %>%
    dplyr::select(-qc, -units) %>%
    tidyr::spread("metric", "val") %>%
    dplyr::inner_join(samples %>%
                        dplyr::select(id, stove, fuel, stovecat, fuelcat), by = "id") %>%
    dplyr::mutate(id = as_factor(id)) %>%
    dplyr::select(pol, pol_category, pol_subcategory, id, stove, fuel, energy_delivered_ef, mass_fuel_ef) %>%
    dplyr::mutate(stove = as.character(stove),
                  stove = ifelse(stove == "lpg", "pressure lpg", stove)) %>%
    dplyr::mutate(stove = 
                    stove %>% 
                    factor %>% 
                    forcats::fct_relevel("three stone fire",
                                         "clay ring",
                                         "rocket elbow",
                                         "built-in plancha",
                                         "fan rocket elbow",
                                         "ceramic charcoal",
                                         "metal charcoal",
                                         "gasifier",
                                         "pressure lpg",
                                         "pressure kerosene",
                                         "wick kerosene"),
                  fuel = 
                    fuel %>% 
                    factor %>% 
                    forcats::fct_relevel("oak",
                                         "eucalyptus",
                                         "douglas fir",
                                         "lump hardwood (med.)",
                                         "lump hardwood (sm.)",
                                         "coconut charcoal",
                                         "west slope pellets",
                                         "eucalyptus pellets",
                                         "lpg",
                                         "kerosene"))
```

## Fine particulate matter

```{r}
  emissions %>%
    dplyr::filter(grepl("PM", pol)) %>%
    dplyr::select(-pol_category, -pol_subcategory) %>%
    dplyr::mutate(id =
                    id %>%
                    as_factor) %>%
    dplyr::mutate(energy_delivered_ef = format(round(energy_delivered_ef, 2), nsmall = 2, scientific = FALSE),
                  mass_fuel_ef = format(round(mass_fuel_ef, 2), nsmall = 2, scientific = FALSE),
                  energy_delivered_ef = as.character(energy_delivered_ef),
                  mass_fuel_ef = as.character(mass_fuel_ef)) %>%
    dplyr::rename("pollutant" = "pol",
                  "per-energy-delivered" = "energy_delivered_ef",
                  "per-mass-fuel" = "mass_fuel_ef") %>%
    dplyr::arrange(pollutant, stove, fuel) %>%
    kable(escape = FALSE, booktabs = TRUE, align = "c",
          longtable = TRUE) %>%
    kable_styling(position = "left", font_size = 9,
                  latex_options = "repeat_header") %>%
    footnote(general = "BB is below background; * indicates a value below limit of detection; ** indicates a value below limit of quantification")
```

## Carbon monoxide, carbon dioxide, and methane

```{r}
  emissions %>%
    dplyr::filter(grepl("carbon |methane", pol)) %>%
    dplyr::select(-pol_category, -pol_subcategory) %>%
    dplyr::mutate(id =
                    id %>%
                    as_factor) %>%
    dplyr::mutate(energy_delivered_ef = format(round(energy_delivered_ef, 2), nsmall = 2, scientific = FALSE),
                  mass_fuel_ef = format(round(mass_fuel_ef, 2), nsmall = 2, scientific = FALSE),
                  energy_delivered_ef = as.character(energy_delivered_ef),
                  mass_fuel_ef = as.character(mass_fuel_ef)) %>%
    dplyr::rename("pollutant" = "pol",
                  "per-energy-delivered" = "energy_delivered_ef",
                  "per-mass-fuel" = "mass_fuel_ef") %>%
    dplyr::arrange(pollutant, stove, fuel) %>%
    kable(escape = FALSE, booktabs = TRUE, align = "c",
          longtable = TRUE) %>%
    kable_styling(position = "left", font_size = 9,
                  latex_options = "repeat_header") %>%
    footnote(general = "BB is below background; * indicates a value below limit of detection; ** indicates a value below limit of quantification")
```

## Organic carbon, organic matter, elemental carbon

```{r}
  emissions %>%
    dplyr::filter(grepl("organic|elemental", pol)) %>%
    dplyr::select(-pol_category, -pol_subcategory) %>%
    dplyr::mutate(id =
                    id %>%
                    as_factor) %>%
    dplyr::mutate(energy_delivered_ef = format(round(energy_delivered_ef, 2), nsmall = 2, scientific = FALSE),
                  mass_fuel_ef = format(round(mass_fuel_ef, 2), nsmall = 2, scientific = FALSE),
                  energy_delivered_ef = as.character(energy_delivered_ef),
                  mass_fuel_ef = as.character(mass_fuel_ef)) %>%
    dplyr::rename("pollutant" = "pol",
                  "per-energy-delivered" = "energy_delivered_ef",
                  "per-mass-fuel" = "mass_fuel_ef") %>%
    dplyr::arrange(pollutant, stove, fuel) %>%
    kable(escape = FALSE, booktabs = TRUE, align = "c",
          longtable = TRUE) %>%
    kable_styling(position = "left", font_size = 9,
                  latex_options = "repeat_header") %>%
    footnote(general = "BB is below background; * indicates a value below limit of detection; ** indicates a value below limit of quantification")
```

## Inorganic ions

```{r, echo=FALSE}
  emissions %>%
    dplyr::filter(pol_category == "ions") %>%
    dplyr::left_join(dplyr::select(pol_properties, pol, mw), by = "pol") %>%
    dplyr::select(-pol_category, -pol_subcategory) %>%
    dplyr::mutate(pol = as_factor(pol),
                  pol = fct_reorder(pol, mw)) %>%
    dplyr::select(-mw) %>%
    dplyr::mutate(energy_delivered_ef = format(round(energy_delivered_ef, 2), nsmall = 2, scientific = FALSE),
                  mass_fuel_ef = format(round(mass_fuel_ef, 2), nsmall = 2, scientific = FALSE),
                  energy_delivered_ef = as.character(energy_delivered_ef),
                  mass_fuel_ef = as.character(mass_fuel_ef)) %>%
    dplyr::rename("pollutant" = "pol",
                  "per-energy-delivered" = "energy_delivered_ef",
                  "per-mass-fuel" = "mass_fuel_ef") %>%
    dplyr::arrange(pollutant, stove, fuel) %>%
    kable(escape = FALSE, booktabs = TRUE, align = "c",
          longtable = TRUE) %>%
    kable_styling(position = "left", font_size = 9,
                  latex_options = "repeat_header") %>%
    footnote(general = "BB is below background; * indicates a value below limit of detection; ** indicates a value below limit of quantification")
```

## Ultrafine particles

```{r, echo=FALSE}
  emissions %>%
    dplyr::filter(pol_category == "smps") %>%
    dplyr::select(-pol_category, -pol_subcategory) %>%
    dplyr::mutate(id =
                    id %>%
                    as_factor) %>%
    dplyr::mutate(energy_delivered_ef = format(energy_delivered_ef, format = "e", digits = 3),
                  mass_fuel_ef = format(mass_fuel_ef, 2, format = "e", digits = 3),
                  energy_delivered_ef = as.character(energy_delivered_ef),
                  mass_fuel_ef = as.character(mass_fuel_ef)) %>%
    dplyr::rename("pollutant" = "pol",
                  "per-energy-delivered" = "energy_delivered_ef",
                  "per-mass-fuel" = "mass_fuel_ef") %>%
    dplyr::arrange(pollutant, stove, fuel) %>%
    kable(escape = FALSE, booktabs = TRUE, align = "c",
          longtable = TRUE) %>%
    kable_styling(position = "left", font_size = 9,
                  latex_options = "repeat_header") %>%
    footnote(general = "BB is below background; * indicates a value below limit of detection; ** indicates a value below limit of quantification")
```

## Carbonyl compounds

```{r, echo=FALSE}
  emissions %>%
    dplyr::filter(pol_category == "carbonyls") %>%
    dplyr::mutate(pol = ifelse(pol == "o_tolualdehyde", "o-tolualdehyde", pol),
                  pol = ifelse(pol == "m_p_tolualdehyde", "m,p-tolualdehyde", pol),
                  pol = ifelse(pol == "2_5_dimethylbenzaldehyde", "2,5-dimethylbenzaldehyde", pol)) %>%
    dplyr::left_join(dplyr::select(pol_properties, pol, mw), by = "pol") %>%
    dplyr::select(-pol_category) %>%
    dplyr::mutate(pol = as_factor(pol),
                  pol = fct_reorder(pol, mw)) %>%
    dplyr::select(-mw) %>%
    dplyr::mutate(energy_delivered_ef = format(round(energy_delivered_ef, 2), nsmall = 2, scientific = FALSE),
                  mass_fuel_ef = format(round(mass_fuel_ef, 2), nsmall = 2, scientific = FALSE),
                  energy_delivered_ef = as.character(energy_delivered_ef),
                  mass_fuel_ef = as.character(mass_fuel_ef)) %>%
    dplyr::rename("pollutant" = "pol",
                  "pollutant category" = "pol_subcategory",
                  "per-energy-delivered" = "energy_delivered_ef",
                  "per-mass-fuel" = "mass_fuel_ef") %>%
    dplyr::arrange(pollutant, stove, fuel) %>%
    kable(escape = FALSE, booktabs = TRUE, align = "c",
          longtable = TRUE) %>%
    kable_styling(position = "left", font_size = 9,
                  latex_options = "repeat_header") %>%
    footnote(general = "BB is below background; * indicates a value below limit of detection; ** indicates a value below limit of quantification")
```

## Volatile organic compounds

## Polycyclic Aromatic Hydrocarbons

```{r, echo=FALSE}
  emissions %>%
    dplyr::filter(pol_category == "pahs") %>%
    dplyr::select(-pol_category) %>%
    dplyr::mutate(pol_subcategory = 
                    pol_subcategory %>% 
                    factor %>% 
                    forcats::fct_relevel("two rings",
                                         "three rings",
                                         "four rings",
                                         "five rings",
                                         "six rings")) %>%
    dplyr::mutate(energy_delivered_ef = format(round(energy_delivered_ef, 2), nsmall = 2, scientific = FALSE),
                  mass_fuel_ef = format(round(mass_fuel_ef, 2), nsmall = 2, scientific = FALSE),
                  energy_delivered_ef = as.character(energy_delivered_ef),
                  mass_fuel_ef = as.character(mass_fuel_ef),
                  pol = gsub("indeno\\(1,2,3\\) cd pyrene", "indeno\\[1,2,3-cd\\]pyrene", pol),
                  pol = gsub("\\(ah\\)",  "\\[a,h\\]", pol),
                  pol = gsub("b\\[",  "benzo\\[", pol)) %>%
    dplyr::arrange(pol_subcategory, pol, stove, fuel) %>%
    dplyr::rename("pollutant" = "pol",
                  "pollutant category" = "pol_subcategory",
                  "per-energy-delivered" = "energy_delivered_ef",
                  "per-mass-fuel" = "mass_fuel_ef") %>%
    kable(escape = FALSE, booktabs = TRUE, align = "c",
          longtable = TRUE) %>%
    kable_styling(position = "left", font_size = 9,
                  latex_options = "repeat_header") %>%
    footnote(general = "BB is below background; * indicates a value below limit of detection; ** indicates a value below limit of quantification")
```

## Carbohydrates