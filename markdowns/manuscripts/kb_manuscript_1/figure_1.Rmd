---
title: "figure 1: particle emissions"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r load_libraries, echo=FALSE, message=FALSE}
  if (!require("pacman")) install.packages("pacman")
  pacman::p_load(tidyverse, pals, devtools, patchwork)
  #devtools::install_github("thomasp85/patchwork")
```

```{r global_options, echo=FALSE}
  knitr::opts_chunk$set(fig.path ='figures/',
                        warning = FALSE, message = FALSE, cache = FALSE)
```

# figure 1

## tidy data

load data

```{r}
  emissions <- readRDS("../../../r_data/emissions_factors.RDS")
  samples <- readRDS("../../../r_data/samples.RDS")
```

## add stove fuel info

```{r}
  emissions <-
    emissions %>%
    dplyr::left_join(samples %>%
                       dplyr::select(id, stove, fuel, stovecat, fuelcat), by = "id")
```

## rename pollutants

```{r}
  emissions <-
    emissions %>%
    dplyr::mutate(pol_category = ifelse(grepl("^ec$", pol_category), "elemental carbon", pol_category),
                  pol_category = ifelse(grepl("ions", pol_category), "inorganic ions", pol_category),
                  pol = ifelse(grepl("^co$", pol), "carbon monoxide", pol))
```

## select pollutants

```{r}
  ultrafines <-
    emissions %>%
    dplyr::filter(grepl("ultrafines", pol)) %>%
    dplyr::filter(metric == "energy_delivered_ef") %>%
    dplyr::mutate(pol_category = "ultrafine particles",
                  pol = "ultrafine particles")
```

```{r}
  ec_oc_ions <-
    emissions %>%
    dplyr::filter(grepl("inorganic ions|elemental carbon|organic matter", pol_category)) %>%
    dplyr::filter(metric == "energy_delivered_ef")
```

```{r}
  pm_mass <-
    emissions %>%
    dplyr::filter(grepl("pm_mass", pol_category)) %>%
    dplyr::filter(metric == "energy_delivered_ef") %>%
    dplyr::mutate(pol_category = ifelse(grepl("pm_mass", pol_category), "PM2.5 mass", pol_category))
```

```{r}
  co <-
    emissions %>%
    dplyr::filter(grepl("monoxide", pol)) %>%
    dplyr::filter(metric == "energy_delivered_ef")
```

# check for outliers

## elemental carbon

## carbon monoxide

```{r, echo=FALSE, fig.width=10, fig.height=8, eval=FALSE}
  co %>%
    ggplot(aes(x = id, y = val, color = fuel)) +
    geom_point() +
    theme_bw() +
    theme(text = element_text(size = 12),
          legend.position = "top") +
    facet_wrap(~stove, scales = "free")
```

```{r, echo=FALSE, fig.width=10, fig.height=8, eval=FALSE}
  ultrafines %>%
    ggplot(aes(x = id, y = val, color = fuel)) +
    geom_point() +
    theme_bw() +
    theme(text = element_text(size = 12),
          legend.position = "top") +
    facet_wrap(~stove, scales = "free")
```

## elemental carbon

```{r, echo=FALSE, fig.width=10, fig.height=8, eval=FALSE}
  ec_oc_ions %>%
    dplyr::filter(pol_category == "elemental carbon") %>%
    ggplot(aes(x = id, y = val, color = fuel)) +
    geom_point() +
    theme_bw() +
    theme(text = element_text(size = 12),
          legend.position = "top") +
    facet_wrap(~stove, scales = "free")
```

## organic carbon

```{r, echo=FALSE, fig.width=10, fig.height=8, eval=FALSE}
  ec_oc_ions %>%
    dplyr::filter(pol_category == "organic carbon") %>%
    ggplot(aes(x = id, y = val, color = fuel)) +
    geom_point() +
    theme_bw() +
    theme(text = element_text(size = 12),
          legend.position = "top") +
    facet_wrap(~stove, scales = "free_x")
```

## pm mass

```{r, echo=FALSE, fig.width=10, fig.height=8, eval=FALSE}
  pm_mass %>%
    ggplot(aes(x = id, y = val, color = fuel)) +
    geom_point() +
    theme_bw() +
    theme(text = element_text(size = 12),
          legend.position = "top") +
    facet_wrap(~stove, scales = "free_x")
```

## ions

```{r, echo=FALSE, fig.width=10, fig.height=8, eval=FALSE}
  ec_oc_ions %>%
    dplyr::filter(pol_category == "inorganic ions") %>%
    dplyr::group_by(id) %>%
    dplyr::mutate(val = sum(val, na.rm = TRUE)) %>%
      ggplot(aes(x = id, y = val, color = fuel)) +
      geom_point() +
      theme_bw() +
      theme(text = element_text(size = 12),
            legend.position = "top") +
      facet_wrap(~stove, scales = "free")
```

## remove tests

```{r}
  ec_oc_ions <-
    ec_oc_ions %>%
    dplyr::filter(id != "6E")
```

## calculate range of pm mass

```{r}
  range_pm <-
    pm_mass %>%
    na.omit %>%
    dplyr::group_by(stove, stovecat) %>%
    dplyr::summarise(min = min(val, na.rm = TRUE),
                     max = max(val, na.rm = TRUE)) %>%
    tidyr::gather("var", "val", min, max) %>%
    dplyr::mutate(sym = ifelse(var == "min", "[", "]"))
```

```{r}
  range_ultrafines <-
    ultrafines %>%
    na.omit %>%
    dplyr::group_by(stove, stovecat) %>%
    dplyr::summarise(min = min(val, na.rm = TRUE),
                     max = max(val, na.rm = TRUE)) %>%
    tidyr::gather("var", "val", min, max) %>%
    dplyr::mutate(sym = ifelse(var == "min", "[", "]"))
```

```{r}
  range_co <-
    co %>%
    na.omit %>%
    dplyr::group_by(stove, stovecat) %>%
    dplyr::mutate(val = val / 1000) %>%
    dplyr::summarise(min = min(val, na.rm = TRUE),
                     max = max(val, na.rm = TRUE)) %>%
    tidyr::gather("var", "val", min, max) %>%
    dplyr::mutate(sym = ifelse(var == "min", "[", "]"))
```


## average pm mass by stove type

```{r}
  pm_mass_p <-
    pm_mass %>%
    dplyr::group_by(pol_category, stove, stovecat) %>%
    dplyr::summarise(val = mean(val, na.rm = TRUE)) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(pol = "PM2.5 mass",
                  pol_category = "PM2.5 mass")
```

## average ec, oc, and ion mass by stove type

```{r}
  ec_oc_ions_p <-
    ec_oc_ions %>%
    #dplyr::mutate(val = ifelse(pol_category == "organic carbon", val * 1.8, val)) %>%
    dplyr::group_by(id, pol_category, stove, fuel, stovecat, fuelcat) %>%
    dplyr::summarise(val = sum(val, na.rm = TRUE)) %>%
    tidyr::spread(pol_category, val) %>%
    na.omit %>%
    tidyr::gather(pol_category, val, 6:8) %>%
    dplyr::group_by(pol_category, stove, stovecat, fuelcat) %>%
    dplyr::summarise(val = mean(val, na.rm = TRUE)) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(pol = pol_category,
                  pol = 
                    pol %>% 
                    factor %>% 
                    forcats::fct_relevel("organic matter",
                                         "elemental carbon",
                                         "inorganic ions") %>%
                    forcats::fct_rev(),
                  pol_category = "PM2.5 mass")
```

## average ultrafines by stove type

```{r}
  ultrafines_p <-
    ultrafines %>%
    dplyr::group_by(stove, stovecat) %>%
    dplyr::summarise(mean = mean(val, na.rm = TRUE)) %>%
    dplyr::mutate(pol_category = "ultrafine particles")
```

## average carbon monoxide by stove type

```{r}
  co_p <-
    co %>%
    dplyr::group_by(pol, stove, stovecat) %>%
    dplyr::mutate(val = val / 1000) %>%
    dplyr::summarise(mean = mean(val, na.rm = TRUE)) %>%
    dplyr::mutate(pol_category = "carbon monoxide")
```

## figure 1

```{r, echo=FALSE}
  p1 <-
    pm_mass_p  %>%
    dplyr::filter(grepl("traditional", stovecat)) %>%
    ggplot(aes(x = stove, y = val)) +
    geom_histogram(aes(fill = pol), stat = "identity") +
    geom_histogram(data = ec_oc_ions_p %>%
                   dplyr::filter(grepl("traditional", stovecat)),
                   aes(x = stove, y = val, fill = pol, order = pol), stat = "identity", width = 0.75) +
    scale_fill_manual(values = c("gray30", "#E69F00", "snow", "#999999")) +
    scale_y_continuous(limits = c(0, 1000)) +
    annotate("text", x = 1, y = 1000, label = "XXX", size = 5) +
    annotate("text", x = 2, y = 1000, label = "XXX", size = 5) +
    geom_text(data = range_pm %>%
              dplyr::filter(grepl("traditional", stovecat)),
              aes(x = stove, y = val, label = sym), size = 10, angle = 90, nudge_x = -0.02) +
    theme_bw() +
    theme(text = element_text(size = 20),
          axis.text.y = element_text(size = 18),
          axis.text.x = element_blank(),
          axis.title.x = element_blank(),
          legend.position = "none") +
    guides(fill = guide_legend(title = NULL)) +
    facet_grid(pol_category~stovecat, scales = "free", switch = "y") +
    ylab("mg per MJ delivered")

  p2 <-
    pm_mass_p %>%
    dplyr::filter(grepl("improved", stovecat)) %>%
    ggplot(aes(x = stove, y = val)) +
      geom_histogram(aes(fill = pol), stat = "identity") +
      geom_histogram(data = ec_oc_ions_p %>%
                     dplyr::filter(grepl("improved", stovecat)),
                     aes(x = stove, y = val, fill = pol, order = pol), stat = "identity", width = 0.75) +
      scale_fill_manual(values = c("gray30", "#E69F00", "snow", "#999999")) +
      annotate("text", x = 1, y = 500, label = "XXX", size = 5) +
      annotate("text", x = 2, y = 500, label = "XXX", size = 5) +
      scale_y_continuous(limits = c(0, 500)) +
      geom_text(data = range_pm %>%
                dplyr::filter(grepl("improved", stovecat)),
                aes(x = stove, y = val, label = sym), size = 10, angle = 90, nudge_x = -0.04) +
      theme_bw() +
      theme(text = element_text(size = 20),
            axis.text.y = element_text(size = 18),
            axis.title.y = element_blank(),
            axis.text.x = element_blank(),
            axis.title.x = element_blank(),
            legend.position = "none") +
      guides(fill = guide_legend(title = NULL)) +
      facet_wrap(~stovecat, scales = "free")
  
  p3 <-
    pm_mass_p %>%
    dplyr::filter(grepl("liquid", stovecat)) %>%
    ggplot(aes(x = stove, y = val)) +
      geom_histogram(aes(fill = pol), stat = "identity") +
      geom_histogram(data = ec_oc_ions_p %>%
                       dplyr::filter(grepl("liquid", stovecat)),
                     aes(x = stove, y = val, fill = pol, order = pol),
                     stat = "identity", width = 0.75) +
      scale_fill_manual(values = c("gray30", "#E69F00", "snow", "#999999")) +
      annotate("text", x = 1, y = 10, label = "XXX", size = 5) +
      geom_text(data = range_pm %>%
                  dplyr::filter(grepl("liquid", stovecat)),
                aes(x = stove, y = val, label = sym),
                stroke = 2, size = 10, angle = 90, nudge_x = -0.02) +
      theme_bw() +
      scale_y_continuous(limits = c(0, 10)) +
      theme(text = element_text(size = 20),
            axis.text.y = element_text(size = 18),
            axis.title.y = element_blank(),
            axis.text.x = element_blank(),
            axis.title.x = element_blank(),
            legend.position = "right",
            legend.text = element_text(size = 12)) +
      guides(fill = guide_legend(title = NULL)) +
      facet_wrap(~stovecat, scales = "free")
```

```{r, echo=FALSE}
  p4 <- 
    ultrafines_p %>%
    dplyr::filter(grepl("traditional", stovecat)) %>%
      ggplot(aes(x = stove, y = mean)) +
      geom_histogram(stat = "identity", fill = "#56B4E9") +
      geom_text(data = range_ultrafines %>%
                dplyr::filter(grepl("traditional", stovecat)),
                aes(x = stove, y = val, label = sym), stroke = 2, size = 10, angle = 90, nudge_x = -0.05) +
        theme_bw() +
        #scale_y_continuous(trans = "log10", limits = c(1e5, 1e8), breaks = c(1e5, 1e6, 1e7, 1e8)) +
        theme(text = element_text(size = 20),
              axis.text.y = element_text(size = 18),
              axis.text.x = element_blank(),
              strip.text.x = element_blank(),
              axis.title.x = element_blank(),
              legend.position = "none") +
        guides(fill = guide_legend(title = NULL)) +
        facet_grid(pol_category~stovecat, scales = "free", switch = "y") +
        ylab("num. per MJ delivered")

  p5 <- 
    ultrafines_p %>%
    dplyr::filter(grepl("improved", stovecat)) %>%
      ggplot(aes(x = stove, y = mean)) +
      geom_histogram(stat = "identity", fill = "#56B4E9") +
      geom_text(data = range_ultrafines %>%
                dplyr::filter(grepl("improved", stovecat)),
                aes(x = stove, y = val, label = sym), stroke = 2, size = 10, angle = 90, nudge_x = -0.05) +
        theme_bw() +
        #scale_y_continuous(trans = "log10", limits = c(1e5, 1e8), breaks = c(1e5, 1e6, 1e7, 1e8)) +
        theme(text = element_text(size = 20),
              axis.text.y = element_text(size = 18),
              axis.text.x = element_blank(),
              strip.text.x = element_blank(),
              axis.title.y = element_blank(),
              axis.title.x = element_blank(),
              legend.position = "none") +
        guides(fill = guide_legend(title = NULL)) +
        facet_wrap(~stovecat, scales = "free")
  p6 <- 
    ultrafines_p %>%
    dplyr::filter(grepl("liquid", stovecat)) %>%
      ggplot(aes(x = stove, y = mean)) +
      geom_histogram(stat = "identity", fill = "#56B4E9") +
      geom_text(data = range_ultrafines %>%
                dplyr::filter(grepl("liquid", stovecat)),
                aes(x = stove, y = val, label = sym), stroke = 2, size = 10, angle = 90, nudge_x = -0.05) +
        theme_bw() +
        #scale_y_continuous(trans = "log10", limits = c(1e5, 1e8), breaks = c(1e5, 1e6, 1e7, 1e8)) +
        theme(text = element_text(size = 20),
              axis.text.y = element_text(size = 18),
              strip.text.x = element_blank(),
              axis.text.x = element_blank(),
              legend.title = element_blank(),
              axis.title.y = element_blank(),
              axis.title.x = element_blank(),
              legend.position = "none",
              legend.text = element_text(size = 12)) +
        guides(fill = guide_legend(title = NULL)) +
        facet_wrap(~stovecat, scales = "free")
```

```{r, echo=FALSE}
  p7 <- 
    co_p %>%
    dplyr::filter(grepl("traditional", stovecat)) %>%
      ggplot(aes(x = stove, y = mean)) +
      geom_histogram(stat = "identity", fill = "mediumslateblue") +
      geom_text(data = range_co %>%
                dplyr::filter(grepl("traditional", stovecat)),
                aes(x = stove, y = val, label = sym), stroke = 2, size = 10, angle = 90, nudge_x = -0.05) +
        scale_y_continuous(limits = c(0, 40)) +
        theme_bw() +
        theme(text = element_text(size = 20),
              axis.text.y = element_text(size = 18),
              axis.text.x = element_blank(),
              axis.title.x = element_blank(),
              strip.text.x = element_blank(),
              legend.position = "none") +
        guides(fill = guide_legend(title = NULL)) +
        facet_grid(pol_category~stovecat, scales = "free", switch = "y") +
        ylab("grams per MJ delivered")

  p8 <- 
    co_p %>%
    dplyr::filter(grepl("improved", stovecat)) %>%
      ggplot(aes(x = stove, y = mean)) +
      geom_histogram(stat = "identity", fill = "mediumslateblue") +
      geom_text(data = range_co %>%
                dplyr::filter(grepl("improved", stovecat)),
                aes(x = stove, y = val, label = sym), stroke = 2, size = 10, angle = 90, nudge_x = -0.05) +
        theme_bw() +
        scale_y_continuous(limits = c(0, 40)) +
        theme(text = element_text(size = 20),
              axis.text.y = element_text(size = 18),
              axis.text.x = element_blank(),
              axis.title.x = element_blank(),
              strip.text.x = element_blank(),
              axis.title.y = element_blank(),
              legend.position = "none") +
        guides(fill = guide_legend(title = NULL)) +
        facet_wrap(~stovecat, scales = "free")
  
  p9 <- 
    co_p %>%
    dplyr::filter(grepl("liquid", stovecat)) %>%
      ggplot(aes(x = stove, y = mean)) +
      geom_histogram(stat = "identity", fill = "mediumslateblue") +
      geom_text(data = range_co %>%
                dplyr::filter(grepl("liquid", stovecat)),
                aes(x = stove, y = val, label = sym), stroke = 2, size = 10, angle = 90, nudge_x = -0.05) +
        scale_y_continuous(limits = c(0, 4)) +
        theme_bw() +
        theme(text = element_text(size = 20),
              axis.text.y = element_text(size = 18),
              axis.title.x = element_blank(),
              strip.text.x = element_blank(),
              axis.text.x = element_blank(),
              legend.title = element_blank(),
              axis.title.y = element_blank(),
              legend.position = "none",
              legend.text = element_text(size = 12)) +
        guides(fill = guide_legend(title = NULL)) +
        facet_wrap(~stovecat, scales = "free")
```

```{r figure_1, echo=FALSE, fig.width=16, fig.height=10}
 (p1 + p2 + p3) + p7 + p8 + p9 + p4 + p5 + p6 + plot_layout(ncol = 3, widths = c(1, 1.5, 1), heights = c(1.25, 1, 1))
```

# summary tables

## carbon monoxide

average carbon monoxide by stove type

```{r, echo=FALSE}
  co %>%
    dplyr::group_by(stove) %>%
    dplyr::mutate(val = val / 1000) %>%
    dplyr::summarise(mean = mean(val, na.rm = TRUE),
                     min = min(val, na.rm = TRUE),
                     max = max(val, na.rm = TRUE)) %>%
    dplyr::mutate(stove = gsub("\n", " ", stove)) %>%
      dplyr::arrange(mean) %>%
    knitr::kable("markdown", digits = 2, align = 'c')
```

average carbon monoxide by stovecat

```{r, echo=FALSE}
  co %>%
    dplyr::group_by(stovecat) %>%
    dplyr::mutate(val = val / 1000) %>%
    dplyr::summarise(mean = mean(val, na.rm = TRUE),
                     min = min(val, na.rm = TRUE),
                     max = max(val, na.rm = TRUE)) %>%
      dplyr::arrange(mean) %>%
    knitr::kable("markdown", digits = 2, align = 'c')
```

average carbon monoxide by fuel type

```{r, echo=FALSE}
  co %>%
    dplyr::group_by(fuel) %>%
    dplyr::mutate(val = val / 1000) %>%
    dplyr::summarise(mean = mean(val, na.rm = TRUE),
                     min = min(val, na.rm = TRUE),
                     max = max(val, na.rm = TRUE)) %>%
      dplyr::arrange(mean) %>%
    knitr::kable("markdown", digits = 2, align = 'c')
```

average carbon monoxide by fuelcat

```{r, echo=FALSE}
  co %>%
    dplyr::group_by(fuelcat) %>%
    dplyr::mutate(val = val / 1000) %>%
    dplyr::summarise(mean = mean(val, na.rm = TRUE),
                     min = min(val, na.rm = TRUE),
                     max = max(val, na.rm = TRUE)) %>%
      dplyr::arrange(mean) %>%
    knitr::kable("markdown", digits = 2, align = 'c')
```

## ultrafines

average ultrafines by stove type

```{r, echo=FALSE}
  ultrafines %>%
    dplyr::group_by(stove) %>%
    dplyr::summarise(mean = mean(val, na.rm = TRUE),
                     min = min(val, na.rm = TRUE),
                     max = max(val, na.rm = TRUE)) %>%
    dplyr::mutate(stove = gsub("\n", " ", stove)) %>%
    dplyr::arrange(mean) %>%
    dplyr::mutate_if(is.numeric, funs(as.character(signif(., 2)))) %>%
    knitr::kable("markdown", digits = 2, align = 'c')
```

average ultrafines by stovecat

```{r, echo=FALSE}
  ultrafines %>%
    dplyr::group_by(stovecat) %>%
    dplyr::summarise(mean = mean(val, na.rm = TRUE),
                     min = min(val, na.rm = TRUE),
                     max = max(val, na.rm = TRUE)) %>%
    dplyr::arrange(mean) %>%
    dplyr::mutate_if(is.numeric, funs(as.character(signif(., 2)))) %>%
    knitr::kable("markdown", digits = 2, align = 'c')
```

average ultrafines by fuel type

```{r, echo=FALSE}
  ultrafines %>%
    dplyr::group_by(fuel) %>%
    dplyr::summarise(mean = mean(val, na.rm = TRUE),
                     min = min(val, na.rm = TRUE),
                     max = max(val, na.rm = TRUE)) %>%
    dplyr::arrange(mean) %>%
    dplyr::mutate_if(is.numeric, funs(as.character(signif(., 2)))) %>%
    knitr::kable("markdown", digits = 2, align = 'c')
```

average ultrafines by fuelcat

```{r, echo=FALSE}
  ultrafines %>%
    dplyr::group_by(fuelcat) %>%
    dplyr::summarise(mean = mean(val, na.rm = TRUE),
                     min = min(val, na.rm = TRUE),
                     max = max(val, na.rm = TRUE)) %>%
    dplyr::arrange(mean) %>%
    dplyr::mutate_if(is.numeric, funs(as.character(signif(., 2)))) %>%
    knitr::kable("markdown", digits = 2, align = 'c')
```

## pm mass

pm mass in natural-draft improved stoves

```{r, echo=FALSE}
  pm_mass %>%
    dplyr::filter(grepl("^rocket elbow|plancha|metal charcoal", stove)) %>%
    dplyr::summarise(mean = mean(val, na.rm = TRUE),
                     min = min(val, na.rm = TRUE),
                     max = max(val, na.rm = TRUE)) %>%
    knitr::kable("markdown", digits = 2, align = 'c')
```

pm mass in forced-draft improved stoves

```{r, echo=FALSE}
  pm_mass %>%
    dplyr::filter(grepl("gasifier|fan rocket elbow", stove)) %>%
    dplyr::summarise(mean = mean(val, na.rm = TRUE),
                     min = min(val, na.rm = TRUE),
                     max = max(val, na.rm = TRUE)) %>%
    knitr::kable("markdown", digits = 2, align = 'c')
```

average pm mass by stove type

```{r, echo=FALSE}
  pm_mass %>%
    dplyr::group_by(stove) %>%
    dplyr::summarise(mean = mean(val, na.rm = TRUE),
                     min = min(val, na.rm = TRUE),
                     max = max(val, na.rm = TRUE)) %>%
    dplyr::mutate(stove = gsub("\n", " ", stove)) %>% 
    knitr::kable("markdown", digits = 2, align = 'c')
```

average pm mass by stovecat

```{r, echo=FALSE}
  pm_mass %>%
    dplyr::group_by(stovecat) %>%
    dplyr::summarise(mean = mean(val, na.rm = TRUE),
                     min = min(val, na.rm = TRUE),
                     max = max(val, na.rm = TRUE)) %>%
    knitr::kable("markdown", digits = 2, align = 'c')
```

average pm mass by fuel type

```{r, echo=FALSE}
  pm_mass %>%
    dplyr::group_by(fuel) %>%
    dplyr::summarise(mean = mean(val, na.rm = TRUE),
                     min = min(val, na.rm = TRUE),
                     max = max(val, na.rm = TRUE)) %>%
    knitr::kable("markdown", digits = 2, align = 'c')
```

average pm mass by fuelcat

```{r, echo=FALSE}
  pm_mass %>%
    dplyr::group_by(fuelcat) %>%
    dplyr::summarise(mean = mean(val, na.rm = TRUE),
                     min = min(val, na.rm = TRUE),
                     max = max(val, na.rm = TRUE)) %>%
    knitr::kable("markdown", digits = 2, align = 'c')
```

## pm composition

average pm composition by stove type

```{r, echo=FALSE}
  ec_oc_ions %>%
    dplyr::group_by(id, pol_category, stove) %>%
    dplyr::summarise(val = sum(val, na.rm = TRUE)) %>%
    tidyr::spread(pol_category, val) %>%
    na.omit %>%
    tidyr::gather(pol_category, val, 3:5) %>%
    dplyr::group_by(pol_category, stove) %>%
    dplyr::summarise(mean = mean(val, na.rm = TRUE),
                     min = min(val, na.rm = TRUE),
                     max = max(val, na.rm = TRUE)) %>%
    dplyr::mutate(stove = gsub("\n", " ", stove)) %>% 
    dplyr::arrange(mean) %>%
    knitr::kable("markdown", digits = 2, align = 'c')
```

average pm composition by stovecat

```{r, echo=FALSE}
  ec_oc_ions %>%
    dplyr::group_by(id, pol_category, stovecat) %>%
    dplyr::summarise(val = sum(val, na.rm = TRUE)) %>%
    tidyr::spread(pol_category, val) %>%
    na.omit %>%
    tidyr::gather(pol_category, val, 3:5) %>%
    dplyr::group_by(pol_category, stovecat) %>%
    dplyr::summarise(mean = mean(val, na.rm = TRUE),
                     min = min(val, na.rm = TRUE),
                     max = max(val, na.rm = TRUE)) %>%
    dplyr::arrange(mean) %>%
    knitr::kable("markdown", digits = 2, align = 'c')
```

average pm composition by fuel type

```{r, echo=FALSE}
  ec_oc_ions %>%
    dplyr::group_by(id, pol_category, fuel) %>%
    dplyr::summarise(val = sum(val, na.rm = TRUE)) %>%
    tidyr::spread(pol_category, val) %>%
    na.omit %>%
    tidyr::gather(pol_category, val, 3:5) %>%
    dplyr::group_by(pol_category, fuel) %>%
    dplyr::summarise(mean = mean(val, na.rm = TRUE),
                     min = min(val, na.rm = TRUE),
                     max = max(val, na.rm = TRUE)) %>%
    dplyr::arrange(mean) %>%
    knitr::kable("markdown", digits = 2, align = 'c')
```

average pm composition by fuelcat

```{r, echo=FALSE}
  ec_oc_ions %>%
    dplyr::group_by(id, pol_category, fuelcat) %>%
    dplyr::summarise(val = sum(val, na.rm = TRUE)) %>%
    tidyr::spread(pol_category, val) %>%
    na.omit %>%
    tidyr::gather(pol_category, val, 3:5) %>%
    dplyr::group_by(pol_category, fuelcat) %>%
    dplyr::summarise(mean = mean(val, na.rm = TRUE),
                     min = min(val, na.rm = TRUE),
                     max = max(val, na.rm = TRUE)) %>%
    dplyr::arrange(mean) %>%
    knitr::kable("markdown", digits = 2, align = 'c')
```
