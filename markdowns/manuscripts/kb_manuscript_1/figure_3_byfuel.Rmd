---
title: "Figure 3: Ultrafines and PAHs"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r load_libraries, echo=FALSE, message=FALSE}
  if (!require("pacman")) install.packages("pacman")
  pacman::p_load(tidyverse, pals, devtools, patchwork, RColorBrewer)
  #devtools::install_github("thomasp85/patchwork")
```

```{r global_options, echo=FALSE}
  knitr::opts_chunk$set(fig.path ='figures/',
                        warning = FALSE, message = FALSE, cache = FALSE)
```

# tidy data

load data

```{r}
  emissions <- readRDS("../../../r_data/emissions_factors.RDS")
  samples <- readRDS("../../../r_data/samples.RDS")
  pol_properties <- readRDS("../../../r_data/pol_properties.RDS")
```

```{r}
  samples <-
    samples %>%
    dplyr::mutate(stove_fuel = paste0(stove, ": ", fuel)) %>%
    dplyr::mutate(stove_fuel = 
                    stove_fuel %>%
                    factor %>%
                    forcats::fct_recode("Three-stone fire: Douglas fir" =
                                          "three-stone fire: douglas fir",
                                        "Three-stone fire: Eucalyptus" =
                                          "three-stone fire: eucalyptus",
                                        "Three-stone fire: Oak" =
                                          "three-stone fire: oak",
                                        "Mud chulha: Douglas fir" =
                                          "chulha: douglas fir",
                                        "Mud chulha: Eucalyptus" =
                                          "chulha: eucalyptus",
                                        "Mud chulha: Oak" =
                                          "chulha: oak", 
                                        "Rocket elbow: Douglas fir" =
                                          "rocket elbow: douglas fir",
                                        "Rocket elbow: Eucalyptus" =
                                          "rocket elbow: eucalyptus",
                                        "Rocket elbow: Oak" =
                                          "rocket elbow: oak",
                                        "Built-in plancha: Douglas fir" =
                                          "built-in plancha: douglas fir",
                                        "Built-in plancha: Eucalyptus" =
                                          "built-in plancha: eucalyptus",
                                        "Built-in plancha: Oak" =
                                          "built-in plancha: oak",
                                        "Fan rocket-elbow: Douglas fir" =
                                          "fan rocket-elbow: douglas fir",
                                        "Fan rocket-elbow: Eucalyptus" =
                                            "fan rocket-elbow: eucalyptus",
                                        "Fan rocket-elbow: Oak" =
                                          "fan rocket-elbow: oak",
                                        "Gasifier: West slope pellets" =
                                          "forced-draft gasifier: west slope pellets",
                                        "Gasifier: Eucalyptus pellets" =
                                          "forced-draft gasifier: eucalyptus pellets",
                                        "Ceramic charcoal: Lump hardwood (sm.)" =
                                          "ceramic charcoal: lump hardwood (sm.)",
                                        "Ceramic charcoal: Lump hardwood (med.)" =
                                          "ceramic charcoal: lump hardwood (med.)",
                                        "Ceramic charcoal: Coconut briquettes" =
                                          "ceramic charcoal: coconut charcoal",
                                        "Metal charcoal: Lump hardwood (sm.)" =
                                          "metal charcoal: lump hardwood (sm.)",
                                        "Metal charcoal: Lump hardwood (med.)" =
                                          "metal charcoal: lump hardwood (med.)",
                                        "Metal charcoal: Coconut briquettes" =
                                          "metal charcoal: coconut charcoal",
                                        "Wick kerosene: Kerosene" =
                                          "wick kerosene: kerosene",
                                        "Pressure kerosene: Kerosene" =
                                          "pressure kerosene: kerosene",
                                        "LPG: LPG" =
                                          "lpg: lpg") %>%
                    forcats::fct_relevel("Three-stone fire: Douglas fir",
                                        "Three-stone fire: Eucalyptus",
                                        "Three-stone fire: Oak",
                                        "Mud chulha: Douglas fir",
                                        "Mud chulha: Eucalyptus",
                                        "Mud chulha: Oak",
                                        "Rocket elbow: Douglas fir",
                                        "Rocket elbow: Eucalyptus",
                                        "Rocket elbow: Oak",
                                        "Built-in plancha: Douglas fir",
                                        "Built-in plancha: Eucalyptus",
                                        "Built-in plancha: Oak",
                                        "Fan rocket-elbow: Douglas fir",
                                        "Fan rocket-elbow: Eucalyptus",
                                        "Fan rocket-elbow: Oak",
                                        "Gasifier: West slope pellets",
                                        "Gasifier: Eucalyptus pellets",
                                        "Ceramic charcoal: Lump hardwood (sm.)",
                                        "Ceramic charcoal: Lump hardwood (med.)",
                                        "Ceramic charcoal: Coconut briquettes",
                                        "Metal charcoal: Lump hardwood (sm.)",
                                        "Metal charcoal: Lump hardwood (med.)",
                                        "Metal charcoal: Coconut briquettes",
                                        "Wick kerosene: Kerosene",
                                        "Pressure kerosene: Kerosene",
                                        "LPG: LPG"))
```

## add stove fuel info

```{r}
  emissions <-
    emissions %>%
    dplyr::left_join(samples %>%
                       dplyr::select(id, stove_fuel), by = "id")
```

## filter out values below background

```{r}
  emissions <-
    emissions %>%
    dplyr::mutate(val = ifelse(bg == "below", 0, val))
```

## rename pollutants

```{r}
  emissions <-
    emissions %>%
    dplyr::mutate(pol_category = ifelse(grepl("pahs", pol_category),
                                        "polycyclic aromatic hydrocarbons", pol_category))
```

## select pollutants

```{r}
  ultrafines <-
    emissions %>%
    dplyr::filter(grepl("ultrafines", pol)) %>%
    dplyr::filter(metric == "energy_delivered_ef") %>%
    dplyr::mutate(pol_category = "ultrafine particles",
                  pol = "ultrafine particles")
```

```{r}
  pahs <-
    emissions %>%
    dplyr::filter(grepl("aromatic", pol_category), pol != "naphthalene") %>%
    dplyr::filter(metric == "energy_delivered_ef")
```

## calculate stats

```{r}
  range_ultrafines <-
    ultrafines %>%
    dplyr::group_by(stove_fuel) %>%
    dplyr::summarise(min = min(val, na.rm = TRUE),
                     max = max(val, na.rm = TRUE)) %>%
    tidyr::gather("var", "val", min, max) %>%
    dplyr::mutate(sym = ifelse(var == "min", "[", "]"))
```

```{r}
  stats_pahs <-
    pahs %>%
    dplyr::group_by(id, stove_fuel) %>%
    dplyr::summarise(val = sum(val, na.rm = TRUE)) %>%
    dplyr::group_by(stove_fuel) %>%
    dplyr::summarise(min = min(val, na.rm = TRUE),
                     max = max(val, na.rm = TRUE),
                     mean = mean(val, na.rm = TRUE)) %>%
    tidyr::gather("var", "val", min, max, mean) %>%
    dplyr::mutate(sym = ifelse(var == "min", "[", "]"))
```

## calculate means by pollutant

```{r}
  ultrafines_p <-
    ultrafines %>%
    dplyr::group_by(stove_fuel) %>%
    dplyr::summarise(mean = mean(val, na.rm = TRUE)) %>%
    dplyr::mutate(pol_category = "ultrafine particles")
```


```{r}
  pahs_p <-
    pahs %>%
    dplyr::group_by(id, pol_subcategory, stove_fuel) %>%
    dplyr::summarise(val = sum(val, na.rm = TRUE)) %>%
    dplyr::group_by(pol_subcategory, stove_fuel) %>%
    dplyr::summarise(val = mean(val, na.rm = TRUE)) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(pol_subcategory = 
                    pol_subcategory %>% 
                    factor %>% 
                    fct_recode("three rings " = "three rings",
                               "four rings " = "four rings",
                               "five rings " = "five rings",
                               "six rings " = "six rings") %>%
                    forcats::fct_relevel("three rings ",
                                         "four rings ",
                                         "five rings ",
                                         "six rings ") %>%
                    forcats::fct_rev(),
                  pol_category = "polycyclic aromatic hydrocarbons")
```

# figures

```{r, echo=FALSE}
  p1 <- 
    ultrafines_p %>%
      ggplot(aes(x = stove_fuel, y = mean)) +
      geom_histogram(stat = "identity", fill = "plum4") +
      geom_text(data = range_ultrafines,
                aes(x = stove_fuel, y = val, label = sym), stroke = 2, size = 6, angle = 90, nudge_x = -0.05) +
        theme_minimal() +
        #scale_y_continuous(trans = "log10", limits = c(1e5, 1e8), breaks = c(1e5, 1e6, 1e7, 1e8)) +
      theme(text = element_text(size = 16),
            legend.justification = c(1, 1), 
            legend.position = c(1, 1),
            axis.text.y = element_text(size = 14),
            axis.text.x = element_text(size = 10, angle = 45, hjust = 1, vjust = 0.8),
            axis.title.y = element_text(size = 14),
            axis.title.x = element_blank(),
            legend.title = element_blank()) +
      ylab(expression(atop(paste('Ultrafine Particles'), paste('particles per Megajoul', e[delivered]))))
```

```{r, echo=FALSE}
  p2 <-
    pahs_p %>%
    ggplot(aes(x = stove_fuel, y = val)) +
      geom_histogram(aes(fill = pol_subcategory, order = pol_subcategory), stat = "identity") +
      geom_text(data = stats_pahs %>%
                  dplyr::filter(var != "mean"),
                aes(x = stove_fuel, y = val, label = sym), size = 6, angle = 90, nudge_x = -0.02) +
      scale_fill_manual(values = c("gray36", "grey", "darkcyan", "yellowgreen")) +
      #scale_y_continuous(limits = c(0, 30)) +
      #annotate("text", x = 1, y = 30, label = "35", size = 5) +
      #annotate("text", x = 2, y = 30, label = "55", size = 5) +
      #annotate("text", x = 3, y = 30, label = "73", size = 5) +
      theme_minimal() +
      guides(fill = guide_legend(nrow = 2, byrow = FALSE)) +
      theme(text = element_text(size = 16),
            legend.justification = c(1, 1), 
            legend.position = c(1, 1),
            axis.text.y = element_text(size = 14),
            axis.text.x = element_text(size = 10, angle = 45, hjust = 1, vjust = 0.8),
            axis.title.y = element_text(size = 14),
            axis.title.x = element_blank(),
            legend.title = element_blank(), 
            legend.spacing.x = unit(0.25, 'cm'), 
            legend.spacing.y = unit(0.25, 'cm')) +
    ylab(expression(atop(paste('Polycyclic Aromatic Hydrocarbons'), paste('miligrams per Megajoul', e[delivered]))))
```

```{r figure_3_byfuel, echo=FALSE, fig.width=12, fig.height=10, dpi=400, dev='pdf'}
  p1 + p2 + plot_layout(nrow = 2, heights = c(1, 1))
```
