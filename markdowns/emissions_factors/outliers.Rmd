---
title: "Emissions factor outliers"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r load_libraries, echo=FALSE, message=FALSE}
  if (!require("pacman")) install.packages("pacman")
  pacman::p_load(tidyverse, pals, devtools, patchwork)
  #devtools::install_github("thomasp85/patchwork")
```

```{r global_options, echo=FALSE}
  knitr::opts_chunk$set(fig.path ='figures/',
                        warning = FALSE, message = FALSE, cache = FALSE)
```

# tidy data

load data

```{r}
  emissions <- readRDS("../../r_data/emissions_factors.RDS")
  samples <- readRDS("../../r_data/samples.RDS")
```

```{r}
  samples <-
    samples %>%
    dplyr::mutate(stove = 
                    stove %>% 
                    factor %>% 
                    forcats::fct_relevel("three-stone fire",
                                         "clay ring",
                                         "rocket elbow",
                                         "built-in plancha",
                                         "fan rocket-elbow",
                                         "gasifier",
                                         "ceramic charcoal",
                                         "metal charcoal",
                                         "wick kerosene",
                                         "pressure kerosene",
                                         "lpg"))
```

# add stove fuel info

```{r}
  emissions <-
    emissions %>%
    dplyr::left_join(samples %>%
                       dplyr::select(id, stove, fuel, stovecat, fuelcat), by = "id")
```

# filter out values below background

```{r}
  emissions <-
    emissions %>%
    dplyr::filter(bg != "below")
```

# pm mass

## energy delivered

```{r, echo=FALSE, fig.width=10, fig.height=8}
  emissions %>%
    dplyr::filter(pol_category == "pm_mass", metric == "energy_delivered_ef") %>%
    ggplot(aes(x = id, y = val, color = qc)) +
    geom_point() +
    theme_bw() +
    theme(text = element_text(size = 12),
          legend.position = "top") +
    facet_wrap(~stove, scales = "free")
```

## mass of fuel

```{r, echo=FALSE, fig.width=10, fig.height=8}
  emissions %>%
    dplyr::filter(pol_category == "pm_mass", metric == "mass_fuel_ef") %>%
    ggplot(aes(x = id, y = val, color = qc)) +
    geom_point() +
    theme_bw() +
    theme(text = element_text(size = 12),
          legend.position = "top") +
    facet_wrap(~stove, scales = "free")
```

## energy of fuel

```{r, echo=FALSE, fig.width=10, fig.height=8}
  emissions %>%
    dplyr::filter(pol_category == "pm_mass", metric == "energy_fuel_ef") %>%
    ggplot(aes(x = id, y = val, color = qc)) +
    geom_point() +
    theme_bw() +
    theme(text = element_text(size = 12),
          legend.position = "top") +
    facet_wrap(~stove, scales = "free")
```

## emissions rate

```{r, echo=FALSE, fig.width=10, fig.height=8}
  emissions %>%
    dplyr::filter(pol_category == "pm_mass", metric == "emissions_rate") %>%
    ggplot(aes(x = id, y = val, color = qc)) +
    geom_point() +
    theme_bw() +
    theme(text = element_text(size = 12),
          legend.position = "top") +
    facet_wrap(~stove, scales = "free")
```

# elemental carbon

## energy delivered

```{r, echo=FALSE, fig.width=10, fig.height=8}
  emissions %>%
    dplyr::filter(pol_category == "ec", metric == "energy_delivered_ef") %>%
    ggplot(aes(x = id, y = val, color = qc)) +
    geom_point() +
    theme_bw() +
    theme(text = element_text(size = 12),
          legend.position = "top") +
    facet_wrap(~stove, scales = "free")
```

## mass of fuel

```{r, echo=FALSE, fig.width=10, fig.height=8}
  emissions %>%
    dplyr::filter(pol_category == "ec", metric == "mass_fuel_ef") %>%
    ggplot(aes(x = id, y = val, color = qc)) +
    geom_point() +
    theme_bw() +
    theme(text = element_text(size = 12),
          legend.position = "top") +
    facet_wrap(~stove, scales = "free")
```

## energy of fuel

```{r, echo=FALSE, fig.width=10, fig.height=8}
  emissions %>%
    dplyr::filter(pol_category == "ec", metric == "energy_fuel_ef") %>%
    ggplot(aes(x = id, y = val, color = qc)) +
    geom_point() +
    theme_bw() +
    theme(text = element_text(size = 12),
          legend.position = "top") +
    facet_wrap(~stove, scales = "free")
```

## emissions rate

```{r, echo=FALSE, fig.width=10, fig.height=8}
  emissions %>%
    dplyr::filter(pol_category == "ec", metric == "emissions_rate") %>%
    ggplot(aes(x = id, y = val, color = qc)) +
    geom_point() +
    theme_bw() +
    theme(text = element_text(size = 12),
          legend.position = "top") +
    facet_wrap(~stove, scales = "free")
```

# organic carbon

## energy delivered

```{r, echo=FALSE, fig.width=10, fig.height=8}
  emissions %>%
    dplyr::filter(pol_category == "oc", metric == "energy_delivered_ef") %>%
    ggplot(aes(x = id, y = val, color = qc)) +
    geom_point() +
    theme_bw() +
    theme(text = element_text(size = 12),
          legend.position = "top") +
    facet_wrap(~stove, scales = "free")
```

## mass of fuel

```{r, echo=FALSE, fig.width=10, fig.height=8}
  emissions %>%
    dplyr::filter(pol_category == "oc", metric == "mass_fuel_ef") %>%
    ggplot(aes(x = id, y = val, color = qc)) +
    geom_point() +
    theme_bw() +
    theme(text = element_text(size = 12),
          legend.position = "top") +
    facet_wrap(~stove, scales = "free")
```

## energy of fuel

```{r, echo=FALSE, fig.width=10, fig.height=8}
  emissions %>%
    dplyr::filter(pol_category == "oc", metric == "energy_fuel_ef") %>%
    ggplot(aes(x = id, y = val, color = qc)) +
    geom_point() +
    theme_bw() +
    theme(text = element_text(size = 12),
          legend.position = "top") +
    facet_wrap(~stove, scales = "free")
```

## emissions rate

```{r, echo=FALSE, fig.width=10, fig.height=8}
  emissions %>%
    dplyr::filter(pol_category == "oc", metric == "emissions_rate") %>%
    ggplot(aes(x = id, y = val, color = qc)) +
    geom_point() +
    theme_bw() +
    theme(text = element_text(size = 12),
          legend.position = "top") +
    facet_wrap(~stove, scales = "free")
```

# inorganic ions

## energy delivered

```{r, echo=FALSE, fig.width=10, fig.height=8}
  emissions %>%
    dplyr::filter(pol_category == "ions", metric == "energy_delivered_ef") %>%
    dplyr::group_by(id) %>%
    dplyr::summarise(val = sum(val, na.rm = TRUE),
                     qc = first(qc),
                     stove = first(stove)) %>%
    ggplot(aes(x = id, y = val, color = qc)) +
    geom_point() +
    theme_bw() +
    theme(text = element_text(size = 12),
          legend.position = "top") +
    facet_wrap(~stove, scales = "free")
```

## mass of fuel

```{r, echo=FALSE, fig.width=10, fig.height=8}
  emissions %>%
    dplyr::filter(pol_category == "ions", metric == "mass_fuel_ef") %>%
    dplyr::group_by(id) %>%
    dplyr::summarise(val = sum(val, na.rm = TRUE),
                     qc = first(qc),
                     stove = first(stove)) %>%
    ggplot(aes(x = id, y = val, color = qc)) +
    geom_point() +
    theme_bw() +
    theme(text = element_text(size = 12),
          legend.position = "top") +
    facet_wrap(~stove, scales = "free")
```

## energy of fuel

```{r, echo=FALSE, fig.width=10, fig.height=8}
  emissions %>%
    dplyr::filter(pol_category == "ions", metric == "energy_fuel_ef") %>%
    dplyr::group_by(id) %>%
    dplyr::summarise(val = sum(val, na.rm = TRUE),
                     qc = first(qc),
                     stove = first(stove)) %>%
    ggplot(aes(x = id, y = val, color = qc)) +
    geom_point() +
    theme_bw() +
    theme(text = element_text(size = 12),
          legend.position = "top") +
    facet_wrap(~stove, scales = "free")
```

## emissions rate

```{r, echo=FALSE, fig.width=10, fig.height=8}
  emissions %>%
    dplyr::filter(pol_category == "ions", metric == "emissions_rate") %>%
    dplyr::group_by(id) %>%
    dplyr::summarise(val = sum(val, na.rm = TRUE),
                     qc = first(qc),
                     stove = first(stove)) %>%
    ggplot(aes(x = id, y = val, color = qc)) +
    geom_point() +
    theme_bw() +
    theme(text = element_text(size = 12),
          legend.position = "top") +
    facet_wrap(~stove, scales = "free")
```