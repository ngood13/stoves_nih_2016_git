---
title: "Fivegas Data Processing"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo=FALSE, include=FALSE}
  library(tidyverse)
  library(forcats)
```

```{r global_options, include=FALSE}
  knitr::opts_chunk$set(fig.path = 'figures/', warning = FALSE, message = FALSE,
                        fig.width=10, fig.height = 4, cache = TRUE)
```

```{r}
  source("../r_scripts/R_tidy.R")
  source("../r_scripts/R_functions.R")
```

# Load data

* data logged in ppm units.

```{r}
  fivegas <- readRDS("../r_files/fivegas.RDS")
```

* sample information

```{r}
  samples <- readRDS("../r_files/samples.RDS")
```

* notes

```{r}
  #load("../r_files/notes.Rda")
```

# Units

* Convert co2 from percent to ppm (note CO and CH4 are collected as ppm)

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  fivegas <- dplyr::mutate(fivegas, co2 = co2 * 10^4)
```

# Reformat data

## concentration

Convert concentration data to longer format

```{r}
#Edited 7/12/17   
  fivegas_conc <- tibble::as_tibble(dplyr::select(fivegas, -time_s) %>%
                  tidyr::gather("pol", "ppm", ch4:co))
```

```{r}
 head(fivegas_conc, 2)
```

Remove NOx and oxygen rows (channels not used during study)

```{r}
 fivegas_merged <- dplyr::filter(fivegas_conc, pol != "nox", pol != "o2")
```

# QC

Extract notes relevant to  fivegas analyzer

```{r}
  # notes <- dplyr::filter(notes, grepl("fivegas|all", notes$inst) == TRUE)
```

Flag bad data from notes and plots

```{r}
  # notes$qc[] <- "ok"
```

Make one flag per test precidented from bad to ok.

```{r}
  # flags <- dplyr::select(notes, id, qc) %>%
  #          dplyr::group_by(id) %>%
  #          dplyr::arrange(qc) %>%
  #          dplyr::summarise(qc = first(qc))
```

Merge with data

```{r}
  # fivegas_merged <- dplyr::left_join(fivegas_merged, flags, by = "id") %>%
  #                   dplyr::mutate(id = as.factor(id),
  #                                 qc = as.factor(ifelse(is.na(qc),
  #                                                "ok", as.character(qc))))

```

Additional bad tests

```{r}
  # fivegas_merged$qc[fivegas_merged$id == ""] <- "bad"
  # fivegas_merged$qc[fivegas_merged$id == ""] <- "bad"
  # fivegas_merged$qc[fivegas_merged$id == ""] <- "bad"
  # fivegas_merged$qc[fivegas_merged$id == ""] <- "bad"
```

# Save merged file

```{r}
  saveRDS(fivegas_merged, file = "../r_files/fivegas_merged.RDS")
```

# Summary

The Fivegas analyzer measured during `r length(unique(fivegas_merged$id))` experiments between `r min(fivegas_merged$date, na.rm = TRUE)` and `r max(fivegas_merged$date, na.rm = TRUE)`. There is no fivegas data for tests: `r setdiff(as.character(samples$id), as.character(fivegas_merged$id))`.

# Plots

```{r, echo = FALSE, warning = FALSE, message = FALSE, results = 'markup', cache=FALSE, fig.width = 12, fig.height = 40, eval = TRUE}
  df <- dplyr::mutate(fivegas_merged, id = as.character(id)) %>%
        dplyr::arrange(id) %>%
        dplyr::mutate(id = as.factor(id))

  ggplot(df, aes(datetime, ppm, group = pol, colour=pol)) + 
    geom_line() +
    scale_y_log10(limits = c(.01, 10^3)) +
    scale_colour_manual(breaks= df$pol,
                        values = 
                        c("ch4" = "mediumaquamarine",
                        "co" = "mediumorchid1",
                        "co2" = "darkorange1")) +
    facet_wrap(~id, ncol = 3, scale = "free") +
    theme_minimal() +
    xlab("") +
    theme(legend.position = "top")
```
