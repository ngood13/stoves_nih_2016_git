---
title: "Fivegas Data Processing"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo=FALSE, include=FALSE}
  library(tidyverse)
  library(forcats)
  library(svglite)
  library(knitr)
```

```{r global_options, include=FALSE}
  knitr::opts_chunk$set(fig.path = 'figures/', warning = FALSE, message = FALSE,
                        fig.width=10, fig.height = 4, cache = FALSE)
```

```{r}
  source("../r_scripts/R_tidy.R")
  source("../r_scripts/R_functions.R")
```

# Load data

* data logged in ppm units.

```{r}
  fivegas <- readRDS("../r_files/fivegas.RDS")
```

* sample information

```{r}
  samples <- readRDS("../r_files/samples.RDS")
  fuel_prep_clean <- readRDS("../r_files/fuel_prep_clean.RDS")
  fuel_wgts <- readRDS("../r_files/fuel_wgts.RDS")
  carbon_bal_2 <- readRDS("../r_files/carbon_bal_2.RDS")
```

* notes

```{r}
  #load("../r_files/notes.Rda")
```

# Units

* Convert co2 from percent to ppm (note CO and CH4 are collected as ppm)

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  fivegas <- dplyr::mutate(fivegas, co2 = co2 * 10^4)
```

# Reformat data

## concentration

Convert concentration data to longer format

```{r}
#Edited 7/12/17   
  fivegas_conc <- tibble::as_tibble(dplyr::select(fivegas, -time_s) %>%
                  tidyr::gather("pol", "ppm", ch4:co))
```

```{r}
 head(fivegas_conc, 2)
```

Remove NOx and oxygen rows (channels not used during study)

```{r}
 fivegas_merged <- dplyr::filter(fivegas_conc, pol != "nox", pol != "o2")
```

# QC

Extract notes relevant to  fivegas analyzer

```{r}
  # notes <- dplyr::filter(notes, grepl("fivegas|all", notes$inst) == TRUE)
```

Flag bad data from notes and plots

```{r}
  # notes$qc[] <- "ok"
```

Make one flag per test precidented from bad to ok.

```{r}
  # flags <- dplyr::select(notes, id, qc) %>%
  #          dplyr::group_by(id) %>%
  #          dplyr::arrange(qc) %>%
  #          dplyr::summarise(qc = first(qc))
```

Merge with data

```{r}
  # fivegas_merged <- dplyr::left_join(fivegas_merged, flags, by = "id") %>%
  #                   dplyr::mutate(id = as.factor(id),
  #                                 qc = as.factor(ifelse(is.na(qc),
  #                                                "ok", as.character(qc))))

```

Additional bad tests

```{r}
  # fivegas_merged$qc[fivegas_merged$id == ""] <- "bad"
  # fivegas_merged$qc[fivegas_merged$id == ""] <- "bad"
  # fivegas_merged$qc[fivegas_merged$id == ""] <- "bad"
  # fivegas_merged$qc[fivegas_merged$id == ""] <- "bad"
```

# Save merged file

```{r}
  saveRDS(fivegas_merged, file = "../r_files/fivegas_merged.RDS")
```

# Summary

The Fivegas analyzer measured during `r length(unique(fivegas_merged$id))` experiments between `r min(fivegas_merged$date, na.rm = TRUE)` and `r max(fivegas_merged$date, na.rm = TRUE)`. There is no fivegas data for tests: `r setdiff(as.character(samples$id), as.character(fivegas_merged$id))`.

# Plots

```{r, echo = FALSE, warning = FALSE, message = FALSE, results = 'markup', cache=FALSE, fig.width = 12, fig.height = 40, eval = TRUE}
  df <- dplyr::mutate(fivegas_merged, id = as.character(id)) %>%
        dplyr::arrange(id) %>%
        dplyr::mutate(id = as.factor(id))

  ggplot(df, aes(datetime, ppm, group = pol, colour=pol)) + 
    geom_line() +
    scale_y_log10(limits = c(.01, 10^4)) +
    scale_colour_manual(breaks= df$pol,
                        values = 
                        c("ch4" = "mediumaquamarine",
                        "co" = "mediumorchid1",
                        "co2" = "darkorange1")) +
    facet_wrap(~id, ncol = 3, scale = "free") +
    theme_minimal() +
    xlab("") +
    theme(legend.position = "top")
```

```{r}
# calculate MCE
summary <- tidyr::spread(fivegas_merged, pol, ppm)

carbon_bal_2 <- select(carbon_bal_2, id, mean_mc)
           
library(forcats)

bg <- dplyr::filter(summary, grepl("^BG[0-9]", id) == TRUE) %>%
      dplyr::summarise(mean_co_bg = mean(co), mean_co2_bg = mean (co2))

mce <- dplyr::group_by(summary, id) %>%
           dplyr::summarise(mean_co = mean(co), mean_co2 = mean(co2)) %>%
           dplyr::mutate(mce = (mean_co2 - bg$mean_co2_bg)/
                               ((mean_co2- bg$mean_co2_bg) + (mean_co - bg$mean_co_bg)))

mce <- dplyr::left_join(mce, samples) %>%
       dplyr::select(-date, -stove, - fuel, - notes, - mc_target) %>%
       dplyr::filter(type != "bg", id != "FH2", id != "LM4")

#mce check for significance
df_anova <- dplyr::select(mce, mce, type, mc_level, id) %>%
       dplyr::mutate(type = as.factor(type),
                     mc_level = as.factor(mc_level)) %>%
       dplyr::mutate(test_fuel_type = paste(type, mc_level, sep = "_"))
                
TukeyHSD(aov(mce ~ test_fuel_type, df_anova))
TukeyHSD(aov(mce ~ mc_level, df_anova))
pairwise.t.test(df_anova$mce, df_anova$test_fuel_type, p.adj = "none")
```

### Modified combustion efficiency

I updated just this chunk of code on Dec. 4, 2018. -- J.T. 

```{r, fig.width=3.15, fig.height=3.15, fig.align='center'}
       
  mce_plot <- dplyr::mutate(mce, mc_level = forcats::fct_relevel(mc_level, "low", "med", "high")) %>%
              dplyr::left_join(carbon_bal_2, by = "id") %>%
              dplyr::mutate(type = forcats::fct_recode(type, "Split"  = "field",
                                                             "Milled" = "lab"))

  ggplot(data=mce_plot, aes(x=mean_mc, y=100*mce, shape=type)) + 
         geom_point(size=3, alpha=0.7) +
         coord_cartesian(xlim=c(4,30), ylim=c(96.2,99.2)) +
         scale_x_continuous(breaks=seq(5,30,10)) + 
         scale_y_continuous(breaks=seq(96,99,1)) + 
         xlab("Moisture content (%)") + 
         ylab("Modified combustion efficiency (%)") +
         labs(shape = "Fuel shape") + 
         theme(aspect.ratio=1,
               panel.grid.major.x = element_line(color="gray95"),
               panel.grid.minor.x = element_line(color="gray95"),
               panel.grid.major.y = element_line(color="gray95"),
               panel.grid.minor.y = element_line(color="gray95"),
               panel.border     = element_rect(fill=NA),
               panel.background = element_rect(fill='white'),
               axis.text  = element_text(size=10, color='black'),
               axis.title = element_text(size=10, color='black'),
               axis.ticks = element_line(color='black'),
               legend.text  = element_text(size=10, color='black'),
               legend.title = element_text(size=10, color='black'),
               legend.key   = element_blank(),
               legend.box.background = element_rect(color="black", size=0.6),
               legend.position = c(0.8,0.8)) 

  saveRDS(mce_plot, file = "../r_files/mce_plot.RDS")

  ggsave(filename="mce_fig.svg", plot=last_plot(), device="svg", width=8/2.54, height=8/2.54)
  ggsave(filename="mce_fig.pdf", plot=last_plot(), device="pdf", width=8/2.54, height=8/2.54)
```

```{r}
  df_mce_summary <- group_by(mce, mc_level) %>%
                     summarise(mean   = mean(100*mce),
                               sd     = sd(100*mce))

  kable(df_mce_summary, format="markdown", digits=c(2,1),
        col.names=c("Moisture level", "Mean (%)","SD (%)"))
```

```{r}
  TukeyHSD(aov(mce ~ mc_level, mce))
```

```{r}
  temp_merged <- readRDS("../r_files/temp_merged.RDS")
  test_times <- readRDS("../r_files/test_times.RDS")
```

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  times <- dplyr::filter(test_times, var == "set_1" | var == "end") %>%
           tidyr::spread(var, value) %>%
           dplyr::rename(start = set_1) %>%
           dplyr::filter(!grepl("^BG", id))
```

Extract temperature for periods of interest

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  
  temp_merged <- mutate(temp_merged, time = time + 3600)  
  
  df_temp_e <- dplyr::filter(temp_merged, grepl("pot", loc))  
  df_temp_e <- filter_temp(times, df_temp_e) %>%
               dplyr::filter(!grepl("FH2", id)) %>%
               group_by(id) %>%
               dplyr::summarise(temp_mean = mean(t_oc)) 
```

```{r}
  df_mce_temp <- left_join(mce, df_temp_e, by=c("id")) 

  pearson_r <- cor.test(df_mce_temp$temp_mean, df_mce_temp$mce, method="pearson", conf.level=0.95)
  pearson_r
```

```{r}
  mod_mce_temp <- lm(mce ~ temp_mean, df_mce_temp)

  summary(mod_mce_temp)
```

```{r, fig.width=6.3, fig.height=6.3, fig.align='center'}
  par(mfrow = c(2, 2))
  plot(mod_mce_temp)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  # Define the colors to use in the plots. 

  purple <- "#330099"
  gold   <- "#FF9900"
  teal1  <- "#33CC99"
  teal2  <- "#339999"
  teal3  <- "#0099CC"
  orange <- "#FF6633"
  pink1  <- "#CC0066"
  pink2  <- "#FF3366"
```

```{r, fig.width=4.3, fig.height=3.15, fig.align='center'}
       
  df_mce_temp <- dplyr::mutate(df_mce_temp, type = forcats::fct_recode(type, "Split"  = "field",
                                                                             "Milled" = "lab"),
                               mc_level = as.character(mc_level),
                               mc_level = ifelse(mc_level=="high", "High",   mc_level),
                               mc_level = ifelse(mc_level=="med",  "Medium", mc_level),
                               mc_level = ifelse(mc_level=="low",  "Low",    mc_level),
                               mc_level = as.factor(mc_level),
                               mc_level = forcats::fct_relevel(mc_level, "High","Medium","Low"))

  r_text <- sprintf("%.2f", round(pearson_r$estimate, digits = 3))
  textlab_r <- paste("r == ",r_text,sep="")

  ggplot(data=df_mce_temp, aes(x=temp_mean, y=100*mce, shape=type, color=mc_level)) + 
         geom_point(size=3, alpha=0.7) +
            scale_color_manual(values = c(teal3,gold,pink1)) +
         coord_cartesian(xlim=c(305,520), ylim=c(96.1,99.1)) +
         scale_x_continuous(breaks=seq(300,500,50)) + 
         scale_y_continuous(breaks=seq(96,99,1)) + 
         xlab(expression(Mean ~ exhaust ~ temperature ~ "(" * degree * C * ")")) + 
         ylab("Modified combustion efficiency (%)") +
         labs(shape="Fuel shape", color="Moisture level") + 
         theme(aspect.ratio=1,
               panel.border     = element_rect(fill=NA),
               panel.background = element_rect(fill='white'),
               axis.text  = element_text(size=10, color='black'),
               axis.title = element_text(size=10, color='black'),
               axis.ticks = element_line(color='black'),
               legend.text  = element_text(size=10, color='black'),
               legend.title = element_text(size=10, color='black'),
               legend.key   = element_blank(),
               legend.position = "right") + 
        geom_text(aes(x=310, y=99, label=textlab_r), parse=TRUE,
                  color='black', hjust='left', size=3.5, fontface='plain')

  ggsave(filename="mce_temp.pdf", plot=last_plot(), device="pdf", width=4.3, height=8/2.54)
```


```{r}
mce_means <- ungroup(mce, `Fuel Shape`) %>%
       group_by(mc_level) %>%
       summarise(sd_mce = sd(mce), mean_mce = mean(mce))

#inefficienies
mce_plot2 <- mutate(mce_plot, mce = 100-mce)

ggplot(data = mce_plot2, aes(x = mean_mc, y = mce, color = `MC Level`, shape = `Fuel shape`)) +
  #geom_boxplot(size = 1) +
  geom_point(size = 4) +
  theme_bw() +
  labs(x = "Moisture Content (%)", y = "100 - MCE (%)") +
  theme(text = element_text(size=15)) +
  scale_color_manual(values = c("darkorange", "darkorchid3", "blue")) +
  scale_x_continuous(breaks = c(5, 15, 25))
```
