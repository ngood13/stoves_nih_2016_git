---
title: "Fivegas Data Processing"
date: "December 11, 2018"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo=FALSE, include=FALSE}
  library(tidyverse)
  library(knitr)
```

```{r global_options, include=FALSE}
  knitr::opts_chunk$set(fig.path = 'figures/', warning = FALSE, message = FALSE,
                        fig.width=10, fig.height = 4, cache = FALSE)
```

```{r}
  source("../r_scripts/R_tidy.R")
  source("../r_scripts/R_functions.R")
```

# Load data

Test metadata:

```{r}
  samples <- readRDS("../r_files/samples.RDS")
```

Five gas data logged in ppm units:

```{r}
  fivegas <- readRDS("../r_files/fivegas.RDS")
```

# Reformat data

Convert the CO~2~ concentrations from percent volume to ppmv (note that CO and CH~4~ were recorded as ppmv).

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  fivegas_merged <- dplyr::mutate(fivegas, co2 = co2 * 10^4)
```

Convert the concentration data to longer format.

```{r}
  fivegas_merged <- tibble::as_tibble(dplyr::select(fivegas_merged, -time_s) %>%
                    tidyr::gather("pol", "ppm", ch4:co))

  head(fivegas_merged, 2)
```

Remove NO~x~ and oxygen rows (these channels were not used during the study)

```{r}
 fivegas_merged <- dplyr::filter(fivegas_merged, pol != "nox", pol != "o2")
```

# QC

Extract notes relevant to the five gas analyzer.

```{r}
  # notes <- dplyr::filter(notes, grepl("fivegas|all", notes$inst) == TRUE)
```

Flag bad data from notes and plots.

```{r}
  # notes$qc[] <- "ok"
```

Make one flag per test precidented from bad to ok.

```{r}
  # flags <- dplyr::select(notes, id, qc) %>%
  #          dplyr::group_by(id) %>%
  #          dplyr::arrange(qc) %>%
  #          dplyr::summarise(qc = first(qc))
```

Merge with data

```{r}
  # fivegas_merged <- dplyr::left_join(fivegas_merged, flags, by = "id") %>%
  #                   dplyr::mutate(id = as.factor(id),
  #                                 qc = as.factor(ifelse(is.na(qc),
  #                                                "ok", as.character(qc))))

```

Additional bad tests

```{r}
  # fivegas_merged$qc[fivegas_merged$id == ""] <- "bad"
  # fivegas_merged$qc[fivegas_merged$id == ""] <- "bad"
  # fivegas_merged$qc[fivegas_merged$id == ""] <- "bad"
  # fivegas_merged$qc[fivegas_merged$id == ""] <- "bad"
```

# Save merged file

```{r}
  saveRDS(fivegas_merged, file = "../r_files/fivegas_merged.RDS")
```

# Summary

The Fivegas analyzer measured during `r length(unique(fivegas_merged$id))` experiments between `r min(fivegas_merged$date, na.rm = TRUE)` and `r max(fivegas_merged$date, na.rm = TRUE)`. There is no fivegas data for tests: `r setdiff(as.character(samples$id), as.character(fivegas_merged$id))`.

# Plot the data

```{r, echo = FALSE, warning = FALSE, message = FALSE, results = 'markup', cache=FALSE, fig.width=6.5, fig.height=16, fig.align='center'}
  
  log10_breaks <- c(0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,
                     1,2,3,4,5,6,7,8,9,
                     10,20,30,40,50,60,70,80,90,
                     100,200,300,400,500,600,700,800,900,
                     1000,2000,3000,4000,5000,6000,7000,8000,9000,10000)

  df_plot <- dplyr::mutate(fivegas_merged, id = as.character(id)) %>%
             dplyr::arrange(id) %>%
             dplyr::mutate(id = as.factor(id))

  ggplot(df_plot, aes(x=datetime, y=ppm, group=pol, color=pol)) + 
    geom_line() +
    facet_wrap(~id, ncol=4, scale="free_x") +
    
    # format the plot
    coord_cartesian(ylim=c(1,10000)) + 
    scale_y_log10(breaks=c(1,10,100,1000,10000),
                  minor_breaks=log10_breaks) +
    scale_colour_manual(values = c("ch4" = "mediumaquamarine",
                                   "co"  = "mediumorchid1",
                                   "co2" = "darkorange1")) +
    xlab("") +
    ylab("Mixing ratio (ppmv)") + 
    theme(aspect.ratio=1,
          panel.border     = element_rect(fill=NA),
          panel.background = element_rect(fill='white'),
          panel.grid.major = element_line(color="gray90"),
          panel.grid.minor = element_line(color="gray90"),
          text       = element_text(size=10, color='black'),
          axis.text  = element_text(size= 9, color='black'),
          axis.title = element_text(size=10, color='black'),
          axis.ticks = element_line(color='black'),
          legend.position = "top") 
```