---
title: "Fivegas Data Processing"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo=FALSE, include=FALSE}
  library(tidyverse)
  library(forcats)
  library(svglite)
```

```{r global_options, include=FALSE}
  knitr::opts_chunk$set(fig.path = 'figures/', warning = FALSE, message = FALSE,
                        fig.width=10, fig.height = 4, cache = FALSE)
```

```{r}
  source("../r_scripts/R_tidy.R")
  source("../r_scripts/R_functions.R")
```

# Load data

* data logged in ppm units.

```{r}
  fivegas <- readRDS("../r_files/fivegas.RDS")
  #samples <- readRDS("../r_files/samples.RDS")
```

* sample information

```{r}
  samples <- readRDS("../r_files/samples.RDS")
  fuel_prep_clean <- readRDS("../r_files/fuel_prep_clean.RDS")
  fuel_wgts <- readRDS("../r_files/fuel_wgts.RDS")
  carbon_bal_2 <- readRDS("../r_files/carbon_bal_2.RDS")
```

* notes

```{r}
  #load("../r_files/notes.Rda")
```

# Units

* Convert co2 from percent to ppm (note CO and CH4 are collected as ppm)

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  fivegas <- dplyr::mutate(fivegas, co2 = co2 * 10^4)
```

# Reformat data

## concentration

Convert concentration data to longer format

```{r}
#Edited 7/12/17   
  fivegas_conc <- tibble::as_tibble(dplyr::select(fivegas, -time_s) %>%
                  tidyr::gather("pol", "ppm", ch4:co))
```

```{r}
 head(fivegas_conc, 2)
```

Remove NOx and oxygen rows (channels not used during study)

```{r}
 fivegas_merged <- dplyr::filter(fivegas_conc, pol != "nox", pol != "o2")
```

# QC

Extract notes relevant to  fivegas analyzer

```{r}
  # notes <- dplyr::filter(notes, grepl("fivegas|all", notes$inst) == TRUE)
```

Flag bad data from notes and plots

```{r}
  # notes$qc[] <- "ok"
```

Make one flag per test precidented from bad to ok.

```{r}
  # flags <- dplyr::select(notes, id, qc) %>%
  #          dplyr::group_by(id) %>%
  #          dplyr::arrange(qc) %>%
  #          dplyr::summarise(qc = first(qc))
```

Merge with data

```{r}
  # fivegas_merged <- dplyr::left_join(fivegas_merged, flags, by = "id") %>%
  #                   dplyr::mutate(id = as.factor(id),
  #                                 qc = as.factor(ifelse(is.na(qc),
  #                                                "ok", as.character(qc))))

```

Additional bad tests

```{r}
  # fivegas_merged$qc[fivegas_merged$id == ""] <- "bad"
  # fivegas_merged$qc[fivegas_merged$id == ""] <- "bad"
  # fivegas_merged$qc[fivegas_merged$id == ""] <- "bad"
  # fivegas_merged$qc[fivegas_merged$id == ""] <- "bad"
```

# Save merged file

```{r}
  saveRDS(fivegas_merged, file = "../r_files/fivegas_merged.RDS")
```

# Summary

The Fivegas analyzer measured during `r length(unique(fivegas_merged$id))` experiments between `r min(fivegas_merged$date, na.rm = TRUE)` and `r max(fivegas_merged$date, na.rm = TRUE)`. There is no fivegas data for tests: `r setdiff(as.character(samples$id), as.character(fivegas_merged$id))`.

# Plots

```{r, echo = FALSE, warning = FALSE, message = FALSE, results = 'markup', cache=FALSE, fig.width = 12, fig.height = 40, eval = TRUE}
  df <- dplyr::mutate(fivegas_merged, id = as.character(id)) %>%
        dplyr::arrange(id) %>%
        dplyr::mutate(id = as.factor(id))

  ggplot(df, aes(datetime, ppm, group = pol, colour=pol)) + 
    geom_line() +
    scale_y_log10(limits = c(.01, 10^4)) +
    scale_colour_manual(breaks= df$pol,
                        values = 
                        c("ch4" = "mediumaquamarine",
                        "co" = "mediumorchid1",
                        "co2" = "darkorange1")) +
    facet_wrap(~id, ncol = 3, scale = "free") +
    theme_minimal() +
    xlab("") +
    theme(legend.position = "top")
```

```{r}
# calculate MCE
summary <- tidyr::spread(fivegas_merged, pol, ppm)

carbon_bal_2 <- select(carbon_bal_2, id, mean_mc)
           
library(forcats)

bg <- dplyr::filter(summary, grepl("^BG[0-9]", id) == TRUE) %>%
      dplyr::summarise(mean_co_bg = mean(co), mean_co2_bg = mean (co2))

mce <- dplyr::group_by(summary, id) %>%
           dplyr::summarise(mean_co = mean(co), mean_co2 = mean(co2)) %>%
           dplyr::mutate(mce = (mean_co2 - bg$mean_co2_bg)/((mean_co2- bg$mean_co2_bg)
                                                            + (mean_co - bg$mean_co_bg)))

mce <- dplyr::left_join(mce, samples) %>%
       dplyr::select(-date, -stove, - fuel, - notes, - mc_target) %>%
       dplyr::filter(type != "bg", id != "FH2", id != "LM4")

#mce check for significance
df_anova <- dplyr::select(mce, mce, type, mc_level, id) %>%
       dplyr::mutate(type = as.factor(type),
                     mc_level = as.factor(mc_level)) %>%
       dplyr::mutate(test_fuel_type = paste(type, mc_level, sep = "_"))
                
TukeyHSD(aov(mce ~ test_fuel_type, df_anova))
TukeyHSD(aov(mce ~ mc_level, df_anova))
pairwise.t.test(df_anova$mce, df_anova$test_fuel_type, p.adj = "none")
```

```{r fig.height=3, fig.width=3.5}
       
mce_plot <- dplyr::mutate(mce, mc_level = forcats::fct_relevel(mc_level, "low", "med", "high")) %>%
       dplyr::mutate(mc_level = forcats::fct_recode(mc_level, "medium" = "med")) %>%
       dplyr::left_join(carbon_bal_2, by = "id") %>%
       dplyr::mutate(type = forcats::fct_recode(type, "Split" = "field",
                                                      "Milled" = "lab"), mce = 100*mce) %>%
       dplyr::group_by(mc_level, type) %>%
       dplyr::rename(`MC Level` = mc_level, `Fuel Shape` = type)

mce_fig <- ggplot(data = mce_plot, aes(x = mean_mc, y = mce, shape = `Fuel Shape`)) + #, color = `MC Level`
  #geom_boxplot(size = 1) +
  geom_point(size = 3) +
  theme_bw() +
  labs(x = "Moisture Content (%)", y = "Modified Combustion Efficiency (%)") +
  theme(text = element_text(size=10), legend.position = "top") +
  #scale_color_manual(values = c("darkorange", "darkorchid3", "blue")) +
  scale_x_continuous(breaks = c(5, 15, 25))

saveRDS(mce_plot, file = "../r_files/mce_plot.RDS")

ggsave(filename = "mce_fig.svg", plot = mce_fig, device = "svg", width = 3, height = 4, units = "in")
```

```{r}
mce_means <- ungroup(mce, `Fuel Shape`) %>%
       group_by(mc_level) %>%
       summarise(sd_mce = sd(mce), mean_mce = mean(mce))

#inefficienies
mce_plot2 <- mutate(mce_plot, mce = 100-mce)

ggplot(data = mce_plot2, aes(x = mean_mc, y = mce, color = `MC Level`, shape = `Fuel Shape`)) +
  #geom_boxplot(size = 1) +
  geom_point(size = 4) +
  theme_bw() +
  labs(x = "Moisture Content (%)", y = "100 - MCE (%)") +
  theme(text = element_text(size=15)) +
  scale_color_manual(values = c("darkorange", "darkorchid3", "blue")) +
  scale_x_continuous(breaks = c(5, 15, 25))
```

