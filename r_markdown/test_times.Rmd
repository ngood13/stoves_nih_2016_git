---
title: "Test Times"
date: "December 21, 2018"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r load_libraries, echo=FALSE, include=FALSE}
  library(tidyverse)
  library(lubridate)
  library(gridExtra)
```

```{r load_functions}
  source("../R_scripts/R_tidy.R")
  source("../r_scripts/R_functions.R")
```

# Load data

Test metadata: 

```{r}
  samples <- readRDS("../r_files/samples.RDS")
```

Log data: 

```{r}
  test_log   <- readRDS("../r_files/mc_test_log.RDS")
  tester_one <- readRDS("../r_files/data_tester_one.RDS")
  tester_two <- readRDS("../r_files/data_tester_two.RDS")
```

# Combine data

### Test log

```{r}
  test_times <- tidy_id_date(test_log, "^time_", "time_") %>%
                dplyr::filter(!is.na(value))
```

### Five gas

Get start and stop times for pre- and post-test fivegas background samples: 

```{r}
  times_bg_fivegas <- dplyr::select(tester_one, id, 
                                    time_start_fivegas_prebg,
                                    time_end_fivegas_prebg,
                                    time_start_fivegas_post_bg,
                                    time_end_fivegas_post_bg) %>%
                      dplyr::rename(bg_pre_start_fivegas  = time_start_fivegas_prebg,
                                    bg_pre_end_fivegas    = time_end_fivegas_prebg,
                                    bg_post_start_fivegas = time_start_fivegas_post_bg,
                                    bg_post_end_fivegas   = time_end_fivegas_post_bg) %>%
                      tidyr::gather("var", "value", 2:5) %>%
                      dplyr::inner_join(dplyr::select(samples, id, date), by = "id")  %>%
                      dplyr::filter(!is.na(value)) 
```

### Filter samples

```{r}
  times_filters <- dplyr::select(tester_one, id, date, matches(".*time.*cart.*")) %>%
                   dplyr::rename(start_filters = time_start_cart_white_orange,
                                 end_filters   = time_end_cart_white_orange) %>%
                   tidyr::gather("var", "value", 3:4)
```

### SMPS and PAX

Get start and stop times for PAX/SMPS background samples: 

```{r}
  times_bg_pax_smps <- dplyr::select(tester_two, id, 
                                     time_start_smps_pax_bg_pre,
                                     time_end_smps_pax_bg_pre,
                                     time_start_smps_pax_bg_post,
                                     time_end_smps_pax_bg_post) %>%
                       dplyr::rename(bg_pre_start_pax_smps  = time_start_smps_pax_bg_pre,
                                     bg_pre_end_pax_smps    = time_end_smps_pax_bg_pre,
                                     bg_post_start_pax_smps = time_start_smps_pax_bg_post,
                                     bg_post_end_pax_smps   = time_end_smps_pax_bg_post) %>%
                      tidyr::gather("var", "value", 2:5) %>%
                      dplyr::inner_join(dplyr::select(samples, id, date), by = "id")     %>%
                      dplyr::filter(!is.na(value)) 
```

### Carbonyls

```{r}
  times_carb <- tidy_id_date(tester_two, "^time_.*carb$", "^time_") %>%
                dplyr::mutate(var = as.character(var)) %>%
                dplyr::filter(!is.na(value))
```

### VOCs

```{r}
  times_voc <- dplyr::select(tester_one, id, date, matches("^time_.*voc$")) %>%
               dplyr::rename(start_voc = time_start_voc,
                             end_voc   = time_end_voc) %>%
               tidyr::gather("var", "value", 3:4)
```

### Combine

```{r}
  test_times <- dplyr::bind_rows(test_times,
                                 times_bg_fivegas,
                                 times_filters,
                                 times_bg_pax_smps,
                                 times_carb,
                                 times_voc)
```

# Save data

```{r}
  saveRDS(test_times, file = "../r_files/test_times_all.RDS")
```

# Check for outliers

Check for unexpected values (before 4 am or after 8 pm): 

```{r, echo=FALSE}
  outliers <- dplyr::filter(test_times, value < 60 * 60 * 4 | value > 60 * 60 * 20)

  knitr::kable(outliers, "markdown", digits = 2)
```

Calculate sample durations (in minutes): 

```{r}
  times <- dplyr::filter(test_times, var == "ignite" | var == "end") %>%
           tidyr::spread(var, value) %>%
           dplyr::mutate(dur = (end - ignite) / 60) # minutes
```

```{r, echo=FALSE, fig.width=6.3, fig.height=3.15, fig.align='center'}
  p_hist <- ggplot(times, aes(x = dur)) +
            geom_histogram(breaks = seq(25,65,5), color="black") +
            xlab("Test duration (minutes)") +
            ylab("Count") + 
            theme(aspect.ratio = 1,
              panel.border = element_rect(fill=NA, color="black"),
              panel.background = element_rect(fill="white"),
              panel.grid.major = element_line(color="gray95"),
              panel.grid.minor = element_line(color="gray95"),
              axis.ticks = element_line(color="black"),
              axis.text  = element_text(size=9, color="black"),
              axis.title = element_text(size=9, color="black"))

  p_data <- dplyr::mutate(times,
                          value_norm = (dur - mean(dur, na.rm = TRUE)) / sd(dur, na.rm = TRUE),
                          outlier    = ifelse(is_outlier(dur), as.character(id), NA))

  p_box <- ggplot(p_data, aes(x = "Duration", y = value_norm)) +
           geom_boxplot() +
           geom_text(aes(label = outlier), na.rm = TRUE, hjust = -0.3, size = 4) +
           theme_minimal() +
           ylab("z score normalized value") +
           xlab("") +
           theme(aspect.ratio = 1,
              panel.border = element_rect(fill=NA, color="black"),
              panel.background = element_rect(fill="white"),
              panel.grid.major.y = element_line(color="gray95"),
              panel.grid.minor.y = element_line(color="gray95"),
              axis.ticks = element_line(color="black"),
              axis.text  = element_text(size=9, color="black"),
              axis.title = element_text(size=9, color="black"))

  grid.arrange(p_hist, p_box, ncol = 2)
```
