---
title: "Pollutant Emissions"
date: "December 21, 2018"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo=FALSE, include=FALSE}
  library(tidyverse)
  library(knitr)
  library(lubridate)
  library(chron)
  library(car)
  library(SDMTools)
```

```{r global_options, include=FALSE}
  knitr::opts_chunk$set(fig.path = 'figures/',
                        warning = FALSE,
                        message = FALSE,
                        fig.width = 10, fig.height = 4,
                        cache = FALSE)
```

```{r}
  source("../r_scripts/R_functions.R")
```

---

# Load

Test metadata

```{r}
  samples    <- readRDS("../r_files/samples.RDS")
  test_times <- readRDS("../r_files/test_times_all.RDS") 
```

Constants

```{r}
  hood_flow       <- readRDS("../r_files/hood_flow.RDS")   # m^3/min
  pol_properties  <- readRDS("../r_files/pol_properties.RDS")
  mw_c            <- readRDS("../r_files/mw_carbon.RDS")   # g/mol
  filter_area     <- readRDS("../r_files/filter_area.RDS") # cm^2
  fuel_properties <- readRDS("../r_files/fuel_properties.RDS")
```

CO~2~, CO, and CH~4~ data

```{r}
  fivegas_merged <- readRDS("../r_files/fivegas_merged.RDS")
  fivegas_bg     <- readRDS("../r_files/fivegas_background.RDS")
```

Gravimetric PM~2.5~

```{r}
  grav_conc <- readRDS("../r_files/grav_conc.RDS")
```

EC/OC

```{r}
  ecoc_conc <- readRDS("../r_files/ecoc_conc.RDS")
```

Carbonyls

```{r}
  carbonyls_conc <- readRDS("../r_files/carbonyls_conc.RDS")
```

VOCs

```{r}
  voc_merged <- readRDS("../r_files/voc_merged.RDS")
```

Temperature data

```{r}
  temp_merged <- readRDS("../r_files/temp_merged.RDS")
```

# Pollutant properties

```{r}
  pol_properties <- mutate(pol_properties, pol = sub("^voc_", "", pol)) 
```

# Timestamps

Get start and end times for integrated samples.

```{r}
  times <- dplyr::filter(test_times, var == "start_filters" | var == "end_filters") %>%
           tidyr::spread(var, value) %>%
           dplyr::select(-date) %>%
           dplyr::rename(start = start_filters, end = end_filters)
```

# CO~2~, CO, and CH~4~

Filter out data recorded outside the emissions sampling period.  

```{r}
  co_co2_ch4_time <- filter_times(times, fivegas_merged)   %>%
                     dplyr::filter(substr(id,1,2) != "BG") 
```

Calculate the average concentration (in ppmv) recorded during each test. 

```{r}
  co_co2_ch4 <- dplyr::group_by(co_co2_ch4_time, id, pol) %>%
                dplyr::summarise(ppm = mean(ppm, na.rm = TRUE))
```

Convert mixing ratio (ppmv) to mass concentration (assuming constant T and P in the exhaust line).

```{r}
  co_co2_ch4 <- dplyr::left_join(co_co2_ch4,
                                 dplyr::select(pol_properties,
                                               pol, mw, num_c),
                                 by = "pol") %>%
                dplyr::mutate(conc = convert_ppmv_ugpmc(ppm, mw, 25, 84)) # ug/m^3
```

Merge background concentrations with test data. 

```{r}
  co_co2_ch4_time <- dplyr::left_join(co_co2_ch4_time,
                                      dplyr::select(fivegas_bg, id, pol, ppm_bg),
                                      by=c("pol","id"))

  co_co2_ch4 <- dplyr::left_join(co_co2_ch4,
                                 dplyr::select(fivegas_bg, id, pol, ppm_bg, conc_bg),
                                 by=c("pol","id"))
```

1. Merge fivegas data with sample time data.  
2. Calculate test duration and convert to minutes.  
3. Calculate the total mass emitted and mass of carbon emitted during each test.  

```{r}
  co_co2_ch4 <- dplyr::left_join(co_co2_ch4, times, by = "id") %>%
                dplyr::mutate(dur          = (end - start) / 60, # minutes
                              mass_emitted = (conc - conc_bg) * hood_flow * dur, # ug
                              num_c        = 1,
                              mass_carbon  = mass_emitted * (mw_c * num_c / mw), # ug
                              inst = "fivegas")
```

```{r}
  head(co_co2_ch4, 2)
```

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  saveRDS(co_co2_ch4, file = "../r_files/fivegas_conc.RDS")
```

---

# Gravimetric PM~2.5~

Calculate the mass of PM~2.5~ emitted

```{r}
  grav <- dplyr::mutate(grav_conc, 
                        mass_emitted = (conc - conc_bg) * hood_flow * dur, # ug
                        mass_carbon  = NA,
                        inst         = "grav")
```

```{r}
  head(grav, 2)
```

---

# EC/OC

Calculate the masses of EC and OC emitted

```{r}
  ecoc <- dplyr::mutate(ecoc_conc, 
                        mass_emitted = (conc_corr - conc_bg) * hood_flow * dur, # ug
                        mass_carbon = mass_emitted,
                        inst = "ecoc") %>%
          dplyr::rename(conc = conc_corr)
```

```{r, eval = FALSE}
  head(ecoc, 2)
```

---

# Carbonyls

Add pollutant properties to data frame. 

```{r}
  carbonyls <- dplyr::left_join(carbonyls_conc, pol_properties, by=c("pol"))
```

Calculate mass of pollutant emitted and mass of carbon emitted. Replace `mass_emitted` values below zero with zero. 

```{r}
  carbonyls <- dplyr::mutate(carbonyls, 
                             mass_emitted = (conc - conc_bg) * hood_flow * dur, # ug
                             mass_emitted = ifelse(mass_emitted < 0, 0, mass_emitted), 
                             mass_carbon  = mass_emitted * (num_c * mw_c / mw),
                             inst = "carbs")
```

```{r, eval = FALSE}
  head(carbonyls, 2)
```

---

# VOCs

Convert mixing ratios (ppbv) to mass concentrations ($\mu$g/m^3^). Then, calculate the mass of each pollutant emitted and the mass of carbon emitted.  Replace `mass_emitted` values below zero with zero.  

```{r}
  voc <- dplyr::left_join(voc_merged, pol_properties, by = "pol") %>%
         dplyr::mutate(ppm     = ppb / 1000,
                       ppm_bg  = ppb_bg / 1000,
                       conc    = convert_ppmv_ugpmc(ppm, mw, 25, 84),     # ug/m3
                       conc_bg = convert_ppmv_ugpmc(ppm_bg, mw, 25, 84),  # ug/m3
                       mass_emitted = (conc - conc_bg) * hood_flow * dur, # ug
                       mass_emitted = ifelse(mass_emitted < 0, 0, mass_emitted),
                       mass_carbon  = mass_emitted * (mw_c * num_c / mw)) 
```

Combine m+p-xylenes and o-xylenes

```{r}

  voc <- voc %>%
         dplyr::select(id, pol, conc, conc_bg, mass_emitted, mass_carbon) %>%
         dplyr::mutate(pol = if_else(pol == "m+p-xylene", "xylenes", pol),
                       pol = if_else(pol == "o-xylene",   "xylenes", pol)) %>%
         dplyr::group_by(pol, id) %>%
         dplyr::summarise(conc         = sum(conc, na.rm=TRUE),
                          conc_bg      = sum(conc_bg, na.rm=TRUE),
                          mass_emitted = sum(mass_emitted, na.rm=TRUE),
                          mass_carbon  = sum(mass_carbon,  na.rm=TRUE))   %>%
         dplyr::mutate(inst = "voc")
```

```{r, eval = FALSE}
  head(voc, 2)
```

---

# Output

Combine mass-based pollutants into a single data frame.

```{r}
  emissions <- dplyr::bind_rows(
                  dplyr::select(co_co2_ch4,
                                id, pol, conc, conc_bg, mass_emitted, mass_carbon, inst),
                  dplyr::select(grav,
                                id, pol, conc, conc_bg, mass_emitted, mass_carbon, inst),
                  dplyr::select(ecoc,
                                id, pol, conc, conc_bg, mass_emitted, mass_carbon, inst),
                  dplyr::select(carbonyls,
                                id, pol, conc, conc_bg, mass_emitted, mass_carbon, inst),
                  dplyr::select(voc,
                                id, pol, conc, conc_bg, mass_emitted, mass_carbon, inst))
```

Convert to longer format

```{r}
  emissions_long <- tidyr::gather(emissions, "metric", "value", 3:6)
```

Save the data frame. 

```{r}
  saveRDS(emissions_long, file = "../r_files/emissions_long.RDS")
```

# Modified combustion efficiency

Calculate real-time MCE:

```{r, message=FALSE}
  df_mce <- dplyr::filter(co_co2_ch4_time, pol %in% c("co","co2")) %>%
            dplyr::mutate(ppm_bg_corr = ppm - ppm_bg)              %>%
            dplyr::select(id, datetime, time, pol, ppm_bg_corr)    %>%
            tidyr::spread(pol, ppm_bg_corr)                        %>%
            dplyr::mutate(mce = co2/(co2 + co))                    %>%
            dplyr::left_join(dplyr::select(times, id, start), by=c("id")) %>%
            dplyr::mutate(time_since_start = time - start,
                          id = forcats::fct_relevel(id,"LL1","LL2","LL3","LL4",
                                                       "FL1","FL2","FL3","FL4",
                                                       "LM1","LM2","LM3","LM4",
                                                       "FM1","FM2","FM3","FM4",
                                                       "LH1","LH2","LH3","LH4",
                                                       "FH1","FH2","FH3","FH4"),
                          mce = ifelse(id=="FH2", NA, mce))

  test_names <- c("Low, milled 1",    "Low, milled 2",    "Low, milled 3",    "Low, milled 4",
                  "Low, split 1",     "Low, split 2",     "Low, split 3",     "Low, split 4",
                  "Medium, milled 1", "Medium, milled 2", "Medium, milled 3", "Medium, milled 4",
                  "Medium, split 1",  "Medium, split 2",  "Medium, split 3",  "Medium, split 4",
                  "High, milled 1",   "High, milled 2",   "High, milled 3",   "High, milled 4",
                  "High, split 1",    "High, split 2",    "High, split 3",    "High, split 4")

  test_ids <- dplyr::select(samples, id) %>%
              dplyr::filter(substr(id,1,2) != "BG") %>%
              dplyr::mutate(id = forcats::fct_relevel(id,"LL1","LL2","LL3","LL4",
                                                         "FL1","FL2","FL3","FL4",
                                                         "LM1","LM2","LM3","LM4",
                                                         "FM1","FM2","FM3","FM4",
                                                         "LH1","LH2","LH3","LH4",
                                                         "FH1","FH2","FH3","FH4")) %>%
              arrange(id)
    
  test_ids$test_name <- test_names
  
  df_mce <- dplyr::left_join(df_mce, test_ids, by=c("id"))
  
  saveRDS(df_mce, file = "../r_files/df_mce.RDS")
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=6.5, fig.height=8.25, fig.align='center'}

  ggplot(dplyr::filter(df_mce, id %in% c("LL1","LL2","LL3","LL4",
                                         "FL1","FL2","FL3","FL4",
                                         "LM1","LM2","LM3","LM4",
                                         "FM1","FM2","FM3","FM4")),
         aes(x=time_since_start/60, y=mce)) + 
    geom_line() +
    facet_wrap(~test_name, ncol=4, scales="free_x") +
    
    # format the plot
    coord_cartesian(ylim=c(0.8,1.0)) + 
    scale_y_continuous(breaks=seq(0.8,1.0,0.05)) +
    xlab("Minutes since start of test") +
    ylab("Modified combustion efficiency (%)") + 
    theme(aspect.ratio=1,
          panel.border     = element_rect(fill=NA),
          panel.background = element_rect(fill='white'),
          panel.grid.major = element_line(color="gray95"),
          strip.background = element_rect(fill="gray95", color="black"),
          strip.text.x = element_text(size=10, color="black"),
          text        = element_text(size=10, color='black'),
          axis.text.x = element_text(size= 9, color='black'),
          axis.text = element_text(size=10, color='black'),
          axis.title  = element_text(size=10, color='black'),
          axis.ticks = element_line(color='black')) 

  ggsave(filename="../figures/mce_low_med.pdf", plot=last_plot(), device="pdf", width=6.5, height=8.25)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=6.5, fig.height=4.25, fig.align='center'}

  ggplot(dplyr::filter(df_mce, id %in% c("LH1","LH2","LH3","LH4",
                                         "FH1","FH2","FH3","FH4")),
         aes(x=time_since_start/60, y=mce)) + 
    geom_line() +
    facet_wrap(~test_name, ncol=4, scales="free_x") +
    
    # format the plot
    coord_cartesian(ylim=c(0.8,1.0)) + 
    scale_y_continuous(breaks=seq(0.8,1.0,0.05)) +
    xlab("Minutes since start of test") +
    ylab("Modified combustion efficiency (%)") + 
    theme(aspect.ratio=1,
          panel.border     = element_rect(fill=NA),
          panel.background = element_rect(fill='white'),
          panel.grid.major = element_line(color="gray95"),
          strip.background = element_rect(fill="gray95", color="black"),
          strip.text.x = element_text(size=10, color="black"),
          text        = element_text(size=10, color='black'),
          axis.text.x = element_text(size= 9, color='black'),
          axis.text = element_text(size=10, color='black'),
          axis.title  = element_text(size=10, color='black'),
          axis.ticks = element_line(color='black')) 

  ggsave(filename="../figures/mce_high.pdf", plot=last_plot(), device="pdf", width=6.5, height=4.25)
```

Calculate summary values:

```{r, message=FALSE, warning=FALSE}
  df_mce_test <- dplyr::mutate(df_mce,
                               dur_mixed   = ifelse(mce <= 0.97,  1, NA),
                               dur_mixed   = ifelse(mce <= 0.85, NA, dur_mixed),
                               dur_smolder = ifelse(mce <= 0.85,  1, NA)) %>%
                 dplyr::group_by(id) %>%
                 dplyr::summarise(mce         = mean(mce),
                                  dur_mixed   = sum(dur_mixed,   na.rm=TRUE),
                                  dur_smolder = sum(dur_smolder, na.rm=TRUE)) %>%
                 dplyr::left_join(times, by=c("id")) %>%
                 dplyr::mutate(dur          = end - start,
                               frac_mixed   = dur_mixed / dur,
                               frac_smolder = dur_smolder / dur) %>%
                 # Add test metadata to dataframe
                 dplyr::left_join(select(samples, id, type, mc_level, mc_dry),
                                  by=c("id")) %>%
                 dplyr::filter(id != "FH2")   %>%
                 dplyr::select(id, mc_level, type, mc_dry, start, end, dur,
                               mce, frac_mixed, frac_smolder)
```

Perform a two-way ANOVA to see if fuel moisture level, fuel shape, and the interaction between these two factors have significant effects on the modified combustion efficiency. 

```{r}
  mod_mce <- lm(mce ~ mc_level * type, df_mce_test)

  leveneTest(mod_mce)
  
  shapiro.test(mod_mce$residuals)

  Anova(mod_mce, type=c("III"))
```

Use Tukey's test to determine whether the differences between the MCEs at different fuel moisture levels are significant. 

```{r}
  aov_mce <- aov(mce ~ mc_level, df_mce_test)

  leveneTest(aov_mce)
  
  shapiro.test(aov_mce$residuals)

  TukeyHSD(aov_mce)
```

Calculate the mean MCE and standard deviation at each moisture level.  

```{r}
  df_mce_summary <- group_by(df_mce_test, mc_level) %>%
                     summarise(mean   = mean(100*mce),
                               sd     = sd(100*mce))

  kable(df_mce_summary, format="markdown", digits=c(2,1),
        col.names=c("Moisture level", "Mean (%)","SD (%)"))
```

### Compare MCE and exhaust temperature

Extract temperature for periods of interest

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}

  times_temp <- dplyr::filter(times, substr(id,1,2) != "BG") %>%
                dplyr::mutate(id = as.character(id))
  
  df_temp_e  <- dplyr::filter(temp_merged, loc=="exhaust") %>%
                dplyr::mutate(time = time + 3600) # add an hour
  
  df_temp_e <- filter_times(times_temp, df_temp_e) %>%
               dplyr::filter(id !="FH2") %>%
               group_by(id) %>%
               dplyr::summarise(temp_mean = mean(t_oc)) 
```

```{r}
  df_mce_temp <- left_join(df_mce_test, df_temp_e, by=c("id")) 

  pearson_r <- cor.test(df_mce_temp$temp_mean, df_mce_temp$mce, method="pearson", conf.level=0.95)
  pearson_r
```

### Plots

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  # Define the colors to use in the plots. 
  purple <- "#330099"
  gold   <- "#FF9900"
  teal1  <- "#33CC99"
  teal2  <- "#339999"
  teal3  <- "#0099CC"
  orange <- "#FF6633"
  pink1  <- "#CC0066"
  pink2  <- "#FF3366"
```

```{r, fig.width=3.15, fig.height=3.15, fig.align='center'}

  ggplot(data=df_mce_test, aes(x=mc_dry, y=100*mce, shape=type)) + 
         geom_point(size=3, alpha=0.7) +
         coord_cartesian(xlim=c(4,30), ylim=c(95.6,99.2)) +
         scale_x_continuous(breaks=seq(5,30,10)) + 
         scale_y_continuous(breaks=seq(95,99,1)) + 
         xlab("Moisture content (%)") + 
         ylab("Modified combustion efficiency (%)") +
         labs(shape = "Fuel shape") + 
         theme(aspect.ratio=1,
               panel.grid.major.x = element_line(color="gray95"),
               panel.grid.minor.x = element_line(color="gray95"),
               panel.grid.major.y = element_line(color="gray95"),
               panel.grid.minor.y = element_line(color="gray95"),
               panel.border     = element_rect(fill=NA),
               panel.background = element_rect(fill='white'),
               axis.text  = element_text(size=10, color='black'),
               axis.title = element_text(size=10, color='black'),
               axis.ticks = element_line(color='black'),
               legend.text  = element_text(size=10, color='black'),
               legend.title = element_text(size=10, color='black'),
               legend.key   = element_blank(),
               legend.box.background = element_rect(color="black", size=0.6),
               legend.position = c(0.8,0.8)) 

  ggsave(filename="../figures/mce_fig.svg", plot=last_plot(), device="svg", width=8/2.54, height=8/2.54)
  ggsave(filename="../figures/mce_fig.pdf", plot=last_plot(), device="pdf", width=8/2.54, height=8/2.54)
```

```{r, fig.width=4.3, fig.height=3.15, fig.align='center'}

  r_text <- sprintf("%.2f", round(pearson_r$estimate, digits = 3))
  textlab_r <- paste("r == ",r_text,sep="")

  ggplot(data=df_mce_temp, aes(x=temp_mean, y=100*mce, shape=type, color=mc_level)) + 
         geom_point(size=3, alpha=0.7) +
            scale_color_manual(values = c(teal3,gold,pink1)) +
         coord_cartesian(xlim=c(305,520), ylim=c(95.7,99.1)) +
         scale_x_continuous(breaks=seq(300,500,50)) + 
         scale_y_continuous(breaks=seq(95,99,1)) + 
         xlab(expression(Mean ~ exhaust ~ temperature ~ "(" * degree * C * ")")) + 
         ylab("Modified combustion efficiency (%)") +
         labs(shape="Fuel shape", color="Moisture level") + 
         theme(aspect.ratio=1,
               panel.border     = element_rect(fill=NA),
               panel.background = element_rect(fill='white'),
               axis.text  = element_text(size=10, color='black'),
               axis.title = element_text(size=10, color='black'),
               axis.ticks = element_line(color='black'),
               legend.text  = element_text(size=10, color='black'),
               legend.title = element_text(size=10, color='black'),
               legend.key   = element_blank(),
               legend.position = "right") + 
        geom_text(aes(x=310, y=99, label=textlab_r), parse=TRUE,
                  color='black', hjust='left', size=3.5, fontface='plain')

  ggsave(filename="../figures/mce_temp.pdf", plot=last_plot(), device="pdf", width=4.3, height=8/2.54)
```

# Firepower

```{r}

  df_fp <- dplyr::select(co_co2_ch4, id, pol, mass_carbon, dur) %>%
           tidyr::spread(pol, mass_carbon) %>%
           dplyr::mutate(lhv = fuel_properties$lhv,  # kJ/kg
                         y_c = fuel_properties$carbon_fraction, # kg/kg
                         m_carbon  = co2 + co + ch4, # ug
                         firepower = (m_carbon*lhv)/(y_c*(dur*60)*(10^9))) %>% # kW
           dplyr::select(-co2,-co,-ch4) %>%
           dplyr::left_join(select(samples, id, type, mc_level, mc_dry),
                            by=c("id")) %>%
           dplyr::filter(id != "FH2")

  df_fp_mean <- group_by(df_fp, mc_level) %>%
                summarise(fp_mean = mean(firepower))
```

```{r, fig.width=3.15, fig.height=3.15, fig.align='center'}
  ggplot(df_fp, aes(x=mc_dry, y=firepower, shape=type)) +
    geom_point(size=3, alpha=0.7) +
    coord_cartesian(xlim=c(4,30), ylim=c(1.5,3.5)) +
    scale_x_continuous(breaks=seq(5,30,10)) + 
    scale_y_continuous(breaks=seq(1.5,3.5,0.5)) + 
    xlab("Moisture content (%)") + 
    ylab("Firepower (kW)") +
    labs(shape="Fuel shape") + 
    theme(aspect.ratio=1,
          panel.grid.major.x = element_line(color="gray95"),
          panel.grid.minor.x = element_line(color="gray95"),
          panel.grid.major.y = element_line(color="gray95"),
          panel.grid.minor.y = element_line(color="gray95"),
          panel.border     = element_rect(fill=NA),
          panel.background = element_rect(fill='white'),
          axis.text  = element_text(size=10, color='black'),
          axis.title = element_text(size=10, color='black'),
          axis.ticks = element_line(color='black'),
          legend.text  = element_text(size=10, color='black'),
          legend.title = element_text(size=10, color='black'),
          legend.key   = element_blank(),
          legend.box.background = element_rect(color="black", size=0.6),
          legend.position = c(0.8,0.8))

  ggsave(filename="../figures/firepower.pdf", plot=last_plot(), device="pdf", width=8/2.54, height=8/2.54)
```

```{r}
  df_mce_test <- dplyr::left_join(df_mce_test,
                                  dplyr::select(df_fp, id, firepower),
                                  by=c("id"))
```

```{r, fig.width=3.15, fig.height=3.15, fig.align='center'}

  ggplot(data=df_mce_test, aes(x=firepower, y=100*frac_mixed, shape=type)) + 
         geom_point(size=3, alpha=0.7) +
         coord_cartesian(c(1.5,3.5), ylim=c(0,60)) +
         scale_x_continuous(breaks=seq(1.5,3.5,0.5)) + 
         scale_y_continuous(breaks=seq(0,60,20)) + 
         xlab("Firepower (kW)") +
         ylab(expression("Fraction of test with" ~ 0.85 * "<" * "MCE" <= "0.97" ~ "(%)")) +
         labs(shape = "Fuel shape") + 
         theme(aspect.ratio=1,
               panel.grid.major.x = element_line(color="gray95"),
               panel.grid.minor.x = element_line(color="gray95"),
               panel.grid.major.y = element_line(color="gray95"),
               panel.grid.minor.y = element_line(color="gray95"),
               panel.border     = element_rect(fill=NA),
               panel.background = element_rect(fill='white'),
               axis.text  = element_text(size=10, color='black'),
               axis.title = element_text(size=10, color='black'),
               axis.ticks = element_line(color='black'),
               legend.text  = element_text(size=10, color='black'),
               legend.title = element_text(size=10, color='black'),
               legend.key   = element_blank(),
               legend.box.background = element_rect(color="black", size=0.6),
               legend.position = c(0.8,0.8)) 

  ggsave(filename="../figures/mce_frac.svg", plot=last_plot(), device="svg", width=8/2.54, height=8/2.54)
  ggsave(filename="../figures/mce_frac.pdf", plot=last_plot(), device="pdf", width=8/2.54, height=8/2.54)
```