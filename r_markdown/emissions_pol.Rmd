---
title: "Pollutant emissions"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo=FALSE, include=FALSE}
  library(tidyverse)
  library(knitr)
  library(lubridate)
  library(chron)
```

```{r global_options, include=FALSE}
  knitr::opts_chunk$set(fig.path = 'figures/',
                        warning = FALSE,
                        message = FALSE,
                        fig.width = 10, fig.height = 4,
                        cache = FALSE)
```

```{r}
  source("../r_scripts/R_functions.R")
```

---

# Load

* fivegas

```{r}
 # fivegas data
  fivegas_merged <- readRDS("../r_files/fivegas_merged.RDS")

 # background co
  bg_co <- readRDS("../r_files/background_co.RDS")
  bg_co_tests <- bg_co$bg
  bg_co_mean <- bg_co$mean

 # background co2
  bg_co2 <- readRDS("../r_files/background_co2.RDS")
  bg_co2_tests <- bg_co2$bg
  bg_co2_mean <- bg_co2$mean

 # background ch4
  bg_ch4 <- readRDS("../r_files/background_ch4.RDS")
  bg_ch4_tests <- bg_ch4$bg
  bg_ch4_mean <- bg_ch4$mean
```

---

* gravimetric pm2.5

```{r}
  grav_merged <- readRDS("../r_files/grav_merged.RDS")
```

* ecoc

```{r}
  ecoc_merged <- readRDS("../r_files/ecoc_merged.RDS")
```

* particle size distributions (smps)

```{r}
  smps_ultrafine <- readRDS("../r_files/smps_ultrafine.RDS")
  smps_ultrafine_bg <- readRDS("../r_files/smps_ultrafine_bg.RDS")
```

* carbonyls
```{r}
carbonyls_merged <- readRDS("../r_files/carbonyls_merged.RDS")
```


* voc

```{r}
  voc <- readRDS("../r_files/voc_merged.RDS")
```

* constants

```{r}
  hood_flow <- readRDS("../r_files/hood_flow.RDS")
  pol_properties <- readRDS("../r_files/pol_properties.RDS")
  mw_c <- readRDS("../r_files/mw_carbon.RDS")
  filter_area <- readRDS("../r_files/filter_area.RDS")
```

* metadata

```{r}
  samples <- readRDS("../r_files/samples.RDS")
  test_times <- readRDS("../r_files/test_times_all.RDS")
```

# timestamps

* integrated sample start & end times

```{r}
  times <- dplyr::filter(test_times, var == "start_filters" | var == "end_filters") %>%
           tidyr::spread(var, value) %>%
           dplyr::select(-date) %>%
           dplyr::rename(start = start_filters, end = end_filters)
```

---

# carbonyls

* select data

```{r}
  carbonyls <- dplyr::select(carbonyls_merged,
                             id, qc,
                             flow, dur,
                             start, end,
                             pol, mass_ug,
                             conc,
                             conc_bg) %>%
               dplyr::left_join(dplyr::select(pol_properties, 
                                              pol, 
                                              mw, 
                                              num_c),
                                       by = "pol")
```

* calculate mass emitted

```{r}
  carbonyls <- dplyr::mutate(carbonyls, 
                             mass_emitted = (conc - conc_bg) * hood_flow * dur,
                             mass_carbon = mass_emitted * (num_c * mw_c / mw),
                             inst = "carbs")
```

* output

```{r, eval = FALSE}
  head(carbonyls, 2)
```

# ecoc

* select data

```{r}
  ecoc <- samples %>%
          dplyr::left_join(ecoc_merged, by = "id") %>%
          dplyr::select(id, cassette,
                        start, end,
                        flow,
                        pol,
                        ug_sq_cm,
                        conc_bg,
                        qc)
```

* calculate concentrations

```{r}
  ecoc <- dplyr::mutate(ecoc, dur = (end - start) / 60,
                              conc = ug_sq_cm * filter_area * 1000 / (flow * dur))
```

* account for artifact 

```{r}
  ecoc_artifact <- ecoc %>%
                   dplyr::select(id, cassette, pol, conc) %>%
                   dplyr::group_by(pol, id, cassette) %>%
                   tidyr::spread(cassette, conc) %>%
                   dplyr::rename(conc_front = qf,
                                 conc_back = qb) %>%
                   dplyr::mutate(conc_back = ifelse(is.na(conc_back), 0, conc_back)) %>%
                   dplyr::mutate(conc_cor = conc_front - conc_back)

  ecoc <- ecoc %>%
          dplyr::filter(cassette == "qf") %>%
          dplyr::left_join(ecoc_artifact, by = c("id", "pol"))
```

* calculate mass emitted

Concentration is corrected for background by removing background test average concentration from each test.

```{r}
  ecoc <- dplyr::mutate(ecoc, 
                        mass_emitted = (conc_cor - conc_bg) * hood_flow * dur,
                        mass_carbon = mass_emitted,
                        inst = "ecoc")
```

* output

```{r, eval = FALSE}
  head(ecoc, 2)
```

---

# fivegas

* select co, co2 and ch4.

```{r}
  co_co2_ch4 <- dplyr::filter(fivegas_merged, pol == "co" | pol == "co2" | pol == "ch4")
```

* filter out data from outside emissions window

```{r}
  co_co2_ch4 <- filter_times(times, co_co2_ch4) %>%
                dplyr::distinct()
```

* calculate average for each test

```{r}
  co_co2_ch4 <- dplyr::group_by(co_co2_ch4, id, pol) %>%
                dplyr::summarise(ppm = mean(ppm, na.rm = TRUE)) %>%
                dplyr::ungroup()
```

* convert mixing ratio to mass (assuming constant T and P)

```{r}
  co_co2_ch4 <- dplyr::left_join(co_co2_ch4,
                                 dplyr::select(pol_properties,
                                               pol,
                                               mw,
                                               num_c), by = "pol") %>%
                dplyr::mutate(conc = convert_ppmv_ugpmc(ppm, mw, 25, 84)) # ug/m^3
```

* merge with sample time data and calculate test duration

```{r}
  co_co2_ch4 <- dplyr::left_join(co_co2_ch4, times, by = "id") %>%
                dplyr::mutate(dur = end - start) %>%
                dplyr::mutate(id = as.factor(id))
```

* background analysis
* replace NaN with between test mean value
* combine pollutants

```{r}
  bg_co <- dplyr::left_join(dplyr::select(samples, id), bg_co_tests) %>%
           dplyr::mutate(ppm_bg = ifelse(is.na(ppm), bg_co_mean$ppm[1], ppm),
                         conc_bg = ifelse(is.na(conc), bg_co_mean$conc[1], conc),
                         pol = "co")

  bg_co2 <- dplyr::left_join(dplyr::select(samples, id), bg_co2_tests) %>%
            dplyr::mutate(ppm_bg = ifelse(is.na(ppm), bg_co2_mean$ppm[1], ppm),
                          conc_bg = ifelse(is.na(conc), bg_co2_mean$conc[1], conc),
                          pol = "co2")

  bg_ch4 <- dplyr::left_join(dplyr::select(samples, id), bg_ch4_tests) %>%
            dplyr::mutate(ppm_bg = ifelse(is.na(ppm), bg_ch4_mean$ppm[1], ppm),
                          conc_bg = ifelse(is.na(conc), bg_ch4_mean$conc[1], conc),
                          pol = "ch4")

  bg <- dplyr::bind_rows(bg_co, bg_co2, bg_ch4) %>%
        dplyr::select(-ppm, -conc)
   
```

* merge background with fivegas data

```{r}
  co_co2_ch4 <- dplyr::left_join(co_co2_ch4, 
                dplyr::select(bg, id, pol, conc_bg), by = c("id", "pol"))
```

* calculate micrograms emitted during tests

```{r}
  co_co2_ch4 <- dplyr::mutate(co_co2_ch4,
                              mass_emitted = (conc - conc_bg) * hood_flow * (dur / 60),
                              num_c = 1,
                              mass_carbon = mass_emitted * (mw_c * num_c / mw),
                              inst = "fivegas")
```

* output

```{r}
  head(co_co2_ch4, 2)
```

---

# grav

* select data

```{r}
  grav <- dplyr::select(grav_merged,
                        id, pol,
                        start, end,
                        flow,
                        wgt_delta,
                        conc_bg)
```

* calculate concentrations

```{r}
  grav <- dplyr::mutate(grav, dur = (end - start) / 60,
                              conc = wgt_delta * 1000 / (flow * dur))
```

* calculate mass emitted

```{r}
  grav <- dplyr::mutate(grav, 
                        mass_emitted = (conc - conc_bg) * hood_flow * dur,
                        mass_carbon = mass_emitted * 0,
                        inst = "grav")
```

* output

```{r}
  head(grav, 2)
```

---

# smps

* calculate test average number concentration
* calculate test duration

```{r}
  ultrafine <-  # dplyr::filter(smps_ultrafine, n_bad == 0) %>%
               dplyr::group_by(smps_ultrafine, id) %>%
               dplyr::summarise(conc = mean(number_conc, na.rm = TRUE),
                                n = n()) %>%
               	                 # qc = first(qc)) %>%
               dplyr::ungroup(id) %>%
               dplyr::left_join(times, by = "id") %>%
               dplyr::mutate(dur = end - start)
```

* calculate average background (use other method?)

```{r}
  bg_smps <-  # dplyr::filter(smps_ultrafine_bg,
                #           qc == "ok",
                 #          n_bad == 0) %>%
             dplyr::group_by(smps_ultrafine_bg, id) %>%
             dplyr::summarise(conc_bg = mean(number_conc)) %>%
             dplyr::ungroup()

  conc_bg <- mean(bg_smps$conc_bg)
```

* calculate number of particles emitted during tests (check this is all???)

```{r}
 # # (N * 1,000,000 /cm^3) * m^3/min * (s / 60)
  ultrafine <- dplyr::mutate(ultrafine,
                             num_emitted = (conc - conc_bg) * 1e6 * hood_flow * (dur / 60),
                             inst = "smps")
```

* output

```{r}
  head(ultrafine, 2)
```

---

# voc

* select data

```{r}
 pol_properties <- mutate(pol_properties, pol = sub("^voc_", "", pol)) 
 
 voc <- dplyr::select(voc_merged,
                       id,
                     start_time, stop_time,
                        pol, ppb, ppb_bg) %>%
                      #ppb_bg, qc) %>%
         dplyr::left_join(dplyr::select(pol_properties,
                                        pol,
                                        mw,
                                        num_c),
                                        by = "pol") %>%
         dplyr::mutate(start_time = hms(start_time),
                       stop_time = hms(stop_time)) %>%
         dplyr::mutate(start_time = period_to_seconds(start_time),
                       stop_time = period_to_seconds(stop_time))
        # dplyr::filter(grepl("^[A-Z]", id) == FALSE)
```

* calculate concentrations

```{r}
  voc <- dplyr::mutate(voc, dur = (stop_time - start_time) / 60,
                            ppm = ppb / 1000,
                            conc = convert_ppmv_ugpmc(ppm, mw, 25, 85),
                            conc_bg = convert_ppmv_ugpmc(ppb_bg / 1000, mw, 25, 85))
```

* calculate mass emitted

```{r}
  voc <- dplyr::mutate(voc, mass_emitted = (conc - conc_bg) * hood_flow * dur,
                            mass_carbon = mass_emitted * (mw_c * num_c / mw),
                            inst = "voc")
```

* output

```{r, eval = FALSE}
  head(voc, 2)
```

---

# Output

## combine pollutants

* mass based

```{r}
  emissions <- dplyr::select(co_co2_ch4,
                             id,
                             pol, 
                             conc, conc_bg,
                             mass_emitted,
                             mass_carbon,
                             inst) %>%
               dplyr::bind_rows(dplyr::select(grav,
                                              id,
                                              pol,
                                              conc, conc_bg,
                                              mass_emitted,
                                              mass_carbon,
                                              inst)) %>%
               dplyr::bind_rows(dplyr::select(ecoc,
                                              id,
                                              pol,
                                              conc, conc_bg,
                                              mass_emitted,
                                              mass_carbon,
                                              inst)) %>%
               dplyr::bind_rows(dplyr::select(carbonyls,
                                              id,
                                              pol,
                                              conc,
                                              conc_bg,
                                              mass_emitted,
                                              mass_carbon,
                                              inst)) %>%
               dplyr::bind_rows(dplyr::select(ecoc,
                                              id,
                                              pol,
                                              conc, conc_bg,
                                              mass_emitted,
                                              mass_carbon,
                                              inst)) %>%
               dplyr::bind_rows(dplyr::select(voc,
                                              id,
                                              pol,
                                              conc, conc_bg,
                                              mass_emitted,
                                              mass_carbon,
                                              inst))
```

* convert to longer format

```{r}
  emissions_long <- tidyr::gather(emissions, "metric", "value", 3:6)
```

* number based

```{r, eval = FALSE}
  number <- dplyr::select(ultrafine, id, conc, num_emitted, inst) %>%
            dplyr::mutate(pol = "number") %>%
            tidyr::gather("metric", "value", 2:3)
```

* combine mass and number instruments

```{r, eval = FALSE}
  emissions_long  <- dplyr::bind_rows(emissions_long, number)
```

## save

```{r}
  saveRDS(emissions_long, file = "../r_files/emissions_long.RDS")
```

