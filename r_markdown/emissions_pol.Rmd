---
title: "Pollutant Emissions"
date: "December 21, 2018"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo=FALSE, include=FALSE}
  library(tidyverse)
  library(knitr)
  library(lubridate)
  library(chron)
```

```{r global_options, include=FALSE}
  knitr::opts_chunk$set(fig.path = 'figures/',
                        warning = FALSE,
                        message = FALSE,
                        fig.width = 10, fig.height = 4,
                        cache = FALSE)
```

```{r}
  source("../r_scripts/R_functions.R")
```

---

# Load

Test metadata

```{r}
  samples    <- readRDS("../r_files/samples.RDS")
  test_times <- readRDS("../r_files/test_times_all.RDS") 
```

Constants

```{r}
  hood_flow       <- readRDS("../r_files/hood_flow.RDS")   # m^3/min
  pol_properties  <- readRDS("../r_files/pol_properties.RDS")
  mw_c            <- readRDS("../r_files/mw_carbon.RDS")   # g/mol
  filter_area     <- readRDS("../r_files/filter_area.RDS") # cm^2
  fuel_properties <- readRDS("../r_files/fuel_properties.RDS")
```

CO~2~, CO, and CH~4~ data

```{r}
  fivegas_merged <- readRDS("../r_files/fivegas_merged.RDS")
  fivegas_bg     <- readRDS("../r_files/fivegas_background.RDS")
```

Gravimetric PM~2.5~

```{r}
  grav_conc <- readRDS("../r_files/grav_conc.RDS")
```

EC/OC

```{r}
  ecoc_conc <- readRDS("../r_files/ecoc_conc.RDS")
```

Carbonyls

```{r}
  carbonyls_conc <- readRDS("../r_files/carbonyls_conc.RDS")
```

Ultrafine particles

```{r}
  smps_ultrafine <- readRDS("../r_files/smps_ultrafine.RDS")
```

VOCs

```{r}
  voc_merged <- readRDS("../r_files/voc_merged.RDS")
```

Temperature data

```{r}
  temp_merged <- readRDS("../r_files/temp_merged.RDS")
```

# Pollutant properties

```{r}
  pol_properties <- mutate(pol_properties, pol = sub("^voc_", "", pol)) 
```

# Timestamps

Get start and end times for integrated samples.

```{r}
  times <- dplyr::filter(test_times, var == "start_filters" | var == "end_filters") %>%
           tidyr::spread(var, value) %>%
           dplyr::select(-date) %>%
           dplyr::rename(start = start_filters, end = end_filters)
```

# CO~2~, CO, and CH~4~

Filter out data recorded outside the emissions sampling period.  

```{r}
  co_co2_ch4 <- filter_times(times, fivegas_merged) %>%
                dplyr::distinct() 
```

Calculate the average concentration (in ppmv) recorded during each test. 

```{r}
  co_co2_ch4 <- dplyr::group_by(co_co2_ch4, id, pol) %>%
                dplyr::summarise(ppm = mean(ppm, na.rm = TRUE)) %>%
                dplyr::filter(substr(id,1,2) != "BG") 
```

Convert mixing ratio (ppmv) to mass concentration (assuming constant T and P in the exhaust line).

```{r}
  co_co2_ch4 <- dplyr::left_join(co_co2_ch4,
                                 dplyr::select(pol_properties,
                                               pol, mw, num_c),
                                 by = "pol") %>%
                dplyr::mutate(conc = convert_ppmv_ugpmc(ppm, mw, 25, 84)) # ug/m^3
```

Merge background concentrations with test data. 

```{r}
  co_co2_ch4 <- dplyr::left_join(co_co2_ch4,
                                 dplyr::select(fivegas_bg, id, pol, ppm_bg, conc_bg),
                                 by=c("pol","id")) 
```

1. Merge fivegas data with sample time data.  
2. Calculate test duration and convert to minutes.  
3. Calculate the total mass emitted and mass of carbon emitted during each test.  

```{r}
  co_co2_ch4 <- dplyr::left_join(co_co2_ch4, times, by = "id") %>%
                dplyr::mutate(dur          = (end - start) / 60, # minutes
                              mass_emitted = (conc - conc_bg) * hood_flow * dur, # ug
                              num_c        = 1,
                              mass_carbon  = mass_emitted * (mw_c * num_c / mw), # ug
                              inst = "fivegas")
```

```{r}
  head(co_co2_ch4, 2)
```

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  saveRDS(co_co2_ch4, file = "../r_files/fivegas_conc.RDS")
```

---

# Gravimetric PM~2.5~

Calculate the mass of PM~2.5~ emitted

```{r}
  grav <- dplyr::mutate(grav_conc, 
                        mass_emitted = (conc - conc_bg) * hood_flow * dur, # ug
                        mass_carbon  = NA,
                        inst         = "grav")
```

```{r}
  head(grav, 2)
```

---

# EC/OC

Calculate the masses of EC and OC emitted

```{r}
  ecoc <- dplyr::mutate(ecoc_conc, 
                        mass_emitted = (conc_corr - conc_bg) * hood_flow * dur, # ug
                        mass_carbon = mass_emitted,
                        inst = "ecoc") %>%
          dplyr::rename(conc = conc_corr)
```

```{r, eval = FALSE}
  head(ecoc, 2)
```

---

# SMPS

1. Calculate the number of ultrafine particles emitted (per size bin).  
2. Sum over all size bins (for each test ID).  

```{r}
  ultrafine <- dplyr::mutate(smps_ultrafine,
                             num = num_conc * hood_flow * dur * (10^6)) %>% # 1
               dplyr::group_by(id) %>%
               summarise(num_emitted = sum(num)) %>%                        # 2
               dplyr::mutate(inst = "smps",
                             pol  = "ultrafines")
```

```{r}
  head(ultrafine, 2)
```

---

# Carbonyls

Add pollutant properties to data frame. 

```{r}
  carbonyls <- dplyr::left_join(carbonyls_conc, pol_properties, by=c("pol"))
```

Calculate mass of pollutant emitted and mass of carbon emitted. Replace `mass_emitted` values below zero with zero. 

```{r}
  carbonyls <- dplyr::mutate(carbonyls, 
                             mass_emitted = (conc - conc_bg) * hood_flow * dur, # ug
                             mass_emitted = ifelse(mass_emitted < 0, 0, mass_emitted), 
                             mass_carbon  = mass_emitted * (num_c * mw_c / mw),
                             inst = "carbs")
```

* output

```{r, eval = FALSE}
  head(carbonyls, 2)
```

---

# VOCs

Convert mixing ratios (ppbv) to mass concentrations ($\mu$g/m^3^). Then, calculate the mass of each pollutant emitted and the mass of carbon emitted.  Replace `mass_emitted` values below zero with zero.  

```{r}
  voc <- dplyr::left_join(voc_merged, pol_properties, by = "pol") %>%
         dplyr::mutate(ppm     = ppb / 1000,
                       ppm_bg  = ppb_bg / 1000,
                       conc    = convert_ppmv_ugpmc(ppm, mw, 25, 84),     # ug/m3
                       conc_bg = convert_ppmv_ugpmc(ppm_bg, mw, 25, 84),  # ug/m3
                       mass_emitted = (conc - conc_bg) * hood_flow * dur, # ug
                       mass_emitted = ifelse(mass_emitted < 0, 0, mass_emitted),
                       mass_carbon  = mass_emitted * (mw_c * num_c / mw),
                       inst = "voc") 
```

* output

```{r, eval = FALSE}
  head(voc, 2)
```

---

# Output

Combine mass-based pollutants into a single data frame.

```{r}
  emissions <- dplyr::bind_rows(
                  dplyr::select(co_co2_ch4,
                                id, pol, conc, conc_bg, mass_emitted, mass_carbon, inst),
                  dplyr::select(grav,
                                id, pol, conc, conc_bg, mass_emitted, mass_carbon, inst),
                  dplyr::select(ecoc,
                                id, pol, conc, conc_bg, mass_emitted, mass_carbon, inst),
                  dplyr::select(carbonyls,
                                id, pol, conc, conc_bg, mass_emitted, mass_carbon, inst),
                  dplyr::select(voc,
                                id, pol, conc, conc_bg, mass_emitted, mass_carbon, inst))
```

Convert to longer format

```{r}
  emissions_long <- tidyr::gather(emissions, "metric", "value", 3:6)
```

Number-based pollutants

```{r}
  number <- dplyr::select(ultrafine, id, pol, num_emitted, inst) %>%
            tidyr::gather("metric", "value", num_emitted)
```

Combine mass- and number-based emissions

```{r}
  emissions_long  <- dplyr::bind_rows(emissions_long, number)
```

Save the data frame. 

```{r}
  saveRDS(emissions_long, file = "../r_files/emissions_long.RDS")
```

# Modified combustion efficiency

Calculate MCE:

```{r, message=FALSE}
  df_mce <- dplyr::select(co_co2_ch4, id, pol, ppm, ppm_bg)     %>%
            dplyr::mutate(ppm_bg_corr = ppm - ppm_bg)           %>% 
            dplyr::select(-ppm, -ppm_bg)                        %>%
            tidyr::spread(pol, ppm_bg_corr)                     %>%
            dplyr::mutate(mce = co2/(co2 + co))                 %>%
            
            # Add test metadata to dataframe
            dplyr::left_join(select(samples, id, type, mc_level, mc_dry),
                             by=c("id")) %>%
            dplyr::filter(id != "FH2")

  saveRDS(df_mce, file = "../r_files/df_mce.RDS")
```

Calculate the mean MCE and standard deviation at each moisture level.  

```{r}
  df_mce_summary <- group_by(df_mce, mc_level) %>%
                     summarise(mean   = mean(100*mce),
                               sd     = sd(100*mce))

  kable(df_mce_summary, format="markdown", digits=c(2,1),
        col.names=c("Moisture level", "Mean (%)","SD (%)"))
```

Test for significant differences between the MCEs at different moisture levels using Tukey's test. 

```{r}
  TukeyHSD(aov(mce ~ mc_level, df_mce))
```

### Compare MCE and exhaust temperature

Extract temperature for periods of interest

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}

  times_temp <- dplyr::filter(times, substr(id,1,2) != "BG") %>%
                dplyr::mutate(id = as.character(id))
  
  df_temp_e  <- dplyr::filter(temp_merged, loc=="exhaust") %>%
                dplyr::mutate(time = time + 3600) # add an hour
  
  df_temp_e <- filter_times(times_temp, df_temp_e) %>%
               dplyr::filter(id !="FH2") %>%
               group_by(id) %>%
               dplyr::summarise(temp_mean = mean(t_oc)) 
```

```{r}
  df_mce_temp <- left_join(df_mce, df_temp_e, by=c("id")) 

  pearson_r <- cor.test(df_mce_temp$temp_mean, df_mce_temp$mce, method="pearson", conf.level=0.95)
  pearson_r
```

```{r}
  mod_mce_temp <- lm(mce ~ temp_mean, df_mce_temp)

  summary(mod_mce_temp)
```

```{r, fig.width=6.3, fig.height=6.3, fig.align='center'}
  par(mfrow = c(2, 2))
  plot(mod_mce_temp)
```

### Plots

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  # Define the colors to use in the plots. 
  purple <- "#330099"
  gold   <- "#FF9900"
  teal1  <- "#33CC99"
  teal2  <- "#339999"
  teal3  <- "#0099CC"
  orange <- "#FF6633"
  pink1  <- "#CC0066"
  pink2  <- "#FF3366"
```

```{r, fig.width=3.15, fig.height=3.15, fig.align='center'}

  ggplot(data=df_mce, aes(x=mc_dry, y=100*mce, shape=type)) + 
         geom_point(size=3, alpha=0.7) +
         coord_cartesian(xlim=c(4,30), ylim=c(96.1,99.2)) +
         scale_x_continuous(breaks=seq(5,30,10)) + 
         scale_y_continuous(breaks=seq(96,99,1)) + 
         xlab("Moisture content (%)") + 
         ylab("Modified combustion efficiency (%)") +
         labs(shape = "Fuel shape") + 
         theme(aspect.ratio=1,
               panel.grid.major.x = element_line(color="gray95"),
               panel.grid.minor.x = element_line(color="gray95"),
               panel.grid.major.y = element_line(color="gray95"),
               panel.grid.minor.y = element_line(color="gray95"),
               panel.border     = element_rect(fill=NA),
               panel.background = element_rect(fill='white'),
               axis.text  = element_text(size=10, color='black'),
               axis.title = element_text(size=10, color='black'),
               axis.ticks = element_line(color='black'),
               legend.text  = element_text(size=10, color='black'),
               legend.title = element_text(size=10, color='black'),
               legend.key   = element_blank(),
               legend.box.background = element_rect(color="black", size=0.6),
               legend.position = c(0.8,0.8)) 

  ggsave(filename="../figures/mce_fig.svg", plot=last_plot(), device="svg", width=8/2.54, height=8/2.54)
  ggsave(filename="../figures/mce_fig.pdf", plot=last_plot(), device="pdf", width=8/2.54, height=8/2.54)
```

```{r, fig.width=4.3, fig.height=3.15, fig.align='center'}

  r_text <- sprintf("%.2f", round(pearson_r$estimate, digits = 3))
  textlab_r <- paste("r == ",r_text,sep="")

  ggplot(data=df_mce_temp, aes(x=temp_mean, y=100*mce, shape=type, color=mc_level)) + 
         geom_point(size=3, alpha=0.7) +
            scale_color_manual(values = c(teal3,gold,pink1)) +
         coord_cartesian(xlim=c(305,520), ylim=c(96.1,99.1)) +
         scale_x_continuous(breaks=seq(300,500,50)) + 
         scale_y_continuous(breaks=seq(96,99,1)) + 
         xlab(expression(Mean ~ exhaust ~ temperature ~ "(" * degree * C * ")")) + 
         ylab("Modified combustion efficiency (%)") +
         labs(shape="Fuel shape", color="Moisture level") + 
         theme(aspect.ratio=1,
               panel.border     = element_rect(fill=NA),
               panel.background = element_rect(fill='white'),
               axis.text  = element_text(size=10, color='black'),
               axis.title = element_text(size=10, color='black'),
               axis.ticks = element_line(color='black'),
               legend.text  = element_text(size=10, color='black'),
               legend.title = element_text(size=10, color='black'),
               legend.key   = element_blank(),
               legend.position = "right") + 
        geom_text(aes(x=310, y=99, label=textlab_r), parse=TRUE,
                  color='black', hjust='left', size=3.5, fontface='plain')

  ggsave(filename="../figures/mce_temp.pdf", plot=last_plot(), device="pdf", width=4.3, height=8/2.54)
```

# Firepower

```{r}

  df_fp <- dplyr::select(co_co2_ch4, id, pol, mass_carbon, dur) %>%
           tidyr::spread(pol, mass_carbon) %>%
           dplyr::mutate(lhv = fuel_properties$lhv,  # kJ/kg
                         y_c = fuel_properties$carbon_fraction, # kg/kg
                         m_carbon  = co2 + co + ch4, # ug
                         firepower = (m_carbon*lhv)/(y_c*(dur*60)*(10^9))) %>% # kW
           dplyr::select(-co2,-co,-ch4) %>%
           dplyr::left_join(select(samples, id, type, mc_level, mc_dry),
                            by=c("id")) %>%
           dplyr::filter(id != "FH2")

  df_fp_mean <- group_by(df_fp, mc_level) %>%
                summarise(fp_mean = mean(firepower))
```

```{r, fig.width=3.15, fig.height=3.15, fig.align='center'}
  ggplot(df_fp, aes(x=mc_dry, y=firepower, shape=type)) +
    geom_point(size=3, alpha=0.7) +
    coord_cartesian(xlim=c(4,30), ylim=c(1.5,3.5)) +
    scale_x_continuous(breaks=seq(5,30,10)) + 
    scale_y_continuous(breaks=seq(1.5,3.5,0.5)) + 
    xlab("Moisture content (%)") + 
    ylab("Firepower (kW)") +
    labs(shape="Fuel shape") + 
    theme(aspect.ratio=1,
          panel.grid.major.x = element_line(color="gray95"),
          panel.grid.minor.x = element_line(color="gray95"),
          panel.grid.major.y = element_line(color="gray95"),
          panel.grid.minor.y = element_line(color="gray95"),
          panel.border     = element_rect(fill=NA),
          panel.background = element_rect(fill='white'),
          axis.text  = element_text(size=10, color='black'),
          axis.title = element_text(size=10, color='black'),
          axis.ticks = element_line(color='black'),
          legend.text  = element_text(size=10, color='black'),
          legend.title = element_text(size=10, color='black'),
          legend.key   = element_blank(),
          legend.box.background = element_rect(color="black", size=0.6),
          legend.position = c(0.8,0.8))

  ggsave(filename="../figures/firepower.pdf", plot=last_plot(), device="pdf", width=8/2.54, height=8/2.54)
```