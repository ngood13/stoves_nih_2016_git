---
title: "Pollutant emissions"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
  library(knitr)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  source("../r_scripts/R_functions.R")
```

# Load all data

* pollutant data - integrated

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
 # currently not complete data - missing one (shows as 0)
 # (emailed Arsineh on 6/27/17)
  voc_merged <- readRDS("../r_files/voc_merged.RDS")

  carbonyls_merged <- readRDS("../r_files/carbonyls_merged.RDS")

  grav_merged <- readRDS("../r_files/grav_merged.RDS")

  ecoc_merged <- readRDS("../r_files/ecoc_merged.RDS")

 # PAHs - no data yet (as of 6/22/17)
```

* pollutant data - time-resolved

```{r}
  fivegas_full <- readRDS("../r_files/fivegas_full.RDS") # also contains bg
  fivegas_byrep <- readRDS("../r_files/fivegas_byrep.RDS") # may not need
  fivegas_background <- readRDS("../r_files/fivegas_background_mean.RDS")

  pax_full <- readRDS("../r_files/pax_merged_full.RDS")
  pax_bg <- readRDS("../r_files/pax_merged_bg.RDS")
  pax_byrep <- readRDS("../r_files/pax_merged_rep.RDS")
```

* fuel data

```{r}
  fuel_burnt_reps <- readRDS("../r_files/fuel_burnt_reps.RDS")
  fuel_burnt_test <- readRDS("../r_files/fuel_burnt_test.RDS")
```

* test times

```{r}
  times_test <- readRDS("../r_files/times_test.RDS")
  times_fuel <- readRDS("../r_files/times_fuel.RDS")
  times_bg <- readRDS("../r_files/times_bg.RDS")
```

* constants

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  load("../r_files/hood_flow.Rda")
  load("../r_files/pol_properties.Rda")
  load("../r_files/inst_constants.Rda")
  load("../r_files/calc_constants.Rda")
```

* metadata

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  test_info <- readRDS("../r_files/test_info.RDS")
```

# calculate emissions

## carbonyls

* select data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
 # rename var as pol
  names(carbonyls_merged)[names(carbonyls_merged) =='var'] <- 'pol'
  
  carbonyls <- dplyr::select(carbonyls_merged,
                             id, qc,
                             flow_mean,
                             start, end,
                             pol, val,
                             bg_conc) %>%
               dplyr::left_join(dplyr::select(pol_properties, 
                                              pol, 
                                              mw, 
                                              num_c), by = "pol")
```

* calculate concentrations

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  carbonyls <- dplyr::mutate(carbonyls, dur = (end - start) / 60,
                             conc = (val * 1000 / (flow_mean * dur))) # ug to ug/m3
```

* calculate mass emitted

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  carbonyls <- dplyr::mutate(carbonyls, 
                             conc_emitted = conc - bg_conc,
                             mass_emitted = conc_emitted * hood_flow * dur,
                             mass_carbon_emitted = mass_emitted * (num_c * mw_c / mw),
                             inst = "carbs")
```

* output

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  head(carbonyls, 2)
```

# ecoc

* calculate mass emitted

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, eval=TRUE}
  ecoc <- ecoc_merged %>%
          dplyr::select(id, pol, value, dur, value_raw, background, qc) %>%
          dplyr::mutate(mass_emitted = value * hood_flow * dur,
                        mass_carbon_emitted = mass_emitted,
                        inst = "ecoc") %>%
          dplyr::rename(conc_emitted = "value",
                        conc = "value_raw",
                        bg_conc = "background")
```

* output

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, eval=FALSE}
  head(ecoc, 2)
```

---

# fivegas

* select co, co2 and ch4.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  co_co2_ch4 <- dplyr::filter(fivegas_full, pol == "co" | pol == "co2" | pol == "ch4")
```

* filter out data from outside emissions window

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  co_co2_ch4 <- dplyr::distinct(filter_times(times_test, co_co2_ch4))
```

* calculate average for each test

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  co_co2_ch4 <- dplyr::group_by(co_co2_ch4, id, pol) %>%
                dplyr::summarise(ppm = mean(val, na.rm = TRUE),
                                 qc = first(qc)) %>%
                dplyr::ungroup()
```

* convert mixing ratio to mass (assuming constant T and P)

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  co_co2_ch4 <- dplyr::left_join(co_co2_ch4,
                                 dplyr::select(pol_properties,
                                               pol,
                                               mw,
                                               num_c), by = "pol") %>%
                dplyr::mutate(conc = convert_ppmv_ugpmc(ppm, mw, 25, 84))
```

* merge with sample time data and calculate test duration

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  co_co2_ch4 <- dplyr::left_join(co_co2_ch4, times_test, by = "id") %>%
                dplyr::mutate(dur = end - start) %>%
                dplyr::mutate(id = as.factor(id))
```

* merge background with fivegas data
* if background is missing us averge across all tests

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  fivegas_background_mean <- fivegas_background %>%
                             dplyr::group_by(pol) %>%
                             dplyr::summarise_if(is.numeric, mean, na.rm = TRUE)

  co_co2_ch4 <- dplyr::left_join(co_co2_ch4, 
                dplyr::select(fivegas_background, id, pol, bg_ppm), by = c("id", "pol"))

  bg_missing <- dplyr::filter(co_co2_ch4, is.na(bg_ppm)) %>%
                dplyr::select(-bg_ppm) %>%
                dplyr::left_join(dplyr::select(fivegas_background_mean, pol, bg_ppm),
                                 by = "pol")

  co_co2_ch4 <- dplyr::bind_rows(dplyr::filter(co_co2_ch4, !is.na(bg_ppm)),
                                 bg_missing) %>%
                dplyr::mutate(bg_conc = convert_ppmv_ugpmc(bg_ppm, mw, 25, 84))
```

* calculate micrograms emitted during tests (background-corrected mass emitted)

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  co_co2_ch4 <- dplyr::mutate(co_co2_ch4,
                              conc_emitted = conc - bg_conc,
                              mass_emitted = conc_emitted * hood_flow * (dur / 60), # ug/m^3 * m^3/min * s/60 = ug
                              num_c = 1,
                              mass_carbon_emitted = mass_emitted * (mw_c * num_c / mw),
                              inst = "fivegas")
```

* output

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  head(co_co2_ch4, 2)
```

---

# PAX - DATA GOOD BUT HAVE NOT ATTEMPTED TO RUN CODE YET - no code from main aim 1? 

---

# grav - FIRST ATTEMPT DONE as of 6/27/17; note question on negative emissions

* select data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  grav <- dplyr::select(grav_merged,
                        id, pol,
                        start, end,
                        flow_mean,
                        delta,
                        bg_conc, qc, conc) %>%
          dplyr::filter(grepl("^[A-Z]", id) == FALSE)
```

* calculate concentrations

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  grav <- dplyr::mutate(grav, dur = (end - start) / 60,
                              qc = as.factor(qc))
```

* calculate mass emitted (using 'conc', the calibration and blank corrected concentration)

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  grav <- dplyr::mutate(grav, 
                        conc_emitted = conc - bg_conc,
                        mass_emitted = conc_emitted * hood_flow * dur,
                        mass_carbon_emitted = mass_emitted * 0,
                        inst = "grav")
```

* output

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  head(grav, 2)
```

---

# pah - NO DATA YET

* waiting on data

---

# voc

* select data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  voc <- dplyr::select(voc_merged,
                       id,
                       time_start, time_end,
                       pol, ppb,
                       ppb_bg, qc) %>%
         dplyr::left_join(dplyr::select(pol_properties,
                                        pol,
                                        mw,
                                        num_c), by = "pol")
```

* calculate concentrations

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  voc <- dplyr::mutate(voc, dur = (time_end - time_start) / 60,
                            ppm = ppb / 1000,
                            conc = convert_ppmv_ugpmc(ppm, mw, 25, 85),
                            bg_conc = convert_ppmv_ugpmc(ppb_bg / 1000, mw, 25, 85))
```

* calculate mass emitted

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  voc <- dplyr::mutate(voc, conc_emitted = conc - bg_conc,
                            mass_emitted = conc_emitted * hood_flow * dur,
                            mass_carbon_emitted = mass_emitted * (mw_c * num_c / mw),
                            inst = "voc")
```

* output

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  head(voc, 2)
```

___

# Output

## combine pollutants

* mass based

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  emissions <- dplyr::bind_rows(select_emissions(co_co2_ch4),
                                select_emissions(carbonyls),
                                select_emissions(grav),
                                select_emissions(voc),
                                select_emissions(ecoc))
```

* convert to longer format

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  emissions_long <- tidyr::gather(emissions, "metric", "value", 3:7)
```

## save

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  saveRDS(emissions_long, file = "../r_files/emissions_long.RDS")
```

## negative emissions

* tests with negative net emissions

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=10, fig.height=40} 
  kable(dplyr::filter(emissions, mass_emitted < 0),
        align = 'c', caption = "Tests with negative values")
```
