---
title: "VOCs"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
  library(forcats)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  source("../r_scripts/R_functions.R")
```

## Load and tidy data

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  load("../r_files/emissions.Rda")  # load emissions data
  load("../r_files/samples.Rda")  # load sample meta data
  load("../r_files/fuel_burnt.Rda")  # fuel use meta data
```

* Output emissions column names 

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  colnames(emissions)
```

* Select pollutant of interest

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  pol_p <- dplyr::filter(emissions, grepl('^voc_benzene|^voc_toluene', pol))
  pol_name <- "vocs"
```

* Filter out bad tests

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  pol_p <- dplyr::filter(pol_p, qc != "bad")
```

* Merge with fuel burnt data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  pol_p <- dplyr::left_join(pol_p, dplyr::select(fuel_burnt, id,
                                                 mass_fuel, lhv,
                                                 carbon_fraction), by = "id") %>%
           dplyr::left_join(dplyr::select(samples, id, stove,
                                          fuel, fuelcat, stovecat,
                                          stove_fuel), by = "id")
```

## Calculate emissions factor
 
```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  pol_p <- dplyr::mutate(pol_p, mass_ef = 
                           (mass_emitted * 1e-3) / (mass_fuel * 1e-3)) %>%  # mg / kg
           dplyr::mutate(energy_ef = (mass_ef * 1e-3)*(lhv * 1e-3))  # g / MJ
```

# Data summary 

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  summary(pol_p$mass_ef)
  summary(pol_p$energy_ef)
```

* emissions are given in units of miligrams of `r pol_name` per kilogram of fuel burned and grams of `r pol_name` per MJ delivered by the fuel

# Mass based emissions factor plots 

* Emissions grouped by stove/fuel combination 

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width = 14,  fig.height = 10}
  plot_ef(pol_p, pol_name, "mass")
```

# Energy based emissions factor plots 

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width = 14, fig.height = 10}
  plot_ef(pol_p, pol_name, "energy")
```

# Flag additional bad tests based on qaqc
