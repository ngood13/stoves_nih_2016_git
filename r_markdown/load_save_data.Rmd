---
title: "Load and save data"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r load_libraries, echo=FALSE, message=FALSE}
  library(tidyverse)
  library(knitr)
```

```{r global_options, include=FALSE}
  knitr::opts_chunk$set(warning = FALSE, message = FALSE, cache = FALSE)
```

```{r}
  source("../r_scripts/R_load_data.R")
  source("../r_scripts/R_load_metadata.R")
  source("../r_scripts/R_tidy.R")
  source("../r_scripts/R_functions.R")
```

# Pollutant data

## co2

* load and save co2 data
* logged as voltage or mixing ratio

```{r} 
  co2_lab <- load_multifile(fldr = "../data/co2",
                            pattern = "DILUTION1.csv$", inst = "co2")

  saveRDS(co2_lab, file = "../r_files/co2_lab.RDS")

  co2_sample <- load_multifile(fldr = "../data/co2",
                               pattern = "DILUTION2.csv$", inst = "co2")

  saveRDS(co2_sample, file = "../r_files/co2_sample.RDS")

  co2_lab_sample <- load_multifile(fldr = "../data/co2",
                                   pattern = "DILUTION.csv$", inst = "co2")

  saveRDS(co2_lab_sample, file = "../r_files/co2_lab_sample.RDS")
```

## ecoc

* load and save ecoc data

```{r} 
  ecoc <- load_multifile(fldr = "../data/ecoc",
                         pattern = "ECOC.csv$",
                         inst = "ecoc")

  saveRDS(ecoc, file = "../r_files/ecoc.RDS")
```  

## fivegas

* load and save five gas data
* logged as voltage or mixing ratio

```{r}
  fivegas_conc <- load_fivegas(type = "conc")

  save(fivegas_conc, file = "../r_files/fivegas_conc.Rda")

  fivegas_volts <- load_fivegas(type = "volts")

  save(fivegas_volts, file = "../r_files/fivegas_volts.Rda")

  fivegas_calibration <- load_fivegas(pattern = "_CALIBRATION_",
                                      type = "volts")

  saveRDS(fivegas_calibration, file = "../r_files/fivegas_calibration.RDS")
```

## gravimetric

* load and save gravimetric data

```{r}
  grav <- load_singlefiles("grav")

  saveRDS(grav, file = "../r_files/grav.RDS")
```

## ions and carbonyls

* load and save ion and carbonyl data

```{r} 
  ions <- load_singlefiles("ions")

  saveRDS(ions, file = "../r_files/ions.RDS")
```

## pahs

* load and save pah data

```{r}
  pah <- load_singlefiles("pah")
  saveRDS(pah, file = "../r_files/pah.RDS")

  pah_lod <- load_singlefiles("pah_lod")
  saveRDS(pah_lod, file = "../r_files/pah_lod.RDS")
```

## pax

* load and save pax data

```{r}
  pax <- load_multifile(fldr = "../data/pax",
                        pattern = "ALLDAY_PAX.csv$", inst = "pax")

  saveRDS(pax, file = "../r_files/pax.RDS")
```

## scale

* load and save real-time mass data

```{r} 
  scale <- load_multifile(fldr = "../data/scale",
                          pattern = "_SCALE.xlsx$", inst = "scale")

  saveRDS(scale, file = "../r_files/scale.RDS")
```

## smps

* load and save smps data

```{r} 
  smps <- load_multifile(fldr = "../data/smps",
                         pattern = "_SMPS.csv$", inst = "smps")

  saveRDS(smps, file = "../r_files/smps.RDS")
```

## temperature

* load and save thermocouple data

```{r}
  temp <- load_multifile(fldr = "../data/temp",
                         pattern = "_TEMP.csv|_TEMP.CSV", inst = "temp")

  saveRDS(temp, file = "../r_files/temp.RDS")
```

## transmissometer

* load and save transmissometer data

```{r}
  trans <- load_singlefiles("trans")

  saveRDS(trans, file = "../r_files/trans.RDS")
```
 
## vocs

* load and save voc data
 
```{r}
  voc <- load_singlefiles("voc")

  saveRDS(voc, file = "../r_files/voc.RDS")
```

# Metadata

## sample logs

* load test info

```{r}
  samples <- load_singlefiles("sample")
```

* stove types

```{r}
  samples <- dplyr::mutate(samples,
                           stove = factor(stove,
                           levels = c("Three Stone Fire (Artisan)",
                             "Clay Ring (Artisan)",
                             "Built-in Justa (Envirofit, HM5000)",
                             "Rocket Elbow (Envirofit, G3300)",
                             "Fan Rocket Elbow (Biolite, HomeStove)",
                             "Ceramic Charcoal (Artisan)",
                             "Metal Charcoal (Burn, Jikokoa)",
                             "Gasifier (Philips, HD4012)",
                             "Gasifer (Mimi Moto, Mimi Moto)",
                             "Gasifier (Envirofit, Prototype)",
                             "Wick Kerosene (Cook 'n Lite, 82)", 
                             "Pressurized Kerosene (Butterfly, 2412)",
                             "Pressurized LPG (WokSmith, WS-C1-25K)")),
                           stove =
                             stove %>%
                             tolower %>%
                             gsub(" [:(:].*[:):]", "",.) %>%
                             forcats::fct_recode("lpg" = "pressurized lpg"),
                             forcats::fct_recode("pressure kerosene" =
                                                   "pressurized kerosene"))
```

* fuel types

```{r}
  samples <- dplyr::mutate(samples,
                           fuel = factor(fuel,
                           levels = c("Douglas Fir",
                             "Oak",
                             "Eucalyptus",
                             "Lump Hardwood (Sm.)",
                             "Lump Hardwood (Med.)",
                             "Coconut Charcoal",
                             "West Slope Pellets",
                             "Eucalyptus Pellets",
                             "Kerosene",
                             "Liquefied Petroleum Gas")),
                           fuel =
                             fuel %>%
                             tolower %>%
                             forcats::fct_recode("lpg" = "liquefied petroleum gas") %>%
                             forcats::fct_relevel("oak",
                                                   "eucalyptus",
                                                   "douglas fir",
                                                   "lump hardwood (med.)",
                                                   "lump hardwood (sm.)",
                                                   "coconut charcoal",
                                                   "west slope pellets",
                                                   "eucalyptus pellets",
                                                   "lpg",
                                                   "kerosene"))
```

* fuel categories

```{r}
  samples <- dplyr::mutate(samples,
                           fuelcat =
                             forcats::fct_collapse(fuel,
                               "wood" = c("oak",
                                        "eucalyptus",
                                        "douglas fir"),
                               "charcoal" = c("coconut charcoal",
                                            "lump hardwood (med.)", 
                                            "lump hardwood (sm.)"),
                               "pellets" = c("eucalyptus pellets",
                                           "west slope lellets"),
                               "liquids" = c("kerosene",
                                          "lpg")))
```

* stove categories

```{r}
  samples <- dplyr::mutate(samples,
                           stovecat =
                            forcats::fct_collapse(stove,
                               "traditional stoves" =
                                 c("clay ring", "three stone fire", "ceramic charcoal"),
                               "insulated [improved] stoves" =
                                 c("fan rocket elbow", "metal charcoal", "rocket elbow", "built-in justa",
                                   "gasifier"),
                               "liquid-fuel stoves" =
                                 c("lpg", "wick kerosene", "pressure kerosene")))
```

* save test info

```{r}
  saveRDS(samples, file = "../r_files/samples.RDS")
```

## batch sample meta data

* weights (fuel, pot, ...)
* times (start, refuel, ...)
* lab conditions (T, RH, P)
* notes
 
```{r}  
  batch <- load_singlefiles("batch")

  batch <- dplyr::filter(batch, grepl("^[0-9]", id))

  saveRDS(batch, file = "../r_files/batch.RDS")
```

## wood sample meta data

* weights (fuel, pot, ...)
* times (start, refuel, ...)
* lab conditions (T, RH, P)
* notes

```{r} 
  wood <- load_singlefiles("wood")

  wood <- dplyr::filter(wood, grepl("^[0-9]", id))

  saveRDS(wood, file = "../r_files/wood.RDS")
```

## calibration log 1

* fivegas calibration standards
* fivegas calibration timestamps

```{r}
  cal_1 <- load_singlefiles("cal_1")

  saveRDS(cal_1, file = "../r_files/cal_1.RDS")
```

## calibration log 2

* co2 calibration information
* pax and smps flow measurements

```{r}  
  cal_2 <- load_singlefiles("cal_2")

  saveRDS(cal_2, file = "../r_files/cal_2.RDS")
```

## data log 1

* load and save data
* filter cartridge flows and times
* voc times
* fivegas background times
* notes

```{r} 
  data_1 <- load_singlefiles("data_1")

  saveRDS(data_1, file = "../r_files/data_1.RDS")
```
 
## data log 2

* load and save data
* carbonyls and isokinetic inlet times and flows
* smps and pax times (including background)

```{r} 
  data_2 <- load_singlefiles("data_2")

  saveRDS(data_2, file = "../r_files/data_2.RDS")
```
