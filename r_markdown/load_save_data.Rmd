---
title: "Load and save data"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
  library(forcats)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  source("../r_scripts/R_load_data.R")
  source("../r_scripts/R_load_metadata.R")
  source("../r_scripts/R_tidy.R")
  source("../r_scripts/R_functions.R")
```

# Pollutant data

### CO~2~

Loads and saves the CO2 voltage data (`calibration?`)

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE} 
  co2 <- load_multifile(fldr = "../data/co2",
                        pattern = ".*_CO2.*.csv$", inst = "co2")

  saveRDS(co2, file = "../r_files/co2.RDS")
```

### EC/OC

Loads ecoc data file and saves

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  ecoc <- load_ecoc_file()
  ecoc
  saveRDS(ecoc, file = "../r_files/ecoc.RDS")
```  

### Five gas

Loads fivegas mixing ratio files and resaves.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  data_fivegas <- load_fivegas()
  saveRDS(data_fivegas, file = "../r_files/fivegas.RDS")
```

### Gravimetric

Loads filter weight data and resaves as .RDS.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  data_grav <- load_grav_file() 
  saveRDS(data_grav, file = "../r_files/grav.RDS")
```

### Carbonyls

Loads and resaves data as .RDS.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE} 
  carbonyls <- load_singlefiles("carbonyls")
  saveRDS(carbonyls, file = "../r_files/carbonyls.RDS")
```

### PAX

Loads and resaves data as .RDS.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  pax <- load_multifile(fldr = "../data/pax",
                        pattern = "ALLDAY_PAX.csv$", inst = "pax")

  saveRDS(pax, file = "../r_files/pax.RDS")
```

### SMPS

Loads and resaves data as an .RDS.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE} 
  smps <- load_multifile(fldr = "../data/smps",
                         pattern = "_SMPS.txt$", inst = "smps")
  saveRDS(smps, file = "../r_files/smps.RDS")
```

### Temperature

Loads and resaves data as an .RDS.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  temp <- load_multifile(fldr = "../data/temp",
                         pattern = "_TEMP.csv", inst = "temp")
  saveRDS(temp, file = "../r_files/temp.RDS")
```

### Transmissometer

Loads and resaves data as an .RDS.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  trans <- load_trans_file("../data/trans/MC Transmissometer Final.xlsx")
  saveRDS(trans, file = "../r_files/trans.RDS")
```
 
### VOCs

Loads the microgram sheet  and resaves data as an .Rda.
 
```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  #voc <- load_singlefiles("voc")
  #save(voc, file = "../r_files/voc.RDS")
```

# Metadata

* Fuel preparation data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  data_fuel_prep <- load_fuel_prep()
  saveRDS(data_fuel_prep, file = "../r_files/data_fuel_prep.RDS")
```

```{r, warning=FALSE}
  
  # Load the data
  fuel_prep_clean <- read_excel("../data/logs/Fuel Prep Final Edited.xlsx")

  # Clean the data
  fuel_prep_clean <- dplyr::select(fuel_prep_clean, fuel_id, test_date, test_order, 
                                                    mass_final, mass_original,
                                                    kiln_wood_original, kiln_wood_post, 
                                                    mc_target) %>%
                     dplyr::mutate(test_order         = as.numeric(test_order),
                                   mass_final         = as.numeric(mass_final),
                                   mass_original      = as.numeric(mass_original),
                                   kiln_wood_original = as.numeric(kiln_wood_original),
                                   kiln_wood_post     = as.numeric(kiln_wood_post),
                                   mc_target          = as.numeric(mc_target)) %>%
                     plyr::rename(c("fuel_id"="id"))   %>%
                     dplyr::filter(!is.na(test_order)) %>%
  
  # Calculate:
  # 1. The moisture content of the reference piece of fuel (on a dry mass basis).  
  # 2. The dry weight of the test fuel.  
  # 3. The actual moisture content of the test fuel (on a dry mass basis). 
  dplyr::mutate(kiln_mc = (kiln_wood_original - kiln_wood_post)/kiln_wood_post, # dry basis
                m_dry   = mass_original/(kiln_mc + 1),
                mc_dry  = 100*(mass_final - m_dry)/m_dry) # dry basis
  
  saveRDS(fuel_prep_clean, "../r_files/fuel_prep_clean.RDS")
```

* Tester 1 log

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  data_tester_one <- load_test_one()
  saveRDS(data_tester_one, file = "../r_files/data_tester_one.RDS")
```

* Tester 2 log

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  data_tester_two <- load_test_two()
  saveRDS(data_tester_two, file = "../r_files/data_tester_two.RDS")
```

* Calibration 2 log

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  data_cal_two <- load_cal_two()
  saveRDS(data_cal_two, file = "../r_files/data_cal_two.RDS")
```

* Test log

```{r, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  mc_test_log <- load_test_log()
  saveRDS(mc_test_log, file = "../r_files/mc_test_log.RDS")
```

