---
title: "gravimetric"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
  library(forcats)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  source("../r_scripts/R_tidy.R")
```

# Load data

* gravimetric

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  grav <- readRDS("../r_files/grav.RDS")
```

* metadata

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  test_info <- readRDS("../r_files/test_info.RDS")
  times_fuel <- readRDS("../r_files/times_fuel.RDS")
  times_bg <- readRDS("../r_files/times_bg.RDS")
  times_test <- readRDS("../r_files/times_test.RDS")
  flow <- readRDS("../r_files/flows.RDS")
  notes <- readRDS("../r_files/notes.RDS")
```

# Organize

* make longer

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  grav <- dplyr::filter(grav, !is.na(id)) %>%
           tidyr::gather("var", "val", matches("^wgt.*")) %>%
           dplyr::filter(grepl(".*avg.*|.*dif.*", var) == FALSE) %>%
           tidyr::separate("var", c("type", "when", "rep")) %>%
           dplyr::mutate(type = ifelse(when == "cal", "cal", "sample"),
                         when = ifelse(when == "cal", rep, when),
                         rep = ifelse(rep == "pre" | rep == "post",
                                      "1", rep))
```

* average

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  grav <- dplyr::group_by(grav, id, type, 
                           when, date_pre, date_post,
                           toc_pre, rh_pre,
                           toc_post, rh_post,
                           id_filter,
                           id_grav,
                           id_blank) %>%
           dplyr::summarise(mean = mean(val, na.rm = TRUE)) %>%
           dplyr::ungroup() %>%
           tidyr::spread(when, mean) %>%
           dplyr::mutate(delta = post - pre) %>%
           dplyr::rename(id_test = id)
```

* merge with id and flows

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  grav <- dplyr::left_join(grav, test_info)

  flow <- dplyr::filter(flow, inst == "isokinetic") %>%
           dplyr::select(id, mean, delta) %>%
           dplyr::rename(flow_delta = delta,
                         flow_mean = mean)
  
  grav <- left_join(grav, flow, by = "id")
```

* add pollutant variable `pol`

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  grav <- dplyr::mutate(grav, pol = "grav")
```

## Calibration weight

Spread data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  cal <- dplyr::filter(grav, type == "cal") %>%
         dplyr::select(id, delta) %>%
         dplyr::rename(cal_delta = delta)

  grav <- dplyr::filter(grav, type == "sample") %>%
          dplyr::left_join(cal)
```

## Test times

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
 grav <- dplyr::left_join(grav,
                           dplyr::select(times_test, id, start, end))
```

## Concentrations

* update conc units?

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
 grav <- dplyr::mutate(grav, conc = (delta - cal_delta) / (60 * flow_mean / 1000 * (end - start))) # mg/m^3???
```

## Test type

Is B[0-9] background as well?

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  grav <- dplyr::mutate(grav, 
                         type = ifelse(grepl("^BG.*", id_test),
                         "bg", type))
```

# QC

* extract notes for gravimetric data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  notes <- dplyr::filter(notes, grepl("grav|all", notes$notes) == TRUE)
```

# Background

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  bg <- dplyr::filter(grav, type == "bg") %>%
        dplyr::summarise(bg = mean(conc, na.rm = TRUE)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  lod_var <- signal$lod[1]
  loq_var <- signal$loq[1]
```

The LOD is `r lod_var`, the LOQ is `r loq_var`.

* flag the measurements

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  grav_merged <- dplyr::mutate(grav_merged,
                               lod = ifelse(wgt_delta >= lod_var, "above", "below"),
                               loq = ifelse(wgt_delta >= loq_var, "above", "below"))
```

# Background analysis

* extract background data
* remove missing data
* calculate average concentration emitted ( and other stats)

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  bg <- dplyr::filter(grav_merged, type == "bg", qc == "ok") %>%
        dplyr::select(id, flow,
                         start, end,
                         wgt_delta) %>%
        na.omit() %>%
        dplyr::mutate(dur = (end - start) / 60,
                      conc = wgt_delta * 1000 / (flow * dur)) %>%
        dplyr::summarise(conc_bg = mean(conc),
                         sd = sd(conc),
                         min = min(conc),
                         max = max(conc),
                         n = n()) %>%
        dplyr::mutate(type = factor("test", levels_type))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  knitr::kable(bg, "markdown", digits = 2)
```

* add background to main dataframe

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  grav_merged <- dplyr::left_join(grav_merged,
                                  dplyr::select(bg, type, conc_bg),
                                                by = "type")
```

# Summary

Gravimetric data was collected during `r length(unique(grav_merged$id))` experiments between `r min(grav_merged$date, na.rm = TRUE)` and `r max(grav_merged$date, na.rm = TRUE)`. There is no $Gravimetric$ data for tests: `r setdiff(as.character(samples$id), as.character(grav_merged$id))`.

Gravimetric data is expected to be missing for: 17A only. Filter ruptured so could not be post-weighed. 

# Save merged file

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  save(grav_merged, file = "../r_files/grav_merged.Rda")
```

# Plots

## weights

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=12, fig.height=8}
  ggplot(dplyr::filter(grav_merged, grepl("^[0-9][A-Z]", id)==TRUE),
         aes(id, wgt_delta, color= qc)) +
  geom_point() +
  theme_minimal()
  
  ggplot(dplyr::filter(grav_merged, grepl("^[1][0-9][A-Z]", id)==TRUE),
         aes(id, wgt_delta, color= qc)) +
  geom_point() +
  theme_minimal()
  
  ggplot(dplyr::filter(grav_merged, grepl("^[2-3][0-9][A-Z]", id)==TRUE),
         aes(id, wgt_delta, color= qc)) +
  geom_point() +
  theme_minimal()
  
  ggplot(dplyr::filter(grav_merged, grepl("^[G]", id)==TRUE),
         aes(id, wgt_delta, color= qc)) +
  geom_point() +
  theme_minimal()
```

## calibration

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=12, fig.height=8}
  ggplot(grav_merged, aes(id, wgt_cal_delta)) +
  geom_point() +
  theme_minimal() +
  ylab("Cal weight delta (mg)") +
  theme(text = element_text(size=8), axis.text.x = element_text(angle=-45, hjust=1))
```

## blanks

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=12, fig.height=8}
  ggplot(grav_merged, aes(id, wgt_blank_delta)) +
  geom_point() +
  theme_minimal() +
  ylab("Blanks weight delta (mg)") +
  theme(text = element_text(size=8), axis.text.x = element_text(angle=-45, hjust=1)) 
```
