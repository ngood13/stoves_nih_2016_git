---
title: "gravimetric"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r global_options, include=FALSE}
  knitr::opts_chunk$set(fig.path = 'figures/',
                        warning = FALSE,
                        message = FALSE,
                        fig.width=10, fig.height = 4,
                        cache = FALSE)
```

```{r, echo=FALSE, include=FALSE}
  library(tidyverse)
  library(forcats)
```

```{r}
  source("../r_scripts/R_tidy.R")
```

# Load data

* gravimetric

```{r}
  grav <- readRDS("../r_files/grav.RDS")
```

* metadata

```{r}
  samples <- readRDS("../r_files/samples.RDS")
  filter_times <- readRDS("../r_files/filter_times.RDS")
  filter_flows <- readRDS("../r_files/filter_flows.RDS")
  notes <- readRDS("../r_files/notes.RDS")
```

# Organize

## filter tests

* select stove and background tests only. Remove pre-calculated LOD.

```{r}
  grav_merged <- dplyr::select(grav, -lod, -phpa_pre, -phpa_post) %>%
                 dplyr::mutate(type = ifelse(grepl("^BG[0-9]", id), "bg", NA),
                               type = ifelse(grepl("^G[0-9]", id), "test_blank", type),
                               type = ifelse(grepl("^F|^L", id), "test", type))
```

# Metadata

* match cassette flows to id

```{r}
  flows <- dplyr::select(filter_flows, -date) %>%
           dplyr::filter(colour == "white") %>%
           dplyr::group_by(id, type, colour) %>%
           dplyr::summarise(flow = mean(value, na.rm = TRUE)) %>%
           dplyr::group_by(id, colour) %>%
           dplyr::summarise(flow = mean(flow, na.rm = TRUE)) %>%
           dplyr::select(-colour)
```

* match cassette timestamps to id

```{r}
  times <- dplyr::select(filter_times, -date) %>%
           dplyr::filter(color == "white") %>%
           tidyr::spread(type, value) %>%
           dplyr::select(-color)
```

* merge gravimetric with metadata

```{r}
  grav_merged <- dplyr::left_join(grav_merged,
                                  flows,
                                  by = "id") %>%
                 dplyr::left_join(times,
                                  by = "id")
```

# Reformat

* pre-average #code calculates preweight DO THIS

```{r}
  grav_pre <- dplyr::select(grav_merged, wgt_pre_1, wgt_pre_2, wgt_pre_3, id) %>%
              tidyr::gather("var", "val", wgt_pre_1, wgt_pre_2, wgt_pre_3) %>%
              dplyr::filter(!is.na(val)) %>%
              dplyr::group_by(id) %>%
              dplyr::summarise(wgt_pre = mean(val))
```

* post-average #code calculates preweights - makes it longer vs more columns DO THIS

```{r}
  grav_post <- dplyr::select(grav_merged, wgt_post_1, wgt_post_2, wgt_post_3, id) %>%
               tidyr::gather("var", "val", wgt_post_1, wgt_post_2, wgt_post_3) %>%
               dplyr::filter(!is.na(val)) %>%
               dplyr::group_by(id) %>%
               dplyr::summarise(wgt_post = mean(val))
```

* merge averages 

```{r}
  grav_merged <- dplyr::left_join(grav_merged, grav_pre, by = "id") %>%
                 dplyr::left_join(grav_post, by = "id")
```

* mass added to test, bg, and test_blank filters

```{r}
  grav_merged <- dplyr::mutate(grav_merged, 
                            wgt_delta = wgt_post - wgt_pre)
```

* change in calibration weight

```{r}
  grav_merged <- dplyr::mutate(grav_merged,
                            wgt_cal_delta = wgt_cal_post - wgt_cal_pre)
```

* change in lab blank weight 

```{r}
  grav_merged <- dplyr::mutate(grav_merged,
                               wgt_blank_delta = wgt_blank_avg_post - wgt_blank_avg_pre)
```

* add pollutant variable `pol`

```{r}
  grav_merged <- dplyr::mutate(grav_merged,
                               pol = "grav")
```

* break out by field/lab/blank/background

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
 # note fix two type variables
  grav_merged <- left_join(grav_merged,
                           dplyr::rename(dplyr::select(samples, id, type),
                                          test_type = type),
                           by = "id")
```

* break out by low, medium, high MC

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  grav_merged<- dplyr::mutate(grav_merged,mc_level=ifelse(grepl("^G[1-9]",id)== TRUE, "none",
                                                          ifelse(grepl("^BG[1-9]",id) == TRUE, "none",
                                                          ifelse(grepl("^[A-Z]L[1-9]",id) == TRUE, "low",
                                                          ifelse(grepl("^[A-Z]M[1-9]",id) == TRUE, "medium","high")))))
```

# QC

* extract notes for gravimetric data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  notes <- dplyr::filter(notes, grepl("grav|all", inst) == TRUE)
```

* mark `bad` tests

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
 # notes$qc[] <- "bad"
 # notes$qc[] <- "bad"
```

* apply flags: `bad` preceeds `maybe` preceeds `good`

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  # flags <- dplyr::select(notes, id, qc) %>%
  #          dplyr::group_by(id) %>%
  #          dplyr::arrange(qc) %>%
  #          dplyr::summarise(qc = first(qc))
```

* merge

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  # grav_merged <- dplyr::left_join(grav_merged, flags, by = "id") %>%
  #                dplyr::mutate(id = as.factor(id)) %>%
  #                dplyr::mutate(qc = as.factor(ifelse(is.na(qc), "ok", as.character(qc))))
```

Additional bad tests

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  # grav_merged$qc[grav_merged$id == ""] <- "bad"
  # grav_merged$qc[grav_merged$id == ""] <- "bad"
  # grav_merged$qc[grav_merged$id == ""] <- "bad"
```

* remove backgrounds and bad data then calculate the limit of detection and quantification

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  grav_lod <- grav_merged %>%
              filter(type == "test_blank") %>%
              #dplyr::filter(qc != "bad") %>%
              dplyr::summarise(lod = sd(wgt_delta) * 3 + mean(wgt_delta),
                               loq = sd(wgt_delta) * 10 + mean(wgt_delta),
                               delta = mean(wgt_delta))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  lod_var <- grav_lod$lod[1]
  loq_var <- grav_lod$loq[1]
```

The LOD is `r lod_var`, the LOQ is `r loq_var`.

* flag the measurements

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  grav_merged <- dplyr::mutate(grav_merged,
                               lod = ifelse(wgt_delta >= lod_var, "above", "below"),
                               loq = ifelse(wgt_delta >= loq_var, "above", "below"))
```

# Background analysis

* extract background data
* remove missing data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  bg <- dplyr::filter(grav_merged, type == "bg") %>% #, qc == "ok") %>%
        dplyr::select(id, flow,
                      start, end,
                      wgt_delta) %>%
        na.omit() %>%
        dplyr::mutate(dur = (end - start) / 60,
                      conc = wgt_delta * 1000 / (flow * dur))
```

```{r, fig.width = 6, fig.height = 4}
  ggplot(bg, aes(id, conc)) +
  geom_point() +
  theme_minimal() +
  ylab(expression(PM[2.5]~~mu~g/m^3))
```

* calculate average concentration emitted (and other stats)

```{r}
  bg_summary <- bg %>%
                dplyr::summarise(mean_bg = mean(conc),
                                 sd = sd(conc),
                                 min = min(conc),
                                 max = max(conc),
                                 n = n()) %>%
                dplyr::mutate(type = factor("bg", "bg"))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  knitr::kable(bg_summary, "markdown", digits = 2)
```

* add background to main dataframe

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  grav_merged <- grav_merged %>%
                 dplyr::mutate(conc_bg = bg_summary$mean_bg)
```

# Summary 

Gravimetric data was collected during `r length(unique(grav_merged$id))` experiments between `r min(grav_merged$date, na.rm = TRUE)` and `r max(grav_merged$date, na.rm = TRUE)`. There is no Gravimetric data for tests: `r #setdiff(as.character(samples$id), as.character(grav_merged$id))`.

Gravimetric data is expected to be missing for: no tests.

# Save merged file

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  saveRDS(grav_merged, file = "../r_files/grav_merged.RDS")
```

# Plots

## Test blanks

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=12, fig.height=8}
  ggplot(dplyr::filter(grav_merged, type == "test_blank"), aes(id, wgt_delta)) +
  geom_point() +
  theme_minimal()
```

## calibration

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=12, fig.height=8}
  ggplot(grav_merged, aes(id, wgt_cal_delta)) +
  geom_point() +
  theme_minimal() +
  ylab("Cal weight delta (mg)") +
  theme(text = element_text(size=8), axis.text.x = element_text(angle=-45, hjust=1))
```

## blanks

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=12, fig.height=8}
  ggplot(grav_merged, aes(id, wgt_blank_delta)) +
  geom_point() +
  theme_minimal() +
  ylab("Blanks weight delta (mg)") +
  theme(text = element_text(size=8), axis.text.x = element_text(angle=-45, hjust=1)) 
```
