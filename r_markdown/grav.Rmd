---
title: "Gravimetric PM2.5 Samples"
date:  "December 21, 2018"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo=FALSE, include=FALSE}
  library(tidyverse)
  library(gridExtra)
```

```{r}
  source("../r_scripts/R_tidy.R")
  source("../r_scripts/R_functions.R")
```

# Load data

Test metadata:

```{r}
  samples <- readRDS("../r_files/samples.RDS")
  times   <- readRDS("../r_files/test_times_all.RDS")
  flows   <- readRDS("../r_files/flow_rates.RDS")
```

Log data:

```{r}
  tester_one <- readRDS("../r_files/data_tester_one.RDS")
```

Gravimetric PM~2.5~ data:

```{r}
  data_grav    <- readRDS("../r_files/grav.RDS")
```

# Organize and combine

### Filter weights

1. Remove values that are (a) unavailable or (b) were calculated in the Excel data file.  
2. Specify the filter type (background, test blank, or test).  

```{r}
  df_grav <- dplyr::select(data_grav, -phpa_pre, -phpa_post, 
                                      -wgt_pre_avg, -wgt_post_avg, -wgt_dif, -lod) %>%
             dplyr::mutate(filter_type = ifelse(grepl("^BG[0-9]", id), "bg", NA),
                           filter_type = ifelse(grepl("^G[0-9]", id), "test_blank", filter_type),
                           filter_type = ifelse(grepl("^F|^L", id), "test", filter_type))
```

Calculate the change in mass for: (a) the test filter, (b) the calibration weight, and (c) the lab blank filter.  

```{r}
  df_grav <- dplyr::mutate(df_grav,
                        mass_pre    = (wgt_pre_1  + wgt_pre_2  + wgt_pre_3)  / 3,
                        mass_post   = (wgt_post_1 + wgt_post_2 + wgt_post_3) / 3,
                        d_mass      = mass_post - mass_pre,       # ug
                        d_cal       = wgt_cal_post - wgt_cal_pre, # ug 
                        d_lab_blank = wgt_blank_avg_post - wgt_blank_avg_pre, # ug
                        pol         = "grav") 
```

### Flow rates

```{r}
  df_flows <- flows %>%
              dplyr::filter(instrument == "filters", colour=="white") %>%
              dplyr::ungroup() %>%
              dplyr::select(-colour, -loc, -instrument)
```

### Start and end times

Get the starting and ending times for the filter sample associate with each test.  

```{r}
  df_times <- dplyr::filter(times, var %in% c("start_filters","end_filters")) %>%
              tidyr::spread(var, value) %>%
              dplyr::select(-date) 
```

### Combine

Merge filter weights, flow rates, start and end times, and test metadata.

```{r}
  df_grav_merged <- dplyr::left_join(df_grav, df_flows, by = "id") %>%
                    dplyr::left_join(df_times, by = "id")          %>%
                    dplyr::left_join(dplyr::select(samples, id, type, mc_level), 
                                     by = "id")                    %>%
                    dplyr::rename(test_type = type)
```

# LOD/LOQ

Select test blanks:  

```{r}
  df_lod <-  filter(df_grav_merged, filter_type == "test_blank")
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=3.15, fig.height=3.15, fig.align='center'}
  ggplot(df_lod, aes(id, d_mass)) +
    geom_point(size = 3) +
    coord_cartesian(ylim=c(-8,8)) + 
    scale_y_continuous(breaks=seq(-10,10,2)) + 
    xlab("Blank filter ID") + 
    ylab("Change in test blank mass (ug)") + 
    theme(aspect.ratio = 1,
          panel.border = element_rect(fill=NA, color="black"),
          panel.background = element_rect(fill="white"),
          panel.grid.major = element_line(color="gray95"),
          panel.grid.minor = element_line(color="gray95"),
          axis.ticks = element_line(color="black"),
          axis.text  = element_text(size=9, color="black"),
          axis.title = element_text(size=9, color="black"))
```

Calculate the limit of detection (LOD) and limit of quanitification (LOQ). 

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}

  df_lod <- dplyr::summarise(df_lod,
                             lod = mean(d_mass) + ( 3 * sd(d_mass)),
                             loq = mean(d_mass) + (10 * sd(d_mass)))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  lod_var <- df_lod$lod[1]
  loq_var <- df_lod$loq[1]
```

The LOD is `r ceiling(lod_var)` $\mu$g. The LOQ is `r ceiling(loq_var)` $\mu$g.

Flag each filter sample as being either above or below the LOD and LOQ.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  df_grav_merged <- dplyr::filter(df_grav_merged,
                                  filter_type != "test_blank") %>%
                    dplyr::mutate(lod = ifelse(d_mass >= lod_var, "above", "below"),
                                  loq = ifelse(d_mass >= loq_var, "above", "below"),
                                  d_mass = ifelse(lod == "below", lod_var/sqrt(2), d_mass))
```

* The mass accumulated on the filter was above the LOD for `r nrow(dplyr::filter(df_grav_merged, filter_type == "test", lod == "above"))`/`r nrow(dplyr::filter(df_grav_merged, filter_type == "test"))` tests (background tests not included).  
* The mass accumulated on the filter was above the LOQ for `r nrow(dplyr::filter(df_grav_merged, filter_type == "test", loq == "above"))`/`r nrow(dplyr::filter(df_grav_merged, filter_type == "test"))` tests (background tests not included).  

* The mass accumulated on the filter was above the LOD for `r nrow(dplyr::filter(df_grav_merged, filter_type == "bg", lod == "above"))`/`r nrow(dplyr::filter(df_grav_merged, filter_type == "bg"))` background samples.  
* The mass accumulated on the filter was above the LOQ for `r nrow(dplyr::filter(df_grav_merged, filter_type == "bg", loq == "above"))`/`r nrow(dplyr::filter(df_grav_merged, filter_type == "bg"))` background samples.  

# Calculate concentration

Calculate the PM~2.5~ concentration in the hood exhaust.

```{r}
  df_grav_conc <- df_grav_merged %>%
                  dplyr::mutate(dur = (end_filters - start_filters) / 60, # minutes
                  conc = d_mass / ((flow * dur)/1000)) # ug/m3
```

# Background 

1. Select background tests.  
2. Remove tests for which data is incomplete.  

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  df_bg <- dplyr::filter(df_grav_conc, is.na(test_type)) %>% # 1
           dplyr::select(id, conc) %>%
           na.omit() # 2
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=3.15, fig.height=3.15, fig.align='center'}
  ggplot(df_bg, aes(id, conc)) +
    geom_point(size = 3) +
    xlab("Test ID") + 
    ylab(expression(PM[2.5]~concentration~"("*mu*g/m^3*")")) + 
    coord_cartesian(ylim=c(0,300)) + 
    scale_y_continuous(breaks=seq(0,300,50)) + 
    theme(aspect.ratio = 1,
          panel.border = element_rect(fill=NA, color="black"),
          panel.background = element_rect(fill="white"),
          panel.grid.major = element_line(color="gray95"),
          panel.grid.minor = element_line(color="gray95"),
          axis.ticks = element_line(color="black"),
          axis.text  = element_text(size=9, color="black"),
          axis.title = element_text(size=9, color="black"))
```

Calculate the mean background concentration.

```{r}
  bg_summary <- df_bg %>%
                dplyr::summarise(mean = mean(conc),
                                 sd   = sd(conc),
                                 min  = min(conc),
                                 max  = max(conc),
                                 n    = n())
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  knitr::kable(bg_summary, "markdown", digits = 0)
```

Add the mean background concentration to the main dataframe. 

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  df_grav_conc <- dplyr::mutate(df_grav_conc, conc_bg = bg_summary$mean)
```

# Save

```{r}

  df_grav_conc <- df_grav_conc %>%
                  dplyr::filter(substr(id,1,1) != "G",  # reomve test blanks
                                substr(id,1,2) != "BG") # remove background tests

  saveRDS(df_grav_conc, file = "../r_files/grav_conc.RDS")
```

Gravimetric data was collected during `r nrow(dplyr::filter(df_grav_merged, !is.na(test_type)))` experiments between `r min(df_grav_merged$date, na.rm = TRUE)` and `r max(df_grav_merged$date, na.rm = TRUE)`. Gravimetric data is missing for: no tests.  

# QC Plots

Change in mass of calibration weight:

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=8, fig.height=3.15, fig.align='center'}
  ggplot(df_grav_conc, aes(id, d_cal)) +
    geom_point(size = 3) +
    coord_cartesian(ylim=c(-2,2)) + 
    scale_y_continuous(breaks=seq(-5,5,1)) + 
    xlab("Filter ID") + 
    ylab("Change in calibration weight mass (ug)") + 
    theme(aspect.ratio = 0.35,
          panel.border = element_rect(fill=NA, color="black"),
          panel.background = element_rect(fill="white"),
          panel.grid.major = element_line(color="gray95"),
          panel.grid.minor = element_line(color="gray95"),
          axis.ticks  = element_line(color="black"),
          axis.text.x = element_text(size=6, color="black"),
          axis.text.y = element_text(size=9, color="black"),
          axis.title  = element_text(size=9, color="black"))
```

Change in mass of calibration weight:

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=8, fig.height=3.15, fig.align='center'}
  ggplot(df_grav_conc, aes(id, d_lab_blank)) +
    geom_point(size = 3) +
    coord_cartesian(ylim=c(-3,3)) + 
    scale_y_continuous(breaks=seq(-5,5,1)) + 
    xlab("Filter ID") + 
    ylab("Change in lab blank mass (ug)") + 
    theme(aspect.ratio = 0.35,
          panel.border = element_rect(fill=NA, color="black"),
          panel.background = element_rect(fill="white"),
          panel.grid.major = element_line(color="gray95"),
          panel.grid.minor = element_line(color="gray95"),
          axis.ticks  = element_line(color="black"),
          axis.text.x = element_text(size=6, color="black"),
          axis.text.y = element_text(size=9, color="black"),
          axis.title  = element_text(size=9, color="black"))
```
