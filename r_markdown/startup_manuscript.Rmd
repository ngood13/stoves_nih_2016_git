---
title: "Startup Manuscript"
output: html_document
---

```{r global_options, include = FALSE}
  knitr::opts_chunk$set(fig.path = 'figures/',
                        warning = FALSE,
                        message = FALSE,
                        fig.width = 10, fig.height = 4,
                        cache = FALSE)
```

```{r setup, include=FALSE}
  library(tidyverse)
  library(knitr)
  source("../r_scripts/R_functions.R")
```

```{r, include=FALSE}
  emission_factors <- readRDS(file = "../r_files/emission_factors.RDS")
  fuel_burnt_reps <- readRDS(file = "../r_files/fuel_burnt_reps.RDS")
  qc <- readRDS(file = "../r_files/qc.RDS")
```


# Results

## Prepare data

* calculate mean fuel consumed per fuel type

```{r, include = FALSE}
  fuel_consumed <- fuel_burnt_reps %>%
                   dplyr::left_join(dplyr::select(qc, id, qc),
                                                  by = "id") %>%
                   dplyr::filter(!is.na(dm), qc != "bad") %>%
                   dplyr::group_by(fuel) %>%
                   dplyr::summarise(mean_dm = mean(dm),
                                    min_dm = min(dm),
                                    max_dm = max(dm),
                                    total_dm = sum(dm),
                                    mean_burn_time = round(mean(dur)*60, 1), #in minutes per startup
                                    min_burn_time = round(min(dur)*60, 1),
                                    max_burn_time = round(max(dur)*60, 1),
                                    num_reps = n()) %>%
                   dplyr::mutate(fuel = forcats::fct_relevel(fuel, "background", "kerosene",
                                                              "leaves_twigs", "flipflops",
                                                              "rubber", "newspaper",
                                                              "wood_shims", "t_shirts",
                                                              "food_packaging", "plastic_bags")) %>%
                   dplyr::mutate(fuel = forcats::fct_drop(fuel, "blank")) %>%
                   dplyr::mutate(fuel_names = forcats::fct_recode(fuel, "plastic bags" = "plastic_bags",
                                                                   "kindling" = "leaves_twigs",
                                                                   "inner tubes" = "rubber",
                                                                   "footwear" = "flipflops",
                                                                   "fabric" = "t_shirts",
                                                                   "wood shims" = "wood_shims",
                                                                   "food packaging" = "food_packaging"))

  kable(fuel_consumed, digits = 3)
```

* calculate emissions metrics

```{r, echo = FALSE}
# set variable types from character -> factor
# filter out bad QC data
# set fuel type order by survey result "commonality" of use. 
# create variable mass (g) pollutant emitted per startup event
# create variable average mass (g) of startup material per startup event
# filter out backgrounds and blanks
  per_test <- dplyr::mutate(emission_factors, fuel = factor(fuel),
                                              qc = factor(qc),
                                              pol = factor(pol)) %>%
              dplyr::rename(mass_emitted = value) %>%
              dplyr::select(-metric) %>%
              dplyr::filter(qc != "bad") %>%
              dplyr::mutate(fuel = forcats::fct_relevel(fuel, "background", "kerosene",
                                                              "leaves_twigs", "flipflops",
                                                              "rubber", "newspaper",
                                                              "wood_shims", "t_shirts",
                                                              "food_packaging", "plastic_bags")) %>%
              dplyr::mutate(fuel_names = forcats::fct_recode(fuel, "plastic bags" = "plastic_bags",
                                                                   "kindling" = "leaves_twigs",
                                                                   "inner tubes" = "rubber",
                                                                   "footwear" = "flipflops",
                                                                   "fabric" = "t_shirts",
                                                                   "wood shims" = "wood_shims",
                                                                   "food packaging" = "food_packaging"),
                            mass_pol_per_startup = (mass_emitted * 1e-3) / fuel_quant, # mg per startup event
                            mass_fuel_per_startup = fuelmass_total / fuel_quant, # g per startup event
                            mass_pol_per_mass_fuel = mass_emitted / fuelmass_total) %>%  # mg/g (same as g/kg)
              dplyr::filter(!grepl("^B", id_test)) %>%
              dplyr::left_join(dplyr::select(fuel_consumed, fuel_names, mean_dm),
                               by = "fuel_names") %>%
              dplyr::mutate(fuel_quant_std = fuelmass_total / mean_dm,
                            mass_pol_per_startup_std = (mass_emitted * 1e-3) / fuel_quant_std)

```

* QC comparison - standardized "startup event" vs. per-test average startup event
```{r, include = FALSE, fig.width = 15, fig.height = 18, eval = FALSE}
ggplot(per_test) +
geom_point(aes(x= id, y=mass_pol_per_startup), size = 2, color = 'red') +
  geom_point(aes(x=id, y=mass_pol_per_startup_std), size = 2, color = 'black') +
    facet_wrap(~pol, scales = "free", ncol = 3) +
  theme_bw() +
  theme(legend.position = "top")
```

## Table 1

* experiment summary

```{r, echo = FALSE}
  fuel_sum <- dplyr::filter(per_test, pol == 'grav') %>% 
              dplyr::group_by(fuel_names) %>%
              dplyr::summarize(n_tests = n(),
                               n_events_per_test = round(mean(fuel_quant), 2),
                               min_events_per_test = min(fuel_quant),
                               max_events_per_test = max(fuel_quant),
                               n_events_per_test_std = round(mean(fuel_quant_std), 2),
                               min_events_per_test_std = round(min(fuel_quant_std), 2),
                               max_events_per_test_std = round(max(fuel_quant_std), 2)) %>%
             dplyr::left_join(select(fuel_consumed, -fuel, -num_reps), by = "fuel_names") %>%
             dplyr::mutate(mean_dm = round(mean_dm, 2),
                           max_dm = round(max_dm, 2),
                           total_dm = round(total_dm, 2))

knitr::kable(fuel_sum)
```

## Table 2

* emissions per startup event (mg per startup event), average per test

```{r, echo = FALSE}
  mean_per_startup <- per_test %>%
                      dplyr::group_by(inst, fuel_names, pol) %>%
                      dplyr::summarize(nreps = n(),
                                   mean = round(mean(mass_pol_per_startup_std, na.rm = TRUE), 2),
                                   min = round(min(mass_pol_per_startup_std, na.rm = TRUE), 2),
                                   max = round(max(mass_pol_per_startup_std, na.rm = TRUE), 2),
                                   stdev = round(sd(mass_pol_per_startup_std, na.rm = TRUE), 2), 
                                   cov = round(((stdev/mean) * 100), 2),
                                   variation_pct = round(((max - min) / max)*100, 0),
                                   variation_act = round((max - min), 2)) %>%
                      dplyr::ungroup()

  mean_per_startup_table <- mean_per_startup %>%
                            dplyr::select(fuel_names, pol, mean, inst) %>%
                            tidyr::spread(fuel_names, mean) %>%
                            dplyr::arrange(inst)
  
  knitr::kable(mean_per_startup_table)
```

## Supplemental Table 1

* emissions per mass fuel (mg per g fuel (same as g/kg))

```{r, echo = FALSE}
  per_fuel_mass <- per_test %>%
                      dplyr::group_by(inst, fuel_names, pol) %>%
                      dplyr::summarize(nreps = n(),
                                   mean = round(mean(mass_pol_per_mass_fuel, na.rm = TRUE), 2),
                                   min = round(min(mass_pol_per_mass_fuel, na.rm = TRUE), 2),
                                   max = round(max(mass_pol_per_mass_fuel, na.rm = TRUE), 2)) %>%
                      dplyr::ungroup()

  per_fuel_mass_table <- per_fuel_mass %>%
                            dplyr::select(fuel_names, pol, mean, inst) %>%
                            tidyr::spread(fuel_names, mean) %>%
                            dplyr::arrange(inst)
  
  knitr::kable(per_fuel_mass_table)
```

## Figure 1.

* Experimental setup - created in powerpoint

## Figure 2.

* emissions of key pollutants (standardized calc)

```{r, echo = FALSE, fig.width = 16, fig.height = 11}
  p_data_key <- dplyr::filter(per_test, grepl('^grav$|^co$|^formaldehyde$|^acetaldehyde$|^voc_benzene$|^voc_toluene$', pol)) %>% #add ECOC when have data
                dplyr::mutate(pol = sub("^voc_", "", pol),
                              pol = sub("^grav", "PM2.5", pol)) %>%
                dplyr::mutate(pol = forcats::fct_relevel(pol, "PM2.5", "co",
                                                      "formaldehyde", "acetaldehyde",
                                                      "benzene", "toluene")) %>%
                dplyr::mutate(fuel_names = forcats::fct_relevel(fuel_names, "kerosene", "wood shims", "kindling", 
                                                                       "newspaper", "fabric", 
                                                                       "plastic bags", "food packaging", 
                                                                       "inner tubes", "footwear"))

  p_data_key_means <- dplyr::filter(mean_per_startup, grepl('^grav$|^co$|^formaldehyde$|^acetaldehyde$|^voc_benzene$|^voc_toluene$', pol)) %>%
                      dplyr::mutate(pol = sub("^voc_", "", pol),
                                    pol = sub("^grav", "PM2.5", pol))%>%
                      dplyr::mutate(pol = forcats::fct_relevel(pol, "PM2.5", "co",
                                                                    "formaldehyde", "acetaldehyde",
                                                                    "benzene", "toluene"))

  ggplot(p_data_key, aes(fuel_names, mass_pol_per_startup_std, color = fuel)) +
  geom_point(size = 5, shape = 1, stroke = 2) +
  #geom_point(data = p_data_key_means, aes(x = fuel_names, y = mean), colour = 'black', size = 10, shape = 95, stroke = 2) + 
  #geom_vline(xintercept = 4.5, col='black', lwd=1) +
    theme_bw() +
  theme(legend.position = "none",
        text = element_text(size=25),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text.y = element_text(margin = margin(t = 0, r = 0, b = 0, l = 25))) +
  scale_y_log10(breaks = c(0, 0.1, 0.5, 1, 3, 10, 25, 100, 500, 1000)) + 
  ylab("Emissions Factor (mg per startup event) per Test") + xlab("Fuel Type") +
  facet_wrap(~pol, scales = "free")
```

## Supplemental Figure 1.

* emissions of key pollutants (mass per mass fuel basis)

```{r, echo = FALSE, fig.width = 16, fig.height = 11}
  ggplot(p_data_key, aes(fuel_names, mass_pol_per_mass_fuel, color = fuel)) +
  geom_point(size = 5, shape = 1, stroke = 2) +
    theme_bw() +
  theme(legend.position = "none",
        text = element_text(size=25),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text.y = element_text(margin = margin(t = 0, r = 0, b = 0, l = 25))) +
  ylab("Emissions Factor (g/kg) per Test") + xlab("Fuel Type") +
  facet_wrap(~pol, scales = "free")
```


## pairwise comparisons of key pollutants (for text)

* PM2.5

```{r}
grav_means <- dplyr::filter(p_data_key, grepl('^PM2.5$', pol))
pairwise.t.test(grav_means$mass_pol_per_startup_std, grav_means$fuel_names, p.adjust.method = "none")
```

* CO

```{r}
co_means <- dplyr::filter(p_data_key, grepl('^co$', pol))
pairwise.t.test(co_means$mass_pol_per_startup_std, co_means$fuel_names, p.adjust.method = "none")
```

* formaldehyde

```{r}
for_means <- dplyr::filter(p_data_key, grepl('^formaldehyde$', pol))
pairwise.t.test(for_means$mass_pol_per_startup_std, for_means$fuel_names, p.adjust.method = "none")
```

* acetaldehyde

```{r}
acet_means <- dplyr::filter(p_data_key, grepl('^acetaldehyde$', pol))
pairwise.t.test(acet_means$mass_pol_per_startup_std, acet_means$fuel_names, p.adjust.method = "none")
```

* benzene

```{r}
bz_means <- dplyr::filter(p_data_key, grepl('^benzene$', pol))
pairwise.t.test(bz_means$mass_pol_per_startup_std, bz_means$fuel_names, p.adjust.method = "none")
```

* toluene

```{r}
tol_means <- dplyr::filter(p_data_key, grepl('^toluene$', pol))
pairwise.t.test(tol_means$mass_pol_per_startup_std, tol_means$fuel_names, p.adjust.method = "none")
```

# variations in emissions for key pollutants (for text) 

* variation in emissions per test for key pollutants - coefficient of variation (COV)

```{r, echo = FALSE}
var_per_fuel_cov <- mean_per_startup %>%
                            dplyr::filter(grepl('^grav$|^co$|^formaldehyde$|^acetaldehyde$|^voc_benzene$|^voc_toluene$', pol)) %>% #add ECOC 
                            dplyr::mutate(fuel_names = factor(fuel_names, levels = c("kerosene", "wood shims", "kindling", 
                                                                                     "newspaper", "fabric", 
                                                                                     "plastic bags", "food packaging", 
                                                                                     "inner tubes", "footwear"))) %>%
                            dplyr::select(fuel_names, pol, cov) %>%
                            tidyr::spread(fuel_names, cov) %>%
                            dplyr::arrange(pol)

  knitr::kable(var_per_fuel_cov)
```

* variation in emissions per test for key pollutants - actual value variation min to max (g/startup). 

```{r, echo = FALSE}
var_per_fuel_act <- mean_per_startup %>%
                            dplyr::filter(grepl('^grav$|^co$|^formaldehyde$|^acetaldehyde$|^voc_benzene$|^voc_toluene$', pol)) %>% #add ECOC 
                            dplyr::mutate(fuel_names = factor(fuel_names, levels = c("kerosene", "wood shims", "kindling", 
                                                                                     "newspaper", "fabric", 
                                                                                     "plastic bags", "food packaging", 
                                                                                     "inner tubes", "footwear"))) %>%
                            dplyr::select(fuel_names, pol, variation_act) %>%
                            tidyr::spread(fuel_names, variation_act) %>%
                            dplyr::arrange(pol)

  knitr::kable(var_per_fuel_act)
```

* variation in emissions per test for key pollutants - - percent variation min to max 

```{r, echo = FALSE}
var_per_fuel_pct <- mean_per_startup %>%
                            dplyr::filter(grepl('^grav$|^co$|^formaldehyde$|^acetaldehyde$|^voc_benzene$|^voc_toluene$', pol)) %>% #add ECOC
                            dplyr::mutate(fuel_names = factor(fuel_names, levels = c("kerosene", "wood shims", "kindling", 
                                                                                     "newspaper", "fabric", 
                                                                                     "plastic bags", "food packaging", 
                                                                                     "inner tubes", "footwear"))) %>%
                            dplyr::select(fuel_names, pol, variation_pct) %>%
                            tidyr::spread(fuel_names, variation_pct) %>%
                            dplyr::arrange(pol)

  knitr::kable(var_per_fuel_pct)
```

## Figure 3.

* stacked bar charts of health relevent pollutant categories

```{r, echo = FALSE, fig.width = 6, fig.height = 4}
  pol_cats <- mean_per_startup %>%
              dplyr::filter(pol == "voc_benzene" |
                            pol == "voc_toluene" |
                            pol == "voc_ethylbenzene" |
                            pol == "voc_m_p_xylene" |
                            pol == "voc_o_xylene") %>%
              dplyr::mutate(cat = "BTEX") %>%
              dplyr::bind_rows(dplyr::filter(mean_per_startup,
                                             inst == "carbs") %>%
                              dplyr::mutate(cat = "Carbonyls")) %>%
              dplyr::bind_rows(dplyr::filter(mean_per_startup,
                                             pol == "voc_benzene" |
                                             pol == "voc_toluene" |
                                             pol == "formaldehyde" |
                                             pol == "acetaldehyde") %>%
                              dplyr::mutate(cat = "Carcinogens")) %>%
              dplyr::mutate(pol = sub("^voc_", "", pol),
                            pol = sub(".*xylene.*", "xylenes", pol)) %>%
              dplyr::filter(cat != "Carbonyls") %>%
              dplyr::mutate(pol = factor(pol, levels = c("formaldehyde", "acetaldehyde", 
                                                         "benzene", "toluene", 
                                                         "ethylbenzene", "xylenes"))) %>%
              dplyr::mutate(fuel_names = factor(fuel_names, levels = c("kerosene", "wood shims", "kindling", 
                                                                       "newspaper", "fabric", 
                                                                       "plastic bags", "food packaging", 
                                                                       "inner tubes", "footwear")))

palette <- c("#E69F00", "#009E73", "#993333", "#0072B2", "#999999", "#D55E00")

stacked_plot <- ggplot(pol_cats, aes(fuel_names, mean)) +
                geom_col(aes(fill = pol), position = "stack") +
                #geom_vline(xintercept = 4.5, col='black', lwd=1) +
                facet_wrap(~cat) +
                theme_bw() +
                theme(legend.position = "top",text = element_text(size=15), 
                      axis.text.x = element_blank(),
                      axis.title.x=element_blank()) +
                scale_fill_manual(values = palette) +
                theme(legend.title=element_blank(),
                      axis.text.y = element_text(margin = margin(t = 0, r = 0, b = 0, l = 10))) +
                scale_y_continuous(limits = c(0, 60)) + 
                ylab("mg per startup event") 

filled_plot <- ggplot(pol_cats, aes(fuel_names, mean)) +
               geom_col(aes(fill = pol), position = "fill") +
               #geom_vline(xintercept = 4.5, col='black', lwd=1) +
               facet_wrap(~cat) +
               theme_bw() +
               theme(legend.position = "none",text = element_text(size=15), 
                     axis.text.x = element_text(angle = 45, hjust = 1)) +
               scale_fill_manual(values = palette) +
               theme(legend.title=element_blank(),
                     axis.text.y = element_text(margin = margin(t = 0, r = 0, b = 0, l = 10), size = 10)) +
               ylab("fraction of total") + 
               xlab("Startup Material") 
```

```{r fig.width = 6, fig.height = 9}
gridExtra::grid.arrange(stacked_plot, filled_plot)
```

## Supplemental Figure 2. 

* stacked bar charts of health relevent pollutant categories - 

```{r, echo = FALSE, fig.width = 6, fig.height = 4}

  pol_cats2 <- per_fuel_mass %>%
               dplyr::filter(pol == "voc_benzene" |
                             pol == "voc_toluene" |
                             pol == "voc_ethylbenzene" |
                             pol == "voc_m_p_xylene" |
                             pol == "voc_o_xylene") %>%
               dplyr::mutate(cat = "BTEX") %>%
               dplyr::bind_rows(dplyr::filter(per_fuel_mass,
                                              inst == "carbs") %>%
                               dplyr::mutate(cat = "Carbonyls")) %>%
               dplyr::bind_rows(dplyr::filter(per_fuel_mass,
                                              pol == "voc_benzene" |
                                              pol == "voc_toluene" |
                                              pol == "formaldehyde" |
                                              pol == "acetaldehyde") %>%
                               dplyr::mutate(cat = "Carcinogens")) %>%
               dplyr::mutate(pol = sub("^voc_", "", pol),
                             pol = sub(".*xylene.*", "xylenes", pol)) %>%
               dplyr::filter(cat != "Carbonyls") %>%
               dplyr::mutate(pol = factor(pol, levels = c("formaldehyde", "acetaldehyde", 
                                                          "benzene", "toluene", 
                                                          "ethylbenzene", "xylenes"))) %>%
               dplyr::mutate(fuel_names = factor(fuel_names, levels = c("kerosene", "wood shims", "kindling", 
                                                                        "newspaper", "fabric", 
                                                                        "plastic bags", "food packaging", 
                                                                        "inner tubes", "footwear")))

  palette <- c("#E69F00", "#009E73", "#993333", "#0072B2", "#999999", "#D55E00")

  stacked_plot2 <- ggplot(pol_cats2, aes(fuel_names, mean)) +
                   geom_col(aes(fill = pol), position = "stack") +
                   geom_vline(xintercept = 4.5, col='black', lwd=1) +
                   facet_wrap(~cat) +
                   theme_bw() +
                   theme(legend.position = "top",text = element_text(size=15), 
                         axis.text.x = element_blank(),
                         axis.title.x=element_blank()) +
                   scale_fill_manual(values = palette) +
                   theme(legend.title=element_blank(),
                         axis.text.y = element_text(margin = margin(t = 0, r = 0, b = 0, l = 10))) +
                   scale_y_continuous() + #limits = c(0, 60)) + 
                   ylab("g per kg") 

  filled_plot2 <- ggplot(pol_cats, aes(fuel_names, mean)) +
                 geom_col(aes(fill = pol), position = "fill") +
                 geom_vline(xintercept = 4.5, col='black', lwd=1) +
                 facet_wrap(~cat) +
                 theme_bw() +
                 theme(legend.position = "none",text = element_text(size=15), 
                       axis.text.x = element_text(angle = 45, hjust = 1)) +
                 scale_fill_manual(values = palette) +
                 theme(legend.title=element_blank(),
                       axis.text.y = element_text(margin = margin(t = 0, r = 0, b = 0, l = 10), size = 10)) +
                 ylab("fraction of total") + 
                 xlab("Startup Material") 
```

```{r fig.width = 6, fig.height = 9}
gridExtra::grid.arrange(stacked_plot2, filled_plot2)
```


## Figure 4

* correlations - change to spearman's rho 
corr <- cor.test(x=cars$speed, y=cars$dist, method = 'spearman')
corr$estimate gives you rho

geom_smooth method= loess ? or other way to visualize spearman correlation rather than linear pearson


### PM vs CO

```{r, echo=FALSE}
  pmco <- dplyr::filter(mean_per_startup, grepl('^grav$|^co$', pol)) %>%
          dplyr::mutate(fuel_cat = ifelse(fuel_names == 'newspaper' | 
                                          fuel_names == 'kerosene' |
                                          fuel_names == 'wood shims' | 
                                          fuel_names == 'kindling', 
                                          'conventional', 'nonconventional')) %>%
          dplyr::select(fuel_names, fuel_cat, pol, mean) %>%
          tidyr::spread(pol, mean)

 # r2 for all fuels combined
  rho_all <- cor(pmco$grav, pmco$co, method = "spearman")
# r2 for each fuel cat
  r_conv <- cor(pmco$grav[pmco$fuel_cat == "conventional"], pmco$co[pmco$fuel_cat == "conventional"], method = "spearman")
  r_noncon <- cor(pmco$grav[pmco$fuel_cat == "nonconventional"], pmco$co[pmco$fuel_cat == "nonconventional"], method = "spearman")
  
  rhos <- data.frame(c(rho_all, r_conv, r_noncon))
  colnames(rhos) <- "val"

  ggplot(data = pmco, aes(x = grav, y = co)) + 
        geom_point(size = 5, aes(colour = fuel_names, shape = fuel_cat)) +
        geom_smooth(method = "lm", se = FALSE, color = "black") +
        geom_text(data = rhos, aes(x = 200, y = 500, label = val[1]), #all
                      color = 'black',  parse = TRUE,
                      size = 5) +
        geom_smooth(method = "lm", se = FALSE, aes(group = fuel_cat, color = fuel_cat)) +
        geom_text(data = rhos, aes(x = 100, y = 700, label = val[2]), #conventional
                       color = 'red',  parse = TRUE,
                       size = 4) +
        geom_text(data = rhos, aes(x = 100, y = 100, label = val[3]), #nonconv
                       color = 'purple',  parse = TRUE,
                       size = 4) +
          ylab("CO") +
          xlab("PM2.5") +
          scale_color_hue(l=50, c=80) +
          theme_bw() +
          #scale_x_log10() +
          #scale_y_log10() +
          theme(text = element_text(size = 14),
                legend.position = "right",
                legend.key.size = unit(0.1, "cm"),
                legend.title = element_blank())
```

### formaldehyde vs acetaldehyde

```{r, echo=FALSE}
 # function for calculating  r2 value to add to plots
 # fit lm to formula
  lm_mod <- function(out = carbs, fm = "formaldehyde ~ acetaldehyde"){
    m = lm(fm, out)
    eq <- substitute(~~R^2~"="~r2, 
                     list(r2 = format(summary(m)$r.squared, digits = 2)))
    as.character(as.expression(eq))
  }
```

```{r, echo=FALSE}
  carbs <- dplyr::filter(mean_per_startup, grepl('^formaldehyde$|^acetaldehyde$', pol)) %>%
           dplyr::mutate(fuel_cat = ifelse(fuel_names == 'newspaper' | 
                                           fuel_names == 'kerosene' |
                                           fuel_names == 'wood shims' | 
                                           fuel_names == 'kindling', 
                                          'conventional', 'nonconventional')) %>%
          dplyr::select(fuel_names, fuel_cat, pol, mean) %>%
          tidyr::spread(pol, mean)

 # r2 for all fuels combined
  r2_data <- data.frame(eq = unclass(lm_mod(carbs, "formaldehyde ~ acetaldehyde")))
# r2 for each fuel cat
  eqns <- by(carbs, carbs$fuel_cat, lm_mod)
  r2_each <- data.frame(eq = unclass(eqns), fuel_cat = as.factor(names(eqns)))
  
  ggplot(data = carbs, aes(x = formaldehyde, y = acetaldehyde)) + 
        geom_point(size = 5, aes(colour = fuel_names, shape = fuel_cat)) +
        geom_smooth(method = "lm", se = FALSE, color = "black") +
        geom_text(data = r2_data, aes(x = 20, y = 15, label = eq),
                      color = 'black',  parse = TRUE,
                      size = 5) +
        geom_smooth(method = "lm", se = FALSE, aes(group = fuel_cat, color = fuel_cat)) +
        geom_text(data = r2_each, aes(x = 25, y = 10, label = eq[1]),
                       color = 'red',  parse = TRUE,
                       size = 4) +
        geom_text(data = r2_each, aes(x = 2.5, y = 4, label = eq[2]),
                       color = 'purple',  parse = TRUE,
                       size = 4) +
          ylab("acetaldehyde") +
          xlab("formaldehyde") +
          scale_color_hue(l=50, c=80) +
          theme_bw() +
          #scale_x_log10() +
          #scale_y_log10() +
          theme(text = element_text(size = 14),
                legend.position = "right",
                legend.key.size = unit(0.1, "cm"),
                legend.title = element_blank())
```

### benzene vs toluene

```{r, echo=FALSE}
 # function for calculating  r2 value to add to plots
 # fit lm to formula
  lm_mod <- function(out = voc, fm = "voc_benzene ~ voc_toluene"){
    m = lm(fm, out)
    eq <- substitute(~~R^2~"="~r2, 
                     list(r2 = format(summary(m)$r.squared, digits = 2)))
    as.character(as.expression(eq))
  }
```

```{r, echo=FALSE}
  voc <- dplyr::filter(mean_per_startup, grepl('^voc_benzene$|^voc_toluene$', pol)) %>%
         dplyr::mutate(fuel_cat = ifelse(fuel_names == 'newspaper' | 
                                         fuel_names == 'kerosene' |
                                         fuel_names == 'wood shims' | 
                                         fuel_names == 'kindling', 
                                          'conventional', 'nonconventional')) %>%
          dplyr::select(fuel_names, fuel_cat, pol, mean) %>%
          tidyr::spread(pol, mean)

 # r2 for all fuels combined
  r2_data <- data.frame(eq = unclass(lm_mod(voc, "voc_benzene ~ voc_toluene")))
# r2 for each fuel cat
  eqns <- by(voc, voc$fuel_cat, lm_mod)
  r2_each <- data.frame(eq = unclass(eqns), fuel_cat = as.factor(names(eqns)))
  

  ggplot(data = voc, aes(x = voc_benzene, y = voc_toluene)) + 
        geom_point(size = 5, aes(colour = fuel_names, shape = fuel_cat)) +
        geom_smooth(method = "lm", se = FALSE, color = "black") +
        geom_text(data = r2_data, aes(x = 15, y = 2.5, label = eq),
                      color = 'black',  parse = TRUE,
                      size = 5) +
        geom_smooth(method = "lm", se = FALSE, aes(group = fuel_cat, color = fuel_cat)) +
        geom_text(data = r2_each, aes(x = 5, y = 2.5, label = eq[1]),
                       color = 'red',  parse = TRUE,
                       size = 4) +
        geom_text(data = r2_each, aes(x = 4, y = 0.5, label = eq[2]),
                       color = 'purple',  parse = TRUE,
                       size = 4) +
          ylab("toluene") +
          xlab("benzene") +
          scale_color_hue(l=50, c=80) +
          theme_bw() +
          #scale_x_log10() +
          #scale_y_log10() +
          theme(text = element_text(size = 14),
                legend.position = "right",
                legend.key.size = unit(0.1, "cm"),
                legend.title = element_blank())
```

### PM vs formaldehyde
```{r, echo=FALSE}
 # function for calculating  r2 value to add to plots
 # fit lm to formula
  lm_mod <- function(out = pmfor, fm = "grav ~ formaldehyde"){
    m = lm(fm, out)
    eq <- substitute(~~R^2~"="~r2, 
                     list(r2 = format(summary(m)$r.squared, digits = 2)))
    as.character(as.expression(eq))
  }
```

```{r, echo=FALSE}
  pmfor <- dplyr::filter(mean_per_startup, grepl('^grav$|^formaldehyde$', pol)) %>%
           dplyr::mutate(fuel_cat = ifelse(fuel_names == 'newspaper' | 
                                           fuel_names == 'kerosene' |
                                           fuel_names == 'wood shims' | 
                                           fuel_names == 'kindling', 
                                          'conventional', 'nonconventional')) %>%
          dplyr::select(fuel_names, fuel_cat, pol, mean) %>%
          tidyr::spread(pol, mean)

 # r2 for all fuels combined
  r2_data <- data.frame(eq = unclass(lm_mod(pmfor, "grav ~ formaldehyde")))
 # r2 for each fuel cat
  eqns <- by(pmfor, pmfor$fuel_cat, lm_mod)
  r2_each <- data.frame(eq = unclass(eqns), fuel_cat = as.factor(names(eqns)))
  

  ggplot(data = pmfor, aes(x = grav, y = formaldehyde)) + 
        geom_point(size = 5, aes(colour = fuel_names, shape = fuel_cat)) +
        geom_smooth(method = "lm", se = FALSE, color = "black") +
        geom_text(data = r2_data, aes(x = 380, y = 10, label = eq),
                      color = 'black',  parse = TRUE,
                      size = 5) +
        geom_smooth(method = "lm", se = FALSE, aes(group = fuel_cat, color = fuel_cat)) +
        geom_text(data = r2_each, aes(x = 250, y = 16, label = eq[1]),
                       color = 'red',  parse = TRUE,
                       size = 4) +
        geom_text(data = r2_each, aes(x = 200, y = 3, label = eq[2]),
                       color = 'purple',  parse = TRUE,
                       size = 4) +
          ylab("formaldehyde") +
          xlab("PM2.5") +
          scale_color_hue(l=50, c=80) +
          theme_bw() +
          #scale_x_log10() +
          #scale_y_log10() +
          theme(text = element_text(size = 14),
                legend.position = "right",
                legend.key.size = unit(0.1, "cm"),
                legend.title = element_blank())
```

### PM vs acetaldehyde
```{r, echo=FALSE}
 # function for calculating  r2 value to add to plots
 # fit lm to formula
  lm_mod <- function(out = pmacet, fm = "grav ~ acetaldehyde"){
    m = lm(fm, out)
    eq <- substitute(~~R^2~"="~r2, 
                     list(r2 = format(summary(m)$r.squared, digits = 2)))
    as.character(as.expression(eq))
  }
```

```{r, echo=FALSE}
  pmacet <- dplyr::filter(mean_per_startup, grepl('^grav$|^acetaldehyde$', pol)) %>%
            dplyr::mutate(fuel_cat = ifelse(fuel_names == 'newspaper' | 
                                            fuel_names == 'kerosene' |
                                            fuel_names == 'wood shims' | 
                                            fuel_names == 'kindling', 
                                           'conventional', 'nonconventional')) %>%
           dplyr::select(fuel_names, fuel_cat, pol, mean) %>%
           tidyr::spread(pol, mean)

 # r2 for all fuels combined
  r2_data <- data.frame(eq = unclass(lm_mod(pmacet, "grav ~ acetaldehyde")))
   # r2 for each fuel cat
  eqns <- by(pmacet, pmacet$fuel_cat, lm_mod)
  r2_each <- data.frame(eq = unclass(eqns), fuel_cat = as.factor(names(eqns)))

  ggplot(data = pmacet, aes(x = grav, y = acetaldehyde)) + 
        geom_point(size = 5, aes(colour = fuel_names, shape = fuel_cat)) +
        geom_smooth(method = "lm", se = FALSE, color = "black") +
        geom_text(data = r2_data, aes(x = 400, y = 10, label = eq),
                      color = 'black',  parse = TRUE,
                      size = 5) +
        geom_smooth(method = "lm", se = FALSE, aes(group = fuel_cat, color = fuel_cat)) +
        geom_text(data = r2_each, aes(x = 250, y = 8, label = eq[1]),
                       color = 'red',  parse = TRUE,
                       size = 4) +
        geom_text(data = r2_each, aes(x = 200, y = 2, label = eq[2]),
                       color = 'purple',  parse = TRUE,
                       size = 4) +
          ylab("acetaldehyde") +
          xlab("PM2.5") +
          scale_color_hue(l=50, c=80) +
          theme_bw() +
          #scale_x_log10() +
          #scale_y_log10() +
          theme(text = element_text(size = 14),
                legend.position = "right",
                legend.key.size = unit(0.1, "cm"),
                legend.title = element_blank())
```

### PM vs benzene
```{r, echo=FALSE}
 # function for calculating  r2 value to add to plots
 # fit lm to formula
  lm_mod <- function(out = pmbenz, fm = "grav ~ voc_benzene"){
    m = lm(fm, out)
    eq <- substitute(~~R^2~"="~r2, 
                     list(r2 = format(summary(m)$r.squared, digits = 2)))
    as.character(as.expression(eq))
  }
```

```{r, echo=FALSE}
  pmbenz <- dplyr::filter(mean_per_startup, grepl('^grav$|^voc_benzene$', pol)) %>%
            dplyr::mutate(fuel_cat = ifelse(fuel_names == 'newspaper' | 
                                            fuel_names == 'kerosene' |
                                            fuel_names == 'wood shims' | 
                                            fuel_names == 'kindling', 
                                           'conventional', 'nonconventional')) %>%
           dplyr::select(fuel_names, fuel_cat, pol, mean) %>%
           tidyr::spread(pol, mean)

 # r2 for all fuels combined
  r2_data <- data.frame(eq = unclass(lm_mod(pmbenz, "grav ~ voc_benzene")))
   # r2 for each fuel cat
  eqns <- by(pmbenz, pmbenz$fuel_cat, lm_mod)
  r2_each <- data.frame(eq = unclass(eqns), fuel_cat = as.factor(names(eqns)))
  
  ggplot(data = pmbenz, aes(x = grav, y =voc_benzene)) + 
        geom_point(size = 5, aes(colour = fuel_names, shape = fuel_cat)) +
        geom_smooth(method = "lm", se = FALSE, color = "black") +
        geom_text(data = r2_data, aes(x = 300, y = 13, label = eq),
                      color = 'black',  parse = TRUE,
                      size = 5) +
        geom_smooth(method = "lm", se = FALSE, aes(group = fuel_cat, color = fuel_cat)) +
        geom_text(data = r2_each, aes(x = 200, y = 10, label = eq[1]),
                       color = 'red',  parse = TRUE,
                       size = 4) +
        geom_text(data = r2_each, aes(x = 200, y = 2, label = eq[2]),
                       color = 'purple',  parse = TRUE,
                       size = 4) +
          ylab("benzene") +
          xlab("PM2.5") +
          scale_color_hue(l=50, c=80) +
          theme_bw() +
          #scale_x_log10() +
          #scale_y_log10() +
          theme(text = element_text(size = 14),
                legend.position = "right",
                legend.key.size = unit(0.1, "cm"),
                legend.title = element_blank())
```

### PM vs toluene

```{r, echo=FALSE}
 # function for calculating  r2 value to add to plots
 # fit lm to formula
  lm_mod <- function(out = lpmt, fm = "grav ~ voc_toluene"){
    m = lm(fm, out)
    eq <- substitute(~~R^2~"="~r2, 
                     list(r2 = format(summary(m)$r.squared, digits = 2)))
    as.character(as.expression(eq))
  }
```

```{r, echo=FALSE}
  pmtol <- dplyr::filter(mean_per_startup, grepl('^grav$|^voc_toluene$', pol)) %>%
            dplyr::mutate(fuel_cat = ifelse(fuel_names == 'newspaper' | 
                                            fuel_names == 'kerosene' |
                                            fuel_names == 'wood shims' | 
                                            fuel_names == 'kindling', 
                                           'conventional', 'nonconventional')) %>%
           dplyr::select(fuel_names, fuel_cat, pol, mean) %>%
           tidyr::spread(pol, mean)

 # r2 for all fuels combined
  r2_data <- data.frame(eq = unclass(lm_mod(pmtol, "grav ~ voc_toluene")))
   # r2 for each fuel cat
  eqns <- by(pmtol, pmtol$fuel_cat, lm_mod)
  r2_each <- data.frame(eq = unclass(eqns), fuel_cat = as.factor(names(eqns)))
  
  ggplot(data = pmtol, aes(x = grav, y =voc_toluene)) + 
        geom_point(size = 5, aes(colour = fuel_names, shape = fuel_cat)) +
        geom_smooth(method = "lm", se = FALSE, color = "black") +
        geom_text(data = r2_data, aes(x = 350, y = 1.5, label = eq),
                      color = 'black',  parse = TRUE,
                      size = 5) +
        geom_smooth(method = "lm", se = FALSE, aes(group = fuel_cat, color = fuel_cat)) +
        geom_text(data = r2_each, aes(x = 200, y = 2.8, label = eq[1]),
                       color = 'red',  parse = TRUE,
                       size = 4) +
        geom_text(data = r2_each, aes(x = 200, y = 0.7, label = eq[2]),
                       color = 'purple',  parse = TRUE,
                       size = 4) +
          ylab("toluene") +
          xlab("PM2.5") +
          scale_color_hue(l=50, c=80) +
          theme_bw() +
          #scale_x_log10() +
          #scale_y_log10() +
          theme(text = element_text(size = 14),
                legend.position = "right",
                legend.key.size = unit(0.1, "cm"),
                legend.title = element_blank())
```


### CO vs formaldehyde
```{r, echo=FALSE}
 # function for calculating  r2 value to add to plots
 # fit lm to formula
  lm_mod <- function(out = cofor, fm = "co ~ formaldehyde"){
    m = lm(fm, out)
    eq <- substitute(~~R^2~"="~r2, 
                     list(r2 = format(summary(m)$r.squared, digits = 2)))
    as.character(as.expression(eq))
  }
```

```{r, echo=FALSE}
  cofor <- dplyr::filter(mean_per_startup, grepl('^co$|^formaldehyde$', pol)) %>%
           dplyr::mutate(fuel_cat = ifelse(fuel_names == 'newspaper' | 
                                           fuel_names == 'kerosene' |
                                           fuel_names == 'wood shims' | 
                                           fuel_names == 'kindling', 
                                          'conventional', 'nonconventional')) %>%
          dplyr::select(fuel_names, fuel_cat, pol, mean) %>%
          tidyr::spread(pol, mean)

 # r2 for all fuels combined
  r2_data <- data.frame(eq = unclass(lm_mod(cofor, "co ~ formaldehyde")))
   # r2 for each fuel cat
  eqns <- by(cofor, cofor$fuel_cat, lm_mod)
  r2_each <- data.frame(eq = unclass(eqns), fuel_cat = as.factor(names(eqns)))
  
  ggplot(data = cofor, aes(x = co, y = formaldehyde)) + 
        geom_point(size = 5, aes(colour = fuel_names, shape = fuel_cat)) +
        geom_smooth(method = "lm", se = FALSE, color = "black") +
        geom_text(data = r2_data, aes(x = 380, y = 15, label = eq),
                      color = 'black',  parse = TRUE,
                      size = 5) +
          ylab("formaldehyde") +
        geom_smooth(method = "lm", se = FALSE, aes(group = fuel_cat, color = fuel_cat)) +
        geom_text(data = r2_each, aes(x = 750, y = 13, label = eq[1]),
                       color = 'red',  parse = TRUE,
                       size = 4) +
        geom_text(data = r2_each, aes(x = 200, y = 2, label = eq[2]),
                       color = 'purple',  parse = TRUE,
                       size = 4) +
          xlab("CO") +
          scale_color_hue(l=50, c=80) +
          theme_bw() +
          #scale_x_log10() +
          #scale_y_log10() +
          theme(text = element_text(size = 14),
                legend.position = "right",
                legend.key.size = unit(0.1, "cm"),
                legend.title = element_blank())
```

### CO vs acetaldehyde
```{r, echo=FALSE}
 # function for calculating  r2 value to add to plots
 # fit lm to formula
  lm_mod <- function(out = coacet, fm = "co ~ acetaldehyde"){
    m = lm(fm, out)
    eq <- substitute(~~R^2~"="~r2, 
                     list(r2 = format(summary(m)$r.squared, digits = 2)))
    as.character(as.expression(eq))
  }
```

```{r, echo=FALSE}
  coacet <- dplyr::filter(mean_per_startup, grepl('^co$|^acetaldehyde$', pol)) %>%
            dplyr::mutate(fuel_cat = ifelse(fuel_names == 'newspaper' | 
                                            fuel_names == 'kerosene' |
                                            fuel_names == 'wood shims' | 
                                            fuel_names == 'kindling', 
                                           'conventional', 'nonconventional')) %>%
           dplyr::select(fuel_names, fuel_cat, pol, mean) %>%
           tidyr::spread(pol, mean)

 # r2 for all fuels combined
  r2_data <- data.frame(eq = unclass(lm_mod(coacet, "co ~ acetaldehyde")))
   # r2 for each fuel cat
  eqns <- by(coacet, coacet$fuel_cat, lm_mod)
  r2_each <- data.frame(eq = unclass(eqns), fuel_cat = as.factor(names(eqns)))
  
  
  ggplot(data = coacet, aes(x = co, y = acetaldehyde)) + 
        geom_point(size = 5, aes(colour = fuel_names, shape = fuel_cat)) +
        geom_smooth(method = "lm", se = FALSE, color = "black") +
        geom_text(data = r2_data, aes(x = 600, y = 10, label = eq),
                      color = 'black',  parse = TRUE,
                      size = 5) +
        geom_smooth(method = "lm", se = FALSE, aes(group = fuel_cat, color = fuel_cat)) +
        geom_text(data = r2_each, aes(x = 675, y = 5, label = eq[1]),
                       color = 'red',  parse = TRUE,
                       size = 4) +
        geom_text(data = r2_each, aes(x = 250, y = 1.25, label = eq[2]),
                       color = 'purple',  parse = TRUE,
                       size = 4) +
          ylab("acetaldehyde") +
          xlab("CO") +
          scale_color_hue(l=50, c=80) +
          theme_bw() +
          #scale_x_log10() +
          #scale_y_log10() +
          theme(text = element_text(size = 14),
                legend.position = "right",
                legend.key.size = unit(0.1, "cm"),
                legend.title = element_blank())
```

### CO vs benzene
```{r, echo=FALSE}
 # function for calculating  r2 value to add to plots
 # fit lm to formula
  lm_mod <- function(out = cobenz, fm = "co ~ voc_benzene"){
    m = lm(fm, out)
    eq <- substitute(~~R^2~"="~r2, 
                     list(r2 = format(summary(m)$r.squared, digits = 2)))
    as.character(as.expression(eq))
  }
```

```{r, echo=FALSE}
  cobenz <- dplyr::filter(mean_per_startup, grepl('^co$|^voc_benzene$', pol)) %>%
            dplyr::mutate(fuel_cat = ifelse(fuel_names == 'newspaper' | 
                                            fuel_names == 'kerosene' |
                                            fuel_names == 'wood shims' | 
                                            fuel_names == 'kindling', 
                                           'conventional', 'nonconventional')) %>%
           dplyr::select(fuel_names, fuel_cat, pol, mean) %>%
           tidyr::spread(pol, mean)

 # r2 for all fuels combined
  r2_data <- data.frame(eq = unclass(lm_mod(cobenz, "co ~ voc_benzene")))
   # r2 for each fuel cat
  eqns <- by(cobenz, cobenz$fuel_cat, lm_mod)
  r2_each <- data.frame(eq = unclass(eqns), fuel_cat = as.factor(names(eqns)))
  
  ggplot(data = cobenz, aes(x = co, y = voc_benzene)) + 
        geom_point(size = 5, aes(colour = fuel_names, shape = fuel_cat)) +
        geom_smooth(method = "lm", se = FALSE, color = "black") +
        geom_text(data = r2_data, aes(x = 450, y = 7.5, label = eq),
                      color = 'black',  parse = TRUE,
                      size = 5) +
        geom_smooth(method = "lm", se = FALSE, aes(group = fuel_cat, color = fuel_cat)) +
        geom_text(data = r2_each, aes(x = 600, y = 11, label = eq[1]),
                       color = 'red',  parse = TRUE,
                       size = 4) +
        geom_text(data = r2_each, aes(x = 200, y = 1.25, label = eq[2]),
                       color = 'purple',  parse = TRUE,
                       size = 4) +
          ylab("benzene") +
          xlab("CO") +
          scale_color_hue(l=50, c=80) +
          theme_bw() +
          #scale_x_log10() +
          #scale_y_log10() +
          theme(text = element_text(size = 14),
                legend.position = "right",
                legend.key.size = unit(0.1, "cm"),
                legend.title = element_blank())
```

### CO vs toluene
```{r, echo=FALSE}
 # function for calculating  r2 value to add to plots
 # fit lm to formula
  lm_mod <- function(out = cotol, fm = "co ~ voc_toluene"){
    m = lm(fm, out)
    eq <- substitute(~~R^2~"="~r2, 
                     list(r2 = format(summary(m)$r.squared, digits = 2)))
    as.character(as.expression(eq))
  }
```

```{r, echo=FALSE}
  cotol <- dplyr::filter(mean_per_startup, grepl('^co$|^voc_toluene$', pol)) %>%
            dplyr::mutate(fuel_cat = ifelse(fuel_names == 'newspaper' | 
                                            fuel_names == 'kerosene' |
                                            fuel_names == 'wood shims' | 
                                            fuel_names == 'kindling', 
                                           'conventional', 'nonconventional')) %>%
           dplyr::select(fuel_names, fuel_cat, pol, mean) %>%
           tidyr::spread(pol, mean)

 # r2 for all fuels combined
  r2_data <- data.frame(eq = unclass(lm_mod(cotol, "co ~ voc_toluene")))
   # r2 for each fuel cat
  eqns <- by(cotol, cotol$fuel_cat, lm_mod)
  r2_each <- data.frame(eq = unclass(eqns), fuel_cat = as.factor(names(eqns)))
  
  
  ggplot(data = cotol, aes(x = co, y = voc_toluene)) + 
        geom_point(size = 5, aes(colour = fuel_names, shape = fuel_cat)) +
        geom_smooth(method = "lm", se = FALSE, color = "black") +
        geom_text(data = r2_data, aes(x = 500, y = 1.5, label = eq),
                      color = 'black',  parse = TRUE,
                      size = 5) +
        geom_smooth(method = "lm", se = FALSE, aes(group = fuel_cat, color = fuel_cat)) +
        geom_text(data = r2_each, aes(x = 750, y = 3, label = eq[1]),
                       color = 'red',  parse = TRUE,
                       size = 4) +
        geom_text(data = r2_each, aes(x = 225, y = 0.5, label = eq[2]),
                       color = 'purple',  parse = TRUE,
                       size = 4) +
          ylab("toluene") +
          xlab("CO") +
          scale_color_hue(l=50, c=80) +
          theme_bw() +
          #scale_x_log10() +
          #scale_y_log10() +
          theme(text = element_text(size = 14),
                legend.position = "right",
                legend.key.size = unit(0.1, "cm"),
                legend.title = element_blank())
```
