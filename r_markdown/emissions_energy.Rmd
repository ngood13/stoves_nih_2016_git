---
title: "Emission factors"
subtitle: "Mass emitted per energy delivered"
author: "Lizette van Zyl and Jessica Tryner"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
  library(knitr)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  source("../r_scripts/R_functions.R")
```

# Load data

Test metadata: 

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  samples     <- readRDS("../r_files/samples.RDS")
  test_times  <- readRDS("../r_files/test_times_all.RDS") 
  mc_test_log <- readRDS("../r_files/mc_test_log.RDS")
```

Constants: 

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  c_water <- readRDS("../r_files/c_water.RDS")
  hfg_water <- readRDS("../r_files/hfg_water.RDS")
```

Emissions data: 

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  emissions_long <- readRDS("../r_files/emissions_long.RDS")
```

Temperature data: 

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  temp_merged <- readRDS("../r_files/temp_merged.RDS")
```

# Test timestamps

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  df_times <- dplyr::filter(test_times, var == "set_1" | var == "end") %>%
              tidyr::spread(var, value) %>%
              dplyr::rename(start = set_1) %>%
              dplyr::filter(!grepl("^BG", id))
```

# Calculate energy delivered to water

Get the pot weights. Then calculate: (1) the starting mass of water in the pot and (2) the mass of water evaporated.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  df_weights <- select(mc_test_log, id, wgt_pot, wgt_on, wgt_off) %>%
                mutate(mass_h2o  = wgt_on - wgt_pot,     # g
                       mass_evap = wgt_on - wgt_off) %>% # g
                filter(!is.na(wgt_on)) # remove background tests
```

Select water temperatures recorded during the test.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}

  df_temp <- mutate(temp_merged, time = time + 3600) %>%
             dplyr::filter(loc == "water")

  df_temp <- filter_temp(df_times, df_temp)
```

Calculate the change in water temperature between the beginning and end of the test.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}

  df_energy <- dplyr::group_by(df_temp, id) %>%
               dplyr::summarise(temp_min = min(t_oc, na.rm = TRUE),  
                                temp_max = max(t_oc, na.rm = TRUE))
```

Combine the water mass and temperature data. Then, calculate the mass of energy delivered to the water.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}

  df_energy <- dplyr::left_join(df_energy, df_weights, by=c("id")) %>%
               dplyr::mutate(j_heat = mass_h2o * c_water * (temp_max - temp_min), # g * J/(g.oC) * oC
                             j_evap = mass_evap * hfg_water,    #  J
                             mj_d   = (j_heat + j_evap)/(10^6)) # MJ
```

# Calculate emission factors

Calculate the amount of each pollutant emitted per unit energy delivered to the cooking surface:  

1. Select the `mass_emitted` and `num_emitted` metrics for actual tests.  
2. Add the number of megajoules delivered to the dataframe.  
3. Calculate the emission factors as $\mu$g/MJ~d~ or number/MJ~d~.  
4. Convert mass-based emission factors to g/MJ~d~.  
5. Add a column with units.  

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
 df_ef <- dplyr::filter(emissions_long, metric %in% c("mass_emitted", # 1
                                                      "num_emitted"),
                                        !grepl("^BG|G", id)) %>%
          dplyr::left_join(dplyr::select(df_energy, id, mj_d), by=c("id")) %>% # 2
          dplyr::mutate(ef = value / mj_d, # ug/MJd or #/MJd          # 3
                        ef = ifelse(metric == "mass_emitted",         # 4
                                    ef * (1e-6), ef), # g/MJd
                        units = ifelse(metric == "mass_emitted",      # 5
                                       "g_MJd", "num_MJd")) %>% 
          dplyr::select(-metric, -value)
```

Add test metadata to the data frame.

```{r}
  df_ef <- dplyr::left_join(df_ef,
                            dplyr::select(samples, id, type, mc_level, mc_dry), 
                            by=c("id")) %>% 
           dplyr::ungroup() %>%
           dplyr::mutate(id = forcats::fct_relevel(id, "FL1", "FL2", "FL3", "FL4",
                                                       "FM1", "FM2", "FM3", "FM4",
                                                       "FH1", "FH2", "FH3", "FH4",
                                                       "LL1", "LL2", "LL3", "LL4",
                                                       "LM1", "LM2", "LM3", "LM4",
                                                       "LH1", "LH2", "LH3","LH4"),
                         fuel_mc_shape = paste(mc_level, type, sep="_")) %>%
    
          dplyr::filter(!is.na(type), # remove background tests
                        id != "FH2")
```

Save the data.

```{r}
  saveRDS(df_ef, file = "../r_files/ef_energy.RDS")
```

# Plot results

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  # Define the colors to use in the plots. 
  purple <- "#330099"
  gold   <- "#FF9900"
  teal1  <- "#33CC99"
  teal2  <- "#339999"
  teal3  <- "#0099CC"
  orange <- "#FF6633"
  pink1  <- "#CC0066"
  pink2  <- "#FF3366"
```

```{r, fig.width=3.15, fig.height=3.15, fig.align='center'}

  ggplot(df_ef, aes(x=mc_dry, y=mj_d, shape=type)) +
      geom_point(size=3, alpha=0.7) +
      coord_cartesian(xlim=c(4,30), ylim=c(0.35,1)) +
      scale_x_continuous(breaks=seq(5,30,10)) + 
      scale_y_continuous(breaks=seq(0.1,1.0,0.1)) + 
      xlab("Moisture content (%)") + 
      ylab("Energy delivered (MJ)") +
      labs(shape = "Fuel shape") + 
      theme(aspect.ratio=1,
            panel.border     = element_rect(fill=NA),
            panel.background = element_rect(fill='white'),
            axis.text  = element_text(size=10, color='black'),
            axis.title = element_text(size=10, color='black'),
            axis.ticks = element_line(color='black'),
            legend.text  = element_text(size=10, color='black'),
            legend.title = element_text(size=10, color='black'),
            legend.key   = element_blank(),
            legend.box.background = element_rect(color="black", size=0.6),
            legend.position = c(0.80,0.20)) 
```

```{r, fig.width=7.48, fig.height=3.54, fig.align='center'}

  df_ef_subset <- dplyr::filter(df_ef, pol %in% c("co","grav","ec","oc","ch4",
                                                  "formaldehyde","acetaldehyde","benzene")) %>%
                  dplyr::mutate(pol = factor(pol,
                                             levels = c("co","grav","ec","oc","ch4",
                                                        "formaldehyde","acetaldehyde",
                                                        "benzene")))

  # dummy data used to ensure that y-axis goes to zero on all panels except CO and CH4
  df_dummy <- data.frame(pol=levels(df_ef_subset$pol),
                         mc_dry=c(5),
                         ef=c(5,0,0,0,0.3,0,0,0),
                         type=c("Milled"))

  ggplot(df_ef_subset, aes(x=mc_dry, y=1000*ef, shape=type, color=pol)) +
      facet_wrap(~pol, ncol=4, scales="free_y") + 
    # add lines for CO tiers
    geom_hline(aes(yintercept=11500), size=0.5, data=subset(df_ef_subset, pol=="co"), linetype=2, color="gray75") +
    geom_hline(aes(yintercept= 7200), size=0.5, data=subset(df_ef_subset, pol=="co"), linetype=2, color="gray75") +
    geom_hline(aes(yintercept= 4400), size=0.5, data=subset(df_ef_subset, pol=="co"), linetype=2, color="gray75") +
    geom_hline(aes(yintercept= 3000), size=0.5, data=subset(df_ef_subset, pol=="co"), linetype=2, color="gray75") +
    # add lines for PM tiers
    geom_hline(aes(yintercept=1030), size=0.5, data=subset(df_ef_subset, pol=="grav"), linetype=2, color="gray75") +
    geom_hline(aes(yintercept= 481), size=0.5, data=subset(df_ef_subset, pol=="grav"), linetype=2, color="gray75") +
    geom_hline(aes(yintercept= 218), size=0.5, data=subset(df_ef_subset, pol=="grav"), linetype=2, color="gray75") +
    geom_hline(aes(yintercept=  62), size=0.5, data=subset(df_ef_subset, pol=="grav"), linetype=2, color="gray75") +
    geom_hline(aes(yintercept=   5), size=0.5, data=subset(df_ef_subset, pol=="grav"), linetype=2, color="gray75") +
      # label CO tiers
      geom_text(aes(label="1", x=30.5, y=13000), data=subset(df_ef_subset, pol=="co"),
                color="gray75", hjust="right", vjust="top", size=3.2) +
      geom_text(aes(label="2", x=30.5, y= 9400), data=subset(df_ef_subset, pol=="co"),
                color="gray75", hjust="right", vjust="center", size=3.2) +
      geom_text(aes(label="3", x=30.5, y= 5700), data=subset(df_ef_subset, pol=="co"),
                color="gray75", hjust="right", vjust="center", size=3.2) +
      geom_text(aes(label="4", x=30.5, y= 3700), data=subset(df_ef_subset, pol=="co"),
                color="gray75", hjust="right", vjust="center", size=3.2) +
      # label PM tiers
      geom_text(aes(label="0", x=30.5, y=1100), data=subset(df_ef_subset, pol=="grav"),
                color="gray75", hjust="right", vjust="bottom", size=3.2) +
      geom_text(aes(label="1", x=30.5, y= 756), data=subset(df_ef_subset, pol=="grav"),
                color="gray75", hjust="right", vjust="center", size=3.2) +
      geom_text(aes(label="2", x=30.5, y= 350), data=subset(df_ef_subset, pol=="grav"),
                color="gray75", hjust="right", vjust="center", size=3.2) +
      geom_text(aes(label="3", x=30.5, y= 140), data=subset(df_ef_subset, pol=="grav"),
                color="gray75", hjust="right", vjust="center", size=3.2) +
      # add data
      geom_point(size=2, alpha=0.7) +
      # format plot
      coord_cartesian(xlim=c(4,30)) + 
      scale_x_continuous(breaks=seq(5,25,10)) +
      geom_blank(data=df_dummy) + 
      xlab("Moisture content (%)") +
      ylab(expression(Emission ~ factor ~ "(" * mg ~ MJ[delivered]^-1*")")) + 
      scale_color_manual(values = c(pink2, gold, teal1, teal2, purple, pink1, orange, teal3)) +
      # label panels
      geom_text(aes(label="CO",           x= 4, y=13000), data=subset(df_ef_subset, pol=="co"),
                color="black", hjust="left", vjust="top", size=3.5) +
      geom_text(aes(label="PM[2.5]",      x= 4, y= 1100), data=subset(df_ef_subset, pol=="grav"),
                color="black", hjust="left", vjust="bottom", size=3.5, parse=TRUE) +
      geom_text(aes(label="EC",           x=30, y=  225), data=subset(df_ef_subset, pol=="ec"),
                color="black", hjust="right", vjust="top", size=3.5) +
      geom_text(aes(label="OC",           x= 4, y=  700), data=subset(df_ef_subset, pol=="oc"),
                color="black", hjust="left", vjust="top", size=3.5) +
      geom_text(aes(label="CH[4]",        x= 4, y= 1050), data=subset(df_ef_subset, pol=="ch4"),
                color="black", hjust="left", vjust="top", size=3.5, parse=TRUE) +
      geom_text(aes(label="Formaldehyde", x= 4, y=  290), data=subset(df_ef_subset, pol=="formaldehyde"),
                color="black", hjust="left", vjust="top", size=3.5) +
      geom_text(aes(label="Acetaldehyde", x= 4, y=  110), data=subset(df_ef_subset, pol=="acetaldehyde"),
                color="black", hjust="left", vjust="top", size=3.5) +
      geom_text(aes(label="Benzene",      x= 4, y=   62), data=subset(df_ef_subset, pol=="benzene"),
                color="black", hjust="left", vjust="top", size=3.5) +
      # format plot
      theme(aspect.ratio=1,
            panel.border     = element_rect(fill=NA),
            panel.background = element_rect(fill="white"),
            strip.background = element_blank(),
            strip.text.x = element_blank(),
            text       = element_text(size=10, color="black"), 
            axis.text  = element_text(size=10, color="black"),
            axis.title = element_text(size=10, color="black"),
            axis.ticks = element_line(color="black"),
            legend.position = "none")
  
  ggsave(filename="../figures/main_fig.svg", plot=last_plot(), device="svg", width=19/2.54, height=9/2.54)
  ggsave(filename="../figures/main_fig.pdf", plot=last_plot(), device="pdf", width=19/2.54, height=9/2.54)
```

```{r, fig.width=6.5, fig.height=8.25, fig.align='center'}
  df_ef_subset <- dplyr::filter(df_ef, 
                      pol %in% c("acetaldehyde",     "acetone",          "acrolein",
                                 "benzaldehyde",     "butanone",         "butyraldehyde",
                                 "crotonaldehyde",   "formaldehyde",     "hexaldehyde",
                                 "isovaleraldehyde", "m_p_tolualdehyde", "methacrolein",
                                 "o_tolualdehyde",   "propionaldehyde",  "valeraldehyde")) %>%
             dplyr::mutate(pol  = ifelse(pol=="o_tolualdehyde","o-tolualdehyde",pol),
                           pol  = ifelse(pol=="m_p_tolualdehyde","m+p-tolualdehyde",pol))

  # dummy data used to ensure that y-axis goes to zero on all panels except CO and CH4
  df_dummy <- data.frame(pol    = unique(df_ef_subset$pol),
                         mc_dry = c(5),
                         ef     = c(0),
                         type   = c("Milled"))

  ggplot(df_ef_subset, aes(x=mc_dry, y=1000*ef, shape=type)) +
         geom_point(size=3, alpha=0.7, color="black") +
         geom_blank(data=df_dummy) + 
         facet_wrap(~pol, scales = "free_y", ncol = 3) +
         
         # format plot
         coord_cartesian(xlim=c(4,30)) + 
         scale_x_continuous(breaks=seq(5,25,10)) +
         xlab("Moisture content (%)") +
         ylab(expression(Emission ~ factor ~ "(" * mg ~ MJ[delivered]^-1*")")) + 
         labs(shape = "Fuel shape") + 
         theme(aspect.ratio=1,
               panel.border     = element_rect(fill=NA),
               panel.background = element_rect(fill="white"),
               strip.background = element_rect(fill="gray95", color="black"),
               strip.text.x = element_text(size=10, color="black"),
               panel.grid.major.x = element_line(color="gray95"),
               panel.grid.minor.x = element_line(color="gray95"),
               panel.grid.major.y = element_line(color="gray95"),
               panel.grid.minor.y = element_line(color="gray95"),
               axis.text    = element_text(size=10, color="black"),
               axis.title   = element_text(size=10, color="black"),
               axis.ticks   = element_line(color="black"),
               legend.text  = element_text(size=10, color='black'),
               legend.title = element_text(size=10, color='black'),
               legend.key   = element_blank())

  ggsave(filename="../figures/aldehydes_energy.pdf", plot=last_plot(), device="pdf", width=6.5, height=8.25)
```

```{r, fig.width=6.5, fig.height=4.8, fig.align='center'}

  df_ef_subset <- dplyr::filter(df_ef, 
                    pol %in% c("benzene", "toluene", "ethylbenzene",
                               "m+p-xylene", "o-xylene")) %>%
                  dplyr::mutate(pol = factor(pol,
                                             levels = c("benzene","toluene",
                                                        "ethylbenzene",
                                                        "m+p-xylene","o-xylene")))

  ggplot(df_ef_subset, aes(x=mc_dry, y=1000*ef, shape=type)) +
         geom_point(size=3, alpha=0.7, color="black") +
         facet_wrap(~pol, scales="free_y", ncol=3) +
    
         # format plot
         coord_cartesian(xlim=c(4,30)) + 
         scale_x_continuous(breaks=seq(5,25,10)) +
         xlab("Moisture content (%)") +
         ylab(expression(Emission ~ factor ~ "(" * mg ~ MJ[delivered]^-1*")")) + 
         labs(shape = "Fuel shape") + 
              theme(aspect.ratio=1,
              panel.border     = element_rect(fill=NA),
              panel.background = element_rect(fill="white"),
              strip.background = element_rect(fill="gray95", color="black"),
              strip.text.x = element_text(size=10, color="black"),
              panel.grid.major.x = element_line(color="gray95"),
              panel.grid.minor.x = element_line(color="gray95"),
              panel.grid.major.y = element_line(color="gray95"),
              panel.grid.minor.y = element_line(color="gray95"),
              axis.text    = element_text(size=10, color="black"),
              axis.title   = element_text(size=10, color="black"),
              axis.ticks   = element_line(color="black"),
              legend.text  = element_text(size=10, color='black'),
              legend.title = element_text(size=10, color='black'),
              legend.key   = element_blank(),
              legend.position = "none")
  
  ggsave(filename="../figures/voc_energy.pdf", plot=last_plot(), device="pdf", width=6.5, height=4.8)
```

```{r, fig.width=3.15, fig.height=2.8, fig.align='center'}

  ggplot(dplyr::filter(df_ef, pol=="ultrafines"), 
         aes(x=mc_dry, y=ef, shape=type)) +
      geom_point(size=3, alpha=0.7) +
      coord_cartesian(xlim=c(4,30), ylim=c(0,7.2e15)) + # 
      scale_x_continuous(breaks=seq(5,30,10)) + 
      xlab("Moisture content (%)") + 
      ylab(expression(Ultrafine ~ particles ~ "(" * "#" ~ MJ[delivered]^-1*")")) + 
      labs(shape = "Fuel shape") + 
      theme(aspect.ratio=1,
            panel.border     = element_rect(fill=NA),
            panel.background = element_rect(fill='white'),
            axis.text  = element_text(size=10, color='black'),
            axis.title = element_text(size=10, color='black'),
            axis.ticks = element_line(color='black'),
            legend.text  = element_text(size=10, color='black'),
            legend.title = element_text(size=10, color='black'),
            legend.key   = element_blank(),
            legend.box.background = element_rect(color="black", size=0.6),
            legend.position = c(0.80,0.205)) 

  ggsave(filename="../figures/ufp_energy.pdf", plot=last_plot(), device="pdf", width=3.15, height=2.8)
```

# Compare emission factors

### Between different fuel moisture levels and shapes

```{r}
  TukeyHSD(aov(ef ~ fuel_mc_shape, dplyr::filter(df_ef, pol=="co")))
```

```{r}
  TukeyHSD(aov(ef ~ fuel_mc_shape, dplyr::filter(df_ef, pol=="grav")))
```

```{r}
  TukeyHSD(aov(ef ~ fuel_mc_shape, dplyr::filter(df_ef, pol=="ec")))
```

```{r}
  TukeyHSD(aov(ef ~ fuel_mc_shape, dplyr::filter(df_ef, pol=="oc")))
```

```{r}
  TukeyHSD(aov(ef ~ fuel_mc_shape, dplyr::filter(df_ef, pol=="ultrafines")))
```

```{r}
  TukeyHSD(aov(ef ~ fuel_mc_shape, dplyr::filter(df_ef, pol=="ch4")))
```

```{r}
  TukeyHSD(aov(ef ~ fuel_mc_shape, dplyr::filter(df_ef, pol=="formaldehyde")))
```

```{r}
  TukeyHSD(aov(ef ~ fuel_mc_shape, dplyr::filter(df_ef, pol=="acetaldehyde")))
```

```{r}
  TukeyHSD(aov(ef ~ fuel_mc_shape, dplyr::filter(df_ef, pol=="benzene")))
```

### Between different fuel moisture levels

```{r}
  TukeyHSD(aov(ef ~ mc_level, dplyr::filter(df_ef, pol=="co")))
```

```{r}
  TukeyHSD(aov(ef ~ mc_level, dplyr::filter(df_ef, pol=="grav")))
```

```{r}
  TukeyHSD(aov(ef ~ mc_level, dplyr::filter(df_ef, pol=="ec")))
```

```{r}
  TukeyHSD(aov(ef ~ mc_level, dplyr::filter(df_ef, pol=="oc")))
```

```{r}
  TukeyHSD(aov(ef ~ mc_level, dplyr::filter(df_ef, pol=="ultrafines")))
```

```{r}
  TukeyHSD(aov(ef ~ mc_level, dplyr::filter(df_ef, pol=="ch4")))
```

```{r}
  TukeyHSD(aov(ef ~ mc_level, dplyr::filter(df_ef, pol=="formaldehyde")))
```

```{r}
  TukeyHSD(aov(ef ~ mc_level, dplyr::filter(df_ef, pol=="acetaldehyde")))
```

```{r}
  TukeyHSD(aov(ef ~ mc_level, dplyr::filter(df_ef, pol=="benzene")))
```

# Summarize EFs by fuel moisture level

```{r}
  df_table <- dplyr::filter(df_ef, pol %in% c("co","grav","ec","oc","ch4",
                                               "acetaldehyde","formaldehyde","benzene")) %>%
              dplyr::mutate(pol = factor(pol, levels=c("co","grav","ec","oc","ch4",
                                                       "acetaldehyde","formaldehyde","benzene"))) %>%
              group_by(pol, mc_level) %>%
              summarise(mean = mean(1000 * ef),
                        sd   = sd(1000 * ef),
                        min  = min(1000 * ef),
                        max  = max(1000 * ef))
```

```{r, echo=FALSE}
  kable(df_table, format="markdown", digits=1,
        col.names=c("Pollutant","Moisture level","Mean (mg/MJd)","SD (mg/MJd)","Min (mg/MJd)","Max (mg/MJd"))
```

# Compare to voluntary performance targets

```{r}
  df_co <- dplyr::filter(df_ef, pol=="co") %>%
           group_by(mc_level) %>%
           dplyr::summarise(mean  = mean(ef),
                            sd    = sd(ef),
                            n     = length(ef)) %>%
           dplyr::mutate(ci_lower = mean - (qt(.95,df=n-1)*sd/sqrt(n)),
                         ci_upper = mean + (qt(.95,df=n-1)*sd/sqrt(n)))

  df_pm <- dplyr::filter(df_ef, pol=="grav") %>%
           group_by(mc_level) %>%
           dplyr::summarise(mean  = mean(1000 * ef),
                            sd    = sd(1000 * ef),
                            n     = length(ef)) %>%
           dplyr::mutate(ci_lower = mean - (qt(.95,df=n-1)*sd/sqrt(n)),
                         ci_upper = mean + (qt(.95,df=n-1)*sd/sqrt(n)))
```

The upper limit on the 90% confidence interval for CO emissions was: 
* `r round(dplyr::filter(df_co, mc_level==high)$ci_upper, digits=1)` g/MJ~d~ with the high-moisture fuel.  
* `r round(dplyr::filter(df_co, mc_level==medium)$ci_upper, digits=1)` g/MJ~d~ with the medium-moisture fuel.  
* `r round(dplyr::filter(df_co, mc_level==low)$ci_upper, digits=1)` g/MJ~d~ with the low-moisture fuel.  

The upper limit on the 90% confidence interval for PM~2.5~ emissions was: 
* `r round(dplyr::filter(df_pm, mc_level==high)$ci_upper)` g/MJ~d~ with the high-moisture fuel.  
* `r round(dplyr::filter(df_pm, mc_level==medium)$ci_upper)` g/MJ~d~ with the medium-moisture fuel.  
* `r round(dplyr::filter(df_pm, mc_level==low)$ci_upper)` g/MJ~d~ with the low-moisture fuel.  