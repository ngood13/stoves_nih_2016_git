---
title: "Energy applied"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
  library(knitr)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  source("../r_scripts/R_functions.R")
```

# Load

* water (pot) temperature and emissions

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  emissions_long <- readRDS("../r_files/emissions_long.RDS")
  temp_merged <- readRDS("../r_files/temp_merged.RDS")
  mean_mc <- readRDS("../r_files/mean_mc_df.RDS")
```

* constants

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}

  c_water <- readRDS("../r_files/c_water.RDS")
  
  hfg_water <- readRDS("../r_files/hfg_water.RDS")
```

* metadata

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  samples <- readRDS("../r_files/samples.RDS")
  test_times <- readRDS("../r_files/test_times.RDS")
  mc_test_log <- readRDS("../r_files/mc_test_log.RDS")

```

# Test timestamps

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  times <- dplyr::filter(test_times, var == "set_1" | var == "end") %>%
           tidyr::spread(var, value) %>%
           dplyr::rename(start = set_1) %>%
           dplyr::filter(!grepl("^BG", id))
```

# Energy

## joules applied


* pot mass

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
pot_weights <- select(mc_test_log, wgt_pot_a, wgt_on_1, wgt_off_1, id, date) %>%
               mutate(delta_m = wgt_on_1 - wgt_off_1, m_start = wgt_on_1 - wgt_pot_a) %>%
               filter(!is.na(wgt_on_1))
  

```

* extract temperature for periods of interest

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  temp_merged <- mutate(temp_merged, time = time + 3600)  

  e_temp <- dplyr::filter(temp_merged, grepl("stove", loc))


  #e_temp <- filter_temp(times, e_temp)
```

* temperature change

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  t_range <- dplyr::group_by(e_temp, id) %>%
            dplyr::summarise(t_min = min(t_oc, na.rm = TRUE),  
                             t_max = max(t_oc, na.rm = TRUE),
                             t_med = median(t_oc))

saveRDS(t_range, file = "../r_files/t_range.RDS")
```

```{r}
# plot temps
 mean_mc <- readRDS("../r_files/mean_mc_df.RDS")

 temp_plot <- left_join(t_range, mean_mc, by = "id")
 
 ggplot(data = temp_plot, aes(x = mean_mc)) +
   geom_point(aes(y = t_max), color = "darkblue") +
   #geom_point(aes(y = t_min, color= "blue")) +
   theme_bw() +
   labs(x = "Mean Moisture Content (%)", y = "Maximum Temperature (C)")
```


* merge data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  e_data <- dplyr::left_join(pot_weights, times, by = "id") %>%
            dplyr::left_join(t_range, by = "id")%>%
            dplyr::select(-date.y) %>%
            dplyr::rename(date = date.x)
```

* energy applied

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  e_data <- dplyr::mutate(e_data,
                          mass_evap = delta_m,
                          mass_h2o = wgt_on_1 - wgt_pot_a,
                          dt = t_max - t_min,
                          j_heat = mass_h2o * c_water * dt, # g * J/(g.oC) * oC
                          j_vap = mass_evap * hfg_water,
                          joules = j_heat + j_vap)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  kable(dplyr::slice(e_data, 1:5),
        align = 'c', caption = "Energy Numbers")
```

* energy applied per test

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  energy <- dplyr::select(e_data, id, joules) %>%
            dplyr::group_by(id) %>%
            dplyr::summarise(joules = sum(joules, na.rm = TRUE))
```

# Plots

## temperature (id & loc)

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=12, fig.height=50}
  ggplot(dplyr::filter(e_temp, loc != "flue"),
         aes(datetime, t_oc, color = loc)) +
         geom_line() +
         geom_point() +
         facet_wrap(~id, ncol = 3, scales = "free") +
         theme_minimal() +
         theme(legend.position = "top") +
         ylab("degress celsius") +
         theme(legend.position = "top")
```

## temperature (id & rep)




# Plot EFs for Energy

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
 ef_energy <- dplyr::left_join(dplyr::filter(emissions_long, metric == "mass_emitted", !grepl("^BG|G", id)), 
                                       energy,
                                       by = "id" ) %>%
                      dplyr::mutate(mass_pol_energy = ((value * 1e-6) / (joules *1e-6))) %>%
              left_join(mean_mc, by = "id")
```

## energy delivered


```{r}
p_data <- dplyr::left_join(ef_energy,
                             dplyr::select(samples, id, type, mc_level),
                                           by = "id") %>%
            dplyr::filter(type != "bg") %>%
            dplyr::mutate(mc_level = forcats::fct_relevel(mc_level, "low",
                                                                    "med",
                                                                    "high")) %>%
            dplyr::mutate(id = factor(id, levels = c("FL1", "FL2", "FL3", "FL4", "FM1", "FM2",
                                                     "FM3", "FM4", "FH1", "FH2", "FH3", "FH4",
                                                     "LL1", "LL2", "LL3", "LL4", "LM1", "LM2",
                                                     "LM3", "LM4", "LH1", "LH2", "LH3",
                                                     "LH4")))
mj_delivered <- p_data %>%
                select(joules, id, type, mc_level, mean_mc) %>%
                mutate(joules = joules * 10^-6) %>%
                distinct()

ggplot(mj_delivered, aes(x = mean_mc, y = joules, color = mc_level)) +
  geom_point(size = 3.5)
```

```{r}
temps <- group_by(e_temp, id) %>%
            dplyr::summarise(t_mean = mean(t_oc, na.rm = TRUE))

grav_energy <- p_data %>%
          dplyr::filter(pol %in% "grav") %>%
          dplyr::select(-inst) %>%
          left_join(temps, by = "id")

ggplot(grav_energy, aes(x = mean_mc, y = mass_pol_energy, color = mc_level, shape = type)) +
  geom_point(size = 3.5) +
  theme_bw() +
  theme(text = element_text(size=15)) +
  ylab("EF [g pol / MJ Delivered]") + xlab("Moisture Content (%)") +
  #facet_wrap(~pol, scales = "free") +
  scale_color_manual(values = c("darkorange", "darkorchid3", "blue")) +
  scale_x_continuous(breaks = c(5, 15, 25)) +
  labs(color = "MC Level", shape = "Fuel Shape")
```

```{r}

gas_energy <- p_data %>%
          dplyr::filter(pol %in% c("co", "co2", "ch4")) %>%
          dplyr::select(-inst) %>%
          left_join(temps, by = "id")

ggplot(gas_energy, aes(x = mean_mc, y = mass_pol_energy, color = mc_level, shape = type)) +
  geom_point(size = 3.5) +
  theme_bw() +
  theme(text = element_text(size=15)) +
  ylab("EF [g pol / MJ Delivered]") + xlab("Moisture Content (%)") +
  facet_wrap(~pol, scales = "free", ncol = 2) +
  scale_color_manual(values = c("darkorange", "darkorchid3", "blue")) +
  scale_x_continuous(breaks = c(5, 15, 25)) +
  labs(color = "MC Level", shape = "Fuel Shape")
```

```{r}

voc_energy <- p_data %>%
          dplyr::filter(pol %in% c("benzene", "toluene", "ethylbenzene")) %>%
          dplyr::select(-inst) %>%
          left_join(temps, by = "id")

ggplot(voc_energy, aes(x = mean_mc, y = mass_pol_energy, color = mc_level, shape = type)) +
  geom_point(size = 3.5) +
  theme_bw() +
  theme(text = element_text(size=15)) +
  ylab("EF [g pol / MJ Delivered]") + xlab("Moisture Content (%)") +
  facet_wrap(~pol, scales = "free", ncol = 2) +
  scale_color_manual(values = c("darkorange", "darkorchid3", "blue")) +
  scale_x_continuous(breaks = c(5, 15, 25)) +
  labs(color = "MC Level", shape = "Fuel Shape")
```

```{r}

carbonyl_energy <- p_data %>%
          dplyr::filter(pol %in% c("formaldehyde", "acetaldehyde")) %>%
          dplyr::select(-inst) %>%
          left_join(temps, by = "id")

ggplot(carbonyl_energy, aes(x = mean_mc, y = mass_pol_energy, color = mc_level, shape = type)) +
  geom_point(size = 3.5) +
  theme_bw() +
  theme(text = element_text(size=15)) +
  ylab("EF [g pol / MJ Delivered]") + xlab("Moisture Content (%)") +
  facet_wrap(~pol, scales = "free", ncol = 2) +
  scale_color_manual(values = c("darkorange", "darkorchid3", "blue")) +
  scale_x_continuous(breaks = c(5, 15, 25)) +
  labs(color = "MC Level", shape = "Fuel Shape")
```

```{r}

ecoc_energy <- p_data %>%
          dplyr::filter(pol %in% c("ec", "oc")) %>%
          dplyr::select(-inst) %>%
          left_join(temps, by = "id")

ggplot(ecoc_energy, aes(x = mean_mc, y = mass_pol_energy, color = mc_level, shape = type)) +
  geom_point(size = 3.5) +
  theme_bw() +
  theme(text = element_text(size=15)) +
  ylab("EF [g pol / MJ Delivered]") + xlab("Moisture Content (%)") +
  facet_wrap(~pol, scales = "free", ncol = 2) +
  scale_color_manual(values = c("darkorange", "darkorchid3", "blue")) +
  scale_x_continuous(breaks = c(5, 15, 25)) +
  labs(color = "MC Level", shape = "Fuel Shape")
```