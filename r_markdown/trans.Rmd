---
title: "trans"
author: "Nicholas Good"
date: "11/21/2016"
output: html_document
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  source("../r_scripts/R_tidy.R")
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  samples <- readRDS("../r_files/samples.RDS")
  filter_times <- readRDS("../r_files/filter_times.RDS")
  filter_flows <- readRDS("../r_files/filter_flows.RDS")
```

## Get mean flows and turn flowrate/ duration into total volume of air through filter

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  filter_vol <- dplyr::group_by(filter_flows, id, colour) %>%
                dplyr::summarise(mean_flow = mean(value) * 60) %>%
                dplyr::filter(colour == "white")

  filter_dur <- dplyr::filter(filter_times, color =="white") %>%
                dplyr::group_by(id) %>%
                tidyr::spread(type, value)
  
  filter_dur <- dplyr::mutate(filter_dur, dur = end - start)
  
  filter_dur_1 <- dplyr::select(filter_dur, id, dur)
  
  filter_vol_1 <- dplyr::select(filter_vol, id, mean_flow)
  
  filter_cc_merged <- dplyr::left_join(filter_dur_1, filter_vol_1)
  
  filter_cc_merged <- dplyr::mutate(filter_cc_merged, total_cc = dur * mean_flow)
```


## Load transmissometer data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  trans <- readRDS("../r_files/trans.RDS")
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  colnames(trans)
```

## Load filter id numbers

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  grav <- readRDS("../r_files/grav.RDS") 

  filter_info <- dplyr::select(grav, id, id_filter) %>%
                 dplyr::rename(filter_id = id_filter)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  head(filter_info, 2)
```

## Merge data with id

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  trans_merged <- dplyr::left_join(trans, filter_info, "filter_id") %>%
                  dplyr::mutate(id = as.factor(id))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  head(trans_merged, 2)
```

## Filters without matches - NONE FOUND FOR MC STUDY

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  # trans_no_match <- dplyr::anti_join(dplyr::select(filter_info, filter_id),
  #                                    dplyr::select(trans, filter_id),
  #                                    by = "filter_id")
  # 
  # saveRDS(trans_no_match, file = "../r_files/trans_no_match.RDS")
```

## Melt

Make longer and remove missing values *THIS CHUNK NOW WORKS BUT NOT SURE WHAT IT DOES?

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  trans_merged <- dplyr::filter(trans_merged, !is.na(test_id)) %>%
                  dplyr::filter(!grepl("Pilot", test_id)) %>%
                  tidyr::gather_("var", "val", grep("^*ir*|^*uv*", colnames(trans_merged), value = TRUE)) %>%
                  dplyr::mutate(lamda = sub("_.*", "", var)) %>%
                  dplyr::mutate(pos = sub(".*_", "", var)) %>%
                  dplyr::mutate(type = gsub(".*_(.*)_.*","\\1", var))
```

#Recalculate attenuations

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  trans_merged <- dplyr::mutate(trans_merged, uv_atn_pre = 100 * log(blankuv/sampleuv)) %>%
                  dplyr::mutate(ir_atn_pre = 100 * log(blankir/sampleir)) %>%
                  dplyr::mutate(uv_atn_post = 100 * log(as.numeric(post_blankuv)/as.numeric(post_sampleuv))) %>%
                  dplyr::mutate(ir_atn_post = 100 * log(as.numeric(post_blankir)/as.numeric(post_sampleir)))
```

## Adjust attenuations by dividing by total volume of air through filter

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  trans_merged <- dplyr::rename(trans_merged, id = val)

  trans_merged <- dplyr::left_join(trans_merged, filter_cc_merged)
  
  trans_merged <- dplyr::mutate(trans_merged, delta_ir_over_vol = (ir_atn_post - ir_atn_pre)/(total_cc/(10^6))) %>%
                  dplyr::mutate(delta_uv_over_vol = (uv_atn_post - uv_atn_pre)/(total_cc/(10^6)))
```


## QC

Load notes

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  notes <- readRDS("../r_files/notes.RDS")

  notes <- dplyr::filter(notes, grepl("trans|all", notes$inst) == TRUE)
```

Set one flag per test

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  flags <- dplyr::select(notes, id, qc) %>%
           dplyr::group_by(id) %>%
           dplyr::arrange(qc) %>%
           dplyr::summarise(qc = first(qc))
```

Merge with data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  trans_merged <- dplyr::left_join(trans_merged, flags, by = "id") %>%
                  dplyr::mutate(id = as.factor(id)) %>%
                  dplyr::mutate(qc = as.factor(ifelse(is.na(qc), "ok", as.character(qc))))
```

Additional bad tests

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  # trans_merged$qc[trans_merged$id == ""] <- "bad"
```

## Save merged file

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  saveRDS(trans_merged, file = "../r_files/trans_merged.RDS")
```

## Data summary

Transmissometer was was collected for `r length(unique(trans_merged$id))` experiments. There is no transmissometer data for tests: `r setdiff(as.character(samples$id), as.character(trans_merged$id))`.

#plots

```{r}
  ggplot(trans_merged, aes(id, uv_atn_pre)) +
  geom_point() +
  theme_minimal() +
  ylab("Pre Test UV Attenuation") +
  theme(text = element_text(size=8), axis.text.x = element_text(angle=-45, hjust=1))
```

```{r}
  trans_no_err <- dplyr::filter(trans_merged, !grepl("^ERR60", atn_uv_2))

  ggplot(trans_no_err, aes(id, uv_atn_post)) +
    geom_point() +
    theme_minimal() +
    ylab("Post Test UV Attenuation") +
    theme(text = element_text(size=8), axis.text.x = element_text(angle=-45, hjust=1))
```

#Percentage change in UV: (uv_atn_post/uv_atn_pre)/uv_atn_pre

```{r}
  trans_no_err <- dplyr::mutate(trans_no_err, delta_uv_atn = (uv_atn_post - uv_atn_pre)/uv_atn_pre)

  ggplot(trans_no_err, aes(id, delta_uv_atn)) +
    geom_point() +
    theme_minimal() +
    ylab("Post Test UV Attenuation") +
    theme(text = element_text(size=8), axis.text.x = element_text(angle=-45, hjust=1))
```

# Plot delta uv divided by total m^3 of air through filter

```{r}
    ggplot(trans_no_err, aes(id, delta_uv_over_vol)) +
    geom_point() +
    theme_minimal() +
    ylab("Post Test UV Attenuation") +
    theme(text = element_text(size=8), axis.text.x = element_text(angle=45, hjust=.5))
```

Note: in pre UV plot: all 5 filters around the 35 mark are from the same batch of filters which were trans'd on a later date than the original filters; all 6 filters around the 11 mark are from a batch of filters which were trans'd on a different date from originals; ERR60's (too dark) have been removed for plot visuals
