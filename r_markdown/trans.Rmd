---
title: "Transmissometer"
author: "Nicholas Good and Jessica Tryner"
date: "January 9, 2019"
output: html_document
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  source("../r_scripts/R_tidy.R")
```

# Load data

Test metadata:

```{r}
  samples <- readRDS("../r_files/samples.RDS")
  notes   <- readRDS("../r_files/notes.RDS")
```

Transmissometer data:

```{r}
  trans <- readRDS("../r_files/trans.RDS")
```

Gravimetric PM~2.5~ data:

```{r}
  grav_merged <- readRDS("../r_files/grav_merged.RDS")
```

# Organize and combine

Calculate total volume of airflow through each filter. 

```{r}
  df_grav <- dplyr::select(grav_merged, id, id_filter, flow, dur, d_mass) %>%
             dplyr::rename(filter_id = id_filter) %>%
             dplyr::mutate(vol_m3 = (flow / 1000) * dur)
```

Check to make sure that there are transmissometer data for all filters.

```{r}
  df_missing <- dplyr::anti_join(df_grav, 
                                 dplyr::select(trans, filter_id),
                                 by=c("filter_id"))
```

Notes.

```{r}
  df_flags <- dplyr::filter(notes, grepl("trans|all", inst) == TRUE) %>%
              dplyr::select(id, qc) %>%
              dplyr::group_by(id) %>%
              dplyr::arrange(qc) %>%
              dplyr::summarise(qc = first(qc))
```

Combine transmissometer data with filter data.

```{r, warning=FALSE}
  df_trans <- dplyr::left_join(df_grav, trans, by=c("filter_id")) %>%
              dplyr::left_join(df_flags, by=c("id")) %>%
              dplyr::select(-description, -test_id)  %>%
              dplyr::mutate(post_blankir  = as.numeric(post_blankir),
                            post_sampleir = as.numeric(post_sampleir),
                            post_blankuv  = as.numeric(post_blankuv),
                            post_sampleuv = as.numeric(post_sampleuv),
                            qc = ifelse(is.na(qc), "ok", as.character(qc)),
                            id = as.factor(id),
                            id = forcats::fct_relevel(id,"G1","G2","G3","G4","G5","G6","G7","G8",
                                                         "BG1","BG2","BG3","BG4","BG5","BG6","BG7","BG8",
                                                         "LL1","LL2","LL3","LL4","FL1","FL2","FL3","FL4",
                                                         "LM1","LM2","LM3","LM4","FM1","FM2","FM3","FM4",
                                                         "LH1","LH2","LH3","LH4","FH1","FH2","FH3","FH4"))
```

# Recalculate attenuations

```{r}
  df_trans <- dplyr::select(df_trans, -atn_ir, -atn_uv, -atn_ir_2, -atn_uv_2) %>%
              dplyr::mutate(uv_atn_pre   = 100 * log(blankuv/sampleuv),
                            ir_atn_pre   = 100 * log(blankir/sampleir),
                            uv_atn_post  = 100 * log(post_blankuv/post_sampleuv),
                            ir_atn_post  = 100 * log(post_blankir/post_sampleir),
                            delta_uv_atn = (uv_atn_post - uv_atn_pre)/uv_atn_pre)
```

Adjust attenuations by dividing by total volume of air through filter

```{r}
  df_trans <- df_trans %>%
              dplyr::mutate(delta_ir_over_vol = (ir_atn_post - ir_atn_pre) / vol_m3,
                            delta_uv_over_vol = (uv_atn_post - uv_atn_pre) / vol_m3)
```

# Save

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  saveRDS(df_trans, file = "../r_files/trans_merged.RDS")
```

Transmissometer was was collected for `r length(unique(df_trans$id))` experiments. There is no transmissometer data for tests: `r setdiff(as.character(samples$id), as.character(df_trans$id))`.

# Plot data

Select just UV attenuation data: 

```{r}
  df_atn_uv <- dplyr::select(df_trans, id, uv_atn_pre, uv_atn_post) %>%
               dplyr::rename(`Pre-test`  = uv_atn_pre,
                             `Post-test` = uv_atn_post) %>%
               tidyr::gather("type", "uv_atn", c(`Pre-test`, `Post-test`)) 
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=8, fig.height=3.15, fig.align='center'}

  ggplot(df_atn_uv, aes(x=id, y=uv_atn, shape=type)) +
    geom_point(size=3, color="black") +
      scale_shape_manual(values = c(19,1)) +
    scale_y_continuous(breaks=seq(0,500,100)) + 
    xlab("Filter ID") + 
    ylab("UV attenuation") + 
    labs(shape=NULL) + 
    theme(aspect.ratio = 0.35,
          panel.border = element_rect(fill=NA, color="black"),
          panel.background = element_rect(fill="white"),
          panel.grid.major = element_line(color="gray95"),
          panel.grid.minor = element_line(color="gray95"),
          axis.ticks  = element_line(color="black"),
          axis.text.x = element_text(size=6, color="black"),
          axis.text.y = element_text(size=9, color="black"),
          axis.title  = element_text(size=9, color="black"),
          legend.text  = element_text(size=10, color='black'),
          legend.key   = element_blank(),
          legend.position = c(0.07,0.85))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=8, fig.height=3.15, fig.align='center'}

  ggplot(df_trans, aes(x=id, y=delta_uv_atn)) +
    geom_point(size = 3) +
    scale_y_continuous(breaks=seq(0,100,10)) + 
    xlab("Filter ID") + 
    ylab("Change in UV attenuation (%)") +
    theme(aspect.ratio = 0.35,
          panel.border = element_rect(fill=NA, color="black"),
          panel.background = element_rect(fill="white"),
          panel.grid.major = element_line(color="gray95"),
          panel.grid.minor = element_line(color="gray95"),
          axis.ticks  = element_line(color="black"),
          axis.text.x = element_text(size=6, color="black"),
          axis.text.y = element_text(size=9, color="black"),
          axis.title  = element_text(size=9, color="black"),
          legend.position = c(0.1,0.8))
```

### Plot delta uv divided by total m^3 of air through filter

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=8, fig.height=3.15, fig.align='center'}

  ggplot(df_trans, aes(id, delta_uv_over_vol)) +
    geom_point(size = 3) +
    scale_y_continuous(breaks=seq(0,3000,500)) + 
    xlab("Filter ID") + 
    ylab("Change in UV attenuation per m3 of air") +
    theme(aspect.ratio = 0.35,
          panel.border = element_rect(fill=NA, color="black"),
          panel.background = element_rect(fill="white"),
          panel.grid.major = element_line(color="gray95"),
          panel.grid.minor = element_line(color="gray95"),
          axis.ticks  = element_line(color="black"),
          axis.text.x = element_text(size=6, color="black"),
          axis.text.y = element_text(size=9, color="black"),
          axis.title  = element_text(size=9, color="black"),
          legend.position = c(0.1,0.8))
```

Note: in pre UV plot: all 5 filters around the 35 mark are from the same batch of filters which were trans'd on a later date than the original filters; all 6 filters around the 11 mark are from a batch of filters which were trans'd on a different date from originals; ERR60's (too dark) have been removed for plot visuals