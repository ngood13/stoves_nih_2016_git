---
title: "trans"
author: "Nicholas Good"
date: "11/21/2016"
output: html_document
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  source("../r_scripts/R_tidy.R")
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  load("../r_files/samples.Rda")    # sample info
```

## Load transmissometer data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  load("../r_files/trans.Rda")
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  colnames(trans)
```

## Load filter id numbers
```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  load("../r_files/grav.Rda") 
  filter_info <- dplyr::select(grav, id, id_filter)
```


```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  head(filter_info, 2)
```

## Merge data with id
```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  trans_merged <- left_join(trans, filter_info, "id_filter") 
  trans_merged$id <- as.factor(trans_merged$id)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  head(trans_merged, 2)
```

## Melt

Make longer and remove missing values

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  trans_merged_ <- dplyr::filter(trans_merged, grepl("^[0-9]|^G[0-9]", id) == TRUE) %>%
  tidyr::gather_("var", "val", grep("^ir|^uv", colnames(trans_merged), value = TRUE)) %>%
  dplyr::mutate(lamda = sub("_.*", "", var)) %>%
  dplyr::mutate(pos = sub(".*_", "", var)) %>%
  dplyr::mutate(type = gsub(".*_(.*)_.*","\\1", var))
```

## Save merged file

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  save(trans_merged, file = "../r_files/trans_merged.Rda")
```

## Data summary

The $transmissometer$ measured during `r length(unique(trans_merged$id))` experiments between `r min(trans_merged$date, na.rm = TRUE)` and `r max(trans_merged$date, na.rm = TRUE)`. There is no $trans$ data for tests: `r setdiff(levels(samples$id), levels(trans_merged$id))`.

