---
title: "trans"
author: "Nicholas Good"
date: "11/21/2016"
output: html_document
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  source("../r_scripts/R_tidy.R")
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  samples <- readRDS("../r_files/samples.RDS")
```

## Load transmissometer data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  trans <- readRDS("../r_files/trans.RDS")
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  colnames(trans)
```

## Load filter id numbers

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  grav <- readRDS("../r_files/grav.RDS") 

  filter_info <- dplyr::select(grav, id, id_filter) %>%
                 dplyr::rename(filter_id = id_filter)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  head(filter_info, 2)
```

## Merge data with id

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  trans_merged <- dplyr::left_join(trans, filter_info, "filter_id") %>%
                  dplyr::mutate(id = as.factor(id))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  head(trans_merged, 2)
```

## Filters without matches

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  trans_no_match <- dplyr::anti_join(dplyr::select(filter_info, filter_id),
                                     dplyr::select(trans, filter_id),
                                     by = "filter_id")

  saveRDS(trans_no_match, file = "../r_files/trans_no_match.RDS")
```

## Melt

Make longer and remove missing values *THIS CHUNK NOW WORKS BUT NOT SURE WHAT IT DOES?

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  trans_merged <- dplyr::filter(trans_merged, !is.na(test_id)) %>%
                  dplyr::filter(!grepl("Pilot", test_id)) %>%
                  tidyr::gather_("var", "val", grep("^*ir*|^*uv*", colnames(trans_merged), value = TRUE)) %>%
                  dplyr::mutate(lamda = sub("_.*", "", var)) %>%
                  dplyr::mutate(pos = sub(".*_", "", var)) %>%
                  dplyr::mutate(type = gsub(".*_(.*)_.*","\\1", var))
```

## QC

Load notes

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  notes <- readRDS("../r_files/notes.RDS")

  notes <- dplyr::filter(notes, grepl("trans|all", notes$inst) == TRUE)
```

Set one flag per test

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  flags <- dplyr::select(notes, id, qc) %>%
           dplyr::group_by(id) %>%
           dplyr::arrange(qc) %>%
           dplyr::summarise(qc = first(qc))
```

Merge with data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  trans_merged <- dplyr::rename(trans_merged, id = val) %>%
                  dplyr::left_join(flags, by = "id") %>%
                  dplyr::mutate(id = as.factor(id)) %>%
                  dplyr::mutate(qc = as.factor(ifelse(is.na(qc), "ok", as.character(qc))))
```

Additional bad tests

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  # trans_merged$qc[trans_merged$id == ""] <- "bad"
```

## Save merged file

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  saveRDS(trans_merged, file = "../r_files/trans_merged.RDS")
```

## Data summary

Transmissometer was was collected for `r length(unique(trans_merged$id))` experiments. There is no transmissometer data for tests: `r setdiff(as.character(samples$id), as.character(trans_merged$id))`.

#plots

```{r}
  ggplot(trans_merged, aes(id, atn_uv)) +
  geom_point() +
  theme_minimal() +
  ylab("Pre Test UV Attenuation") +
  theme(text = element_text(size=8), axis.text.x = element_text(angle=-45, hjust=1))
```

```{r}
ggplot(trans_merged, aes(id, atn_uv_2)) +
  geom_point() +
  theme_minimal() +
  ylab("Post Test UV Attenuation") +
  theme(text = element_text(size=8), axis.text.x = element_text(angle=-45, hjust=1))
```

Note: in pre UV plot: all 5 filters around the 35 mark are from the same batch of filters which were trans'd on a later date than the original filters; all 6 filters around the 11 mark are from a batch of filters which were trans'd on a different date from original
