---
title: "Startup Emissions Analysis - g pol / startup event "
author: "Kristen Fedak"
date: "July 27, 2017"
output:
  rmarkdown::html_document:
    toc: true
    toc_float: 
      collapsed: false
    theme: yeti
---

# Setup 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

  library(tidyverse)
  library(knitr)

```

# Load and format data
```{r}
  emission_factors <- readRDS(file = "../r_files/emission_factors.RDS")
```

```{r}
 source("../r_scripts/R_functions.R")
```

```{r include = FALSE}
# set variable types from character -> factor
# filter out bad QC data
# set fuel type order by survey result "commonality" of use. 
# create variable mass (g) pollutant emitted per startup event
# create variable average mass (g) of startup material per startup event
# filter out backgrounds and blanks
  ef_su_event <- dplyr::mutate(emission_factors, fuel = factor(fuel),
                                              qc = factor(qc),
                                              pol = factor(pol)) %>%
               dplyr::filter(qc != "bad") %>%
               dplyr::mutate(fuel = forcats::fct_relevel(fuel, "background", "kerosene",
                                                      "plastic_bags", "newspaper",
                                                      "leaves_twigs", "rubber",
                                                      "flipflops", "t_shirts",
                                                      "food_packaging", "wood_shims")) %>%
              dplyr::mutate(masspol_per_startup = (value * 1e-3) / fuel_quant, 
                            #value = ug emitted per test, so *1e-6 to convert to g for unit = mg per event 
                            mass_avg_startup = fuelmass_total / fuel_quant) %>% 
                            #fuelmass = g, so unit = g per startup bundle
              dplyr::filter(!grepl('31|32|33|34|35|36|37|38|39|40|41|42|43', id))
```

# Summary Tables

## Average mass of material burned per startup event
* unit = grams of material 
```{r}
fuel_sum <- dplyr::filter(ef_su_event, pol == 'grav') %>% 
            dplyr::group_by(fuel) %>%
            dplyr::summarize(n_tests = n(),
                             n_events_pertest = round(mean(fuel_quant), 2),
                             min_events_pertest = min(fuel_quant),
                             max_events_pertest = max(fuel_quant),
                             mean_fuelmass_perevent_g = round(mean(mass_avg_startup), 2),
                             mean_duration_pertest = round((mean(dur)*60), 1),
                             min_duration_pertest = round((min(dur)*60), 0),
                             max_duration_pertest = round((max(dur)*60), 0))

knitr::kable(fuel_sum)
```

## Emissions Per startup Event
```{r}
  ef_sum <- ef_su_event %>% dplyr::group_by(fuel, pol) %>%
                            dplyr::summarize(nreps = n(),
                                     mean_ef = round(mean(masspol_per_startup, na.rm = TRUE), 3),
                                     min_ef = round(min(masspol_per_startup, na.rm = TRUE), 3),
                                     max_ef = round(max(masspol_per_startup, na.rm = TRUE), 3))
#mass_ef in units g pol / startup event; one average value per fuel_type.

ef_mean_table <- select(ef_sum, fuel, pol, mean_ef) %>%
                 spread(fuel, mean_ef)
```
* units = mg pollutant emitted per startup event
```{r echo = FALSE}
knitr::kable(ef_mean_table)
```


# Plots

## Overview: All pollutants
```{r fig.width = 15, fig.height=15}
ggplot(ef_su_event, aes(fuel, masspol_per_startup, color = fuel)) +
  geom_point() +
  theme_bw() +
  theme(legend.position = "none",
        text = element_text(size=20),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab("mg per startup event") + xlab("fuel type") +
  facet_wrap(~pol, scales = "free")
```

## Key Pollutants only! 

* all individual data points shown as circles; black star is mean value for that group. Fuel types ordered by highest to lowest PM.  
```{r fig.width=18, fig.height= 12}
  p_data_key <- dplyr::filter(ef_su_event, grepl('^grav$|^co$|^formaldehyde$|^acetaldehyde$|^voc_benzene$|^voc_toluene$', pol)) %>%
                dplyr::mutate(pol = forcats::fct_relevel(pol, "grav", "co",
                                                      "formaldehyde", "acetaldehyde",
                                                      "voc_benzene", "voc_toluene")) %>%
                dplyr::mutate(fuel = forcats::fct_relevel(fuel, "kerosene", "leaves_twigs",
                                                          "flipflops", "rubber", "newspaper",
                                                          "wood_shims", "t_shirts", 
                                                          "food_packaging", "plastic_bags"))

  p_data_key_means <- filter(ef_sum, grepl('^grav$|^co$|^formaldehyde$|^acetaldehyde$|^voc_benzene$|^voc_toluene$', pol))

  ggplot(p_data_key, aes(fuel, masspol_per_startup, color = fuel)) +
  geom_point(size = 5) +
  geom_point(data = p_data_key_means, aes(x = fuel, y = mean_ef), colour = 'black', size = 6, shape = 8, stroke = 1.5) + 
  theme_bw() +
  theme(legend.position = "none",
        text = element_text(size=25),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab("mg per startup event") + xlab("fuel type") +
  facet_wrap(~pol, scales = "free")
```

## Correlations
* all individual data points shown. 

## PM vs others 
### PM vs. CO
```{r}
  pmco <- dplyr::filter(ef_su_event, grepl('^grav$|^co$', pol)) %>%
          dplyr::select(id, fuel, pol, masspol_per_startup) %>%
          tidyr::spread(pol, masspol_per_startup) 

  ggplot(data = pmco, aes(x = grav, y = co)) + 
        geom_smooth(method = "lm", se= FALSE, color = "black") +
        geom_point(size = 2, aes(colour = fuel)) +
          ylab("CO EF (mg per startup event)") +
          xlab("PM2.5 EF (mg per startup event)") +
          scale_color_hue(l=50, c=80) +
          scale_x_log10() +
          theme_bw() +
          scale_y_log10() +
          theme(text = element_text(size = 18),
                legend.position = "top",
                legend.key.size = unit(0.1, "cm"),
                legend.title = element_blank())
```

### PM vs. benzene
```{r}
  pmbz <- dplyr::filter(ef_su_event, grepl('^grav$|^voc_benzene$', pol)) %>%
          dplyr::select(id, fuel, pol, masspol_per_startup) %>%
          tidyr::spread(pol, masspol_per_startup) 

  ggplot(data = pmbz, aes(x = grav, y = voc_benzene)) + 
        geom_smooth(method = "lm", se= FALSE, color = "black") +
        geom_point(size = 2, aes(colour = fuel)) +
          ylab("benzene EF (mg per startup event)") +
          xlab("PM2.5 EF (mg per startup event)") +
          scale_color_hue(l=50, c=80) +
          scale_x_log10() +
          theme_bw() +
          scale_y_log10() +
          theme(text = element_text(size = 18),
                legend.position = "top",
                legend.key.size = unit(0.1, "cm"),
                legend.title = element_blank())
```


### PM vs. toluene
```{r}
  pmto <- dplyr::filter(ef_su_event, grepl('^grav$|^voc_toluene$', pol)) %>%
          dplyr::select(id, fuel, pol, masspol_per_startup) %>%
          tidyr::spread(pol, masspol_per_startup) 

  ggplot(data = pmto, aes(x = grav, y = voc_toluene)) + 
        geom_smooth(method = "lm", se= FALSE, color = "black") +
        geom_point(aes(colour = fuel), size = 2) +
          ylab("toluene EF (mg per startup event)") +
          xlab("PM2.5 EF (mg per startup event)") +
          scale_color_hue(l=50, c=80) +
          scale_x_log10() +
          theme_bw() +
          scale_y_log10() +
          theme(text = element_text(size = 18),
                legend.position = "top",
                legend.key.size = unit(0.1, "cm"),
                legend.title = element_blank())
```


### PM vs. formaldehyde
```{r}
  pmfd <- dplyr::filter(ef_su_event, grepl('^grav$|^formaldehyde$', pol)) %>%
          dplyr::select(id, fuel, pol, masspol_per_startup) %>%
          tidyr::spread(pol, masspol_per_startup) 

  ggplot(data = pmfd, aes(x = grav, y = formaldehyde)) + 
        geom_smooth(method = "lm", se= FALSE, color = "black") +
        geom_point(aes(colour = fuel), size = 2) +
          ylab("formaldehyde EF (mg per startup event) ") +
          xlab("PM2.5 EF (mg per startup event)") +
          scale_color_hue(l=50, c=80) +
          scale_x_log10() +
          theme_bw() +
          scale_y_log10() +
          theme(text = element_text(size = 18),
                legend.position = "top",
                legend.key.size = unit(0.1, "cm"),
                legend.title = element_blank())
```


### PM vs. acetaldehyde
```{r}
  pmfd <- dplyr::filter(ef_su_event, grepl('^grav$|^acetaldehyde$', pol)) %>%
          dplyr::select(id, fuel, pol, masspol_per_startup) %>%
          tidyr::spread(pol, masspol_per_startup) 

  ggplot(data = pmfd, aes(x = grav, y = acetaldehyde)) + 
        geom_smooth(method = "lm", se= FALSE, color = "black") +
        geom_point(aes(colour = fuel), size = 2) +
          ylab("acetaldehyde EF (mg per startup event) ") +
          xlab("PM2.5 EF (mg per startup event)") +
          scale_color_hue(l=50, c=80) +
          scale_x_log10() +
          theme_bw() +
          scale_y_log10() +
          theme(text = element_text(size = 18),
                legend.position = "top",
                legend.key.size = unit(0.1, "cm"),
                legend.title = element_blank())
```


## CO vs others 
### CO vs. PM
```{r}
  pmco <- dplyr::filter(ef_su_event, grepl('^grav$|^co$', pol)) %>%
          dplyr::select(id, fuel, pol, masspol_per_startup) %>%
          tidyr::spread(pol, masspol_per_startup) 

  ggplot(data = pmco, aes(x = co, y = grav)) + 
        geom_smooth(method = "lm", se= FALSE, color = "black") +
        geom_point(aes(colour = fuel), size = 2) +
          xlab("CO EF (mg per startup event) ") +
          ylab("PM2.5 EF (mg per startup event)") +
          scale_color_hue(l=50, c=80) +
          scale_x_log10() +
          theme_bw() +
          scale_y_log10() +
          theme(text = element_text(size = 18),
                legend.position = "top",
                legend.key.size = unit(0.1, "cm"),
                legend.title = element_blank())
```

### CO vs. benzene
```{r}
  cobz <- dplyr::filter(ef_su_event, grepl('^co$|^voc_benzene$', pol)) %>%
          dplyr::select(id, fuel, pol, masspol_per_startup) %>%
          tidyr::spread(pol, masspol_per_startup) 

  ggplot(data = cobz, aes(x = co, y = voc_benzene)) + 
        geom_smooth(method = "lm", se= FALSE, color = "black") +
        geom_point(aes(colour = fuel), size = 2) +
          ylab("benzene EF (mg per startup event) ") +
          xlab("CO EF (mg per startup event)") +
          scale_color_hue(l=50, c=80) +
          scale_x_log10() +
          theme_bw() +
          scale_y_log10() +
          theme(text = element_text(size = 18),
                legend.position = "top",
                legend.key.size = unit(0.1, "cm"),
                legend.title = element_blank())
```


### CO vs. toluene
```{r}
  coto <- dplyr::filter(ef_su_event, grepl('^co$|^voc_toluene$', pol)) %>%
          dplyr::select(id, fuel, pol, masspol_per_startup) %>%
          tidyr::spread(pol, masspol_per_startup) 

  ggplot(data = coto, aes(x = co, y = voc_toluene)) + 
        geom_smooth(method = "lm", se= FALSE, color = "black") +
        geom_point(aes(colour = fuel), size = 2) +
          ylab("toluene EF (mg per startup event)") +
          xlab("CO EF (mg per startup event)") +
          scale_color_hue(l=50, c=80) +
          scale_x_log10() +
          theme_bw() +
          scale_y_log10() +
          theme(text = element_text(size = 18),
                legend.position = "top",
                legend.key.size = unit(0.1, "cm"),
                legend.title = element_blank())
```


### CO vs. formaldehyde
```{r}
  cofd <- dplyr::filter(ef_su_event, grepl('^co$|^formaldehyde$', pol)) %>%
          dplyr::select(id, fuel, pol, masspol_per_startup) %>%
          tidyr::spread(pol, masspol_per_startup) 

  ggplot(data = cofd, aes(x = co, y = formaldehyde)) +
        geom_smooth(method = "lm", se= FALSE, color = "black") +
        geom_point(aes(colour = fuel), size = 2) +
          ylab("formaldehyde EF (mg per startup event)") +
          xlab("CO EF (mg per startup event)") +
          scale_color_hue(l=50, c=80) +
          scale_x_log10() +
          theme_bw() +
          scale_y_log10() +
          theme(text = element_text(size = 18),
                legend.position = "top",
                legend.key.size = unit(0.1, "cm"),
                legend.title = element_blank())
```


### CO vs. acetaldehyde
```{r}
  coad <- dplyr::filter(ef_su_event, grepl('^co$|^acetaldehyde$', pol)) %>%
          dplyr::select(id, fuel, pol, masspol_per_startup) %>%
          tidyr::spread(pol, masspol_per_startup) 

  ggplot(data = coad, aes(x = co, y = acetaldehyde)) + 
        geom_smooth(method = "lm", se= FALSE, color = "black") +
        geom_point(aes(colour = fuel), size = 2) +
          ylab("acetaldehyde EF (mg per startup event)") +
          xlab("CO EF (mg per startup event)") +
          scale_color_hue(l=50, c=80) +
          scale_x_log10() +
          theme_bw() +
          scale_y_log10() +
          theme(text = element_text(size = 18),
                legend.position = "top",
                legend.key.size = unit(0.1, "cm"),
                legend.title = element_blank())
```


