---
title: "EC/OC"
date: "December 22, 2018"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r global_options, include=FALSE}
  knitr::opts_chunk$set(fig.path = 'figures/',
                        warning = FALSE,
                        message = FALSE,
                        fig.width = 10, fig.height = 4,
                        cache = FALSE,
                        results='markup')
```

```{r, include=FALSE}
  library(tidyverse)
  library(knitr)
```

```{r}
  source("../r_scripts/R_tidy.R")
  source("../r_scripts/R_functions.R")
```

# Load data

Test metadata:

```{r}
  samples <- readRDS("../r_files/samples.RDS")
  times   <- readRDS("../r_files/test_times_all.RDS")
  flows   <- readRDS("../r_files/flow_rates.RDS")
  notes   <- readRDS(file = "../r_files/notes.RDS")
```

EC/OC

```{r,}
  ecoc <- readRDS("../r_files/ecoc.RDS")
```

Constants

```{r}
  filter_area <- readRDS("../r_files/filter_area.RDS")
```

# Organize and combine

### Filter data

Separate the filter ID from the data file into an ID column and a filter type (e.g., Q, QB, blank).  

```{r}
  df_ecoc <- ecoc %>%
             tidyr::separate(filter_id, c("id", "cassette"), extra = "merge") %>%
             dplyr::mutate(cassette = ifelse(id == "blank", "blank", cassette),
                           cassette = ifelse(grepl(".*Blank.*", cassette),
                                            "blank", cassette),
                           cassette = ifelse(grepl(".*of day.*", cassette),
                                             "start_blank", cassette),
                           cassette = ifelse(grepl(".*Test.*", cassette),
                                             "test", cassette),
                           cassette = tolower(cassette),
                           id = ifelse(grepl(".*blank.*", cassette), "blank", id),
                           id = ifelse(grepl(".*start_blank.*", cassette),
                                       "start_blank", id),
                           id = ifelse(grepl(".*test.*", cassette), "test", id)) 
```

* select columns of interest (others?)
* longer format with columns: `pol = ec, oc or tc` containing the pollutant name and `ug_sq_cm` containing the measured value

```{r}
  df_ecoc <- dplyr::select(df_ecoc,
                           id, cassette, oc_ug_cm2, ec_ug_cm2, tc_ug_cm2,
                           punch_area_cm2, datetime, date, time, analyst)
```

### Flow rates

Match filter type to color:  

* white = QB
* orange = QF

```{r}
  df_flows <- dplyr::filter(flows, instrument == "filters") %>%
              dplyr::mutate(cassette = ifelse(colour == "white", "qb", "qf")) %>%
              dplyr::select(-colour, -loc, -instrument)
```

### Start and end times

Get the starting and ending times for the filter sample associate with each test.  

```{r}
  df_times <- dplyr::filter(times, var %in% c("start_filters","end_filters")) %>%
              tidyr::spread(var, value) %>%
              dplyr::select(-date) 
```

### Notes

Extract EC/OC notes

```{r}
  notes <- dplyr::filter(notes, grepl("ecoc|all", inst) == TRUE)
```

* apply flags: `bad` preceeds `maybe` preceeds `good`

```{r}
  flags <- dplyr::select(notes, id, qc) %>%
           dplyr::mutate(id = as.character(id)) %>%
           dplyr::group_by(id)          %>%
           dplyr::arrange(qc)           %>%
           dplyr::summarise(qc = first(qc))
```

### Combine

```{r}
  df_ecoc_merged <- dplyr::left_join(df_ecoc, df_flows, by=c("id","cassette")) %>%
                    dplyr::left_join(df_times, by=c("id")) %>%
                    dplyr::left_join(flags,    by=c("id")) %>%
                    dplyr::mutate(qc = ifelse(is.na(qc), "ok", qc))
```

```{r}

  df_ecoc_merged <- df_ecoc_merged %>%
                    tidyr::gather("pol", "ug_sq_cm",
                                  ec_ug_cm2,  oc_ug_cm2, tc_ug_cm2) %>%
                    dplyr::mutate(pol = ifelse(pol == "ec_ug_cm2", "ec", pol),
                                  pol = ifelse(pol == "oc_ug_cm2", "oc", pol),
                                  pol = ifelse(pol == "tc_ug_cm2", "tc", pol)) %>%
                    dplyr::filter(pol != "tc")
```

# LOD / LOQ

Select test blanks. Then, calculate the limit of detection (LOD) and limit of quantification (LOQ).  

```{r}
  df_lod <-  filter(df_ecoc_merged, grepl("^G", id)) %>%
             dplyr::group_by(pol) %>%
             dplyr::summarise(lod = mean(ug_sq_cm) + ( 3 * sd(ug_sq_cm)),
                              loq = mean(ug_sq_cm) + (10 * sd(ug_sq_cm)))
```

```{r}
  lod_ec <- dplyr::filter(df_lod, pol == "ec")$lod[1]
  loq_ec <- dplyr::filter(df_lod, pol == "ec")$loq[1]

  lod_oc <- dplyr::filter(df_lod, pol == "oc")$lod[1]
  loq_oc <- dplyr::filter(df_lod, pol == "oc")$loq[1]
```

* The EC LOD is `r round(dplyr::filter(df_lod, pol == "ec")$lod[1], 3)` $\mu$ g/cm^2^.  
* The EC LOQ is `r round(dplyr::filter(df_lod, pol == "ec")$loq[1], 3)` $\mu$ g/cm^2^.  

* The OC LOD is `r round(dplyr::filter(df_lod, pol == "oc")$lod[1], 2)` $\mu$ g/cm^2^.  
* The OC LOQ is `r round(dplyr::filter(df_lod, pol == "oc")$loq[1], 2)` $\mu$ g/cm^2^.  

Flag each filter sample as being either above or below the LOD and LOQ.

```{r}
  df_ecoc_merged <- dplyr::left_join(df_ecoc_merged, df_lod, by=c("pol")) %>%
                    dplyr::mutate(lod = ifelse(ug_sq_cm >= lod, "above", "below"),
                                  loq = ifelse(ug_sq_cm >= loq, "above", "below"))
```

# Calculate concentration

```{r}
  df_ecoc_merged <- df_ecoc_merged %>%
                    plyr::mutate(dur  = (end_filters - start_filters) / 60, # minutes
                                 conc = ug_sq_cm * filter_area / ((flow * dur) / 1000)) # ug/m3
```

# Background 

1. Select background tests with "ok" data.  
2. Calculate sample duration in minutes.  
3. Calculate mass concentration in $\mu$g/m^3^.  
4. Calculate averge background concentration by pollutant / cassette.  

```{r}
  df_bg <- dplyr::filter(df_ecoc_merged, grepl("^BG", id), qc == "ok") %>%
           dplyr::group_by(pol, cassette) %>%
           dplyr::summarise(mean = mean(conc),
                            sd   = sd(conc),
                            min  = min(conc),
                            max  = max(conc),
                            n    = n())
```

Account for the OC adsorption artifact on the front quartz filter.  

```{r}
  df_bg <- dplyr::select(df_bg, pol, cassette, mean) %>%
           tidyr::spread(cassette, mean)             %>%
           dplyr::mutate(conc_bg = qf - qb)
```

```{r}
  knitr::kable(df_bg, "markdown", digits = 2)
```

# Account for OC adsoprtion artifact

Select test data

```{r}
  df_ecoc_merged <- df_ecoc_merged %>%
                    dplyr::filter(substr(id,1,1) != "G",  # reomve blanks
                                  substr(id,1,2) != "BG", # remove backgrounds
                                  cassette %in% c("qf", "qb"))
```

Subtract concentrations on back quartz filters from concentrations on front quartz filters. 

```{r}
  df_artifact <- dplyr::select(df_ecoc_merged, id, pol, cassette, conc, dur) %>% 
                 tidyr::spread(cassette, conc) %>%
                 dplyr::mutate(qb = ifelse(pol=="ec", 0, qb),
                               conc_corr = qf - qb)
```

Combine background data.

```{r}
  df_ecoc_conc <- dplyr::select(df_artifact, id, pol, dur, conc_corr) %>%
                  dplyr::left_join(dplyr::select(df_bg, pol, conc_bg), by=c("pol"))
```

Both the test concentrations and the background concentrations have been corrected for the OC adsorption artifact.  All concentrations are in units of $\mu$g/m^3^. 

# Save

```{r}
  saveRDS(df_ecoc_conc, file ="../r_files/ecoc_conc.RDS")
```

# QC plots

```{r, fig.width = 12, fig.height = 10}
  ggplot(df_ecoc_merged, aes(id, ug_sq_cm, color = cassette)) +
  geom_point(size=3) +
  facet_wrap(~pol, scales = "free", ncol = 1) +
  theme_minimal() +
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r, fig.width=12, fig.height=8}
  test_data <- dplyr::filter(df_ecoc_merged, qc == "ok",
                                             cassette == "qf")

  ggplot(test_data, aes(id, ug_sq_cm, colour = lod)) +
    geom_point(size=3) +
    theme_minimal() +
    theme(legend.position = "top") +
    facet_wrap(~pol, ncol = 1, scales = "free") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

