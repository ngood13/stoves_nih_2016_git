---
title: "ecoc"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
  library(knitr)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  source("../r_scripts/R_tidy.R")
  source("../r_scripts/R_functions.R")
```

# Load data

* ecoc

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  load("../r_files/ecoc.Rda")
```

* metadata

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  load(file = "../r_files/filter_times.Rda")
  load(file = "../r_files/filter_flows.Rda")
  load(file = "../r_files/notes.Rda")
  load(file = "../r_files/samples.Rda")
```

# Filter data

* retain test and background data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  ecoc_merged <- dplyr::filter(ecoc, type == "test" | type == "bg") %>%
                 dplyr::arrange(id) %>%
                 dplyr::mutate(id = as.factor(id))
```

# Meta data

* match cassette flows to id

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
 flows <- dplyr::select(filter_flows, -date) %>%
           dplyr::filter(colour == "white" | colour == "orange") %>%
           dplyr::group_by(id, type, colour) %>%
           dplyr::summarise(flow = mean(value, na.rm = TRUE)) %>%
           dplyr::group_by(id, colour) %>%
           dplyr::summarise(flow = mean(flow, na.rm = TRUE)) %>%
           dplyr::mutate(colour = factor(colour)) %>%
           dplyr::mutate(cassette = 
                         forcats::fct_recode(colour, "a" = "white",
                                                     "e" = "orange")) %>%
           dplyr::select(-colour)
```

* match cassette timestamps to id

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
 times <- dplyr::select(filter_times, -date) %>%
           dplyr::filter(color == "white" | color == "orange") %>%
           tidyr::spread(type, value) %>%
           dplyr::mutate(cassette = 
                         forcats::fct_recode(color, "a" = "white",
                                                     "e" = "orange")) %>%
           dplyr::select(-color)
```

* merge ecoc with metadata

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  ecoc_merged <- dplyr::left_join(ecoc_merged,
                                  flows,
                                  by = c("id", "cassette")) %>%
                 dplyr::left_join(times,
                                  by = c("id", "cassette"))
```

# QC

## merge notes with data

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  notes <- dplyr::filter(notes, grepl("ecoc|all", notes$inst) == TRUE)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  flags <- dplyr::select(notes, id, qc) %>%
           dplyr::group_by(id) %>%
           dplyr::arrange(qc) %>%
           dplyr::summarise(qc = first(qc))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  ecoc_merged <- dplyr::left_join(ecoc_merged, flags, by = "id") %>%
                 dplyr::mutate(id = as.factor(id)) %>%
                 dplyr::mutate(qc = ifelse(is.na(qc),
                                    "ok", as.character(qc))) %>%
                 dplyr::mutate(qc = as.factor(qc))
```

## additional bad tests

* tests where fid2 is out of range
* first 6D measurement, that produced very high value (repeated)
* 8D, very high value
* 9B, artifact gives very high values.

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  ecoc_merged <- dplyr::mutate(ecoc_merged, qc = ifelse(grepl("ok", fid2),
                                                 as.character(qc), "bad")) %>%
                  dplyr::mutate(qc = ifelse(date == as.Date("2016-06-20") &
                                            time == 42234 &
                                            id == "6D", 
                                            "bad",
                                            as.character(qc))) %>%
                  dplyr::mutate(qc = ifelse(date == as.Date("2016-06-20") &
                                            time == 53318 &
                                            id == "8D",
                                            "bad",
                                             as.character(qc))) %>%
                  dplyr::mutate(qc = ifelse(id == "9B",
                                            "bad",
                                            as.character(qc)))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  bad <- dplyr::filter(ecoc_merged, qc == "bad") %>% dplyr::select(id)

  maybe <- dplyr::filter(ecoc_merged, qc == "maybe") %>% dplyr::select(id)
```

* the following tests are flagged as bad: `r unique(bad$id)`.

* the following tests are flagged as maybe bad: `r unique(maybe$id)`.

# Convert to longer format

* select columns of interest (others?)

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  ecoc_merged <- dplyr::select(ecoc_merged,
                               id, 
                               oc_ug_sq_cm, ec_ug_sq_cm, tc_ug_sq_cm,
                               datetime, date, time,
                               flow,
                               start, end,
                               qc,
                               type, cassette,
                               punch_area,
                               analyst) %>%
                  tidyr::gather("pol", "ug_sq_cm",
                                ec_ug_sq_cm,
                                oc_ug_sq_cm,
                                tc_ug_sq_cm) %>%
                  dplyr::mutate(pol = ifelse(pol == "ec_ug_sq_cm",
                                             "ec", pol),
                                pol = ifelse(pol == "oc_ug_sq_cm",
                                             "oc", pol),
                                pol = ifelse(pol == "tc_ug_sq_cm",
                                             "tc", pol))
```

# Calculate LOD / LOQ

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  blanks <- dplyr::filter(ecoc_merged, id == "lab_blank") %>%
            dplyr::group_by(pol) %>%
            dplyr::summarise(lod = sd(ug_sq_cm) * 3 + mean(ug_sq_cm),
                             loq = sd(ug_sq_cm) * 10 + mean(ug_sq_cm))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  lod_ec <- dplyr::filter(blanks, pol == "ec")$lod[1]
  lod_oc <- dplyr::filter(blanks, pol == "oc")$lod[1]
  loq_ec <- dplyr::filter(blanks, pol == "ec")$loq[1]
  loq_oc <- dplyr::filter(blanks, pol == "oc")$loq[1]
```

* The EC limit of detection is `r round(lod_ec, 3)` ($\mu g/cm^2$) and limit of quantification is `r round(loq_ec, 3)` ($\mu g/cm^2$).

* The OC limit of detection is `r round(lod_oc, 3)` ($\mu g/cm^2$) and limit of quantification is `r round(loq_oc, 3)` ($\mu g/cm^2$).

# Background analysis

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
 area <- 11.79  # filter area (cm^2)
```

* extract "ok" background data
* remove missing data
* calculate average concentration emitted ( and other stats)
* average any repeat measurements (non in G8-G14)
* note G12 missing measurement data
* calculate averge background by pollutant / type

Filter areas is `r area ` cm^2.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  bg <- dplyr::filter(ecoc_merged, type == "bg", qc == "ok") %>%
        na.omit() %>%
        dplyr::mutate(dur = end - start) %>%
        dplyr::mutate(conc = ug_sq_cm * area * 1000 / (flow * dur)) %>%
        dplyr::group_by(pol, id, cassette) %>%
        dplyr::summarise(rep_mean = mean(conc)) %>%
        dplyr::ungroup() %>%
        dplyr::group_by(pol, cassette) %>%
        dplyr::summarise(mean = mean(rep_mean),
                         sd = sd(rep_mean),
                         min = min(rep_mean),
                         max = max(rep_mean),
                         n = n())
```

* account for artifact

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  bg <- dplyr::select(bg, pol, cassette, mean) %>%
        tidyr::spread(cassette, mean) %>%
        dplyr::mutate(conc_bg = e - a)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  knitr::kable(bg, "markdown", digits = 2)
```

* merge with test data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  ecoc_merged <- dplyr::left_join(ecoc_merged, 
                                  dplyr::select(bg, pol, conc_bg),
                                                by = "pol")
```

# Save merged file

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  save(ecoc_merged, file ="../r_files/ecoc_merged.Rda")
```

# Tables & Plots

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  ecoc_merged <- dplyr::left_join(ecoc_merged,
                                  dplyr::select(samples, id, stove, fuel),
                                                by = "id") %>%
                 dplyr::mutate(id= as.factor(id))
```

## add a LOD and LOQ flags

* ec

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  ecoc_merged <- dplyr::mutate(ecoc_merged,
                                loq = NA,
                                lod = NA) %>%
                  dplyr::mutate(lod = ifelse(pol == "ec" &
                                            (type == "test" | type == "bg") &
                                            ug_sq_cm >= lod_ec,
                                            "ok",
                                            lod)) %>%
                  dplyr::mutate(lod = ifelse(pol == "ec" &
                                            (type == "test" | type == "bg") &
                                            ug_sq_cm < lod_ec,
                                            "low",
                                            lod)) %>%
	                dplyr::mutate(loq = ifelse(pol == "ec" &
                                            (type == "test" | type == "bg") &
                                            ug_sq_cm >= lod_ec,
                                            "ok",
                                            loq)) %>%
                  dplyr::mutate(loq = ifelse(pol == "ec" &
                                            (type == "test" | type == "bg") &
                                            ug_sq_cm < lod_ec,
                                            "low",
                                            loq))
```

* oc

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}

  ecoc_merged <- dplyr::mutate(ecoc_merged, lod = ifelse(pol == "oc" &
                                            (type == "test" | type == "bg") &
                                            ug_sq_cm >= lod_oc,
                                            "ok",
                                            lod)) %>%
                  dplyr::mutate(lod = ifelse(pol == "oc" &
                                            (type == "test" | type == "bg") &
                                            ug_sq_cm < lod_oc,
                                            "low",
                                            lod)) %>%
	                dplyr::mutate(loq = ifelse(pol == "oc" &
                                            (type == "test" | type == "bg") &
                                            ug_sq_cm >= loq_oc,
                                            "ok",
                                            loq)) %>%
                  dplyr::mutate(loq = ifelse(pol == "oc" &
                                            (type == "test" | type == "bg") &
                                            ug_sq_cm < loq_oc,
                                            "low",
                                            loq))
```

## plot blanks

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  ggplot(blanks, aes(pol, ug_sq_cm)) +
    geom_boxplot() +
    theme_minimal() +
    ylab("pollutant [ug/sq.cm]")+
    theme(legend.position = "top")
```

## LOD/LOQ tables

* ec lod

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  lod_ec <- dplyr::select(ecoc_merged, id,
                                       ug_sq_cm,
                                       cassette,
                                       stove,
                                       fuel,
                                       qc, pol,
                                       lod) %>%
             dplyr::filter(lod == "low" & pol == "ec")

  kable(lod_ec, align = 'c', caption = "Filters below LOD for EC")
```

* ec loq

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  loq_ec <- dplyr::select(ecoc_merged, id,
                                       ug_sq_cm,
                                       cassette,
                                       stove,
                                       fuel,
                                       qc, pol,
                                       loq) %>%
             dplyr::filter(loq == "low" & pol == "ec")

  kable(loq_ec, align = 'c', caption = "Filters below LOQ for EC")
```

* oc lod

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  lod_oc <- dplyr::select(ecoc_merged, id,
                                       ug_sq_cm,
                                       cassette,
                                       stove,
                                       fuel,
                                       qc, pol,
                                       lod) %>%
             dplyr::filter(lod == "low" & pol == "oc")

  kable(lod_oc, align = 'c', caption = "Filters below LOD for OC")
```

* oc loq

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  loq_oc <- dplyr::select(ecoc_merged, id,
                                       ug_sq_cm,
                                       cassette,
                                       stove,
                                       fuel,
                                       qc, pol,
                                       loq) %>%
             dplyr::filter(loq == "low" & pol == "oc")

  kable(loq_oc, align = 'c', caption = "Filters below LOQ for OC")
``` 

There were `r nrow(lod_ec)` filters below the limit of detection for ec and `r nrow(lod_oc)` filters below the limit detection for oc. There were `r nrow(loq_ec)` filters below the limit of quantification for ec and `r nrow(loq_oc)` filters below the limit quantification for oc.
