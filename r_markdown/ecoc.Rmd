---
title: "ecoc"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
  library(knitr)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  source("../r_scripts/R_tidy.R")
  source("../r_scripts/R_functions.R")
```

# Load data

* ecoc

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  load("../r_files/ecoc.Rda")
```

* metadata

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  load("../r_files/filter_times.Rda")
  load("../r_files/filter_flows.Rda")
  load("../r_files/data_1.Rda")
```

# Merge with filter meta data

Extract metadata

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  meta <- dplyr::select(data_1, matches("_orange_|_white_|^id$|^date$"))

  flows <- dplyr::select(meta, matches("flow_|^id$|^date$")) %>%
           tidyr::gather("var", "value", -id, -date) %>%
           dplyr::filter(grepl("_avg$", var)==FALSE) %>%
           dplyr::mutate(type = sub("flow.*", "", var),
                         cassette = as.factor(ifelse(grepl("_white_", var), "A", "E")),
                         rep = as.factor(gsub("[^0-9]", "", var))) %>%
           dplyr::select(-var) %>%
           dplyr::filter(!is.na(id)) %>%
           dplyr::group_by(id, type, cassette) %>%
           dplyr::summarise(mean = mean(value, na.rm = TRUE)) %>%
           tidyr::spread(type, mean)

  times <- dplyr::select(meta, matches("^time_|^id$|^date$")) %>%
           tidyr::gather("var", "value", -id, -date) %>%
           dplyr::mutate(type = ifelse(grepl("_start_", var), "start", "NA"),
                         type = ifelse(grepl("_end_", var), "end", type)) %>%
           dplyr::filter(!is.na(id)) %>%
           dplyr::select(-var, -date) %>%
           tidyr::spread(type, value)
```

Merge ecoc with metadata

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  ecoc_merged <- dplyr::left_join(ecoc, flows, by = c("id", "cassette")) %>% 
                 dplyr::left_join(times, by = c("id")) %>%
                 dplyr::filter(grepl("^[0-9]", id) == TRUE |
                               grepl("^G[0-9]", id) == TRUE |
                               grepl("^analysis_bk", type) == TRUE |
                               grepl("^lab_bk", type) == TRUE) %>%
                 dplyr::rename(pre_flow = pre, post_flow = post) %>%
                 dplyr::arrange(id) %>%
                 dplyr::mutate(id = as.factor(id))
```

# QC

Load notes

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  load(file="../r_files/notes.Rda")

  notes <- dplyr::filter(notes, grepl("ecoc|all", notes$inst) == TRUE)

```

Set one flag per test

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  flags <- dplyr::select(notes, id, qc) %>%
           dplyr::group_by(id) %>%
           dplyr::arrange(qc) %>%
           dplyr::summarise(qc = first(qc))
```

Merge with data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  ecoc_merged <- dplyr::left_join(ecoc_merged, flags, by = "id") %>%
                 dplyr::mutate(id = as.factor(id)) %>%
                 dplyr::mutate(qc = ifelse(is.na(qc),
                                    "ok", as.character(qc))) %>%
                 dplyr::mutate(qc = as.factor(qc))
```

Additional bad tests

* tests where fid2 is out of range
* first 6D measurement, that produced very high value (repeated)
* 8D, very high value
* 9B, artifact gives very high values.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  ecoc_merged <- dplyr::mutate(ecoc_merged, qc = ifelse(grepl("ok", fid2), 
                                                 as.character(qc), "bad")) %>%
                  dplyr::mutate(qc = ifelse(date == as.Date("2016-06-20") & time == 42234 & id == "6D", 
                                            "bad", as.character(qc))) %>%
                  dplyr::mutate(qc = ifelse(date == as.Date("2016-06-20") & time == 53318 & id == "8D", 
                                            "bad", as.character(qc))) %>%
	                dplyr::mutate(qc = ifelse(id == "9B", "bad", as.character(qc)))
```

# Convert to longer format

Select columns of interest (others?)

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  ecoc_merged <- dplyr::select(ecoc_merged, id, 
                                            oc_ug_sq_cm, ec_ug_sq_cm, tc_ug_sq_cm,
                                            datetime, date, time,
                                            pre_flow, post_flow,
                                            start, end,
                                            qc,
                                            type, cassette,
                                            punch_area,
                                            analyst) %>%
                  tidyr::gather("pol", "ug_sq_cm", ec_ug_sq_cm,
                                                   oc_ug_sq_cm,
                                                   tc_ug_sq_cm) %>%
                  dplyr::mutate(pol = ifelse(pol == "ec_ug_sq_cm", "ec", pol),
                                pol = ifelse(pol == "oc_ug_sq_cm", "oc", pol),
                                pol = ifelse(pol == "tc_ug_sq_cm", "tc", pol))
```

# Calculate LOD

* need to identify and include blanks in previous analysis

# Background analysis

* extract "ok" background data
* remove missing data
* calculate average concentration emitted ( and other stats)
* average any repeat measurements (non in G8-G14)
* note G12 missing measurement data
* calculate averge backgoround by pollutant / type

Assume filter areas is `r area <- 11.8` cm^2.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  bg <- dplyr::filter(ecoc_merged, type == "bg", qc == "ok") %>%
        na.omit() %>%
        dplyr::mutate(flow = (post_flow + pre_flow) / 2) %>%
        dplyr::mutate(dur = end - start) %>%
        dplyr::mutate(conc = ug_sq_cm * area * 1000 / (flow * dur)) %>%
        dplyr::group_by(pol, id, cassette) %>%
        dplyr::summarise(rep_mean = mean(conc)) %>%
        dplyr::ungroup() %>%
        dplyr::group_by(pol, cassette) %>%
        dplyr::summarise(mean = mean(rep_mean),
                         sd = sd(rep_mean),
                         min = min(rep_mean),
                         max = max(rep_mean),
                         n = n())
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  knitr::kable(bg, "markdown", digits = 2)
```

* account for artifact

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  bg <- dplyr::select(bg, pol, cassette, mean) %>%
         tidyr::spread(cassette, mean) %>%
         dplyr::mutate(conc_bg = E - A)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  knitr::kable(bg, "markdown", digits = 2)
```

* merge with test data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  ecoc_merged <- dplyr::left_join(ecoc_merged, 
                                  dplyr::select(bg, pol, conc_bg),
                                                by = "pol")
```

# Save merged file

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  save(ecoc_merged, file ="../r_files/ecoc_merged.Rda")
```

# Load sample info and merge with ecoc data

** The level definitions should be made when the samples file is created

* Load sample info

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  load(file="../r_files/samples.Rda")

  samples <- dplyr::select(samples, id, stove, fuel)
```

* merge ecoc data with sample info

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  ecoc_merged <- dplyr::left_join(ecoc_merged, samples, by = "id") %>%
                 dplyr::mutate(id= as.factor(id))
```

# Separate blank filters

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  ec_lod_loq <- dplyr::filter(ecoc_merged, type == "lab_bk" & pol == "ec") %>%
                dplyr::summarise(mean_ug_sq_cm = mean(ug_sq_cm),
                                sd_ug_sq_cm = sd(ug_sq_cm),
                                lod = sd_ug_sq_cm * 3 + mean_ug_sq_cm,
                                loq = sd_ug_sq_cm * 10 + mean_ug_sq_cm,
                                n = n())

  oc_lod_loq <- dplyr::filter(ecoc_merged, type == "lab_bk" & pol == "oc") %>%
                dplyr::summarise(mean_ug_sq_cm = mean(ug_sq_cm),
                                sd_ug_sq_cm = sd(ug_sq_cm),
                                lod = sd_ug_sq_cm * 3 + mean_ug_sq_cm,
                                loq = sd_ug_sq_cm * 10 + mean_ug_sq_cm)

  blanks <- dplyr::filter(ecoc_merged, grepl("^B", id)) %>%
            dplyr::select(id, pol, ug_sq_cm)
```

There were `r ec_lod_loq$n[1]` blank ecoc filter analyzed. The average blank oc was `r round(oc_lod_loq$mean[1], 3)` [ug/sq.cm] the average blank ec was `r round(ec_lod_loq$mean[1], 3)` [ug/sq.cm]. For OC the limit of detection was `r round(oc_lod_loq$lod[1], 3)` [ug/sq.cm] and the limit of quantification was `r round(oc_lod_loq$loq[1], 3)` [ug/sq.cm]. For EC the limit of detection was `r round(ec_lod_loq$lod[1], 3)` [ug/sq.cm] and the limit of quantification was `r round(ec_lod_loq$loq[1], 3)` [ug/sq.cm].

# Add a LOD and LOQ flag

* ec

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  ecoc_merged <- dplyr::mutate(ecoc_merged,
                                loq = NA,
                                lod = NA) %>%
                  dplyr::mutate(lod = ifelse(pol == "ec" &
                                            (type == "test" | type == "bg") &
                                            ug_sq_cm >= ec_lod_loq$lod,
                                            "ok",
                                            lod)) %>%
                  dplyr::mutate(lod = ifelse(pol == "ec" &
                                            (type == "test" | type == "bg") &
                                            ug_sq_cm < ec_lod_loq$lod,
                                            "low",
                                            lod)) %>%
	                dplyr::mutate(loq = ifelse(pol == "ec" &
                                            (type == "test" | type == "bg") &
                                            ug_sq_cm >= ec_lod_loq$loq,
                                            "ok",
                                            loq)) %>%
                  dplyr::mutate(loq = ifelse(pol == "ec" &
                                            (type == "test" | type == "bg") &
                                            ug_sq_cm < ec_lod_loq$loq,
                                            "low",
                                            loq))
```

* oc

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}

  ecoc_merged <- dplyr::mutate(ecoc_merged, lod = ifelse(pol == "oc" &
                                            (type == "test" | type == "bg") &
                                            ug_sq_cm >= oc_lod_loq$lod,
                                            "ok",
                                            lod)) %>%
                  dplyr::mutate(lod = ifelse(pol == "oc" &
                                            (type == "test" | type == "bg") &
                                            ug_sq_cm < oc_lod_loq$lod,
                                            "low",
                                            lod)) %>%
	                dplyr::mutate(loq = ifelse(pol == "oc" &
                                            (type == "test" | type == "bg") &
                                            ug_sq_cm >= oc_lod_loq$loq,
                                            "ok",
                                            loq)) %>%
                  dplyr::mutate(loq = ifelse(pol == "oc" &
                                            (type == "test" | type == "bg") &
                                            ug_sq_cm < oc_lod_loq$loq,
                                            "low",
                                            loq))
```

## Plot blanks

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  ggplot(blanks, aes(pol, ug_sq_cm)) +
    geom_boxplot() +
    theme_minimal() +
    ylab("pollutant [ug/sq.cm]")+
    theme(legend.position = "top")
```

## LOD/LOQ table

* ec lod

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  lod_ec <- dplyr::select(ecoc_merged, id,
                                       ug_sq_cm,
                                       cassette,
                                       stove,
                                       fuel,
                                       qc, pol,
                                       lod) %>%
             dplyr::filter(lod == "low" & pol == "ec")

  kable(lod_ec, align = 'c', caption = "Filters below LOD for EC")
```

* ec loq

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  loq_ec <- dplyr::select(ecoc_merged, id,
                                       ug_sq_cm,
                                       cassette,
                                       stove,
                                       fuel,
                                       qc, pol,
                                       loq) %>%
             dplyr::filter(loq == "low" & pol == "ec")

  kable(loq_ec, align = 'c', caption = "Filters below LOQ for EC")
```

* oc lod

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  lod_oc <- dplyr::select(ecoc_merged, id,
                                       ug_sq_cm,
                                       cassette,
                                       stove,
                                       fuel,
                                       qc, pol,
                                       lod) %>%
             dplyr::filter(lod == "low" & pol == "oc")

  kable(lod_oc, align = 'c', caption = "Filters below LOD for OC")
```

* oc loq

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  loq_oc <- dplyr::select(ecoc_merged, id,
                                       ug_sq_cm,
                                       cassette,
                                       stove,
                                       fuel,
                                       qc, pol,
                                       loq) %>%
             dplyr::filter(loq == "low" & pol == "oc")

  kable(loq_oc, align = 'c', caption = "Filters below LOQ for OC")
``` 

There were `r nrow(lod_ec)` filters below the limit of detection for ec and `r nrow(lod_oc)` filters below the limit detection for oc. There were `r nrow(loq_ec)` filters below the limit of quantification for ec and `r nrow(loq_oc)` filters below the limit quantification for oc.
