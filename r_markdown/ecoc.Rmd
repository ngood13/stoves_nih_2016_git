---
title: "ecoc"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
  library(knitr)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  source("../r_scripts/R_tidy.R")
  source("../r_scripts/R_functions.R")
```

# Load data

* ecoc

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  ecoc <- readRDS("../r_files/ecoc.RDS")
```

* metadata

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  test_info <- readRDS("../r_files/test_info.RDS")
  times_fuel <- readRDS("../r_files/times_fuel.RDS")
  times_bg <- readRDS("../r_files/times_bg.RDS")
  times_test <- readRDS("../r_files/times_test.RDS")
  flow <- readRDS("../r_files/flows.RDS")
  notes <- readRDS("../r_files/qc.RDS")
```

# Meta data

* match id to test id

```{r}
  ecoc <- ecoc %>%
          dplyr::mutate(id_test = as.character(id_test)) %>%
          dplyr::left_join(dplyr::select(test_info, id, id_test) %>%
                           dplyr::mutate(id_test = as.character(id_test)),
                           by = "id_test")
```

* match cassette flows to id

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  flows <- flow %>% 
           dplyr::select(-date) %>%
           dplyr::filter(inst == "white" | inst == "red") %>%
           dplyr::mutate(inst = factor(inst)) %>%
           dplyr::mutate(type = 
                         forcats::fct_recode(inst, "artifact" = "white",
                                                   "sample" = "red")) %>%
           dplyr::select(-inst) %>%
           dplyr::rename(flow = "mean") %>%
           dplyr::mutate(flow = ifelse(is.na(flow), pre, flow),
                         flow = ifelse(is.na(flow), post, flow))

  ecoc <- ecoc %>%
          dplyr::left_join(dplyr::select(flows, id, flow, type),
                           by = c("id", "type"))
```

* match cassette timestamps to id

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  ecoc <- ecoc %>%
          dplyr::left_join(dplyr::select(times_test, id, start, end),
                           by = "id")
```

# QC

## flags from notes

* extract ecoc notes

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  notes <- dplyr::filter(notes, grepl("ecoc|all", inst) == TRUE)

  flags <- dplyr::select(notes, id, qc) %>%
           dplyr::group_by(id) %>%
           dplyr::arrange(qc) %>%
           dplyr::summarise(qc = first(qc)) %>%
           dplyr::right_join(dplyr::select(test_info, id), by = "id") %>%
           dplyr::mutate(qc = ifelse(is.na(qc), "good", as.character(qc)))
  
  ecoc <- ecoc %>%
          dplyr::left_join(flags, by = "id")
```


## additional bad tests

* tests where fid2 is out of range

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  ecoc <- dplyr::mutate(ecoc, qc = ifelse(grepl("ok", fid2),
                                                 as.character(qc), "bad")) 
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  bad <- dplyr::filter(ecoc, qc == "bad") %>% dplyr::select(id)

  maybe <- dplyr::filter(ecoc, qc == "maybe") %>% dplyr::select(id)
```

## bad tests

* the following tests are flagged as bad: `r unique(bad$id)`.

* the following tests are flagged as maybe bad: `r unique(maybe$id)`.

# Reformat

* select columns of interest (others?)
* longer format with columns: `pol = ec, oc or tc` containing the pollutant name and `ug_sq_cm` containing the measured value

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  ecoc_long <- dplyr::select(ecoc,
                             id, id_test, 
                             oc_ug_sq_cm, ec_ug_sq_cm, tc_ug_sq_cm,
                             datetime, date, time,
                             flow,
                             start, end,
                             qc,
                             type,
                             punch_area,
                             analyst) %>%
                tidyr::gather("pol", "ug_sq_cm",
                              ec_ug_sq_cm,
                              oc_ug_sq_cm,
                              tc_ug_sq_cm) %>%
                dplyr::mutate(pol = ifelse(pol == "ec_ug_sq_cm",
                                           "ec", pol),
                              pol = ifelse(pol == "oc_ug_sq_cm",
                                           "oc", pol),
                              pol = ifelse(pol == "tc_ug_sq_cm",
                                           "tc", pol)) %>%
                dplyr::mutate(test_type = ifelse(grepl("^BG", id_test), "background", "test"))
```


# Background analysis

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  area <- 11.79  # filter area (cm^2)
```

* extract "good" background data
* remove missing data
* calculate average concentration emitted ( and other stats)
* calculate averge background by pollutant / type
* the filter areas is `r area ` cm^2.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  bg <- dplyr::filter(ecoc_long, test_type == "background", qc != "bad") %>%
        na.omit() %>%
        dplyr::mutate(dur = end - start) %>%
        dplyr::mutate(conc = ug_sq_cm * area * 1000 * 60 / (flow * dur)) %>%
        dplyr::group_by(pol, id, type) %>%
        dplyr::summarise(rep_mean = mean(conc)) %>%
        dplyr::ungroup() %>%
        dplyr::group_by(pol, type) %>%
        dplyr::summarise(mean = mean(rep_mean),
                         sd = sd(rep_mean),
                         min = min(rep_mean),
                         max = max(rep_mean),
                         n = n())
```

* account for artifact

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  bg <- dplyr::select(bg, pol, type, mean) %>%
        tidyr::spread(type, mean) %>%
        dplyr::mutate(background = sample - artifact)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  knitr::kable(bg, "markdown", digits = 2)
```

# Account for artifact

```{r}
  ecoc_merged <- ecoc_long %>%
                 dplyr::filter(type != "blank", !is.na(id)) %>%
                 dplyr::mutate(dur = end - start) %>%
                 dplyr::mutate(conc = ug_sq_cm * area * 1000 * 60 / (flow * dur)) %>% # ug/l converted to ug/m^3. time converted from seconds to minutes since flow rates in lpm.
                 dplyr::select(id, id_test, conc, type, pol) %>%
                 tidyr::spread(type, conc) %>%
                 dplyr::mutate(artifact = ifelse(is.na(artifact), 0, artifact),
                               value_raw = sample - artifact,
                               units = "ug/m3")
```

## Remove background from data

```{r}
  ecoc_merged <- ecoc_merged %>%
                 dplyr::left_join(dplyr::select(bg, pol, background),
                                  by = "pol") %>%
                 dplyr::mutate(value = value_raw - background)
```


# Save merged file

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  saveRDS(ecoc_merged, file ="../r_files/ecoc_merged.RDS")
```

# Plots

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  ecoc_merged <- dplyr::left_join(ecoc_merged,
                                  dplyr::select(samples, id, stove, fuel),
                                                by = "id") %>%
                 dplyr::mutate(id= as.factor(id))
```


