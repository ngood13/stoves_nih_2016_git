---
title: "ISEE 2017 Presentation"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r load_libraries, echo=FALSE, message=FALSE}
  library(tidyverse)
  library(knitr)
```

```{r global_options, include=FALSE}
  knitr::opts_chunk$set(fig.path='figures/', warning=FALSE, message=FALSE, cache=FALSE)
```

# tidy data

## load data

```{r load_data}
  emissions <- readRDS("../r_files/emissions_factors.RDS")
  load("../r_files/samples.Rda")
```

# merge with sample info

```{r merge_data}
  # Use carbon balance method for missing emissions factors
  emissions %<>%
    dplyr::filter(qc != "bad") %>%
    dplyr::mutate(mass_ef_comb = ifelse(is.na(mass_ef),
                                        mass_c_ef, mass_ef)) %>%
    dplyr::mutate(energy_ef_comb = ifelse(is.na(energy_ef), energy_c_ef,
                                          energy_ef)) %>%
    dplyr::select(id, pol, inst, mass_ef_comb, energy_ef_comb) %>%
    tidyr::gather("var", "val", 4:5)
```

# aerosol composition bar charts

## tidy aerosol data

```{r}
  # aerosols <- emissions %>% 
  #             dplyr::filter(grepl("ecoc|grav|ions", inst)) %>%
  #             dplyr::filter(pol != "tc") %>%
  #             dplyr::group_by(id, inst, var) %>%
  #             dplyr::mutate(ions = if(inst == "ions") val else 0) %>%
  #             dplyr::summarise_if(is.numeric, sum)
```


```{r sum_ions}
  # sum ion data
  ions <-
    emissions %>% 
    dplyr::filter(inst == "ions") %>%
    dplyr::group_by(id, var) %>%
    dplyr::summarise_if(is.numeric, sum) %>%
    dplyr::mutate(pol = "ions")
```

```{r aerosol_var}
  # create aerosol variable
  aerosols <-
    emissions %>% 
    dplyr::filter(grepl("ecoc|grav", inst)) %>%
    dplyr::filter(pol != "tc") %>%
    dplyr::select(-inst) %>%
    dplyr::bind_rows(ions)
```

```{r }
  # plot ec + oc vs. grav
  aerosols_p <-
    aerosols %>%
    dplyr::filter(var == "mass_ef_comb") %>%
    dplyr::select(-var) %>%
    dplyr::group_by(id) %>%
    tidyr::spread(pol, val)
```

