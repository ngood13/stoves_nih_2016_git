---
title: "VOCs"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
  library(forcats)
  library(lubridate)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  source("../r_scripts/R_tidy.R")
  source("../r_scripts/R_functions.R")
```

# Load data

Test metadata: 

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  samples <- readRDS("../r_files/samples.RDS") 
  times   <- readRDS("../r_files/test_times_all.RDS")
  notes   <- readRDS("../r_files/notes.RDS")
``` 

 VOCs (ppbv)

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  voc <- readRDS("../r_files/voc.RDS")
```

# Organize

### VOCs

Remove tests with missing values and convert timestamps. 

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}

  df_voc <- dplyr::mutate(voc, start_time = hms(start_time),
                               stop_time  = hms(stop_time),
                               start_time = period_to_seconds(start_time),
                               stop_time  = period_to_seconds(stop_time)) %>%
            dplyr::filter(!is.na(id),
                          id != "NA",
                          stop_reading != "X",
                          stop_reading != 0) %>%
            tidyr::gather("pol", "ppb", c(benzene, toluene, ethylbenzene,
                                          `m+p-xylene`, `o-xylene`)) 
```

### Timestamps

Compare the timestamps from the master timestamp .RDS file to the start and stop times from the VOC data file.  

First, select and combine the timestamps from the two sources. 

```{r}
  df_times <- dplyr::filter(times, var %in% c("ignite","set_1","end",
                                              "start_voc","end_voc")) %>%
              tidyr::spread(var, value) %>%
              dplyr::select(id,ignite,set_1,start_voc,end_voc,end) %>%
              dplyr::left_join(dplyr::select(df_voc, id, start_time, stop_time),
                               by = c("id")) %>%
              dplyr::distinct() 
```

Round each timestamp to the nearest second. Then, compare the starting and ending timestamps for the VOC samples. 

```{r}
  df_times <- dplyr::mutate(df_times,
                            start_voc   = round(start_voc),
                            end_voc     = round(end_voc),
                            start_time  = round(start_time),
                            stop_time   = round(stop_time),
                            start_equal = ifelse(start_voc == start_time, TRUE, FALSE),
                            end_equal   = ifelse(end_voc   == stop_time,  TRUE, FALSE))
```

Select tests for which timestamps do not agree:

```{r}
  df_unequal <- dplyr::filter(df_times, (start_equal == FALSE) | (end_equal == FALSE))
```

There is only one test for which the timestamps in the master timestamp dataframe do not agree with the timestamps in the VOC data file.  The ending timestamp from the master timestamp dataframe is clearly wrong, since is is before the test start time.  The ending timestamp from the VOC data file matches the ending time for the test. 

### Notes

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  df_notes <- dplyr::filter(notes, grepl("voc|all", inst))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  knitr::kable(dplyr::filter(df_notes, grepl(".*voc.*", inst)) %>%
               dplyr::select(-inst, -date),
               "markdown", digits = 2)
```

Apply flags: `bad` preceeds `maybe` preceeds `good`

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  flags <- dplyr::select(df_notes, id, qc) %>%
           dplyr::group_by(id) %>%
           dplyr::arrange(qc) %>%
           dplyr::summarise(qc = first(qc))
```

### Combine

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  df_voc <- dplyr::left_join(df_voc, flags, by=c("id")) %>%
            dplyr::mutate(qc  = ifelse(is.na(qc), "ok", qc),
                          dur = (stop_time - start_time) / 60) # minutes
```

# LOD

1. Add LOD flag  
2. Replace pollutant values below the LOD with `NA`

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  df_voc <- dplyr::mutate(df_voc,
                          lod = ifelse(ppb == -8888, "below", "above"),
                          ppb = ifelse(lod == "below", NA, ppb),
                          lod = as.factor(lod))
```

# Background

Select background tests.  

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  df_bg <- dplyr::filter(df_voc, substr(id,1,2) == "BG")
```

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  df_bg <- dplyr::group_by(df_bg, pol) %>%
           dplyr::summarise(mean = mean(ppb),
                            sd = sd(ppb),
                            min = min(ppb),
                            max = max(ppb),
                            n = n())
```

Average background values (ppb)

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  knitr::kable(df_bg, "markdown", digits = 2)
```

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  df_bg <- dplyr::select(df_bg, pol, mean) %>%
           dplyr::rename(ppb_bg = mean)

  df_voc <- dplyr::left_join(df_voc, df_bg, by=c("pol")) %>%
            dplyr::mutate(ppb_bg = ifelse(is.na(ppb_bg), 0, ppb_bg))
```

# Save

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  saveRDS(df_voc, file="../r_files/voc_merged.RDS")
```

* VOCs were measured for `r length(unique(df_voc$id))` experiments between `r min(df_voc$date, na.rm = TRUE)` and `r max(df_voc$date, na.rm = TRUE)`.  
* There are no VOC data for tests: `r setdiff(as.character(samples$id), as.character(df_voc$id))`.
* VOCs data are expected to be missing for: zero tests.  

# Plots

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=6, fig.height=8}
  p_data <- dplyr::left_join(df_voc, 
                             dplyr::select(samples, id, fuel),
                             by = "id") 

  ggplot(p_data, aes(id, ppb, colour = fuel)) + 
         geom_point() +
         facet_wrap(~pol, ncol = 1, scales = "free_y") +
         theme_minimal() +
         theme(legend.position = "top") +
         ylab("ppb") +
         xlab("") +
         theme(axis.text.x = element_text(angle = 60, hjust = 1))
```
