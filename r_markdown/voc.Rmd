---
title: "VOCs"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
  library(forcats)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  source("../r_scripts/R_tidy.R")
  source("../r_scripts/R_functions.R")
```

# Load data

 * voc (ppbv)

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  data <- readRDS("../r_files/voc.RDS")
```

* metadata

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  test_info <- readRDS("../r_files/test_info.RDS")
  times_fuel <- readRDS("../r_files/times_fuel.RDS")
  times_bg <- readRDS("../r_files/times_bg.RDS")
  times_test <- readRDS("../r_files/times_test.RDS")
  notes <- readRDS("../r_files/notes.RDS")
```

# Organize

* make longer and remove `NA`.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  voc <- tidyr::gather(data, "pol", "ppb", starts_with("voc_")) %>%
                dplyr::filter(!is.na(id) & id != "NA")
```

* merge with test data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  voc <- dplyr::rename(voc, id_test = id) %>%
          dplyr::mutate(id_test = sub("\\.", "", id_test)) %>%
          dplyr::left_join(test_info, voc, by = "id_test")
                                 
```

# LOD

* Add LOD flag
* Replace pollutant values below LOD with `NA`.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  voc <- dplyr::mutate(voc,
                           lod = as.factor(ifelse(ppb == -8888,
                           "below",
                           "above")),
                       ppb = ifelse(ppb == -8888,
                                    NA,
                                    ppb))
```

# QC

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  notes <- dplyr::filter(notes, grepl(".*voc.*|.*all.*", notes)) %>%
           dplyr::mutate(qc = "ok")
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  voc <- dplyr::left_join(voc,
                          dplyr::select(notes, id, qc),
                          by = "id") %>%
         dplyr::mutate(qc = "ok")
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  knitr::kable(dplyr::filter(notes, grepl(".*voc.*", notes)) %>%
               dplyr::select(-date),
               "markdown", digits = 2)
```

# Background

* extract good background data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  bg <- dplyr::filter(voc, type == "bg", qc == "ok") %>%
        dplyr::mutate(ppb = ifelse(is.na(ppb), 0, ppb)) %>%
        na.omit() %>%
        dplyr::select(-id_can, -id_voc)
```

* plot vocs with a background test higher than 10 ppb (note box plots contain all data points)

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=12, fig.height=8}
  p_data <-  dplyr::group_by(bg, pol) %>%
             dplyr::mutate(max = max(ppb)) %>%
             dplyr::ungroup() %>%
             dplyr::filter(max > 10) %>%
             dplyr::group_by(pol) %>%
             dplyr::mutate(outlier = ifelse(is_outlier(ppb), as.character(id), NA),
                           mean = mean(ppb, na.rm = TRUE)) %>%
             dplyr::ungroup() %>%
             dplyr::mutate(pct = round(percent_rank(mean), 1))

  ggplot(p_data, aes(pol, ppb)) +
    geom_boxplot(outlier.size = 0) +
    geom_point() +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ylab("ppb") + xlab("pollutant") +
    geom_text(aes(label = outlier), na.rm = TRUE, hjust = -0.3, size = 4)

```

## average background

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  bg <- dplyr::group_by(bg, pol) %>%
        dplyr::summarise(mean = mean(ppb),
                         sd = sd(ppb),
                         min = min(ppb),
                         max = max(ppb),
                         n = n())
```

* background values (ppb)

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  knitr::kable(bg, "markdown", digits = 2)
```

## merge background

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  bg <- dplyr::select(bg, pol, mean) %>%
        dplyr::rename(ppb_bg = mean)

  voc <- dplyr::left_join(voc, bg, by = "pol") %>%
         dplyr::mutate(ppb_bg = ifelse(is.na(ppb_bg), 0, ppb_bg))
```

# Save

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  saveRDS(voc, file="../r_files/voc_merged.RDS")
```

# Summary

VOCs were measured for `r length(unique(voc$id))` experiments between `r min(voc$date, na.rm = TRUE)` and `r max(voc$date, na.rm = TRUE)`. There is no VOC data for tests: `r setdiff(as.character(test_info$id), as.character(voc$id))`.

VOCs data is expected to be missing for: ?

# Plots

## plot by fuel type

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=20, fig.height=250}
  ggplot(voc, aes(id, ppb, colour = fuel_type)) +
         geom_point(size = 5) +
         facet_wrap(~pol, ncol = 1, scales = "free") +
         theme_minimal() +
         theme(legend.position = "top") +
         ylab("ppb") +
         xlab("") +
         theme(text = element_text(size = 28),
               axis.text.x = element_text(angle = 60, hjust = 1))
```
