---
title: "VOCs"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
  library(forcats)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  source("../r_scripts/R_tidy.R")
```

# Load data

 * voc (ppbv)

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  load("../r_files/voc.Rda")
```

* metadata

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  load("../r_files/samples.Rda")     # load sample meta data
  load("../r_files/fuel_burnt.Rda")  # fuel use meta data
  load("../r_files/emissions.Rda")   # load pollutant emissions data
  load("../r_files/data_1.Rda")
  load("../r_files/notes.Rda")
``` 

* The columns `stove` and `fuel` contain the exact stove and fuel type (e.g., "Ceramic Charcoal (Artisan), Coconut Charcoal") that corresponds with the number of the `id` (3 replicates per id number, specified by A, B, and C (sometimes additional replicates, [i.e. D or E], is also included). The columns `stovecat` and `fuelcat` contain broader categories of stoves and fuels (e.g., "improved, charcoal").

# Organize

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  voc_merged <- dplyr::filter(voc, grepl("^[0-9]|^G[0-9]", id) == TRUE)
```

## longer format

* make longer and remove `NA`.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  voc_merged <- tidyr::gather(voc_merged, "pol", "ppb", starts_with("voc_")) %>%
                dplyr::filter(!is.na(id) & id != "NA")
```

# merge with meta data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  voc_merged <- dplyr::left_join(voc_merged,
                                 dplyr::select(data_1,
                                               matches("_voc|voc_|^id$|^date$")))
```

# LOD

* Add LOD flag
* Replace pollutant values below LOD with `NA`.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  voc_merged <- dplyr::mutate(voc_merged,
                              lod = as.factor(ifelse(ppb == -8888,
                                                     "below",
                                                     "above"))) %>%
                dplyr::mutate(ppb = ifelse(ppb == -8888,
                                           NA,
                                           ppb))
```

# QC

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  notes <- dplyr::filter(notes, grepl("voc|all", inst))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  knitr::kable(dplyr::filter(notes, grepl(".*voc.*", inst)) %>%
               dplyr::select(-inst, -date),
               "markdown", digits = 2)
```

Flag bad data from notes and plots

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  notes$qc[33:36] <- "maybe"
```

Set one flag per test

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  flags <- dplyr::select(notes, id, qc) %>%
           dplyr::group_by(id) %>%
           dplyr::arrange(qc) %>%
           dplyr::summarise(qc = first(qc))
```

Merge with data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  voc_merged <- dplyr::left_join(voc_merged, flags, by = "id") %>%
                dplyr::mutate(id = as.factor(id)) %>%
                dplyr::mutate(qc = as.factor(ifelse(is.na(qc), "ok", as.character(qc))))
```

Additional bad tests

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  # voc_merged$qc[grav_merged$id == ""] <- "bad"
```

Filter out bad tests

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  voc_merged <- dplyr::filter(voc_merged, qc != "bad")
```

## Background analysis

* extract background data
* deal with LOD (not implemented)
* remove missing data
* calculate mean ppbv emitted (and other stats)

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  bg <- dplyr::filter(voc_merged, type == "bg", qc == "ok") %>%
        dplyr::mutate(ppb = ifelse(is.na(ppb), 0, ppb)) %>%
        na.omit() %>%
        dplyr::select(-id_can, -id_voc) %>%
        dplyr::group_by(pol) %>%
        dplyr::summarise(mean = mean(ppb),
                         sd = sd(ppb),
                         min = min(ppb),
                         max = max(ppb),
                         n = n())
```

#Plot background

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=20}
    ggplot(bg, aes(pol, mean, ymin = min, ymax = max)) + 
         geom_pointrange(size = 0.5) +
         theme_minimal() +
         theme(axis.text.x = element_text(angle=45, hjust=1)) +
         ylab("ppb") + xlab("pollutant")
         
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  knitr::kable(bg, "markdown", digits = 2)
```

* merge with test data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
 # extract data for merge
  bg <- dplyr::select(bg, pol, mean) %>%
        dplyr::rename(ppb_bg = mean)

 # merge and add zeros for missing values
  voc_merged <- dplyr::left_join(voc_merged, bg, by = "pol") %>%
                dplyr::mutate(ppb_bg = ifelse(is.na(ppb_bg), 0, ppb_bg))
```

## Save merged file

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  save(voc_merged, file="../r_files/voc_merged.Rda")
```

## Plot (coloured by fuel type)

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  load(file="../r_files/samples.Rda")

  samples <- dplyr::select(samples, id, stove, fuel)

# change factor order
  samples$stove <- factor(samples$stove, levels = c("Three Stone Fire (Artisan)", "Clay Ring (Artisan)",
                          "Built-in Justa (Envirofit, HM5000)", "Rocket Elbow (Envirofit, G3300)",
                          "Fan Rocket Elbow (Biolite, HomeStove)", "Ceramic Charcoal (Artisan)",
                          "Metal Charcoal (Burn, Jikokoa)", "Gasifier (Philips, HD4012)",
                          "Gasifer (Mimi Moto, Mimi Moto)",
                          "Gasifier (Envirofit, Prototype)", "Wick Kerosene (Cook 'n Lite, 82)",
                          "Pressurized Kerosene (Butterfly, 2412)", "Pressurized LPG (WokSmith, WS-C1-25K)"))
    
  samples$fuel <- factor(samples$fuel, levels = c("Douglas Fir", "Oak", "Eucalyptus", "Lump Hardwood (Sm.)",
                        "Lump Hardwood (Med.)", "Coconut Charcoal", "West Slope Pellets", "Eucalyptus Pellets",
                        "Kerosene", "Liquefied Petroleum Gas"))

  voc_p <- dplyr::left_join(voc_merged, samples, by = "id") %>%
           dplyr::mutate(pol = sub("^voc_", "", pol)) %>%
           dplyr::mutate(id = as.factor(id))
  
 # filter out background data and non-detects 
  voc_p <- dplyr::filter(voc_p, ppb > 0 & grepl("^P", id)==FALSE & grepl("^G", id)==FALSE)
```

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=20, fig.height=250}
  #ggplot(voc_p, aes(id, ppb, colour = fuel)) + 
         #geom_point() +
         #facet_wrap(~pol, ncol = 1, scales = "free") +
         #theme_minimal() +
         #theme(legend.position = "top") +
         #ylab("ug/m3") + xlab("")
```

## Plot QC

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=20, fig.height=250}
  #ggplot(voc_p, aes(id, ppb, colour = qc)) + 
         #geom_point() +
         #facet_wrap(~pol, ncol = 1, scales = "free") +
         #theme_minimal()
```

## Select pollutant of interest and merge with fuel burnt and metadata 

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  benzene <- dplyr::filter(emissions,  pol == "voc_benzene")
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}  
  benzene <- dplyr::left_join(benzene, 
                              dplyr::select(samples, id, fuel, stove, fuelcat, stovecat),
                              by = "id") %>%
             dplyr::left_join(fuel_burnt, by = "id")
```

* The `benzene` dataframe now contains a subset of the emissions data for only the pollutant benzene. A summary of the dataset is below:  

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  summary(benzene)
```

## Calculate Emissions Factor

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  benzene <- dplyr::mutate(benzene, pol_fuel_mass_ratio = (mass_emitted * 1e-3) / (mass_fuel*1e-3))  # ug * 1e-6 / g
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  summary(benzene$pol_fuel_mass_ratio)
```

* units: miligram of pollutant emitted per kilogram of fuel burned 

# Plots

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width = 12}
  ggplot(benzene, aes(x= id, pol_fuel_mass_ratio, colour = fuelcat)) +
    geom_point() +
    ggtitle("Benzene EFs by Test ID") +
    xlab("Test ID") +
    ylab("g emitted / g fuel burned") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width = 10}
  ggplot(benzene, aes(x= stove, pol_fuel_mass_ratio, colour = fuel)) +
    geom_point() +
    ggtitle("Benzene EFs by Stove") +
    xlab("Stove type") +
    ylab("mg emitted / kg fuel burned") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width = 10}
  ggplot(benzene, aes(x= stove, pol_fuel_mass_ratio, colour = fuel)) +
    geom_point() +
    facet_grid( ~ stovecat, scales = 'free') +
    ggtitle("Benzene EFs by Stove Type") +
    xlab("Stove type") +
    ylab("mg emitted / kg fuel burned") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```


```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width = 10}
  ggplot(benzene, aes(x= stove, pol_fuel_mass_ratio, colour = stovecat)) +
    geom_point() +
    facet_grid( ~ fuelcat, scales = 'free') +
    ggtitle("Benzene EFs by Fuel Type and Stove Type") +
    xlab("Stove type") +
    ylab("mg emitted / kg fuel burned") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45,  hjust = 0.9))
```


```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width = 10}
  ggplot(benzene, aes(x= id, pol_fuel_mass_ratio, colour = fuel)) +
    geom_point() +
    facet_wrap(fuelcat ~ stovecat) +
    ggtitle("Benzene EFs by Stove and Fuel categories") +
    xlab("Stove type") +
    ylab("mg emitted / kg fuel burned") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```


```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width = 10}
  ggplot(filter(benzene, fuelcat == 'wood'), aes(x= id, pol_fuel_mass_ratio, colour = fuel)) +
    geom_point() +
    facet_grid( ~ stove, scales = 'free') +
    ggtitle("Benzene EFs by Stove Type - Wood Stoves Only") +
    xlab("Stove type") +
    ylab("mg emitted / kg fuel burned") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1))
```



```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width = 10}
ggplot(filter(benzene, fuelcat == 'charcoal'), aes(x= id, pol_fuel_mass_ratio, colour = fuel)) +
  geom_point() +
  facet_grid( ~ stove, scales = 'free') +
  ggtitle("Benzene EFs by Stove Type - Charcoal Stoves Only") +
  xlab("Stove type") +
  ylab("mg emitted / kg fuel burned") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

$VOCs$ were measured for `r length(unique(voc_merged$id))` experiments between `r min(voc_merged$date, na.rm = TRUE)` and `r max(voc_merged$date, na.rm = TRUE)`. There is no $VOC$ data for tests: `r setdiff(as.character(samples$id), as.character(voc_merged$id))`.

$VOCs$ data is expected to be missing for: G18 only. We did not collect a canister for this test due to supply shortage.

# Flag additional bad tests based on qaqc

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  # voc_merged$qc[grav_merged$id == ""] <- "bad"
```
