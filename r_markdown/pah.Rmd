---
title: "PAHs"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r load_libraries, echo=FALSE, message=FALSE, warning = FALSE}
  library(tidyverse)
  library(knitr)
  library(kableExtra)
```

```{r global_options, echo=FALSE}
  knitr::opts_chunk$set(fig.path ='figures/', fig.height = 5, fig.width = 12,
                        echo = FALSE,
                        warning = FALSE, message = FALSE, cache = FALSE)
```

```{r load_source}
  # load source files
  source("../r_scripts/R_load_data.R")
  source("../r_scripts/R_load_metadata.R")
  source("../r_scripts/R_tidy.R")
```

```{r load_data}
  # load pah data
  pah_raw <- readRDS("../r_files/pah.RDS")    # pah dataset
  pah_lod <- readRDS("../r_files/pah_lod.RDS")    # pah lod dataset
```

```{r load_metadata}
  # load metadata
  load("../r_files/data_1.Rda")
  load("../r_files/notes.Rda")
  load("../r_files/samples.Rda")
```

```{r}
  # Extract chemical analysis lod data
  lod <-
    pah_lod %>%
    dplyr::mutate(lod = ifelse(val == "BDL", "below", "above")) %>%
    dplyr::select(-val)
```

```{r}
  # Calculate new value if measurement below instrument lod
  # Replace values below the lod and loq with lod/sqrt(2)
  pah <- 
    pah_raw %>% 
    dplyr::mutate(val = as.numeric(val)) %>%
    dplyr::left_join(lod, by = c("id_asu", "id", "filter_type", "pol")) %>%
    dplyr::group_by(id, pol, filter_type) %>%
    dplyr::summarise(val = last(val), lod = last(lod)) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(val_lod_adj = ifelse(lod == "below", val / sqrt(2), val))
```

```{r}
  # Extract notes for pah
  notes <- 
    notes %>%
    dplyr::filter(grepl("pah|all", inst) == TRUE)
```

```{r}
  # Apply flags: bad preceeds maybe preceeds good
  flags <-
    notes %>%
    dplyr::select(id, qc) %>%
    dplyr::group_by(id) %>%
    dplyr::arrange(qc) %>%
    dplyr::summarise(qc = first(qc))
```

```{r}
  # Merge data with flags
  pah <-
    pah %>%
    dplyr::left_join(flags, by = "id") %>%
    dplyr::mutate(id = as.factor(id)) %>%
    dplyr::mutate(qc = as.factor(ifelse(is.na(qc), "ok", as.character(qc))))
```

```{r}
  # Filter out bad tests
  pah <-
    pah %>% 
    dplyr::filter(qc != "bad")
```

```{r}
  # Define new variable called test type
  pah <- 
    pah %>%
    dplyr::mutate(test_type = ifelse(!grepl("^B|^G", id), "test", "bg"),
                  test_type = ifelse(grepl("^B", id), "blank", test_type))
```

# Blank analysis 

```{r}
  # Extract blank pufs and blank filters
  blanks <-
    pah %>%
    dplyr::filter(test_type == "blank")
```

## Plot 1: Lab blanks

Lab blanks (ug):

* grouped by pollutant
* plotted and colored by filter type
* shape indicates if sample was above or below instrument lod

```{r pah_blank_plot, echo=FALSE, fig.height = 20}
 blanks %>%
    dplyr::filter(!is.na(val)) %>%
    dplyr::mutate(filter_type = 
                    filter_type %>% 
                    forcats::fct_recode("back puf" = "b",
                                        "front puf" = "f",
                                        "filter" = "ba")) %>%
    ggplot(aes_string(x = "filter_type", y = "val_lod_adj")) +
      geom_boxplot(aes(fill = filter_type), outlier.colour = NA) +
      geom_jitter(aes(shape = factor(lod)), size = 4,  width = 0.2) + 
      scale_shape(solid = FALSE) +
      guides(fill = FALSE) +
      theme_bw() +
      scale_y_log10() +
      theme(text = element_text(size = 20),
            legend.position = "top") +
      labs(shape = "chemical analysis lod") +
      facet_wrap(~pol, ncol = 3, scales = "free") +
      ylab("") +
      xlab("")
```

## Table 1: Lab blanks below lod for chemical analysis

Lab blanks below lod for chemical analysis (%):

* values given by pollutant and filter type

```{r}
  blanks %>%
    dplyr::mutate(filter_type = 
                    filter_type %>% 
                    forcats::fct_recode("back puf" = "b",
                                        "front puf" = "f",
                                        "filter" = "ba")) %>%
    dplyr::group_by(filter_type, pol) %>%
    dplyr::do(val = round(nrow(filter(., lod == "below"))/nrow(.), 2) * 100) %>%
    dplyr::mutate(val = cell_spec(val, "html", color = ifelse(val > 10, "red", "blue"))) %>%
    tidyr::spread(filter_type, val) %>%
    dplyr::rename("pah type" = "pol") %>%
    knitr::kable("markdown", align = 'c')
```

* Total percent of blanks below chemical analysis lod: `r round(nrow(filter(blanks, lod == "below")) / nrow(blanks), 2) * 100`%.

## Table 2: Lab blanks with NA values

Lab blanks with NA values (%):

* values given by pollutant and filter type

```{r}
  blanks %>%
    dplyr::mutate(filter_type = 
                    filter_type %>% 
                    forcats::fct_recode("back puf" = "b",
                                        "front puf" = "f",
                                        "filter" = "ba")) %>%
    dplyr::group_by(filter_type, pol) %>%
    dplyr::do(val = round(nrow(filter(., is.na(val_lod_adj) == TRUE))/nrow(.), 2) * 100) %>%
    dplyr::mutate(val = cell_spec(val, "html", color = ifelse(val > 10, "red", "blue"))) %>%
    tidyr::spread(filter_type, val) %>%
    dplyr::rename("pah type" = "pol") %>%
    knitr::kable("markdown", align = 'c')
```

* Total percent of blanks with NA measurements: `r round(sum(is.na(blanks$val)) / nrow(blanks), 2) * 100`%.
* Total percent of 'bad' blank measurements: `r round(nrow(filter(blanks, lod == "below", is.na(val))) / nrow(blanks), 2) * 100`%.

```{r}
  blanks <-
    blanks %>%
    dplyr::group_by(pol, filter_type) %>%
    dplyr::summarise(bk_mean = mean(val_lod_adj, na.rm = TRUE),
                     bk_median = median(val_lod_adj, na.rm = TRUE),
                     bk_sd = sd(val_lod_adj, na.rm = TRUE)) %>%
    dplyr::mutate(filter_type = 
                    filter_type %>% 
                    forcats::fct_recode("p" = "ba"))
```

```{r, include=FALSE}
  # summary table of blank data
  blanks %>%
    dplyr::mutate(filter_type = 
                    filter_type %>% 
                    forcats::fct_recode("back puf" = "b",
                                        "front puf" = "f",
                                        "filter" = "p")) %>%
    knitr::kable(digits = 2, align = 'c',
                 col.names = c("type of pah", "filter type", "mean", "median", "standard deviation"))
```

```{r}
  # remove lab blanks from pah_merged file
  pah_merged <-
    pah %>%
    dplyr::filter(test_type != "blank") # remove blanks
```



```{r}
  # check for missing data
  pah_missing <-
    pah_merged %>%
    dplyr::select(id, pol, filter_type) %>%
    dplyr::ungroup() %>%
    dplyr::group_by(id, filter_type) %>%
    dplyr::summarise(n = n()) %>%
    tidyr::spread(filter_type, n) %>%
    dplyr::filter(!grepl("10D|8E|D2", id)) %>%
    tidyr::gather("filter_type", "n", 2:4) %>%
    dplyr::filter(is.na(n)) %>%
    dplyr::select(-n)
```

# Table 3: Missing filter measurements

```{r}
  pah_missing %>%
    dplyr::mutate(filter_type = 
                    filter_type %>% 
                    forcats::fct_recode("back puf" = "b",
                                        "front puf" = "f",
                                        "filter" = "p")) %>%
    knitr::kable("markdown", align = 'c')
```

* We have measurements for 10D-B and 8E-B, which weren't tests that were run. Could either of these fit one of our missing filters?
* Any tests that are missing a filter or front puf are removed from the analysis

```{r}
  pah_missing <-
    pah_missing %>%
    dplyr::filter(filter_type != "b") %>%
    dplyr::select(id)

  # remove all data from tests that are missing a filter or front puf
  pah_merged <-
    dplyr::anti_join(pah_merged, pah_missing, by = "id")
```

```{r extract_cartridge_data}
  # Extract pah filter cartridge data
  meta <-
    data_1 %>%
    dplyr::select(matches("_red|^id$|^date$"))
```

```{r extract_flows}
  # Extra flow rate data
  flows <-
    meta %>%
    dplyr::select(matches("flow_|^id$|^date$")) %>%
    tidyr::gather("var", "value", -id, -date) %>%
    dplyr::filter(grepl("_avg$", var)==FALSE) %>%
    dplyr::mutate(type = sub("flow.*", "", var),
                  rep = as.factor(gsub("[^0-9]", "", var))) %>%
    dplyr::select(-var)  %>%
    dplyr::filter(!is.na(id)) %>%
    dplyr::group_by(rep, id, type) %>%
    dplyr::mutate(mean = mean(value, na.rm = TRUE))  %>%
    dplyr::ungroup() %>%
    dplyr::filter(rep == 1) %>%
    dplyr::select(-value, -rep, -date)  %>%
    tidyr::spread(type, mean)
```

```{r extract_times}
  # Extra time data
  times <-
    meta %>% 
    dplyr::select(matches("^time_|^id$|^date$")) %>%
    tidyr::gather("var", "value", -id, -date) %>%
    dplyr::mutate(type = ifelse(grepl("_start_", var), "start", "NA"),
                  type = ifelse(grepl("_end_", var), "end", type)) %>%
    dplyr::arrange(id) %>%
    dplyr::filter(!is.na(id)) %>%  
    dplyr::select(-var, -date) %>%  
    tidyr::spread(type, value)
```

```{r}
  # Merge pah with filter metadata
  pah_merged <-
    pah_merged %>%
    dplyr::filter(test_type != "blank") %>%
    dplyr::left_join(flows, by = "id") %>%
    dplyr::left_join(times, by = "id") %>%
    dplyr::rename(pre_flow = pre, post_flow = post) %>%
    dplyr::mutate(flow = (pre_flow + post_flow) / 2)
```

```{r}
  # Calculate concentrations
  pah_merged <-
    pah_merged %>%
    dplyr::mutate(dur = (end - start) / 60,
                  conc = val_bk_adj * 1000 / (flow * dur))
```

# Background analysis

```{r}
  # Extract background pufs (front and back) and background filters
  bg <-
    pah_merged %>%
    dplyr::filter(test_type == "bg")
```

## Plot 2: Lab backgrounds

Background concentrations (ug per meter cubed):

* grouped by pollutant
* plotted and colored by filter type
* shape indicates if sample was above or below lod calculated from lab blanks


```{r pah_bg_plot, echo=FALSE, fig.height = 20}
  bg %>%
    dplyr::filter(!is.na(conc)) %>%
    dplyr::mutate(filter_type = 
                    filter_type %>% 
                    as.factor %>%
                    forcats::fct_recode("back puf" = "b",
                                        "front puf" = "f",
                                        "filter" = "p")) %>%
    ggplot(aes_string(x = "filter_type", y = "conc")) +
      geom_boxplot(aes(fill = filter_type), outlier.colour = NA) +
      geom_jitter(aes(shape = factor(bk_lod)), size = 4,  width = 0.2) + 
      scale_shape(solid = FALSE) +
      guides(fill = FALSE) +
      theme_bw() +
      scale_y_log10() + 
      theme(text = element_text(size = 20),
            legend.position = "top") +
      labs(shape = "cookstove lab blank lod") +
      facet_wrap(~pol, ncol = 3, scales = "free") +
      ylab("") +
      xlab("")
```

## Table 3: Lab backgrounds below lod for chemical analysis

Lab backgrounds below the lod of chemical analysis (%):

* values given by pollutant and filter type

```{r}
  bg %>%
    dplyr::mutate(filter_type = 
                    filter_type %>% 
                    forcats::fct_recode("back puf" = "b",
                                        "front puf" = "f",
                                        "filter" = "p")) %>%
    dplyr::group_by(filter_type, pol) %>%
    dplyr::do(val = round(nrow(filter(., lod == "below"))/nrow(.), 2) * 100) %>%
    dplyr::mutate(val = cell_spec(val, "html", color = ifelse(val > 10, "red", "blue"))) %>%
    tidyr::spread(filter_type, val) %>%
    dplyr::rename("pah type" = "pol") %>%
    knitr::kable("markdown", align = 'c')
```

* Total percent of backgrounds below lod for chemical analysis: `r round(nrow(filter(bg, lod == "below")) / nrow(bg), 2) * 100`%.

## Table 4: Lab backgrounds with NA values

Lab backgrounds with NA values (%):

* values given by pollutant and filter type

```{r}
  bg %>%
    dplyr::mutate(filter_type = 
                    filter_type %>% 
                    forcats::fct_recode("back puf" = "b",
                                        "front puf" = "f",
                                        "filter" = "p")) %>%
    dplyr::group_by(filter_type, pol) %>%
    dplyr::do(val = round(nrow(filter(., is.na(val_lod_adj) == TRUE))/nrow(.), 2) * 100) %>%
    dplyr::mutate(val = cell_spec(val, "html", color = ifelse(val > 10, "red", "blue"))) %>%
    tidyr::spread(filter_type, val) %>%
    dplyr::rename("pah type" = "pol") %>%
    knitr::kable("markdown", align = 'c')
```

* Total percent of backgrounds with NA values: `r round(nrow(filter(bg, is.na(val_lod_adj) == TRUE))/nrow(bg), 2) * 100`%.

## Table 5: Lab backgrounds below lab blank lod

Backgrounds below lab blank lod (%):

* values given by pollutant and filter type

```{r}
  bg %>%
    dplyr::mutate(filter_type = 
                    filter_type %>% 
                    forcats::fct_recode("back puf" = "b",
                                        "front puf" = "f",
                                        "filter" = "p")) %>%
    dplyr::group_by(filter_type, pol) %>%
    dplyr::do(val = round(nrow(filter(., bk_lod == "below"))/nrow(.), 2) * 100) %>%
    dplyr::mutate(val = cell_spec(val, "html", color = ifelse(val > 10, "red", "blue"))) %>%
    tidyr::spread(filter_type, val) %>%
    dplyr::rename("pah type" = "pol") %>%
    knitr::kable("markdown", align = 'c')
```

* Total percent of backgrounds below blank lod: `r round(nrow(filter(bg, bk_lod == "below")) / nrow(bg), 2) * 100`%.

## Table 6: Lab backgrounds below lab blank loq

Backgrounds below lab blank loq (%):

* values given by pollutant and filter type

```{r}
  bg %>%
    dplyr::mutate(filter_type = 
                    filter_type %>% 
                    forcats::fct_recode("back puf" = "b",
                                        "front puf" = "f",
                                        "filter" = "ba")) %>%
    dplyr::group_by(filter_type, pol) %>%
    dplyr::do(val = round(nrow(filter(., bk_loq == "below"))/nrow(.), 2) * 100) %>%
    dplyr::mutate(val = cell_spec(val, "html", color = ifelse(val > 10, "red", "blue"))) %>%
    tidyr::spread(filter_type, val) %>%
    dplyr::rename("pah type" = "pol") %>%
    knitr::kable("markdown", align = 'c')
```

* Total percent of backgrounds below blank loq: `r round(nrow(filter(bg, bk_loq == "below")) / nrow(bg), 2) * 100`%.
* Total percent of 'bad' background values: `r (1 - round(nrow(filter(bg, lod == "above", bk_lod == "above", bk_loq == "above", is.na(val_lod_adj) == FALSE)) / nrow(bg), 2)) * 100`%.

```{r}
  bg <-
    bg %>%
    dplyr::group_by(pol, filter_type) %>%
    dplyr::summarise(bg_mean = mean(conc, na.rm = TRUE),
                     bg_median = median(conc, na.rm = TRUE),
                     bg_sd = sd(conc, na.rm = TRUE))
```

```{r, include=FALSE}
  # Summary statistics of lab backgrounds
  bg %>%
    dplyr::mutate(filter_type = 
                  filter_type %>% 
                  forcats::fct_recode("back puf" = "b",
                                      "front puf" = "f",
                                      "filter" = "p")) %>%
    knitr::kable(digits = 2, align = 'c',
                 col.names = c("type of pah", "filter type", "mean", "median", "standard deviation"))
```

# Sample analysis

```{r}
  # Extract sample pufs (front and back) and sample filters
  pah_samples <-
    pah_merged %>%
    dplyr::filter(test_type == "test")
```

```{r}
  # Subtract background concentrations
  pah_samples <-
    pah_samples %>%
    dplyr::left_join(bg, by = c("pol", "filter_type")) %>%
    dplyr::mutate(conc = conc - bg_mean)
```

## Plot 3: Lab burns

Burn concentrations (ug per meter cubed):

* grouped by pollutant
* plotted and colored by filter type

```{r, echo=FALSE, fig.height = 20}
  pah_samples %>%
    dplyr::filter(!is.na(conc)) %>%
    dplyr::mutate(filter_type = 
                    filter_type %>% 
                    as.factor %>%
                    forcats::fct_recode("back puf" = "b",
                                        "front puf" = "f",
                                        "filter" = "p")) %>%
    ggplot(aes_string(x = "filter_type", y = "conc")) +
      geom_boxplot(aes(fill = filter_type), outlier.colour = NA) +
      geom_jitter(aes(shape = factor(bk_lod)), size = 4,  width = 0.2) + 
      scale_shape(solid = FALSE) +
      guides(fill = FALSE) +
      theme_bw() +
      scale_y_log10() +
      theme(text = element_text(size = 20),
            legend.position = "top") +
      labs(shape = "lab blank lod") +
      facet_wrap(~pol, ncol = 3, scales = "free") +
      xlab("") +
      ylab("")
```

## Plot 4: Summed gas and particle phase concentrations

Total particle and gas phase pah concentrations (ug per meter cubed):

* plotted (and colored) by stove type

```{r, echo=FALSE, fig.height = 65}
  pah_samples %>%
    dplyr::filter(!is.na(conc), !grepl("27|28|29|30", id)) %>%
    dplyr::group_by(id, pol, filter_type) %>%
    dplyr::summarise(conc = sum(conc)) %>%
    dplyr::left_join(dplyr::select(samples, id, stove), by = "id") %>%
    dplyr::mutate(stove = 
                    stove %>% 
                    factor %>% 
                    tolower %>%
                    gsub(" [:(:].*[:):]", "",.) %>%
                    forcats::fct_recode("lpg" = "pressurized lpg") %>%
                    forcats::fct_recode("pressure kerosene" =
                                          "pressurized kerosene")) %>% 
    ggplot(aes_string(x = "stove", y = "conc")) +
      geom_boxplot(aes(fill = stove), outlier.colour = NA) +
      geom_jitter(size = 4,  width = 0.2, shape = 1) + 
      scale_shape(solid = FALSE) +
      guides(fill = FALSE) +
      theme_bw() +
      scale_y_log10() +
      theme(text = element_text(size = 20),
            axis.text.x = element_text(angle = 15, hjust = 1, vjust = 1),
            legend.position = "none") +
      facet_wrap(~pol, ncol = 1, scales = "free") +
      ylab("") +
      xlab("")
```

## Plot 5: Summed gas and particle phase concentrations

Total particle and gas phase pah concentrations (ug per meter cubed):

* plotted (and colored) by fuel type

```{r, echo=FALSE, fig.height = 65}
  pah_samples %>%
    dplyr::filter(!is.na(conc), !grepl("27|28|29|30", id)) %>%
    dplyr::group_by(id, pol, filter_type) %>%
    dplyr::summarise(conc = sum(conc)) %>%
    dplyr::left_join(dplyr::select(samples, id,
                                   stove, fuel,
                                   stovecat, fuelcat), by = "id") %>%
    dplyr::mutate(fuel = 
                    fuel %>% 
                    factor %>% 
                    tolower) %>%
    ggplot(aes_string(x = "fuel", y = "conc")) +
      geom_boxplot(aes(fill = fuel), outlier.colour = NA) +
      geom_jitter(size = 4,  width = 0.2, shape = 1) + 
      scale_shape(solid = FALSE) +
      guides(fill = FALSE) +
      theme_bw() +
      scale_y_log10() +
      theme(text = element_text(size = 20),
            axis.text.x = element_text(angle = 15, hjust = 1, vjust = 1),
            legend.position = "none") +
      facet_wrap(~pol, ncol = 1, scales = "free") +
      ylab("") +
      xlab("")
```

```{r, echo=FALSE, fig.height = 60, include=FALSE}
## Plot 5: Ratio of particle phase pahs to total pahs

#Ratio of particle phase pahs to total pahs (particle + gas):

#* grouped by stove type and colored by fuel category
#* mean shown with an x
#* median shown with a square
# 
#   pah_samples %>%
#     dplyr::filter(!is.na(conc), !grepl("27|28|29|30", id)) %>%
#     dplyr::mutate(filter_type = 
#                     filter_type %>%
#                     forcats::fct_recode("gas" = "b",
#                                         "gas" = "f",
#                                         "particle" = "p")) %>%
#     dplyr::group_by(id, pol, filter_type) %>%
#     dplyr::summarise(conc = sum(conc)) %>%
#     tidyr::spread(filter_type, conc) %>%
#     dplyr::mutate(sigma = particle / (particle + gas)) %>%
#     dplyr::left_join(dplyr::select(samples, id,
#                                    stove, fuel,
#                                    stovecat, fuelcat), by = "id") %>%
#     dplyr::mutate(stove = 
#                     stove %>% 
#                     factor %>% 
#                     tolower %>%
#                     gsub(" [:(:].*[:):]", "",.) %>%
#                     forcats::fct_recode("lpg" = "pressurized lpg") %>%
#                     forcats::fct_recode("pressure kerosene" =
#                                           "pressurized kerosene") %>% 
#                     gsub(" ", " \n ",.) %>% 
#                     forcats::fct_relevel("three \n stone \n fire",
#                                          "clay \n ring",
#                                          "ceramic \n charcoal",
#                                          "rocket \n elbow",
#                                          "built-in \n justa",
#                                          "metal \n charcoal",
#                                          "fan \n rocket \n elbow",
#                                          "gasifier",
#                                          "wick \n kerosene",
#                                          "pressure \n kerosene",
#                                          "lpg"),
#                   fuelcat =
#                     fuelcat %>% 
#                     factor %>%
#                     tolower,
#                   stovecat = 
#                     stovecat %>%
#                     forcats::fct_recode("insulated [improved] stoves" = "improved",
#                                         "insulated [improved] stoves" = "gasifiers",
#                                         "liquid-fuel stoves" = "advanced",
#                                         "traditional stoves" = "traditional")) %>%
#     ggplot(aes_string(x = "stove", y = "sigma")) +
#       geom_boxplot(fill = stove) +
#       geom_point(size = 4) +
#       #geom_point(size = 3, shape = 1, stroke = 2) +
#       #geom_point(stat = "summary", fun.y = "mean", colour = "black",
#       #           shape = 4, size = 4, stroke = 2) +
#       #geom_point(stat = "summary", fun.y = "median", colour = "black",
#       #           shape = 0, size = 4, stroke = 2) +
#       theme_bw() +
#       theme(text = element_text(size = 20),
#             legend.position = "none") +
#       facet_wrap(pol~stovecat, ncol = 3, scales = "free") +
#       ylab("") +
#       xlab("")
```

## Table 7: Burn samples below lod for chemical analysis

Burn samples below the lod of chemical analysis (%):

* values given by pollutant and filter type

```{r}
  pah_samples %>%
    dplyr::mutate(filter_type = 
                    filter_type %>% 
                    forcats::fct_recode("back puf" = "b",
                                        "front puf" = "f",
                                        "filter" = "p")) %>%
    dplyr::group_by(filter_type, pol) %>%
    dplyr::do(val = round(nrow(filter(., lod == "below"))/nrow(.), 2) * 100) %>%
    dplyr::mutate(val = cell_spec(val, "html", color = ifelse(val > 10, "red", "blue"))) %>%
    tidyr::spread(filter_type, val) %>%
    dplyr::rename("pah type" = "pol") %>%
    knitr::kable("markdown", align = 'c')
```

* Total percent of samples below lod for chemical analysis: `r round(nrow(filter(pah_samples, lod == "below")) / nrow(pah_merged), 2) * 100`%.

## Table 8: Burn samples with NA values

Burn samples with NA values (%):

* values given by pollutant and filter type

```{r}
  pah_samples %>%
    dplyr::mutate(filter_type = 
                    filter_type %>% 
                    forcats::fct_recode("back puf" = "b",
                                        "front puf" = "f",
                                        "filter" = "p")) %>%
    dplyr::group_by(filter_type, pol) %>%
    dplyr::do(val = round(nrow(filter(., is.na(val_lod_adj) == TRUE))/nrow(.), 2) * 100) %>%
    dplyr::mutate(val = cell_spec(val, "html", color = ifelse(val > 10, "red", "blue"))) %>%
    tidyr::spread(filter_type, val) %>%
    dplyr::rename("pah type" = "pol") %>%
    knitr::kable("markdown", align = 'c')
```

* Total percent of samples with NA values: `r round(sum(is.na(pah_samples$conc)) / nrow(pah_merged), 2) * 100`%.

## Table 9: Burn samples below background

Burn samples below the background (%):

* values given by pollutant and filter type

```{r}
  pah_samples %>%
    dplyr::mutate(filter_type = 
                    filter_type %>% 
                    forcats::fct_recode("back puf" = "b",
                                        "front puf" = "f",
                                        "filter" = "p")) %>%
    dplyr::group_by(filter_type, pol) %>%
    dplyr::do(val = round(nrow(filter(., conc <= 0))/nrow(.), 2) * 100) %>%
    dplyr::mutate(val = cell_spec(val, "html", color = ifelse(val > 10, "red", "blue"))) %>%
    tidyr::spread(filter_type, val) %>%
    dplyr::rename("pah type" = "pol") %>%
    knitr::kable("markdown", align = 'c')
```

* Total percent of samples that are negative after background correction: `r round(sum(pah_samples$conc <= 0, na.rm = TRUE) / nrow(pah_merged), 3) * 100`%.

## Table 10: Burn samples below lab blank lod

Burn samples below the lab blank lod (%):

* values given by pollutant and filter type

```{r}
  pah_samples %>%
    dplyr::mutate(filter_type = 
                    filter_type %>% 
                    forcats::fct_recode("back puf" = "b",
                                        "front puf" = "f",
                                        "filter" = "p")) %>%
    dplyr::group_by(filter_type, pol) %>%
    dplyr::do(val = round(nrow(filter(., bk_lod == "below"))/nrow(.), 2) * 100) %>%
    dplyr::mutate(val = cell_spec(val, "html", color = ifelse(val > 10, "red", "blue"))) %>%
    tidyr::spread(filter_type, val) %>%
    dplyr::rename("pah type" = "pol") %>%
    knitr::kable("markdown", align = 'c')
```

* Total percent of samples below blank lod: `r round(nrow(filter(pah_samples, bk_lod == "below")) / nrow(pah_merged), 2) * 100`%.

## Table 11: Burn samples below lab blank loq

Burn samples below lab blank loq (%):

* values given by pollutant and filter type

```{r}
  pah_samples %>%
    dplyr::mutate(filter_type = 
                    filter_type %>% 
                    forcats::fct_recode("back puf" = "b",
                                       "front puf" = "f",
                                        "filter" = "p")) %>%
    dplyr::group_by(filter_type, pol) %>%
    dplyr::do(val = round(nrow(filter(., bk_loq == "below"))/nrow(.), 2) * 100) %>%
    plyr::mutate(val = cell_spec(val, "html", color = ifelse(val > 10, "red", "blue"))) %>%
    tidyr::spread(filter_type, val) %>%
    dplyr::rename("pah type" = "pol") %>%
    knitr::kable("markdown", align = 'c')
```

* Total percent of samples below blank loq: `r round(nrow(filter(pah_samples, bk_loq == "below")) / nrow(pah_merged), 2) * 100`%.
* Total percent of 'bad' sample values: `r (1 - round(nrow(filter(pah_samples, lod == "above", bk_lod == "above", bk_loq == "above", is.na(conc) == FALSE, conc > 0)) / nrow(pah_merged), 2)) * 100`%.

# Summary analysis

## Plot 6: Boxplots of all data by pollutant and test type

Blank, test, and background data (ug):

* plotted and colored by test type
* y-axis on a log base 10 scale

```{r, echo=FALSE, fig.height = 60}
  pah %>%
    dplyr::filter(!is.na(val_lod_adj)) %>%
    dplyr::mutate(filter_type = 
                   filter_type %>% 
                   as.factor %>%
                   forcats::fct_recode("back puf" = "b",
                                       "front puf" = "f",
                                       "filter" = "p",
                                       "filter" = "ba")) %>%
    ggplot(aes_string(y = "val_lod_adj", x = "test_type", fill = "test_type")) +
      geom_boxplot(outlier.colour = NA) +
      geom_jitter(size = 4,  width = 0.2, shape = 1) + 
      scale_shape(solid = FALSE) +
      theme_bw() +
      scale_y_log10() +
      ylab("") +
      xlab("") + 
      theme(text = element_text(size = 20),
            legend.position = "none") +
      facet_wrap(pol~filter_type, ncol = 3, scales = "free")
```

## Plot 7: Boxplots of all data by pollutant and filter type

Blank, test, and background data (ug):

* plotted and colored by filter type
* y-axis on a log base 10 scale

```{r, echo=FALSE, fig.height = 60}
  pah %>%
    dplyr::filter(!is.na(val_lod_adj)) %>%
    dplyr::mutate(filter_type = 
                   filter_type %>% 
                   as.factor %>%
                   forcats::fct_recode("back puf" = "b",
                                       "front puf" = "f",
                                       "filter" = "p",
                                       "filter" = "ba")) %>%
    ggplot(aes_string(y = "val_lod_adj", x = "filter_type", fill = "filter_type")) +
      geom_boxplot(outlier.colour = NA) + 
      geom_jitter(size = 4,  width = 0.2, shape = 1) + 
      theme_bw() +
      scale_y_log10() +
      ylab("") +
      xlab("") + 
      theme(text = element_text(size = 20),
            legend.position = "none") +
      facet_wrap(pol~test_type, ncol = 3, scales = "free")
```

```{r}
  # Save merged files
  # saveRDS(pah_merged, file = "../r_files/pah_merged.RDS")
  # saveRDS(bg, file = "../r_files/pah_bg.RDS")
```
