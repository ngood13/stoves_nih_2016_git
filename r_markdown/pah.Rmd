---
title: "PAHs"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r load_libraries, echo=FALSE, message=FALSE}
  library(tidyverse)
  library(knitr)
```

```{r global_options, echo=FALSE}
  knitr::opts_chunk$set(fig.path ='figures/', fig.height = 5, fig.width = 12,
                        warning = FALSE, message = FALSE, cache = FALSE)
```

# Load files

Source files

```{r load_source}
  source("../r_scripts/R_load_data.R")
  source("../r_scripts/R_load_metadata.R")
  source("../r_scripts/R_tidy.R")
```

PAH data

```{r load_data}
  pah_raw <- readRDS("../r_files/pah.RDS")    # pah dataset
  pah_lod <- readRDS("../r_files/pah_lod.RDS")    # pah lod dataset
```

Metadata

```{r load_metadata}
  load("../r_files/data_1.Rda")    # metadata
  load("../r_files/notes.Rda")    # metadata
```

# Tidy data

## Merge raw and LOD data

Extract chemical analysis LOD data

```{r}
  lod <-
    pah_lod %>%
    dplyr::mutate(lod = ifelse(val == "BDL", "below", "above")) %>%
    dplyr::select(id, lod, filter_type, pol)
```

Calculate new value if measurement below LOD

```{r}
  pah <- 
    pah_raw %>% 
    dplyr::left_join(lod, by = c("id", "filter_type", "pol")) %>%
    dplyr::mutate(val = as.numeric(val),
                  val_lod_adj = ifelse(lod == "below", val / sqrt(2), val))
```

## Merge data with qc info

Extract notes for pah

```{r}
  notes <- 
    notes %>%
    dplyr::filter(grepl("pah|all", inst) == TRUE)
```

Apply flags: bad preceeds maybe preceeds good

```{r}
  flags <-
    notes %>%
    dplyr::select(id, qc) %>%
    dplyr::group_by(id) %>%
    dplyr::arrange(qc) %>%
    dplyr::summarise(qc = first(qc))
```

Merge data with flags

```{r}
  pah_merged <-
    pah %>%
    dplyr::left_join(flags, by = "id") %>%
    dplyr::mutate(id = as.factor(id)) %>%
    dplyr::mutate(qc = as.factor(ifelse(is.na(qc), "ok", as.character(qc))))
```

Filter out bad tests

```{r}
  pah_merged <-
    pah_merged %>% 
    dplyr::filter(qc != "bad")
```

# Blank analysis 

Extract blank pufs and blank filters

```{r}
  blanks <-
    pah_merged %>%
    dplyr::filter(grepl("^B", id))
```

Plot blank mass in ug:

* color indicates if sample was above or below instrument lod
* mean shown with an x
* median shown with a square

```{r pah_blank_plot, echo=FALSE, fig.height = 15}
 blanks %>%
    dplyr::filter(!is.na(val)) %>%
    dplyr::mutate(filter_type = 
                    filter_type %>% 
                    as.factor %>%
                    forcats::fct_recode("puf" = "b",
                                        "puf" = "f",
                                        "filter" = "ba")) %>%
    ggplot(aes_string(x = "filter_type", y = "val_lod_adj", colour = "lod")) +
      geom_point(size = 3, shape = 1, stroke = 1) +
      geom_point(stat = "summary", fun.y = "mean", colour = "black",
                 shape = 4, size = 4, stroke = 2) +
      geom_point(stat = "summary", fun.y = "median", colour = "black",
                 shape = 0, size = 4, stroke = 2) +
      theme_bw() +
      theme(axis.text.x = element_text(angle = 15, hjust = 1, vjust = 1),
            text = element_text(size = 18),
            strip.text.x = element_text(size = 12)) +
      facet_wrap(~pol, ncol = 4, scales = "free") +
      ylab("mass (ug)") +
      xlab("")
```

Fraction of blanks below LOD for chemical analysis: `r round(nrow(filter(blanks, lod == "below")) / nrow(blanks), 2)`

Fraction of blanks with NA values: `r round(sum(is.na(blanks$val)) / nrow(blanks), 2)`

Fraction of blanks either below LOD or NA value: `r round((nrow(filter(blanks, lod == "below")) + sum(is.na(blanks$val))) / nrow(blanks), 2)`

Summarize blank data (ignore NAs)

```{r}
  blanks %<>%
    dplyr::group_by(pol, filter_type) %>%
    dplyr::summarise(mean = mean(val_lod_adj, na.rm = TRUE),
                     median = median(val_lod_adj, na.rm = TRUE),
                     sd = sd(val_lod_adj, na.rm = TRUE),
                     lod = 3 * sd,
                     loq = 10 * sd)
```

# Calculate concentrations

Extract pah filter cartridge data

```{r extract_cartridge_data}
  meta <-
    data_1 %>%
    dplyr::select(matches("_red|^id$|^date$"))
```

Extra flow rate data

```{r extract_flows}
  flows <-
    meta %>%
    dplyr::select(matches("flow_|^id$|^date$")) %>%
    tidyr::gather("var", "value", -id, -date) %>%
    dplyr::filter(grepl("_avg$", var)==FALSE) %>%
    dplyr::mutate(type = sub("flow.*", "", var),
                  rep = as.factor(gsub("[^0-9]", "", var))) %>%
    dplyr::select(-var)  %>%
    dplyr::filter(!is.na(id)) %>%
    dplyr::group_by(rep, id, type) %>%
    dplyr::mutate(mean = mean(value, na.rm = TRUE))  %>%
    dplyr::ungroup() %>%
    dplyr::filter(rep == 1) %>%
    dplyr::select(-value, -rep, -date)  %>%
    tidyr::spread(type, mean)
```

Extra time data

```{r extract_times}
  times <-
    meta %>% 
    dplyr::select(matches("^time_|^id$|^date$")) %>%
    tidyr::gather("var", "value", -id, -date) %>%
    dplyr::mutate(type = ifelse(grepl("_start_", var), "start", "NA"),
                  type = ifelse(grepl("_end_", var), "end", type)) %>%
    dplyr::arrange(id) %>%
    dplyr::filter(!is.na(id)) %>%  
    dplyr::select(-var, -date) %>%  
    tidyr::spread(type, value)
```

Merge pah with filter metadata

```{r}
  pah_merged %<>%
    dplyr::filter(!grepl("^B", id)) %>%
    dplyr::left_join(flows, by = "id") %>%
    dplyr::left_join(times, by = "id") %>%
    dplyr::rename(pre_flow = pre, post_flow = post) %>%
    dplyr::mutate(flow = (pre_flow + post_flow) / 2)
```

Calculate concentrations

```{r}
  pah_merged <-
    pah_merged %>%
    dplyr::mutate(dur = (end - start) / 60,
                  conc = val_lod_adj * 1000 / (flow * dur))
```

# Background analysis

Extract background pufs (front and back) and background filters

```{r}
  bg <-
    pah_merged %>%
    dplyr::filter(grepl("^G", id))
```

Plot background concentrations in ug per meter cubed:

* color indicates if sample was above or below LOD calculated from lab blanks
* mean shown with an x
* median shown with a square

```{r pah_bg_plot, echo=FALSE, fig.height = 15}
  bg <-
    bg %>%
    dplyr::mutate(filter_type = 
                    filter_type %>% 
                    as.factor %>%
                    forcats::fct_recode("back puf" = "b",
                                        "front puf" = "f",
                                        "filter" = "p"))

  ggplot(bg, aes_string(x = "filter_type", y = "conc", colour = "lod")) +
    geom_point(size = 3, shape = 1, stroke = 1) +
    geom_point(stat = "summary", fun.y = "mean", colour = "black",
               shape = 4, size = 4, stroke = 2) +
    geom_point(stat = "summary", fun.y = "median", colour = "black",
               shape = 0, size = 4, stroke = 2) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 15, hjust = 1, vjust = 1),
          text = element_text(size = 18),
          strip.text.x = element_text(size = 12)) +
    facet_wrap(~pol, ncol = 4, scales = "free") +
    ylab("mass (ug)") +
    xlab("")
```

Summarize background data

Fraction of backgrounds below LOD for chemical analysis

Fraction of backgrounds with NA values

Fraction of backgrounds below LOD and LOQ calculated from lab blanks

Fraction of backgrounds with NA values

# Sample analysis

Extract sample pufs (front and back) and sample filters

Plot sample concentrations in ug per meter cubed:

* group by stove type and fuel type
* negative values indicate the sample was below the background
* mean shown with an x
* median shown with a square

Plot sigma

Plot phi

Plot ratio of front to back filter

Plot histogram of background and sample data

Fraction of samples below LOD for chemical analysis

Fraction of samples below LOD and LOQ calculated from lab blanks

Fraction of samples with NA values

Fraction of samples below the background

# Save merged file

```{r}
  # saveRDS(pah, file = "../r_files/pah_merged.RDS")
```
