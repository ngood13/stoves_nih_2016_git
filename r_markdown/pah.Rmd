---
title: "PAHs"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r load_libraries, echo=FALSE, message=FALSE}
  library(tidyverse)
  library(knitr)
```

```{r global_options, echo=FALSE}
  knitr::opts_chunk$set(fig.path ='figures/', fig.height = 5, fig.width = 12,
                        warning = FALSE, message = FALSE, cache = FALSE)
```

# Load files

Source files

```{r load_source}
  source("../r_scripts/R_load_data.R")
  source("../r_scripts/R_load_metadata.R")
  source("../r_scripts/R_tidy.R")
```

PAH data

```{r load_data}
  pah_raw <- readRDS("../r_files/pah.RDS")    # pah dataset
  pah_lod <- readRDS("../r_files/pah_lod.RDS")    # pah lod dataset
```

Metadata

```{r load_metadata}
  load("../r_files/data_1.Rda")    # metadata
  load("../r_files/notes.Rda")    # metadata
  load("../r_files/samples.Rda")
```

# Tidy data

## Merge raw and lod data

Extract chemical analysis lod data

```{r}
  lod <-
    pah_lod %>%
    dplyr::mutate(lod = ifelse(val == "BDL", "below", "above")) %>%
    dplyr::select(id, lod, filter_type, pol)
```

Calculate new value if measurement below lod

```{r}
  pah <- 
    pah_raw %>% 
    dplyr::group_by(id, filter_type, pol) %>%
    dplyr::mutate(val = as.numeric(val)) %>%
    dplyr::summarise(val = mean(val, na.rm = TRUE)) %>%
    dplyr::ungroup() %>%
    dplyr::left_join(lod, by = c("id", "filter_type", "pol")) %>%
    dplyr::mutate(val_lod_adj = ifelse(lod == "below", val / sqrt(2), val))
```

## Merge data with qc info

Extract notes for pah

```{r}
  notes <- 
    notes %>%
    dplyr::filter(grepl("pah|all", inst) == TRUE)
```

Apply flags: bad preceeds maybe preceeds good

```{r}
  flags <-
    notes %>%
    dplyr::select(id, qc) %>%
    dplyr::group_by(id) %>%
    dplyr::arrange(qc) %>%
    dplyr::summarise(qc = first(qc))
```

Merge data with flags

```{r}
  pah <-
    pah %>%
    dplyr::left_join(flags, by = "id") %>%
    dplyr::mutate(id = as.factor(id)) %>%
    dplyr::mutate(qc = as.factor(ifelse(is.na(qc), "ok", as.character(qc))))
```

Filter out bad tests

```{r}
  pah <-
    pah %>% 
    dplyr::filter(qc != "bad")
```

# Blank analysis 

Extract blank pufs and blank filters

```{r}
  blanks <-
    pah %>%
    dplyr::filter(grepl("^B", id))
```

Plot blank mass in ug:

* color indicates if sample was above or below instrument lod (lod)
* mean shown with an x
* median shown with a square

```{r pah_blank_plot, echo=FALSE, fig.height = 15}
 blanks %>%
    dplyr::filter(!is.na(val)) %>%
    dplyr::mutate(filter_type = 
                    filter_type %>% 
                    forcats::fct_recode("back puf" = "b",
                                        "front puf" = "f",
                                        "filter" = "ba")) %>%
    ggplot(aes_string(x = "filter_type", y = "val_lod_adj", colour = "lod")) +
      geom_point(size = 3, shape = 1, stroke = 1) +
      geom_point(stat = "summary", fun.y = "mean", colour = "black",
                 shape = 4, size = 4, stroke = 2) +
      geom_point(stat = "summary", fun.y = "median", colour = "black",
                 shape = 0, size = 4, stroke = 2) +
      theme_bw() +
      theme(axis.text.x = element_text(angle = 15, hjust = 1, vjust = 1),
            text = element_text(size = 18),
            strip.text.x = element_text(size = 12),
            legend.position = "top") +
      facet_wrap(~pol, ncol = 4, scales = "free") +
      ylab("") +
      xlab("")
```

* Fraction of blanks below lod: `r round(nrow(filter(blanks, lod == "below")) / nrow(blanks), 2)`.
* Fraction of blanks with NA values: `r round(sum(is.na(blanks$val)) / nrow(blanks), 2)`.
* Fraction of 'bad' background values: `r round((nrow(filter(blanks, lod == "below")) + sum(is.na(blanks$val))) / nrow(blanks), 2)`.

Summarize blank data (ignore NAs)

```{r}
  blanks <-
    blanks %>%
    dplyr::group_by(pol, filter_type) %>%
    dplyr::summarise(bk_mean = mean(val_lod_adj, na.rm = TRUE),
                     bk_median = median(val_lod_adj, na.rm = TRUE),
                     bk_sd = sd(val_lod_adj, na.rm = TRUE)) %>%
    dplyr::mutate(filter_type = 
                    filter_type %>% 
                    forcats::fct_recode("p" = "ba"))
```

```{r, echo=FALSE}
   blanks %>%
    dplyr::mutate(filter_type = 
                    filter_type %>% 
                    forcats::fct_recode("back puf" = "b",
                                        "front puf" = "f",
                                        "filter" = "p")) %>%
    knitr::kable("markdown", digits = 2, align = 'c',
                 caption = "summary statistics of lab blanks (units in ug)",
                 col.names = c("type of pah", "filter type", "mean", "median", "standard deviation"))
```

# Lab blank correction 

Find which backgrounds are below blank lod and loq

* replace values below the lod and loq with lod/sqrt(2)
* replace values below loq and above lod with loq/sqrt(2)

```{r}
  pah <-
    pah %>%
    dplyr::filter(!grepl("^B", id)) %>%  # remove blanks
    dplyr::left_join(blanks, by = c("pol", "filter_type")) %>%
    dplyr::mutate(val_bk_adj = val_lod_adj - bk_mean,
                  bk_lod = ifelse(val_bk_adj <= 3 * bk_sd, "below", "above"),
                  bk_loq = ifelse(val_bk_adj <= 10 * bk_sd, "below", "above"),
                  val_bk_adj = ifelse(bk_lod == "below" & bk_lod == "below",
                                      (3 * bk_sd) / sqrt(2), val_bk_adj),
                  val_bk_adj = ifelse(bk_lod == "above" & bk_loq == "below",
                                      (10 * bk_sd) / sqrt(2), val_bk_adj))
```

# Calculate concentrations

Extract pah filter cartridge data

```{r extract_cartridge_data}
  meta <-
    data_1 %>%
    dplyr::select(matches("_red|^id$|^date$"))
```

Extra flow rate data

```{r extract_flows}
  flows <-
    meta %>%
    dplyr::select(matches("flow_|^id$|^date$")) %>%
    tidyr::gather("var", "value", -id, -date) %>%
    dplyr::filter(grepl("_avg$", var)==FALSE) %>%
    dplyr::mutate(type = sub("flow.*", "", var),
                  rep = as.factor(gsub("[^0-9]", "", var))) %>%
    dplyr::select(-var)  %>%
    dplyr::filter(!is.na(id)) %>%
    dplyr::group_by(rep, id, type) %>%
    dplyr::mutate(mean = mean(value, na.rm = TRUE))  %>%
    dplyr::ungroup() %>%
    dplyr::filter(rep == 1) %>%
    dplyr::select(-value, -rep, -date)  %>%
    tidyr::spread(type, mean)
```

Extra time data

```{r extract_times}
  times <-
    meta %>% 
    dplyr::select(matches("^time_|^id$|^date$")) %>%
    tidyr::gather("var", "value", -id, -date) %>%
    dplyr::mutate(type = ifelse(grepl("_start_", var), "start", "NA"),
                  type = ifelse(grepl("_end_", var), "end", type)) %>%
    dplyr::arrange(id) %>%
    dplyr::filter(!is.na(id)) %>%  
    dplyr::select(-var, -date) %>%  
    tidyr::spread(type, value)
```

Merge pah with filter metadata

```{r}
  pah_merged <-
    pah %>%
    dplyr::filter(!grepl("^B", id)) %>%
    dplyr::left_join(flows, by = "id") %>%
    dplyr::left_join(times, by = "id") %>%
    dplyr::rename(pre_flow = pre, post_flow = post) %>%
    dplyr::mutate(flow = (pre_flow + post_flow) / 2)
```

Calculate concentrations

```{r}
  pah_merged <-
    pah_merged %>%
    dplyr::mutate(dur = (end - start) / 60,
                  conc = val_bk_adj * 1000 / (flow * dur))
```

# Background analysis

Extract background pufs (front and back) and background filters

```{r}
  bg <-
    pah_merged %>%
    dplyr::filter(grepl("^G", id))
```

Plot background concentrations in ug per meter cubed:

* color indicates if sample was above or below lod calculated from lab blanks
* mean shown with an x
* median shown with a square

```{r pah_bg_plot, echo=FALSE, fig.height = 15}
  bg %>%
    dplyr::filter(!is.na(conc)) %>%
    dplyr::mutate(filter_type = 
                    filter_type %>% 
                    as.factor %>%
                    forcats::fct_recode("back puf" = "b",
                                        "front puf" = "f",
                                        "filter" = "p")) %>%
    ggplot(aes_string(x = "filter_type", y = "conc", colour = "bk_lod")) +
      geom_point(size = 3, shape = 1, stroke = 1) +
      geom_point(stat = "summary", fun.y = "mean", colour = "black",
                 shape = 4, size = 4, stroke = 2) +
      geom_point(stat = "summary", fun.y = "median", colour = "black",
                 shape = 0, size = 4, stroke = 2) +
      theme_bw() +
      theme(axis.text.x = element_text(angle = 15, hjust = 1, vjust = 1),
            text = element_text(size = 18),
            strip.text.x = element_text(size = 12),
            legend.position = "top") +
      facet_wrap(~pol, ncol = 4, scales = "free") +
      ylab("") +
      xlab("")
```

* Fraction of backgrounds below lod for chemical analysis: `r round(nrow(filter(bg, lod == "below")) / nrow(bg), 2)`.
* Fraction of backgrounds with NA values: `r round(sum(is.na(bg$val)) / nrow(bg), 2)`.
* Fraction of backgrounds below blank lod: `r round(nrow(filter(bg, bk_lod == "below")) / nrow(bg), 2)`.
* Fraction of backgrounds below blank loq: `r round(nrow(filter(bg, bk_loq == "below")) / nrow(bg), 2)`.
* Fraction of 'bad' background values: `r 1 - round(nrow(filter(bg, lod != "below", bk_lod != "below", bk_loq != "below", !is.na(val_bk_adj))) / nrow(bg), 2)`.

Summarize background data (ignore NAs)

```{r}
  bg <-
    bg %>%
    dplyr::group_by(pol, filter_type) %>%
    dplyr::summarise(bg_mean = mean(conc, na.rm = TRUE),
                     bg_median = median(conc, na.rm = TRUE),
                     bg_sd = sd(conc, na.rm = TRUE))
```

```{r, echo=FALSE}
  bg %>%
    dplyr::mutate(filter_type = 
                  filter_type %>% 
                  forcats::fct_recode("back puf" = "b",
                                      "front puf" = "f",
                                      "filter" = "p")) %>%
    knitr::kable("markdown", digits = 2, align = 'c',
                 caption = "summary statistics of lab backgrounds (units in ug per meter cubed)",
                 col.names = c("type of pah", "filter type", "mean", "median", "standard deviation"))
```

# Sample analysis

Extract sample pufs (front and back) and sample filters

```{r}
  pah_samples <-
    pah_merged %>%
    dplyr::filter(!grepl("^G|^B", id))
```

Subtract background concentrations

```{r}
  pah_samples <-
    pah_samples %>%
    dplyr::left_join(bg, by = c("pol", "filter_type")) %>%
    dplyr::mutate(conc = conc - bg_mean)
```

Concentrations from burns in ug per meter cubed:

* negative values indicate the sample was below the background
* mean shown with an x
* median shown with a square

```{r, echo=FALSE, fig.height = 15}
  pah_samples %>%
    dplyr::filter(!is.na(conc)) %>%
    dplyr::mutate(filter_type = 
                    filter_type %>% 
                    as.factor %>%
                    forcats::fct_recode("back puf" = "b",
                                        "front puf" = "f",
                                        "filter" = "p")) %>%
    ggplot(aes_string(x = "filter_type", y = "conc", colour = "lod")) +
      geom_point(size = 3, shape = 1, stroke = 1) +
      geom_point(stat = "summary", fun.y = "mean", colour = "black",
                 shape = 4, size = 4, stroke = 2) +
      geom_point(stat = "summary", fun.y = "median", colour = "black",
                 shape = 0, size = 4, stroke = 2) +
      theme_bw() +
      theme(axis.text.x = element_text(angle = 15, hjust = 1, vjust = 1),
            text = element_text(size = 18),
            strip.text.x = element_text(size = 12),
            legend.position = "top") +
      facet_wrap(~pol, ncol = 4, scales = "free") +
      ylab("mass (ug per meter cubed)") +
      xlab("")
```

Summed particle and gas phase pah concentrations in ug per meter cubed:

* grouped by stove type and colored by fuel type
* negative values indicate the sample was below the background
* mean shown with an x
* median shown with a square

```{r, echo=FALSE, fig.height = 60, fig.width = 14}
  pah_samples %>%
    dplyr::filter(!is.na(conc), !grepl("27|28|29|30", id)) %>%
    dplyr::group_by(id, pol, filter_type) %>%
    dplyr::summarise(conc = sum(conc)) %>%
    dplyr::left_join(dplyr::select(samples, id,
                                   stove, fuel,
                                   stovecat, fuelcat), by = "id") %>%
    dplyr::mutate(stove = 
                    stove %>% 
                    factor %>% 
                    tolower %>%
                    gsub(" [:(:].*[:):]", "",.) %>%
                    forcats::fct_recode("lpg" = "pressurized lpg") %>%
                    forcats::fct_recode("pressure kerosene" =
                                          "pressurized kerosene") %>% 
                    gsub(" ", " \n ",.) %>% 
                    forcats::fct_relevel("three \n stone \n fire",
                                         "clay \n ring",
                                         "ceramic \n charcoal",
                                         "rocket \n elbow",
                                         "built-in \n justa",
                                         "metal \n charcoal",
                                         "fan \n rocket \n elbow",
                                         "gasifier",
                                         "wick \n kerosene",
                                         "pressure \n kerosene",
                                         "lpg"),
                  fuelcat =
                    fuelcat %>% 
                    factor %>%
                    tolower,
                  stovecat = 
                    stovecat %>%
                    forcats::fct_recode("insulated [improved] stoves" = "improved",
                                        "insulated [improved] stoves" = "gasifiers",
                                        "liquid-fuel stoves" = "advanced",
                                        "traditional stoves" = "traditional")) %>%
    ggplot(aes_string(x = "stove", y = "conc", colour = "fuelcat")) +
      geom_point(size = 3, shape = 1, stroke = 2) +
      geom_point(stat = "summary", fun.y = "mean", colour = "black",
                 shape = 4, size = 4, stroke = 2) +
      geom_point(stat = "summary", fun.y = "median", colour = "black",
                 shape = 0, size = 4, stroke = 2) +
      theme_bw() +
      theme(text = element_text(size = 18),
            legend.position = "top") +
      facet_wrap(pol~stovecat, ncol = 3, scales = "free") +
      ylab("") +
      xlab("")
```

Ratio of particle phase pahs to summed gas and particle phase pahs:

* grouped by stove type and colored by fuel type
* negative values indicate the sample was below the background
* mean shown with an x
* median shown with a square

```{r, echo=FALSE, fig.height = 60, fig.width = 14}
  pah_samples %>%
    dplyr::filter(!is.na(conc), !grepl("27|28|29|30", id)) %>%
    dplyr::mutate(filter_type = 
                    filter_type %>%
                    forcats::fct_recode("gas" = "b",
                                        "gas" = "f",
                                        "particle" = "p")) %>%
    dplyr::group_by(id, pol, filter_type) %>%
    dplyr::summarise(conc = sum(conc)) %>%
    tidyr::spread(filter_type, conc) %>%
    dplyr::mutate(sigma = particle / (particle + gas)) %>%
    dplyr::left_join(dplyr::select(samples, id,
                                   stove, fuel,
                                   stovecat, fuelcat), by = "id") %>%
    dplyr::mutate(stove = 
                    stove %>% 
                    factor %>% 
                    tolower %>%
                    gsub(" [:(:].*[:):]", "",.) %>%
                    forcats::fct_recode("lpg" = "pressurized lpg") %>%
                    forcats::fct_recode("pressure kerosene" =
                                          "pressurized kerosene") %>% 
                    gsub(" ", " \n ",.) %>% 
                    forcats::fct_relevel("three \n stone \n fire",
                                         "clay \n ring",
                                         "ceramic \n charcoal",
                                         "rocket \n elbow",
                                         "built-in \n justa",
                                         "metal \n charcoal",
                                         "fan \n rocket \n elbow",
                                         "gasifier",
                                         "wick \n kerosene",
                                         "pressure \n kerosene",
                                         "lpg"),
                  fuelcat =
                    fuelcat %>% 
                    factor %>%
                    tolower,
                  stovecat = 
                    stovecat %>%
                    forcats::fct_recode("insulated [improved] stoves" = "improved",
                                        "insulated [improved] stoves" = "gasifiers",
                                        "liquid-fuel stoves" = "advanced",
                                        "traditional stoves" = "traditional")) %>%
    ggplot(aes_string(x = "stove", y = "sigma", colour = "fuelcat")) +
      geom_point(size = 3, shape = 1, stroke = 2) +
      geom_point(stat = "summary", fun.y = "mean", colour = "black",
                 shape = 4, size = 4, stroke = 2) +
      geom_point(stat = "summary", fun.y = "median", colour = "black",
                 shape = 0, size = 4, stroke = 2) +
      theme_bw() +
      theme(text = element_text(size = 18),
            legend.position = "top") +
      facet_wrap(pol~stovecat, ncol = 3, scales = "free") +
      ylab("") +
      xlab("")
```

* Fraction of samples below lod for chemical analysis:`r round(nrow(filter(pah_merged, lod == "below")) / nrow(pah_merged), 2)`.
* Fraction of samples with NA values: `r round(sum(is.na(pah_merged$conc)) / nrow(pah_merged), 2)`.
* Fraction of samples that are negative after background correction: `r round(sum(pah_merged$conc <= 0) / nrow(pah_merged), 2)`.
* Fraction of samples below blank lod: `r round(nrow(filter(pah_merged, bk_lod == "below")) / nrow(pah_merged), 2)`.
* Fraction of backgrounds below blank loq: `r round(nrow(filter(pah_merged, bk_loq == "below")) / nrow(pah_merged), 2)`.
* Fraction of 'bad' sample values: `r 1 - round(nrow(filter(pah_merged, lod != "below", bk_lod != "below", bk_loq != "below", !is.na(val_bk_adj), pah_merged$conc <= 0)) / nrow(pah_merged), 2)`.

# Additional QA/QC analysis

Plot ratio of front to back filter

```{r, echo=FALSE, fig.height = 60, fig.width = 14}
  pah_merged %>%
    dplyr::filter(filter_type != "p") %>%
    tidyr::spread(filter_type, conc) %>%
    dplyr::mutate(ratio = f / b) %>%
    ggplot(aes_string(x = "pol", y = "ratio")) +
      geom_point(size = 3, shape = 1, stroke = 2)
      theme_bw() +
      theme(text = element_text(size = 18)) +
      ylab("") +
      xlab("")
```

Plot histogram of background and sample data

# Save merged files

```{r}
  # saveRDS(pah_merged, file = "../r_files/pah_merged.RDS")
  # saveRDS(bg, file = "../r_files/pah_bg.RDS")
```
