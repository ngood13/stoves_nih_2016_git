---
title: "SMPS"
date: "December 23, 2018"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
  library(knitr)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  source("../r_scripts/R_tidy.R")
  source("../r_scripts/R_functions.R")
```

# Load data

Test metadata:

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  samples    <- readRDS("../r_files/samples.RDS")
  test_times <- readRDS("../r_files/test_times_all.RDS")
  notes      <- readRDS("../r_files/notes.RDS")
```

SMPS: 

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  smps     <- readRDS("../r_files/smps.RDS")
  dilution <- readRDS("../r_files/dilution.RDS")
```

Constants: 

```{r}
  hood_flow <- readRDS("../r_files/hood_flow.RDS") # m3/min
  dlogdp    <- readRDS("../r_files/smps_dlogdp.RDS")
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  # Define the colors to use in the plots. 
  purple <- "#330099"
  gold   <- "#FF9900"
  teal1  <- "#33CC99"
  teal2  <- "#339999"
  teal3  <- "#0099CC"
  orange <- "#FF6633"
  pink1  <- "#CC0066"
  pink2  <- "#FF3366"
```

# Organize

### Times

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  df_times <- dplyr::filter(test_times, var == "set_1" | var == "end") %>%
              tidyr::spread(var, value) %>%
              dplyr::rename(start = set_1)  
```

### SMPS

Map test IDs to SMPS data.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}

  df_smps <- dplyr::rename(smps, time = start_time) %>%
             dplyr::mutate(dw = as.numeric(dw))

  df_smps <-  map_id(df_smps, df_times) 
```

### Notes

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  df_notes <- dplyr::filter(notes, grepl("smps|all", inst))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, eval = FALSE}
  knitr::kable(dplyr::filter(df_notes, grepl(".*smps.*", inst)) %>%
               dplyr::select(-inst, -date),
               "markdown", digits = 2)
```

Apply flags: `bad` preceeds `maybe` preceeds `good`

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  flags <- dplyr::select(df_notes, id, qc) %>%
           dplyr::group_by(id) %>%
           dplyr::arrange(qc) %>%
           dplyr::summarise(qc = first(qc))
```

### Combine

Combine the SMPS data with the QC flags. 

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  df_smps_merged <- dplyr::left_join(df_smps, flags, by=c("id")) %>%
                    dplyr::mutate(qc     = ifelse(is.na(qc), "ok", qc),
                                  sample = as.factor(sample),
                                  time   = as.numeric(time))   
```

* The SMPS measured during `r length(unique(df_smps_merged$id))` experiments between `r min(df_smps_merged$date, na.rm = TRUE)` and `r max(df_smps_merged$date, na.rm = TRUE)`.  
* There is no $SMPS$ data for tests: `r setdiff(as.character(samples$id), as.character(df_smps_merged$id))`.  
* SMPS data is expected to be missing for: the first test day.  

```{r, echo = FALSE, warning = FALSE, message = FALSE, results = 'markup', cache=FALSE, fig.width=6.5, fig.height=14, fig.align='center'}

  df_plot <- df_smps_merged %>%
             dplyr::select(id, sample, size_nm, dw) %>%
             dplyr::bind_rows(data.frame(id = c("BG1","LL1"),
                                         size_nm = NA,
                                         dw = NA))

  ggplot(df_plot, aes(x=size_nm, y=dw, group=sample)) + 
    geom_line(color = pink2) +
    facet_wrap(~id, ncol=4) +
    xlab("Particle size (nm)") + 
    ylab(expression("dN/dlog("*D[p]*")")) +
    theme(aspect.ratio=1,
          panel.border     = element_rect(fill=NA),
          panel.background = element_rect(fill='white'),
          panel.grid.major = element_line(color="gray95"),
          panel.grid.minor = element_line(color="gray95"),
          text        = element_text(size=10, color='black'),
          axis.text.x = element_text(size= 6, color='black'),
          axis.text.y = element_text(size= 9, color='black'),
          axis.title  = element_text(size= 9, color='black'),
          axis.ticks  = element_line(color='black')) 
```

# Average

Average the particle number concentrations (dN/dlog(Dp)) in each size bin over each test.  In other words, average the individual scans from each test.  

```{r}
  df_smps_test <- df_smps_merged %>%
                  dplyr::select(id, size_nm, dw)                   %>%
                  dplyr::group_by(id, size_nm)                     %>%
                  dplyr::summarise(dw_mean = mean(dw, na.rm=TRUE)) %>%  
                  dplyr::ungroup()                                 
```

# Background

Compare the particle number size distributions measured during background tests and regular tests.  

```{r, echo=FALSE, fig.width=3.54, fig.height=3.15, fig.align='center'}

  df_plot <- dplyr::mutate(df_smps_test,
                           test_type = ifelse(substr(id, 1, 2) == "BG",
                                              "Background",
                                              "Test"))

  log10_breaks <- c(10,20,30,50,60,70,80,90,
                    100,200,300,400,500)

  ggplot(df_plot, aes(x = size_nm, y = dw_mean, group = id, color = test_type)) +
      geom_line() +
    scale_color_manual(values  = c(pink1, teal3)) +
    xlab("Particle size (nm)") + 
    ylab(expression("dN/dlog("*D[p]*")")) +
    labs(color="Test type") +
    scale_x_log10(breaks=c(10,20,50,100,200,500), minor_breaks=log10_breaks) + 
    theme(aspect.ratio=1,
          panel.grid.major.x = element_line(color="gray95"),
          panel.grid.minor.x = element_line(color="gray95"),
          panel.grid.major.y = element_line(color="gray95"),
          panel.grid.minor.y = element_line(color="gray95"),
          panel.border     = element_rect(fill=NA),
          panel.background = element_rect(fill='white'),
          axis.text  = element_text(size=10, color='black'),
          axis.title = element_text(size=10, color='black'),
          axis.ticks = element_line(color='black'),
          legend.text  = element_text(size=10, color='black'),
          legend.title = element_text(size=10, color='black'),
          legend.key   = element_blank(),
          legend.position = c(0.75,0.79))
```

Compare the number concentration of ultrafine particles in the SMPS sample line during background tests and regular tests.  

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}

  df_ufp_bg <- dplyr::filter(df_smps_test, size_nm <= 100) %>%
               dplyr::mutate(num_conc = dw_mean * dlogdp)  %>%
               dplyr::group_by(id)                         %>%
               dplyr::summarise(num_conc = sum(num_conc))  %>%
               dplyr::mutate(test_type = ifelse(substr(id, 1, 2) == "BG",
                                                "Background",
                                                "Test")) 
```

```{r, echo=FALSE, fig.width=7.5, fig.height=3.15, fig.align='center'}

  ggplot(df_ufp_bg, aes(x = id, y = num_conc, color = test_type, fill = test_type)) +
      geom_col() +
    scale_fill_manual(values  = c(pink1, teal3)) +
    xlab("Test ID") + 
    ylab(expression(Ultrafine ~ particles ~ "("*"#"/cm^3*")")) +
    labs(color="Test type", fill = "Test type") +
    theme(aspect.ratio=0.40,
          panel.grid.major.x = element_line(color="gray95"),
          panel.grid.minor.x = element_line(color="gray95"),
          panel.grid.major.y = element_line(color="gray95"),
          panel.grid.minor.y = element_line(color="gray95"),
          panel.border     = element_rect(fill=NA),
          panel.background = element_rect(fill='white'),
          axis.text.x = element_text(size=7, color='black'),
          axis.text.y = element_text(size=9, color='black'),
          axis.title = element_text(size=9, color='black'),
          axis.ticks = element_line(color='black'),
          legend.text  = element_text(size=9, color='black'),
          legend.title = element_text(size=9, color='black'),
          legend.key   = element_blank(),
          legend.position = c(0.13,0.79))
```

# Correct for dilution

Corect the concentrations measured during actual tests (non-background tests) for the dilution ratio.  

1. Remove background tests.  
2. Add dilution ratios to data frame.  
3. Multiply the dN/dlog(Dp) values recorded by SMPS by the dilution ratio.  
4. Add test metadata.  

```{r}
  df_smps_test <- dplyr::filter(df_smps_test, substr(id,1,2) != "BG") %>% # 1
                  dplyr::left_join(dplyr::select(dilution, id, dilution), # 2
                                   by=c("id"))                        %>%
                  dplyr::mutate(dndlogdp = dw_mean*dilution)          %>% # 3
                  dplyr::left_join(dplyr::select(samples, id, type, mc_level), 
                                   by=c("id"))                            # 4
```

# Particle size distribution

Calculate the average particle number concentration (dN/dlog(Dp)), for each particle size, at each fuel moisture level. 

```{r}
  df_smps_avg <- dplyr::group_by(df_smps_test, mc_level, size_nm) %>%
                 summarise(dndlogdp_avg = mean(dndlogdp),
                           dndlogdp_sd  = sd(dndlogdp))
```

Plot the particle number size distribution for each fuel moisture level.  The values shown in the figure have been corrected for the dilution ratio but have not been background corrected.  Background concentrations were negligible.

```{r, echo=FALSE, fig.width=3.54, fig.height=3.15, fig.align='center'}

  log10_breaks <- c(10,20,30,50,60,70,80,90,
                    100,200,300,400,500)

  ggplot(df_smps_avg, aes(x=size_nm, y=dndlogdp_avg, 
                          ymin=dndlogdp_avg-dndlogdp_sd, ymax=dndlogdp_avg+dndlogdp_sd, 
                          color=mc_level, fill=mc_level)) +
    geom_blank() + 
    geom_ribbon(data=dplyr::filter(df_smps_avg, mc_level=="High"),   alpha=0.25, color=NA) +
      geom_line(data=dplyr::filter(df_smps_avg, mc_level=="High"),   size=1) +
    geom_ribbon(data=dplyr::filter(df_smps_avg, mc_level=="Medium"), alpha=0.25, color=NA) +
      geom_line(data=dplyr::filter(df_smps_avg, mc_level=="Medium"), size=1) +
    geom_ribbon(data=dplyr::filter(df_smps_avg, mc_level=="Low"),    alpha=0.15, color=NA) +
      geom_line(data=dplyr::filter(df_smps_avg, mc_level=="Low"),    size=1) +
    # format plot
    xlab("Particle size (nm)") + 
    ylab(expression("dN/dlog("*D[p]*")")) +
    labs(color="Moisture level", fill="Moisture level") +
    scale_x_log10(breaks=c(10,20,50,100,200,500), minor_breaks=log10_breaks) + 
    scale_color_manual(values = c(teal3,gold,pink1)) +
    scale_fill_manual(values  = c(teal3,gold,pink1)) +
    theme(aspect.ratio=1,
          panel.grid.major.x = element_line(color="gray95"),
          panel.grid.minor.x = element_line(color="gray95"),
          panel.grid.major.y = element_line(color="gray95"),
          panel.grid.minor.y = element_line(color="gray95"),
          panel.border     = element_rect(fill=NA),
          panel.background = element_rect(fill='white'),
          axis.text  = element_text(size=10, color='black'),
          axis.title = element_text(size=10, color='black'),
          axis.ticks = element_line(color='black'),
          legend.text  = element_text(size=10, color='black'),
          legend.title = element_text(size=10, color='black'),
          legend.key   = element_blank(),
          legend.position = c(0.77,0.74))

  ggsave(filename="../figures/smps.pdf", plot=last_plot(), device="pdf", width=9/2.54, height=8/2.54)
```

Calculate the geometric mean diameter:

```{r}

  df_smps_dg <- df_smps_test %>%
                dplyr::mutate(dn    = dndlogdp * dlogdp,
                              dnlnd = dn*log(size_nm)) %>%
                dplyr::group_by(id)                    %>%
                dplyr::summarise(n = sum(dn),
                                 sum_nlnd = sum(dnlnd),
                                 d_g = exp(sum_nlnd/n)) %>%
                dplyr::left_join(dplyr::select(samples, id, mc_level), 
                                 by = c("id")) %>%
                dplyr::group_by(mc_level) %>%
                dplyr::summarise(dg_mean = mean(d_g),
                                 dg_sd   = sd(d_g))
```

```{r, echo=FALSE}
  kable(df_smps_dg, format="markdown", digits=0,
        col.names=c("Moisture level","Mean (nm)","SD (nm)"),
        caption="Geometric mean diameter")
```

Calculate the number mode diameter:  

* For the low-moisture fuel, the mode diameter was `r dplyr::filter(df_smps_avg, mc_level=="Low")$size_nm[which.max(dplyr::filter(df_smps_avg, mc_level=="Low")$dndlogdp_avg)]` nm.  
* For the medium-moisture fuel, the mode diameter was `r dplyr::filter(df_smps_avg, mc_level=="Medium")$size_nm[which.max(dplyr::filter(df_smps_avg, mc_level=="Medium")$dndlogdp_avg)]` nm.  
* For the high-moisture fuel, the mode diameter was `r dplyr::filter(df_smps_avg, mc_level=="High")$size_nm[which.max(dplyr::filter(df_smps_avg, mc_level=="High")$dndlogdp_avg)]` nm.  

# Ultrafine particles  

Calculate the number concentration of ultrafine particles in each size bin (for each test):  

1. Select particles smaller than 100 nm.  
2. Calculate particle number concentration in each size bin (i.e., convert from dN/dlog(Dp) to number of particles per cubic centimeter).  
3. Add test start and end times to the dataframe.  
4. Calculate the test duration (in minutes).  

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}

  df_ufp <- dplyr::filter(df_smps_test, size_nm <= 100) %>% # 1
            dplyr::mutate(num_conc = dndlogdp * dlogdp) %>% # 2
            dplyr::left_join(df_times, by=c("id"))      %>% # 3
            dplyr::mutate(dur = (end - start)/60)           # 4
```

Save data. 

```{r}
  saveRDS(df_ufp, file = "../r_files/smps_ultrafine.RDS")
```

Ultrafine particle concentration in SMPS sample line per scan.

```{r, echo = FALSE, warning = FALSE, message = FALSE, results = 'markup', cache=FALSE, fig.width=6.5, fig.height=14, fig.align='center'}

  df_plot <- dplyr::filter(df_smps_merged, size_nm <= 100) %>%
             dplyr::mutate(num_conc = dw * dlogdp)         %>%
             dplyr::group_by(id, sample)                   %>%
             dplyr::summarise(num_conc = sum(num_conc))    %>%
             dplyr::mutate(sample = as.numeric(sample))    %>%
             dplyr::bind_rows(data.frame(id = c("BG1","LL1"),
                                         sample = NA,
                                         num_conc = NA))

  ggplot(df_plot, aes(x=sample, y=num_conc, group=id)) + 
    geom_point(size = 1) +
    facet_wrap(~id, ncol=4) +
    xlab("Scan number") +
    ylab(expression(Ultrafine ~ particles ~ "("*"#"/cm^3*")")) +
    theme(aspect.ratio=1,
          panel.border     = element_rect(fill=NA),
          panel.background = element_rect(fill='white'),
          panel.grid.major = element_line(color="gray95"),
          panel.grid.minor = element_line(color="gray95"),
          text        = element_text(size=10, color='black'),
          axis.text.x = element_text(size= 6, color='black'),
          axis.text.y = element_text(size= 9, color='black'),
          axis.title  = element_text(size= 9, color='black'),
          axis.ticks  = element_line(color='black')) 
```
