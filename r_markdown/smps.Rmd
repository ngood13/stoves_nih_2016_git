---
title: "smps"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
  library(gridExtra)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  source("../r_scripts/R_tidy.R")
  source("../r_scripts/R_functions.R")
```

# Load data

* smps

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  smps <- readRDS("../r_files/smps.RDS")
```

* metadata

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  samples <- readRDS("../r_files/samples.RDS")
  cal_2 <- readRDS("../r_files/data_cal_two.RDS")
  notes <- readRDS("../r_files/notes.RDS")
  test_times <- readRDS("../r_files/test_times.RDS")
  smps_pax_bg_times <- readRDS("../r_files/smps_pax_bg_times.RDS")
```

```{r}
const <- 0.015625355
```

# Organize

* extract test times

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  test_times <- dplyr::filter(test_times, var == "set_1" | var == "end") %>%
                tidyr::spread(var, value)
```


* extract measured flows.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  smps_flows <- tidy_date(cal_2, "^smps_preflow_[0-9]|^smps_postflow_[0-9]", "")

  smps_flows <- split_flows(smps_flows)
```

* average flows

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  smps_flows <- dplyr::arrange(group_by(smps_flows, date, type), date) %>%
                dplyr::mutate(mean = mean(value, na.rm = TRUE),
                              sd = sd(value, na.rm = TRUE)) %>%
                dplyr::filter(rep == 1) %>%
                dplyr::select(-rep, -value) %>%
                tidyr::gather(temp, val, mean, sd) %>%
                tidyr::unite(temp1, type, temp, sep = "_") %>%
                tidyr::spread(temp1, val)
```

* map ids to smps files

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  test_times_renamed <- dplyr::rename(test_times, start = set_1)  
  smps <- dplyr::rename(smps, time = start_time)
  smps_merged <-  map_id(smps, test_times_renamed) # used to be smps_id
  
  # smps_noid <- dplyr::setdiff(smps, select(smps_id, -id)) %>%
              # dplyr::mutate(id = NA)
  
 # merged file is too long and contains duplicate rows and datetime for unknown reason(s)
  # smps_merged <- dplyr::arrange(rbind(smps_id, smps_noid), datetime)
```


* merge

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  smps_merged <- dplyr::left_join(smps_merged, smps_flows, "date") %>%
                 dplyr::mutate(sample = as.factor(sample))
```

# QC

* notes

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  notes <- dplyr::filter(notes, grepl("smps|all", inst))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  knitr::kable(dplyr::filter(notes, grepl(".*smps.*", inst)) %>%
               dplyr::select(-inst, -date),
               "markdown", digits = 2)
```

* apply flags: `bad` preceeds `maybe` preceeds `good`

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  flags <- dplyr::select(notes, id, qc) %>%
           dplyr::group_by(id) %>%
           dplyr::arrange(qc) %>%
           dplyr::summarise(qc = first(qc))
```

* merge

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  smps_merged <- dplyr::left_join(smps_merged, flags, by = "id") %>%
                 dplyr::mutate(id = as.factor(id)) %>%
                 dplyr::mutate(qc = as.factor(ifelse(is.na(qc),
                                                     "ok",
                                                     as.character(qc)))) %>%
                 dplyr::mutate(type = ifelse(grepl("^[A-Z][A-Z][0-9]", id), "test", NA),
                               type = ifelse(grepl("^BG[0-9]", id), "bg", type))
```

* error from instrument

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
   # smps_merged <- dplyr::mutate(smps_merged,
   #                              qc = ifelse(grepl("^Normal Scan$", instrument_errors),
   #                                          as.character(qc),
   #                                          "bad"))
```

* additional bad tests

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
   # smps_merged$qc[smps_merged$id == ""] <- "bad"
```

```{r}
types <- readRDS("../r_files/samples.RDS") %>%
         select(id, type, mc_level)

smps_conc <- select(smps_merged, id, size_nm, dw) %>%
                 filter(!is.na(size_nm)) %>%
                 mutate(dw = as.numeric(dw)) %>%
                 group_by(id, size_nm) %>%
                 summarise(avg_val = mean(dw)) %>%
                 ungroup() %>%
                 group_by(id) %>%
                 mutate(conc = avg_val/sum(avg_val)) %>%
                 ungroup() %>%
                 left_join(types, by = "id") %>%
                 filter(!grepl("^BG", id))

smps_conc1 <- group_by(smps_conc, mc_level, size_nm) %>%
              mutate(conc = mean(conc)) %>%
              ungroup() %>%
              mutate(mc_level = forcats::fct_relevel(mc_level, "low","med","high"))

smps_conc2 <- filter(smps_conc, grepl("low", mc_level))
smps_conc3 <- filter(smps_conc, grepl("med", mc_level))
smps_conc4 <- filter(smps_conc, grepl("high", mc_level))

ggplot(smps_conc1, aes(x = size_nm, y = conc, color = mc_level)) +
  geom_line(size = 2) +
  scale_y_log10() +
  scale_color_manual(values = c("darkorange", "darkorchid3", "blue")) +
  theme_bw() +
  labs(color = "MC Level", x = "Particle Size [nm]", y = "Particle Number: Relative Frequency")

```

```{r}
ggplot(filter(smps_conc1, grepl("low", mc_level)), aes(x = size_nm, y = conc)) +
  geom_line(size = 2, color = "darkorange") +
  geom_line(data = smps_conc2, aes(group = id, x = size_nm, y = conc), color = "darkorange", alpha = 0.7) +
  scale_y_log10() +
  theme_bw() +
  labs(x = "Particle Size [nm]", y = "Particle Number: Relative Frequency")
```

```{r}
ggplot(filter(smps_conc1, grepl("med", mc_level)), aes(x = size_nm, y = conc)) +
  geom_line(size = 2, color = "darkorchid3") +
  geom_line(data = smps_conc3, aes(group = id, x = size_nm, y = conc), color = "darkorchid3", alpha = 0.7) +
  scale_y_log10() +
  theme_bw() +
  labs(x = "Particle Size [nm]", y = "Particle Number: Relative Frequency")
```

```{r}
ggplot(filter(smps_conc1, grepl("high", mc_level)), aes(x = size_nm, y = conc)) +
  geom_line(size = 2, color = "blue") +
  geom_line(data = smps_conc4, aes(group = id, x = size_nm, y = conc), color = "blue", alpha = 0.7) +
  scale_y_log10() +
  theme_bw() +
  labs(x = "Particle Size [nm]", y = "Particle Number: Relative Frequency")
```


```{r}

smps_plot <- select(smps_merged, id, size_nm, dw) %>%
             left_join(types, by = "id") %>%
             filter(!is.na(size_nm)) %>%
             filter(!grepl("^BG", id)) %>%
             mutate(dw = as.numeric(dw)) %>%
             mutate(mc_level = forcats::fct_relevel(mc_level, "low","med","high")) %>%
             group_by(mc_level, size_nm) %>%
             summarise(avg_val = mean(dw))
             
smps_bg <- select(smps_merged, id, size_nm, dw) %>%
             left_join(types, by = "id") %>%
             filter(!is.na(size_nm)) %>%
             filter(grepl("^BG", id)) %>%
             mutate(dw = as.numeric(dw)) %>%
             group_by(size_nm) %>%
             summarise(avg_val_bg = mean(dw))

smps_plot_bg_correct <- left_join(smps_plot, smps_bg, by = "size_nm") %>%
                        mutate(corrected_num = avg_val - avg_val_bg)

ggplot(smps_plot_bg_correct, aes(x = size_nm, y = corrected_num, color = mc_level)) +
  geom_point() +
  geom_line() +
  scale_y_log10() +
  scale_color_manual(values = c("darkorange", "darkorchid3", "blue")) +
  theme_bw() +
  labs(color = "MC Level", x = "Particle Size [nm]", y = "Number of Particles [dw/dlogDp]")
```


# Ultrafine number

## per scan 

* select sub-100nm data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  smps_ultrafine <- dplyr::select(smps_merged, id, dw, size_nm, time, sample) %>%
                    dplyr::filter(size_nm <= 100)
```

* get timestamps

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  times <- dplyr::select(test_times, -date) %>%
           dplyr::rename(start = set_1)
```

* filter by test time window

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  smps_ultrafine <- filter_times(times, smps_ultrafine)
```

* calculate number concentration over each scan

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  smps_ultrafine <- dplyr::group_by(smps_ultrafine, id, sample) %>%
                    dplyr::summarise(number_conc = sum(as.numeric(dw) * 0.015625355))
```

* plot timeseries for each experiment

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=12, fig.height=40} 
  ggplot(smps_ultrafine, aes(sample, number_conc)) +
         geom_point() +
         facet_wrap(~id, ncol = 3, scales = "free") +
         scale_y_log10() +
         theme_minimal() + 
         ylab("number per cc") +
         theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
         theme(legend.position = "top") +
         scale_colour_manual(values = c("ok" = "mediumaquamarine",
                                        "maybe" = "mediumorchid",
                                        "bad" = "mistyrose4"))
         
```

## test average

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  smps_ultrafine_avg <- dplyr::filter(smps_ultrafine) %>%
                    dplyr::group_by(id) %>%
                    dplyr::summarise(mean_number_conc = mean(number_conc)) #,
                                     #qc = first(qc))
```

* plot test average

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=12, fig.height=6} 
  ggplot(smps_ultrafine_avg, aes(id, mean_number_conc)) +
         geom_point() +
         scale_y_log10() +
         theme_minimal() + 
         ylab("sub 100 nm - mean number per cc") +
         theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
         theme(legend.position = "top") +
         scale_colour_manual(values = c("ok" = "mediumaquamarine",
                                        "maybe" = "mediumorchid",
                                        "bad" = "mistyrose4"))
```

# Background (BG tests)

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  smps_ultrafine_bg <-  dplyr::filter(smps_merged, size_nm <= 100, type == "bg") %>%
                        dplyr::select(id, dw, size_nm, time, sample, type)
```

* reformat time data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  times_bg <- dplyr::filter(smps_pax_bg_times, !grepl("^G", id), type == "sample") %>%
              tidyr::spread(time_point, value) %>%
              dplyr::select(-date)
```

* filter by test time window START HERE 8/10/17

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  smps_ultrafine_bg <- filter_times(times_bg, smps_ultrafine_bg)
```

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  smps_ultrafine_bg <- dplyr::group_by(smps_ultrafine_bg, id, sample) %>%
                       dplyr::summarise(number_conc = sum(as.numeric(dw)) * 0.015625355) %>%
                                       # n_bad = sum(qc == "bad")) %>%
                                        # qc = first(qc)) %>%
                       dplyr::ungroup()
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=12, fig.height=10}
  ggplot(smps_ultrafine_bg, aes(sample, number_conc, group_by(id), colour = id)) +
            geom_point() +
            theme_minimal() +
            scale_y_log10() +
            theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
            theme(legend.position = "top")

  # p_qc <- ggplot(smps_ultrafine_bg, aes(sample, number_conc, group_by(id), colour = qc)) +
  #           geom_point() +
  #           theme_minimal() +
  #           scale_y_log10() +
  #           theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  #           theme(legend.position = "top") +
  #           scale_colour_manual(values = c("ok" = "mediumaquamarine",
  #                                          "maybe" = "mediumorchid",
  #                                          "bad" = "mistyrose4"))
  # 
  # grid.arrange(p_id, p_qc, ncol = 1)
```

# Save files

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  saveRDS(smps_merged, file = "../r_files/smps_merged.RDS")

  saveRDS(smps_ultrafine, file = "../r_files/smps_ultrafine.RDS")

  saveRDS(smps_ultrafine_bg, file = "../r_files/smps_ultrafine_bg.RDS")
```

# Summary

The SMPS measured during `r length(unique(smps_merged$id))` experiments between `r min(smps_merged$date, na.rm = TRUE)` and `r max(smps_merged$date, na.rm = TRUE)`. There is no $SMPS$ data for tests: `r setdiff(as.character(samples$id), as.character(smps_merged$id))`.

SMPS data is expected to be missing for: first test day

# Plots

## qc (optional)

* all scans

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=12, fig.height=80, eval=FALSE}
  # ggplot(smps_merged, aes(size, value, group = sample, colour = qc)) +
  #        geom_line() +
  #        facet_wrap(~id, ncol = 3, scales = "free") +
  #        theme_minimal() +
  #        scale_x_log10() + scale_y_log10() +
  #        ylab("dN/dlogDp") +
  #        xlab("nm") +
  #        theme(legend.position = "none")
```
