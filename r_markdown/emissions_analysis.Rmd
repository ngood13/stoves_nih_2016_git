---
title: "Emissions Analysis"
author: "Kristen Fedak"
date: "July 17, 2017"
output: html_document
---


```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
  library(knitr)
```

# Load and format data
```{r}
  emission_factors <- readRDS(file = "../r_files/emission_factors.RDS")
```

```{r}
 source("../r_scripts/R_functions.R")
```


```{r}
#set variable types from character -> factor
#filter out bad QC data
#set fuel type order by survey result "commonality" of use. 
  ef_bymass <- dplyr::mutate(emission_factors, fuel = factor(fuel),
                                              qc = factor(qc),
                                              pol = factor(pol)) %>%
               dplyr::filter(qc != "bad") %>%
               dplyr::mutate(fuel = forcats::fct_relevel(fuel, "background", "kerosene",
                                                      "plastic_bags", "newspaper",
                                                      "leaves_twigs", "rubber",
                                                      "flipflops", "t_shirts",
                                                      "food_packaging", "wood_shims")) 

#check how many rows (pollutants) per test
table(ef_bymass$id)

```
* Expected number of rows: 896 
* 25 pol x 34 tests + 1 pol x 8 tests (blanks #36-43, grav only) + 0 pol x 2 tests (full censor for bad QC on #8, 24) + 20 x 1 test (#44; no VOCs) + 9 pol x 2 tests (#1,30; no carbonyls - censored for bad QC). 
* final dataset when QC bad censored = 896 rows - as expected!

# Summarize emissions factors by pollutant and fuel type
```{r}
ef_sum <- ef_bymass %>% filter(!grepl("36|37|38|39|40|41|42|43", id)) %>%
                    dplyr::group_by(fuel, pol) %>%
                    dplyr::summarize(nreps = n(),
                                     mean_ef = round(mean(mass_per_mass_fuel, na.rm = TRUE), 4),
                                     min_ef = round(min(mass_per_mass_fuel, na.rm = TRUE), 4),
                                     max_ef = round(max(mass_per_mass_fuel, na.rm = TRUE), 4))
#mass_ef in units g pol / kg fuel; one average value per fuel_type.

ef_mean_table <- select(ef_sum, fuel, pol, mean_ef) %>%
                 spread(fuel, mean_ef) %>%
                 select(-background)
```

### Table 1. Mean emission factors (mass basis) for various startup materials and pollutants
* units = g pollutant emitted per kg of fuel burned
```{r echo = FALSE}
knitr::kable(ef_mean_table)
```

# Figure 1. Mean emission factors (mass basis) for various startup materials and pollutants

```{r fig.width=20, fig.height= 20}
  p_data <- filter(ef_bymass, fuel != "background") 
  
  ggplot(p_data, aes(fuel, mass_per_mass_fuel, color = fuel)) +
  geom_boxplot(outlier.size = NA) +
  geom_point() +
  theme_bw() +
  theme(legend.position = "none",
        text = element_text(size=20),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab("g pol / kg fuel") + xlab("fuel type") +
  facet_wrap(~pol, scales = "free")
```

## Figure 1A. Mean emission factors (mass basis) for VOCs

```{r fig.width=18, fig.height= 12}
  p_data_voc <- dplyr::filter(p_data, inst == "voc")

  ggplot(p_data_voc, aes(fuel, mass_per_mass_fuel, color = fuel)) +
  geom_boxplot(outlier.size = NA, size = 1.25) +
  geom_point(size = 4) +
  theme_bw() +
  theme(legend.position = "none",
        text = element_text(size=25),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab("g pol / kg fuel") + xlab("fuel type") +
  facet_wrap(~pol, scales = "free")
```
## Pairwise tests for VOCs

* benzene
```{r}
pairwise.t.test(p_data_voc$mass_per_mass_fuel[p_data_voc$pol == "voc_benzene"], p_data_voc$fuel[p_data_voc$pol == "voc_benzene"], p.adj = "none")
```
* toluene
```{r}
pairwise.t.test(p_data_voc$mass_per_mass_fuel[p_data_voc$pol == "voc_toluene"], p_data_voc$fuel[p_data_voc$pol == "voc_toluene"], p.adj = "none")
```
## Figure 1B. Mean emission factors (mass basis) for carbonyls

```{r fig.width=24, fig.height= 25}
  p_data_carbs <- dplyr::filter(p_data, inst == "carbs")

  ggplot(p_data_carbs, aes(fuel, mass_per_mass_fuel, color = fuel)) +
  geom_boxplot(outlier.size = NA, size = 1.5) +
  geom_point(size = 4) +
  theme_bw() +
  theme(legend.position = "none",
        text = element_text(size=25),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab("g pol / kg fuel") + xlab("fuel type") +
  facet_wrap(~pol, scales = "free", ncol = 4)
```

## Pairwise tests for carbs

* formaldehyde
```{r}
pairwise.t.test(p_data_carbs$mass_per_mass_fuel[p_data_carbs$pol == "formaldehyde"], p_data_carbs$fuel[p_data_carbs$pol == "formaldehyde"], p.adj = "none")
```

## Figure 1C. Mean emission factors (mass basis) for  CO/CO2/CH4

```{r fig.width=18, fig.height= 6}
  p_data_gas <- dplyr::filter(p_data, inst == "fivegas")

  ggplot(p_data_gas, aes(fuel, mass_per_mass_fuel, color = fuel)) +
  geom_boxplot(outlier.size = NA, size = 1.5) +
  geom_point(size = 4) +
  theme_bw() +
  theme(legend.position = "none",
        text = element_text(size=25),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab("g pol / kg fuel") + xlab("fuel type") +
  facet_wrap(~pol, scales = "free")
```

### Pairwise tests for CO/CO2/CH4
* CO
```{r}
  pairwise.t.test(p_data_gas$mass_per_mass_fuel[p_data_gas$pol == "co"], p_data_gas$fuel[p_data_gas$pol == "co"], p.adj = "none")
```

* CO2
```{r}
  pairwise.t.test(p_data_gas$mass_per_mass_fuel[p_data_gas$pol == "co2"], p_data_gas$fuel[p_data_gas$pol == "co2"], p.adj = "none")
```

* CH4
```{r}
  pairwise.t.test(p_data_gas$mass_per_mass_fuel[p_data_gas$pol == "ch4"], p_data_gas$fuel[p_data_gas$pol == "ch4"], p.adj = "none")
```
## Figure 1D. Mean emission factors (mass basis) for PM2.5

```{r fig.width=6, fig.height= 6}
  p_data_pm <- dplyr::filter(p_data, inst == "grav")

  ggplot(p_data_pm, aes(fuel, mass_per_mass_fuel, color = fuel)) +
  geom_boxplot(outlier.size = NA, size = 1.5) +
  geom_point(size = 4) +
  theme_bw() +
  theme(legend.position = "none",
        text = element_text(size=25),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab("g pol / kg fuel") + xlab("fuel type") #+
  #facet_wrap(~pol, scales = "free")
```

### Pairwise tests for PM2.5
```{r}
  pairwise.t.test(p_data_pm$mass_per_mass_fuel, p_data_pm$fuel, p.adj = "none")
```

## Correlation Plots

* PM vs. CO
```{r}
  pmco <- dplyr::filter(emission_factors, grepl('^grav$|^co$', pol)) %>%
        select(id, fuel, pol, mass_per_mass_fuel) %>%
        tidyr::spread(pol, mass_per_mass_fuel) %>%
        dplyr::filter(!grepl('31|32|33|34|35|36|37|38|39|40|41|42|43', id))

  pmco_means <- dplyr::filter(ef_sum, grepl('^grav$|^co$', pol)) %>%
        select(fuel, pol, mean_ef) %>%
        tidyr::spread(pol, mean_ef) %>%
        dplyr::filter(fuel != 'background')

  ggplot() + 
        geom_point(data = pmco_means, aes(x = grav, y = co, colour = fuel), size = 4, shape = 18) +
        geom_point(data = pmco, aes(x = grav, y = co, colour = fuel), size = 2, shape = 21, stroke = 1.5) +
          ylab("CO EF (g/kg of fuel) ") +
          xlab("PM2.5 EF (g/kg of fuel)") +
          scale_color_hue(l=50, c=80) +
          scale_x_log10() +
          theme_bw() +
          scale_y_log10() +
          theme(text = element_text(size = 18),
                legend.position = "top",
                legend.key.size = unit(0.1, "cm"),
                legend.title = element_blank())
```


* Benzene vs. CO
```{r}
  benzco <- dplyr::filter(emission_factors, grepl('^voc_benzene$|^co$', pol)) %>%
        select(id, fuel, pol, mass_per_mass_fuel) %>%
        tidyr::spread(pol, mass_per_mass_fuel) %>%
        dplyr::filter(!grepl('31|32|33|34|35|36|37|38|39|40|41|42|43', id))

  benzco_means <- dplyr::filter(ef_sum, grepl('^voc_benzene$|^co$', pol)) %>%
        select(fuel, pol, mean_ef) %>%
        tidyr::spread(pol, mean_ef) %>%
        dplyr::filter(fuel != 'background')

  ggplot() + 
        geom_point(data = benzco_means, aes(x = voc_benzene, y = co, colour = fuel), size = 4, shape = 18) +
        geom_point(data = benzco, aes(x = voc_benzene, y = co, colour = fuel), size = 2, shape = 21, stroke = 1.5) +
          ylab("CO EF (g/kg of fuel) ") +
          xlab("Benzene EF (g/kg of fuel)") +
          scale_color_hue(l=50, c=80) +
          scale_x_log10() +
          theme_bw() +
          scale_y_log10() +
          theme(text = element_text(size = 18),
                legend.position = "top",
                legend.key.size = unit(0.1, "cm"),
                legend.title = element_blank())
```


* PM vs. formaldehyde
```{r}
  pmform <- dplyr::filter(emission_factors, grepl('^grav$|^formaldehyde$', pol)) %>%
        select(id, fuel, pol, mass_per_mass_fuel) %>%
        tidyr::spread(pol, mass_per_mass_fuel) %>%
        dplyr::filter(!grepl('31|32|33|34|35|36|37|38|39|40|41|42|43', id))

  pmform_means <- dplyr::filter(ef_sum, grepl('^grav$|^formaldehyde$', pol)) %>%
        select(fuel, pol, mean_ef) %>%
        tidyr::spread(pol, mean_ef) %>%
        dplyr::filter(fuel != 'background')

  ggplot() + 
        geom_point(data = pmform_means, aes(x = grav, y = formaldehyde, colour = fuel), size = 4, shape = 18) +
        geom_point(data = pmform, aes(x = grav, y = formaldehyde, colour = fuel), size = 2, shape = 21, stroke = 1.5) +
          ylab("Formaldehyde EF (g/kg of fuel) ") +
          xlab("PM2.5 EF (g/kg of fuel)") +
          scale_color_hue(l=50, c=80) +
          scale_x_log10() +
          theme_bw() +
          scale_y_log10() +
          theme(text = element_text(size = 18),
                legend.position = "top",
                legend.key.size = unit(0.1, "cm"),
                legend.title = element_blank())
```
