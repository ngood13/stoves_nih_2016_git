---
title: "Emissions Analysis"
author: "Kristen Fedak"
date: "July 17, 2017"
output: html_document
---


```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
  library(knitr)
```

# Load and format data
```{r}
  emission_factors <- readRDS(file = "../r_files/emission_factors.RDS")
```

```{r}
#set variable types from character -> factor
#filter out bad QC data
#set fuel type order by survey result "commonality" of use. 
  ef_bymass <- dplyr::mutate(emission_factors, fuel = factor(fuel),
                                              qc = factor(qc),
                                              pol = factor(pol)) %>%
               dplyr::filter(qc != "bad") %>%
               dplyr::mutate(fuel = forcats::fct_relevel(fuel, "background", "kerosene",
                                                      "plastic_bags", "newspaper",
                                                      "leaves_twigs", "rubber",
                                                      "flipflops", "t_shirts",
                                                      "food_packaging", "wood_shims")) 

#check how many rows (pollutants) per test
table(ef_bymass$id)

```
* Expected number of rows: 896 
* 25 pol x 34 tests + 1 pol x 8 tests (blanks #36-43, grav only) + 0 pol x 2 tests (full censor for bad QC on #8, 24) + 20 x 1 test (#44; no VOCs) + 9 pol x 2 tests (#1,30; no carbonyls - censored for bad QC). 
* final dataset when QC bad censored = 896 rows - as expected!

# Summarize emissions factors by pollutant and fuel type
```{r}
ef_sum <- ef_bymass %>% filter(!grepl("36|37|38|39|40|41|42|43", id)) %>%
                    dplyr::group_by(fuel, pol) %>%
                    dplyr::summarize(nreps = n(),
                                     mean_ef = round(mean(mass_per_mass_fuel, na.rm = TRUE), 4),
                                     min_ef = round(min(mass_per_mass_fuel, na.rm = TRUE), 4),
                                     max_ef = round(max(mass_per_mass_fuel, na.rm = TRUE), 4))
#mass_ef in units g pol / kg fuel; one average value per fuel_type.

ef_mean_table <- select(ef_sum, fuel, pol, mean_ef) %>%
                 spread(fuel, mean_ef) %>%
                 select(-background)
```

### Table 1. Mean emission factors (mass basis) for various startup materials and pollutants
* units = g pollutant emitted per kg of fuel burned
```{r echo = FALSE}
knitr::kable(ef_mean_table)
```

# Figure 1. Mean emission factors (mass basis) for various startup materials and pollutants

```{r fig.width=20, fig.height= 20}
  p_data <- filter(ef_bymass, fuel != "background") 
  
  ggplot(p_data, aes(fuel, mass_per_mass_fuel, color = fuel)) +
  geom_boxplot(outlier.size = NA) +
  geom_point() +
  theme_bw() +
  theme(legend.position = "none",
        text = element_text(size=20),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab("g pol / kg fuel") + xlab("fuel type") +
  facet_wrap(~pol, scales = "free")
```

## Figure 1A. Mean emission factors (mass basis) for various startup materials and VOCs

```{r fig.width=20, fig.height= 20}
  p_data2 <- dplyr::filter(p_data, inst == "voc")

  ggplot(p_data2, aes(fuel, mass_per_mass_fuel, color = fuel)) +
  geom_boxplot(outlier.size = NA) +
  geom_point() +
  theme_bw() +
  theme(legend.position = "none",
        text = element_text(size=20),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab("g pol / kg fuel") + xlab("fuel type") +
  facet_wrap(~pol, scales = "free")
```

## Figure 1B. Mean emission factors (mass basis) for various startup materials and carbonyls

```{r fig.width=20, fig.height= 20}
  p_data3 <- dplyr::filter(p_data, inst == "carbs")

  ggplot(p_data3, aes(fuel, mass_per_mass_fuel, color = fuel)) +
  geom_boxplot(outlier.size = NA) +
  geom_point() +
  theme_bw() +
  theme(legend.position = "none",
        text = element_text(size=20),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab("g pol / kg fuel") + xlab("fuel type") +
  facet_wrap(~pol, scales = "free")
```


## Figure 1C. Mean emission factors (mass basis) for various startup materials and CO/CO2/CH4

```{r fig.width=20, fig.height= 12}
  p_data4 <- dplyr::filter(p_data, inst == "fivegas")

  ggplot(p_data4, aes(fuel, mass_per_mass_fuel, color = fuel)) +
  geom_boxplot(outlier.size = NA) +
  geom_point() +
  theme_bw() +
  theme(legend.position = "none",
        text = element_text(size=20),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab("g pol / kg fuel") + xlab("fuel type") +
  facet_wrap(~pol, scales = "free")
```

## Figure 1D. Mean emission factors (mass basis) for various startup materials and carbons

```{r fig.width=8, fig.height= 8}
  p_data5 <- dplyr::filter(p_data, inst == "grav")

  ggplot(p_data5, aes(fuel, mass_per_mass_fuel, color = fuel)) +
  geom_boxplot(outlier.size = NA) +
  geom_point() +
  theme_bw() +
  theme(legend.position = "none",
        text = element_text(size=20),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab("g pol / kg fuel") + xlab("fuel type") #+
  #facet_wrap(~pol, scales = "free")
```
