---
title: "Notes"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  source("../r_scripts/R_tidy.R")
  source("../r_scripts/R_functions.R")
  source("../r_scripts/R_load_metadata.R")
```

# Load files that contain any notes or test metadata

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  notes <- readRDS("../r_files/notes.RDS")
  test_info <- readRDS("../r_files/test_info.RDS")
  ids_int <- readRDS("../r_files/ids_int.RDS")
  notes_kf <- read.csv("../data/logs/startup_qc_notes.csv")
```

# Compile notes

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  colnames(notes_kf) <- c("id_test", "instrument", "qc", "notes")

  notes_all <- dplyr::left_join(notes, notes_kf, by = "id_test")
  notes_all$notes <- paste0(notes_all$notes.x,"; ", notes_all$notes.y)
  
```

# Break out instruments

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  notes <- dplyr::mutate(notes,
                         inst = ifelse(grepl("5-Gas|5-gas", notes),
                                       "fivegas",
                                       inst)) %>%
           dplyr::mutate(inst = ifelse(grepl("CO2 sensors", notes),
                                       "co2", inst)) %>%
           dplyr::mutate(inst = ifelse(grepl("^Missing", notes),
                                       "fivegas:smps", inst)) %>%
           dplyr::mutate(inst = ifelse(grepl("^P ", notes),
                                       "pah|ions", inst)) %>%
           dplyr::mutate(inst = ifelse(grepl("^Filter ruptured$|^Teflon|^Flow dropped",
                                       notes),
                                       "trans:grav:ecoc:ions:pah",
                                       inst)) %>%
           dplyr::mutate(inst = ifelse(grepl("^Filter ruptured;",
                                       notes),
                                       "trans:grav:ecoc:ions:pah:fivegas",
                                       inst)) %>%
           dplyr::mutate(inst = ifelse(grepl("^No 5Gas", notes),
           														"fivegas:carb",
           														inst)) %>%
           dplyr::mutate(inst = ifelse(grepl("Out of CO2", notes),
           														"fivegas:co2", inst)) %>%
           dplyr::mutate(inst = ifelse(grepl("^Clock", notes),
           														"all", inst)) %>%
           dplyr::mutate(inst = ifelse(grepl("E filter ruptured", notes),
           														"smps:ecoc", inst)) %>%
           dplyr::mutate(inst = ifelse(grepl("SOME PM STUCK|dropped filter",
                                       notes),
                                       "grav", inst)) %>%
           dplyr::mutate(inst = ifelse(grepl("Carbonyl tubing became clogged",
                                       notes),
                                       "carb", inst)) %>%
           dplyr::mutate(inst = ifelse(grepl("^SMPS|Size range:|Time:",
                                       notes),
                                       "smps", inst)) %>%
           dplyr::mutate(inst = ifelse(grepl("^White quartz|White cartridge flow",
                                       notes),
                                       "trans:grav:ecoc:ions:pah",
                                       inst)) %>%
           dplyr::mutate(inst = ifelse(grepl("^Canister|canister", notes),
                                       "voc", inst)) %>%
           dplyr::mutate(inst = ifelse(grepl("Real time and carbonyl", notes),
                                       "pax:smps:co2:carb", inst)) %>%
           dplyr::mutate(inst = ifelse(grepl("white/orange|White cartridge clogged",
                                       notes),
                                       "trans:grav:ecoc", inst)) %>%
           dplyr::mutate(inst = ifelse(grepl("White rotometer malfunctioned during test",
                                       notes),
                                       "grav:trans:ecoc",inst)) %>%
           dplyr::mutate(inst = ifelse(grepl("two filter weights were switched",
                                       notes),
                                       "grav:trans", inst)) %>%
           dplyr::mutate(inst = ifelse(grepl("extra gunk on filter|
                                       ^*Filters in the wrong cassettes|
                                       ^Filter cassettes were mislabled|
                                       ^filter cassettes were mislabeled",
                                       notes),
                                       "trans:grav", inst)) %>%
           dplyr::mutate(inst = ifelse(grepl("Pumps for real time", notes),
                                       "carb:smps:pax:co2", inst)) %>%
           dplyr::distinct() %>%
           dplyr::arrange(inst)
```

## Create qc flag

With default value `maybe`.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  notes <- dplyr::mutate(notes, qc = factor("maybe", c("bad", "maybe", "ok")))
```


# Adjust some flags based on notes

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  notes <- dplyr::mutate(notes, qc = ifelse(grepl("^Thing 2|19:57:00$|
                                            12.12$|^Size range|
                                            Charcoal test in Thing 2|
                                            Charcoal test running",
                                            notes),
                                            "ok",
                                            as.character(qc))) %>%
           dplyr::mutate(qc = ifelse(grepl("^Stove running in Thing 2|
                                           ^Bleed|^CO2
                                            |^5-Gas|^Out of CO2|^KF|^3|^New",
                                            notes),
                                            "ok",
                                            as.character(qc))) %>%
           dplyr::mutate(qc = ifelse(grepl("^Test shut down|^dropped filter
                                           |^Dilution|^SMPS Malfunction|
                                           ^No SMPS data.|^No 5-gas",
                                           notes),
                                           "bad", as.character(qc)))
```

# Save notes

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  save(notes, file = "../r_files/notes.Rda")
```
