---
title: "Notes"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  source("../r_scripts/R_tidy.R")
  source("../r_scripts/R_functions.R")
  source("../r_scripts/R_load_metadata.R")
```

# Load files that contain any notes or test metadata

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  notes <- readRDS("../r_files/notes.RDS")
  test_info <- readRDS("../r_files/test_info.RDS")
  ids_int <- readRDS("../r_files/ids_int.RDS")
  notes_kf <- read.csv("../data/logs/startup_qc_notes.csv")
```

# Compile notes

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  colnames(notes_kf) <- c("id_test", "instrument", "qc", "notes")

  notes_all <- dplyr::left_join(notes, notes_kf, by = "id_test")
  notes_all$notes <- paste0(notes_all$notes.x,"; ", notes_all$notes.y)
  notes_all$notes <- gsub("; NA", "", notes_all$notes)
  notes_all$notes <- gsub("NA;", "", notes_all$notes)
```

# fill in QC and instrument default value

With default value `good` for `all` instruments.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  notes_all$qc <- as.character(notes_all$qc)
  notes_all$qc <- ifelse(is.na(notes_all$qc), 'good', notes_all$qc)

  notes_all$instrument <- as.character(notes_all$instrument)
  notes_all$instrument <- ifelse(is.na(notes_all$instrument), 'all', notes_all$instrument)
```

# Break out instruments

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  notes_all2 <- dplyr::mutate(notes_all,
                         instrument2 = ifelse(grepl("", notes),
                                       "all",
                                       instrument)) %>%
           dplyr::mutate(instrument2 = ifelse(grepl("NA",
                                       notes),
                                       "all",
                                       instrument)) 
  
           dplyr::distinct() %>%
           dplyr::arrange(instrument)
```

## Create qc flag for charcoal test

If noted that other test running in Thing2 Hood, change QC from `good` to `maybe`.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  notes_all2 <- dplyr::mutate(notes_all2, qc = factor("good", c("bad", "maybe", "good")))

```


# Adjust some flags based on notes

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  notes <- dplyr::mutate(notes, qc = ifelse(grepl("^Thing 2|19:57:00$|
                                            12.12$|^Size range|
                                            Charcoal test in Thing 2|
                                            Charcoal test running",
                                            notes),
                                            "ok",
                                            as.character(qc))) %>%
           dplyr::mutate(qc = ifelse(grepl("^Stove running in Thing 2|
                                           ^Bleed|^CO2
                                            |^5-Gas|^Out of CO2|^KF|^3|^New",
                                            notes),
                                            "ok",
                                            as.character(qc))) %>%
           dplyr::mutate(qc = ifelse(grepl("^Test shut down|^dropped filter
                                           |^Dilution|^SMPS Malfunction|
                                           ^No SMPS data.|^No 5-gas",
                                           notes),
                                           "bad", as.character(qc)))
```

# Save QC flags

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  saveRDS(notes_all, file = "../r_files/qc.RDS")
```
