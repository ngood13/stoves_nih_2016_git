---
title: "Notes"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  source("../r_scripts/R_tidy.R")
  source("../r_scripts/R_functions.R")
  source("../r_scripts/R_load_metadata.R")
```

# Load files that contain any notes or test metadata

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  notes <- readRDS("../r_files/notes.RDS")
  notes_kf <- read.csv("../data/logs/startup_qc_notes.csv")
```

# Add QC and instrument to "notes" file

With default value `good` for `all` instruments in no notes; `maybe` for `all` if note was that hood 2 was running/other tests occuring nearby. 
```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  notes$instrument <- ifelse(grepl("", notes$notes), "all", "")
  notes$qc <- ifelse(grepl("", notes$notes), "maybe", "")
  
  notes$instrument <- ifelse(is.na(notes$notes), "all", notes$instrument)
  notes$qc <- ifelse(is.na(notes$notes), "good", notes$qc)

  notes$instrument <- ifelse(grepl("carbonyl", notes$notes), "carbonyl", notes$instrument)
  notes$qc <- ifelse(grepl("carbonyl", notes$notes), "bad", notes$qc)
  
  notes$instrument <- ifelse(grepl("hood|charcoal", notes$notes), "all", notes$instrument)
  notes$qc <- ifelse(grepl("hood|charcoal", notes$notes), "maybe", notes$qc)
  

```

# Compile two note files into one

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  colnames(notes_kf) <- c("id_test", "instrument", "qc", "notes")
  notes$id_test <- as.factor(notes$id_test)
  notes$instrument <- as.factor(notes$instrument)
  notes$qc <- as.factor(notes$qc)
  notes_kf$notes <- as.character(notes_kf$notes)
  
  notes_all <- merge(notes, notes_kf, by = c("id_test", "instrument", "qc"), all = TRUE)
  
  
  notes_all$notes <- paste0(notes_all$notes.x,"; ", notes_all$notes.y)
  notes_all$notes <- gsub("; NA", "", notes_all$notes)
  notes_all$notes <- gsub("NA;", "", notes_all$notes)
```

# Save QC flags into a RDS

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  saveRDS(notes_all, file = "../r_files/qc.RDS")
```
