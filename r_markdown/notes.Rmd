---
title: "Notes"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  source("../r_scripts/R_tidy.R")
  source("../r_scripts/R_functions.R")
  source("../r_scripts/R_load_metadata.R")
```

# Load notes

Load files that contain any notes or test metadata

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  notes <- readRDS("../r_files/notes.RDS")
  notes_kf <- readr::read_csv("../data/logs/startup_qc_notes.csv")
```

# Add flags

* Add qc status and instrument to `notes` file

With default value `good` for `all` instruments in no notes; `maybe` for `all` if note was that hood 2 was running/other tests occuring nearby.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  notes <- dplyr::mutate(notes,
                          instrument = ifelse(grepl("", notes),
                                              "all", 
                                              ""),
                          instrument = ifelse(grepl("", notes),
                                               "all",
                                               ""),
                          qc = ifelse(grepl("", notes),
                                             "maybe",
                                             ""),
                          instrument = ifelse(is.na(notes),
                                               "all",
                                               instrument),
                          qc = ifelse(is.na(notes),
                                       "good",
                                       qc),
                          instrument = ifelse(grepl("carbonyl", notes),                                                  "carbonyl",
                                               instrument),
                          qc = ifelse(grepl("carbonyl", notes),
                                       "bad",
                                       qc),
                          instrument = ifelse(grepl("hood|charcoal",
                                               notes),
                                               "all",
                                               instrument),
                          qc = ifelse(grepl("hood|charcoal",
                                             notes),
                                             "maybe",
                                             qc))
```

# Organize 

Compile the two note files into one.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  notes_kf <- dplyr::rename(notes_kf,
                            id_test = id) %>%
              dplyr::mutate(id_test = as.factor(id_test),
                            instrument = as.factor(instrument),
                            qc = as.factor(qc),
                            notes = as.character(notes))

  notes_all <- dplyr::full_join(notes, 
                                notes_kf,
                                by = c("id_test",
                                       "instrument",
                                       "qc")) %>%
               dplyr::mutate(notes = paste0(notes.x,
                                            "; ", 
                                            notes.y),
                             notes = gsub("; NA", "", notes),
                             notes = gsub("NA;", "", notes)) %>%
                dplyr::rename(notes_log = notes.x,
                              notes_csv = notes.y)
```

# Save

* Saves the QC flags into a RDS

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  saveRDS(notes_all, file = "../r_files/qc.RDS")
```
