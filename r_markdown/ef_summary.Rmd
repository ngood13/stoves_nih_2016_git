---
title: "Emission Factor Summary"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
  library(forcats)
```

# Load and tidy data

* Load data and meta data

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  load("../r_files/emission_factors.Rda")
  load("../r_files/samples.Rda")
```

* Load functions

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  source("../r_scripts/R_functions.R")
```

* Output emissions factors column names 

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  colnames(emission_factors)
```

* Add stove/fuel information

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  emission_factors <- dplyr::left_join(emission_factors, 
                                       dplyr::select(samples, id, stove, fuel,
                                                              fuelcat, stovecat),
                                       by = "id")
```

* Add combined stove/fuel variable

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  emission_factors <- dplyr::mutate(emission_factors, stove_fuel = 
                                                      paste(stove, ":", fuel))
```

* Use carbon balance method for missing emissions factors

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  emission_factors <- dplyr::mutate(emission_factors, ifelse(is.na(mass_ef), 
                                                             mass_c_ef,
                                                             mass_ef))
```

* Remove outliers

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}

```

# CO data

* Plot emissions factors by mass, energy of fuel and energy delivered

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width = 14,  fig.height = 8}
  ef_sum <- dplyr::filter(emission_factors, grepl('^co$', pol)) %>%
            dplyr::group_by(emission_factors, stove) %>%
            dplyr::summarise(mean_ef = mean(mass_ef, na.rm = TRUE),
                             min_ef = min(mass_ef, na.rm = TRUE),
                             max_ef = max(mass_ef, na.rm = TRUE),
                             std_ef = sd(mass_ef, na.rm = TRUE))

  plot_mass_ef(ef_sum, 'CO')
```

# PM data

* Plot emissions factors by mass

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width = 14,  fig.height = 8}
  plot_mass_ef(dplyr::filter(emission_factors, grepl('grav$', pol)), 'PM')
```

# VOC data

* Plot emissions factors by mass

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width = 14,  fig.height = 8}
  plot_mass_ef(dplyr::filter(emission_factors, grepl('^voc_benzene$', pol)), 'Benzene')
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width = 14,  fig.height = 8}
  plot_mass_ef(dplyr::filter(emission_factors, grepl('^voc_toluene$', pol)), 'Benzene')
```

# Carbonyl data

* Plot emissions factors by mass

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width = 14,  fig.height = 8}
  plot_mass_ef(dplyr::filter(emission_factors, grepl('^formaldehyde$', pol)), 'Formaldehyde')
```

# EC and OC data

* Plot emissions factors by mass

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width = 14,  fig.height = 8}
  plot_mass_ef(dplyr::filter(emission_factors, grepl('^ec$', pol)), 'Elemental carbon')
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width = 14,  fig.height = 8}
  plot_mass_ef(dplyr::filter(emission_factors, grepl('^oc$', pol)), 'Organic carbon')
```
