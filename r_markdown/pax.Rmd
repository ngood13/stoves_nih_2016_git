---
title: "PAX"
author: "Nicholas Good"
date: "January 9, 2017"
output: html_document
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  source("../r_scripts/R_tidy.R")
```

# Load data

Test metadata:

```{r}
  samples <- readRDS("../r_files/samples.RDS")
  times   <- readRDS("../r_files/test_times_all.RDS")
  flows   <- readRDS("../r_files/flow_rates.RDS")
  notes   <- readRDS("../r_files/notes.RDS")
```

PAX data:

```{r}
  pax <- readRDS("../r_files/pax.RDS")
```

# Organize and combine

### Flow rates

Select PAX inlet flow rate (other flow rates not required). 

```{r}
  df_flows <- flows %>%
              dplyr::filter(instrument == "pax", loc == "inlet") %>%
              dplyr::select(-id, -colour, -loc, -instrument)
```

### Start and end times

Get the starting and ending times for the filter sample associated with each test.  Then, calculate the duration of the test in minutes.  

```{r}
  df_times <- dplyr::filter(times, var %in% c("set_1","end")) %>%
              tidyr::spread(var, value)    %>%
              dplyr::rename(start = set_1)
```

### Notes

Select one flag per test.

```{r}
  df_flags <- dplyr::filter(notes, grepl("pax|all", inst)) %>%
              dplyr::select(id, qc) %>%
              dplyr::group_by(id) %>%
              dplyr::arrange(qc) %>%
              dplyr::summarise(qc = first(qc))
```

### Combine

Add flow rate data to PAX data.  Then, map test IDs to PAX data.  

```{r}
  df_pax <- dplyr::left_join(pax, df_flows, by=c("date"))

  df_pax_id <- map_id(df_pax, df_times)
  
  df_pax_noid <- dplyr::anti_join(df_pax,
                                  dplyr::select(df_pax_id, -id),
                                  by=c("datetime")) %>%
                 dplyr::mutate(id = NA)
  
  df_pax <- bind_rows(df_pax_id, df_pax_noid) %>%
            dplyr::arrange(datetime) %>%
            dplyr::distinct()        %>%
            dplyr::left_join(df_flags, by=c("id")) %>%
            dplyr::mutate(qc = ifelse(is.na(qc), "ok", as.character(qc))) %>%
            dplyr::filter(qc != "bad")
  
  saveRDS(df_pax, file="../r_files/pax_merged.RDS")
```

The PAX measured during `r length(unique(df_pax$id))` experiments between `r min(df_pax$date, na.rm=TRUE)` and `r max(df_pax$date, na.rm=TRUE)`. There is no PAX data for tests: `r setdiff(as.character(samples$id), as.character(df_pax$id))`. PAX data is expected to be missing for: no tests

# QC Plots

PAX modes:  
0 - Measure  
1 - Zero  
2 - Flush  
3 - Acoustic calibration  

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=12, fig.height=100}

  df_plot <- dplyr::filter(df_pax, !is.na(id), mode == 0)   %>%
             dplyr::select(id, time, qc, babs_1_mm, bscat_1_mm) %>%
             tidyr::gather("type", "value", c(babs_1_mm, bscat_1_mm)) %>%
             dplyr::mutate(id = as.factor(id),
                           id = forcats::fct_relevel(id, "BG1","BG2","BG3","BG4",
                                                         "BG5","BG6","BG7","BG8",
                                                         "LL1","LL2","LL3","LL4",
                                                         "FL1","FL2","FL3","FL4",
                                                         "LM1","LM2","LM3","LM4",
                                                         "FM1","FM2","FM3","FM4",
                                                         "LH1","LH2","LH3","LH4",
                                                         "FH1","FH2","FH3","FH4"))
```

```{r, echo = FALSE, warning = FALSE, message = FALSE, results = 'markup', cache=FALSE, fig.width=6.5, fig.height=16, fig.align='center'}

  ggplot(df_plot, aes(x=time, y=value, group=type, color=type)) + 
    geom_line() +
    facet_wrap(~id, ncol=4, scale="free_x") +
    scale_colour_manual(values = c("babs_1_mm"  = "black",
                                   "bscat_1_mm" = "royalblue2")) +
    xlab("Time (s)") +
    ylab(expression(Mm^{-1})) + 
    labs(color = "Coefficient") + 
    theme(aspect.ratio=1,
          panel.border     = element_rect(fill=NA),
          panel.background = element_rect(fill='white'),
          panel.grid.major = element_line(color="gray90"),
          panel.grid.minor = element_line(color="gray90"),
          text        = element_text(size=10, color='black'),
          axis.text.x = element_text(size= 6, color='black'),
          axis.text.y = element_text(size= 9, color='black'),
          axis.title  = element_text(size= 9, color='black'),
          axis.ticks  = element_line(color='black'),
          legend.text  = element_text(size=10, color='black'),
          legend.title = element_text(size=10, color='black'),
          legend.key   = element_blank(),
          legend.position = "top") 
```

```{r, echo = FALSE, warning = FALSE, message = FALSE, results = 'markup', cache=FALSE, fig.width=6.5, fig.height=16, fig.align='center'}

  teal3  <- "#0099CC"
  orange <- "#FF6633"

  ggplot(df_plot, aes(x=time, y=value, group=type, color=qc)) + 
    geom_line() +
    facet_wrap(~id, ncol=4, scale="free_x") +
    scale_colour_manual(values = c("ok"    = teal3,
                                   "maybe" = orange)) +
    xlab("Time (s)") +
    ylab(expression(Mm^{-1})) + 
    labs(color = "QC") + 
    theme(aspect.ratio=1,
          panel.border     = element_rect(fill=NA),
          panel.background = element_rect(fill='white'),
          panel.grid.major = element_line(color="gray90"),
          panel.grid.minor = element_line(color="gray90"),
          text        = element_text(size=10, color='black'),
          axis.text.x = element_text(size= 6, color='black'),
          axis.text.y = element_text(size= 9, color='black'),
          axis.title  = element_text(size= 9, color='black'),
          axis.ticks  = element_line(color='black'),
          legend.text  = element_text(size=10, color='black'),
          legend.title = element_text(size=10, color='black'),
          legend.key   = element_blank(),
          legend.position = "top") 
```