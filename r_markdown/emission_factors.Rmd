---
title: "Emission factors"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r global_options, include=FALSE}
  knitr::opts_chunk$set(fig.path = 'figures/',
                        warning = FALSE,
                        message = FALSE,
                        fig.width = 10, fig.height = 4,
                        cache = FALSE,
                        results='markup')
```

```{r, echo=FALSE}
  library(tidyverse)
  library(knitr)
```

# Load

* sample info

```{r}
  samples <- readRDS("../r_files/samples.RDS")
```

* fuel burnt

```{r}
  fuel_burnt <- readRDS("../r_files/fuel_burnt.RDS")
```

* emissions

```{r}
  emissions_long <- readRDS("../r_files/emissions_long.RDS")
```

* hood flow

```{r}
  hood_flow <- readRDS("../r_files/hood_flow.RDS")
```

* polultant information

```{r}
  pol_properties <- readRDS("../r_files/pol_properties.RDS")
```

* fuel information

```{r}
  fuel_properties <- readRDS("../r_files/fuel_properties.RDS")
```

# Carbon calculations

* sum carbon over all pollutants

* calculate fuel burned using carbon balance method

```{r}
  carbon_emitted <- dplyr::filter(emissions_long, metric == "mass_carbon") %>%
                    dplyr::group_by(id) %>%
                    dplyr::summarise(mass_carbon = sum(value, na.rm = TRUE)) %>%
                    dplyr::left_join(dplyr::select(samples, id, fuel),
                                     by = "id") %>%
                    dplyr::left_join(fuel_properties, by = "fuel") %>%
                    dplyr::left_join(select(fuel_burnt, -units), by = "id") %>%
                    dplyr::filter(!is.na(fuel)) %>%
                    dplyr::mutate(mass_fuel_from_carbon_balance_kg =
                                  mass_carbon * (1e-9) * (1 / carbon_fraction),
                                  mass_fuel_scale_kg = mass_burnt * (1e-3)) %>%
                    dplyr::select(-mass_burnt)
```

* plot fuel from carbon balance versus measured fuel mass

```{r}
  ggplot(carbon_emitted, aes(mass_fuel_scale_kg, mass_fuel_from_carbon_balance_kg)) + 
  geom_point() +
  theme_minimal() +
  geom_smooth(method = "lm", se = FALSE, color = "black", formula = y ~ x) +
  geom_abline(intercept = 0, slope = 1, color = "grey90") +
  xlim(0, NA) + ylim(0, NA) +
  geom_text(aes(label = id), nudge_x = -0.01, nudge_y = 0.01)

```

```{r}
  df <- dplyr::select(carbon_emitted, mass_fuel_from_carbon_balance_kg, mass_fuel_scale_kg) %>%
      dplyr::rename(mass_carbon_balance = mass_fuel_from_carbon_balance_kg, mass_scale = mass_fuel_scale_kg)

  summary(lm(mass_carbon_balance ~ mass_scale, data = df))
```

# Pollutant mass per kg fuel
 
```{r}
  emission_factors <- dplyr::left_join(dplyr::filter(emissions_long, metric == "mass_emitted"), 
                                       dplyr::select(fuel_burnt, id, mass_burnt),
                                       by = "id" ) %>%
                      dplyr::mutate(mass_pol_mass_fuel = ((value * 1e-3) / mass_burnt)) # g pol / kg fuel
                            
```

## Plot emissions by id

```{r, fig.width = 12, fig.height = 8}
  p_data <- dplyr::left_join(emission_factors,
                             dplyr::select(samples, id, type, mc_level),
                                           by = "id") %>%
            dplyr::filter(type != "bg") %>%
            dplyr::mutate(mc_level = forcats::fct_relevel(mc_level, "low",
                                                                    "med",
                                                                    "high"))

  ggplot(p_data, aes(id, mass_pol_mass_fuel, color = pol)) +
  geom_point(size = 4) +
  scale_y_log10() +
  theme_minimal() +
  theme(legend.position = "top",
        text = element_text(size=20),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab("g pol / kg fuel") + xlab("")
  
```

## Remove tests

* remove FH2 from further plots

```{r}
 p_data <- p_data %>%
           dplyr::filter(id != "FH2")
```

## Gravimetric analysis

```{r}
 df <- dplyr::select(p_data, mass_pol_mass_fuel, type, mc_level, pol, id) %>%
       dplyr::mutate(type = as.factor(type),
                     mc_level = as.factor(mc_level)) %>%
       dplyr::filter(pol == "grav") %>%
       dplyr::mutate(test_fuel_type = paste(type, mc_level, sep = "_"))
 
 f <- formula(mass_pol_mass_fuel ~ mc_level + type + mc_level*type)
 
 mod_grav <- glm(f, data = df)
```

```{r}
  mod_grav$formula
```

```{r}
  summary(mod_grav)
```

```{r}
  grav_mean <- df %>%
               dplyr::group_by(test_fuel_type) %>%
               dplyr::summarise_if(is.numeric, mean, na.rm = TRUE)

  grav_mean_wide <- grav_mean %>%
                    tidyr::spread(test_fuel_type, mass_pol_mass_fuel)

  pairwise.t.test(df$mass_pol_mass_fuel, df$test_fuel_type, p.adj = "none")

  pairwise.t.test(df$mass_pol_mass_fuel, df$test_fuel_type, p.adj = "bonf")

  pairwise.t.test(df$mass_pol_mass_fuel, df$test_fuel_type, p.adj = "holm")

  pairwise.t.test(df$mass_pol_mass_fuel, df$mc_level, p.adj = "holm")

  TukeyHSD(aov(mass_pol_mass_fuel ~ test_fuel_type, df))

  TukeyHSD(aov(mass_pol_mass_fuel ~ mc_level, df))
```

```{r}
   plot(mod_grav)
```

```{r}
  ggplot(df, aes(mc_level, mass_pol_mass_fuel, color = pol)) +
  geom_boxplot(outlier.size = NA) +
  geom_point() +
  theme_bw() +
  theme(legend.position = "none") +
  ylab("g pol / kg fuel") + xlab("moisture content") +
  facet_wrap(~pol, scales = "free")
```

## ecoc

```{r}
  ecoc <- emissions_long %>%
          dplyr::filter(pol == "ec" | pol == "oc", metric == "conc") %>%
          dplyr::select(-inst) %>%
          tidyr::spread(pol, value) %>%
          dplyr::mutate(ratio = ec / oc) %>%
          dplyr::right_join(samples, by = "id") %>%
          dplyr::filter(type != "bg") %>%
          dplyr::mutate(mc_level = forcats::fct_relevel(mc_level, "low",
                                                                  "med",
                                                                  "high"),
                        test_fuel_type = paste(type, mc_level, sep = "_"))

  ggplot(ecoc, aes(mc_level, ratio)) +
  geom_boxplot(outlier.size = NA) +
  geom_point() +
  theme_bw() +
  theme(legend.position = "none") +
  ylab("g pol / kg fuel") + xlab("moisture content") +
  ggtitle("ec : oc ratio")

  ecoc_summary <- ecoc %>%
                  dplyr::group_by(mc_level) %>%
                  dplyr::summarise_if(is.numeric, mean, na.rm = TRUE)

  pairwise.t.test(ecoc$ratio, ecoc$mc_level, p.adj = "none")

  pairwise.t.test(ecoc$ratio, ecoc$test_fuel_type, p.adj = "none")

```

## Plot emissions by moisture content

```{r, fig.width = 12, fig.height = 4}
  p_data_ <- dplyr::filter(p_data, grepl("co2|co|ch4",pol)) # comment this out since p_data redefined here
  ggplot(p_data_, aes(mc_level, mass_pol_mass_fuel, color = pol)) +
  geom_boxplot(outlier.size = NA) +
  geom_point() +
  theme_bw() +
  theme(legend.position = "none") +
  ylab("g pol / kg fuel") + xlab("moisture content") +
  facet_wrap(~pol, scales = "free")
```

## Plot emissions by moisture content and fuel type

```{r, fig.width = 12, fig.height = 8}
  p_data_ <- dplyr::filter(p_data, !grepl("tc",pol))
  ggplot(p_data_, aes(mc_level, mass_pol_mass_fuel, color = type)) +
  geom_boxplot(outlier.size = NA, mapping = aes(color = type)) +
  theme_bw() +
  theme(legend.position = "top") +
  ylab("g pol / kg fuel") + xlab("moisture content") +
  facet_wrap(~pol, scales = "free")
```

## Plot tc vs grav

```{r, echo = FALSE, fig.width = 12, fig.height = 8}
  data_grav_tc <- dplyr::filter(emissions_long,
                               (pol == "grav" | pol == "tc") & metric == "conc") %>%
                  dplyr::select(-inst)%>%
                  tidyr::spread(pol, value)

  p <- ggplot(data_grav_tc, aes(grav, tc)) +
       geom_point(aes(color = id)) +
       theme_bw() +
       theme(legend.position = "top") +
       geom_abline(slope = 1, intercept = 0) +
       geom_text(aes(label = id), nudge_x = 200)

  p
```

# Save

```{r}
  saveRDS(carbon_emitted, file = "../r_files/carbon_emitted.RDS")
  saveRDS(emission_factors, file = "../r_files/emission_factors.RDS")
```

