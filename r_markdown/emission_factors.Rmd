---
title: "Emission factors"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
  library(knitr)
```

# Load

* pollutant data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  test_info <- readRDS("../r_files/test_info.RDS")
  fuel_burnt_reps <- readRDS("../r_files/fuel_burnt_reps.RDS")
  fuel_burnt_test <- readRDS("../r_files/fuel_burnt_test.RDS")
  emissions_long <- readRDS("../r_files/emissions_long.RDS")
```

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  load("../r_files/hood_flow.Rda")
  load("../r_files/pol_properties.Rda")
  load("../r_files/inst_constants.Rda")
  load("../r_files/calc_constants.Rda")
  load("../r_files/fuel_properties.Rda")
```

# Mass carbon per test

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  mass_carbon <- dplyr::filter(emissions_long, metric == "mass_carbon_emitted") %>%
                 dplyr::group_by(id) %>%
                 dplyr::summarise(mass_carbon = sum(value, na.rm = TRUE))

  mass_carbon <- dplyr::left_join(mass_carbon,
                                  select(fuel_burnt_test, id, fuelmass_total),
                                         by = "id")
```


```{r}
  p_data <- mutate(mass_carbon, fuelmass_total = fuelmass_total * 1e6) %>%
            gather("var", "val", 2:3)
           

  ggplot(p_data, aes(id, val, color = var)) + geom_point() + scale_y_log10()

  p_data <- mutate(mass_carbon, fuelmass_total = fuelmass_total * 1e6,
                                frac = mass_carbon / fuelmass_total)
  
  ggplot(p_data, aes(id, frac)) + geom_point(color = "blue")
          
```


# Merge with fuel properties

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE} 
  mass_carbon <- dplyr::left_join(mass_carbon,
                                  dplyr::select(test_info, id, fuel),
                                  by = "id") %>%
                 dplyr::left_join(fuel_properties, by = "fuel")
```

# Carbon balance

* Calculate fuel burned using carbon balance method

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE} 
  mass_carbon <- dplyr::left_join(mass_carbon, fuel_burnt_test, by = c("id", "fuelmass_total")) %>%
                 dplyr::mutate(mass_fuel_from_carbon_balance_kg = mass_carbon * (1e-9) / (carbon_fraction),
                        mass_fuel_scale_kg = fuelmass_total * (1e-3))
```

```{r}
 ggplot(mass_carbon, aes(mass_fuel_scale_kg, mass_fuel_from_carbon_balance_kg)) + geom_point()
```


# Calculate emissions factors
 
```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  emission_factors <- emissions_long %>%
                      dplyr::filter(metric == "mass_emitted") %>%
                      dplyr::left_join(fuel_burnt_test, "id") %>%
                      dplyr::mutate(mass_per_mass_fuel = (value * 1e-6) / (fuelmass_total * (1e-3))) %>%
                      dplyr::left_join(select(test_info, id, fuel), by = "id")
```


```{r, fig.width = 15, fig.height = 30}
  ggplot(dplyr::filter(emission_factors, fuel != "background"), aes(fuel, mass_per_mass_fuel, colour = fuel)) + 
  geom_point() +
  facet_wrap(~pol, scales = "free", ncol = 2) +
  theme_minimal() +
  theme(legend.position = "top")
```

# Save

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  saveRDS(mass_carbon, file = "../r_files/mass_carbon.RDS")
  saveRDS(emission_factors, file = "../r_files/emission_factors.RDS")
```

# Plots

## carbon emitted

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=12, fig.height=8}
  ggplot(mass_carbon, aes(x = id, y = mass_carbon)) +
    geom_point() +
    theme_minimal() +
    scale_y_log10() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
    ggtitle("mass carbon emitted")
```


