---
title: "Emission factors"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
  library(knitr)
```

# Load

* pollutant data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  samples <- readRDS("../r_files/samples.RDS")

  fuel_burnt <- readRDS("../r_files/fuel_burnt.RDS")

  emissions_long <- readRDS("../r_files/emissions_long.RDS")
```

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  hood_flow <- readRDS("../r_files/hood_flow.RDS")

  pol_properties <- readRDS("../r_files/pol_properties.RDS")
  
  fuel_properties <- readRDS("../r_files/fuel_properties.RDS")

```

# Carbon balance

* calc mass carbon emitted

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  carbon_emitted <- dplyr::filter(emissions_long, metric == "mass_carbon") %>%
                    dplyr::group_by(id) %>%
                    dplyr::summarise(mass_carbon = sum(value, na.rm = TRUE))
```

* merge with fuel sample info, fuel properties and fuel burnt

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE} 
  carbon_emitted <- dplyr::left_join(carbon_emitted,
                                dplyr::select(samples, id, fuel),
                                by = "id") %>%
                    dplyr::left_join(fuel_properties, by = "fuel") %>%
                    dplyr::left_join(select(fuel_burnt, -units), by = "id") %>%
                    dplyr::filter(!is.na(fuel))
```

* Calculate fuel burned using carbon balance method

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE} 
  carbon_emitted <- carbon_emitted %>%
                    dplyr::mutate(mass_fuel_from_carbon_balance_kg = mass_carbon * (1e-9) * (1 / carbon_fraction)) %>%
                    dplyr::mutate(mass_fuel_scale_kg = mass_burnt * (1e-3))
```

```{r}
  ggplot(carbon_emitted, aes(mass_fuel_scale_kg, mass_fuel_from_carbon_balance_kg)) + 
  geom_point() +
  theme_minimal() +
  geom_smooth(method = "lm", se=FALSE, color="black", formula = y ~ x)

```

```{r}
df <- dplyr::select(carbon_emitted, mass_fuel_from_carbon_balance_kg, mass_fuel_scale_kg) %>%
      dplyr::rename(y = mass_fuel_from_carbon_balance_kg, x = mass_fuel_scale_kg)

summary(lm(y ~ x, data = df))


```


# Calculate emissions factors
 
```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  emission_factors <- dplyr::left_join(emission_factors, 
                                dplyr::select(mass_fuel, id, mass_fuel_c, 
                                                         mass_fuel_kg, lhv), by = "id" ) %>%
               dplyr::mutate(mass_ef = ((value * 1e-3) / mass_fuel_kg))
                            
```

# Save

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  saveRDS(mass_fuel, file = "../r_files/mass_fuel.RDS")
  saveRDS(emission_factors, file = "../r_files/emission_factors.RDS")
```

# Plots

## carbon emitted

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=12, fig.height=8}
  ggplot(mass_fuel, aes(x = id, y = mass_carbon)) +
    geom_point() +
    theme_minimal() +
    scale_y_log10() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
    ggtitle("mass carbon emitted")
```

## carbon from CO2

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=12, fig.height=8}
  ggplot(dplyr::filter(emission_factors, pol == "co2", metric == "mass_carbon"),
         aes(x = id, y = value)) +
    geom_point() +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
    ggtitle("mass carbon emitted")
```

## fuel burnt vs carbon

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=10}  
  ggplot(mass_fuel, aes(x = mass_fuel_kg, y = mass_fuel_c, color = fuel)) +
    geom_point() +
    theme_minimal() +
    ylim(0, 2) +
    xlab("mass of fuel (measured) [kg]") +
    ylab("mass of fuel (carbon balance) [kg]")
```

## carbon emitted (bar)

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=TRUE, fig.width=10, fig.height=40, eval=TRUE} 
  ggplot(dplyr::filter(emission_factors, metric == "mass_carbon"),
                       aes(x = id, y = value, fill = inst), na.rm = TRUE) +
    geom_bar(stat = "identity")+
    coord_flip() +
    theme_minimal() +
    ylab("test id") + 
    ylab("mass emitted") +
    theme(legend.position = "top")
```

## mass emitted (bar)

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=TRUE, fig.width=10, fig.height=40, eval=TRUE} 
  ggplot(dplyr::filter(emission_factors, metric == "mass_emitted"),
        aes(x = id, y = value, fill = inst), na.rm = TRUE) +
    geom_bar(stat = "identity")+
    coord_flip() +
    theme_minimal() +
    ylab("test id") + 
    ylab("mass emitted") + 
    theme(legend.position = "top")
```
