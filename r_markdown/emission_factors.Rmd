---
title: "Emission factors"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
  library(knitr)
```

# Load

* pollutant data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  load("../r_files/samples.Rda")
  load("../r_files/emissions.Rda")
  load("../r_files/fuel_burnt.Rda")
  # load("../r_files/energy.Rda") # not yet created
```

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  load("../r_files/hood_flow.Rda")
  load("../r_files/pol_properties.Rda")
  load("../r_files/inst_constants.Rda")
  load("../r_files/calc_constants.Rda")
  load("../r_files/fuel_properties.Rda")
```

# Mass carbon per test

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  mass_carbon <- dplyr::group_by(emissions, id) %>%
                 dplyr::summarise(ug = sum(mass_carbon, na.rm = TRUE))
```

# Merge with fuel properties

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE} 
  mass_carbon <- dplyr::left_join(mass_carbon,
                                  dplyr::select(samples, id, fuel),
                                  by = "id") %>%
                 dplyr::left_join(fuel_properties, by = "fuel")
```

# Carbon balance

* Calculate fuel burned using carbon balance method

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE} 
  mass_fuel <- dplyr::left_join(mass_carbon, fuel_burnt, by = "id") %>%
               dplyr::mutate(mass_fuel_c = ug * (1e-9) * (1 / carbon_fraction)) %>%
               dplyr::mutate(mass_fuel_kg = mass_fuel * (1e-3))
```

* Filter out bad tests and only include summed species variables

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=TRUE, fig.width=10, fig.height=40} 
  emissions <- dplyr::filter(emissions, qc != "bad") %>%
               dplyr::filter(grepl("^9B$|^6D$|^2A$|^8D", id) == FALSE)  # unrealistic values
               
```

# Calculate emissions factors
 
```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  emissions <- dplyr::mutate(emissions,
                             mass_ef = ((mass_emitted * 1e-3) / (mass_fuel * 1e-3)),  # mg / kg
                             energy_ef = ((mass_ef * 1e-3) * (lhv * 1e-3)))  # g / MJ
```

# Save

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  save(mass_carbon, file = "../r_files/mass_carbon.Rda")
  save(emissions, file = "../r_files/emissions.Rda")
```

# Plots

## carbon emitted

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=12, fig.height=8}
  ggplot(mass_carbon, aes(x = id, y = ug)) +
    geom_point() +
    theme_minimal() +
    scale_y_log10() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
    ggtitle("mass carbon emitted")
```

## carbon from CO2

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=12, fig.height=8}
  ggplot(dplyr::filter(emissions, pol == "co2"),
         aes(x = id, y = mass_carbon)) +
    geom_point() +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
    ggtitle("mass carbon emitted")
```

## fuel burnt vs carbon (bug)

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=10, eval=FALSE}  
  ggplot(mass_fuel, aes(x = mass_fuel_kg, y = mass_fuel_c, color = fuel)) +
    geom_point() +
    theme_minimal() +
    ylim(0, 2) +
    xlab("mass of fuel (measured) [kg]") +
    ylab("mass of fuel (carbon balance) [kg]")
```

## carbon emitted (bar)

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=TRUE, fig.width=10, fig.height=40, eval=TRUE} 
  ggplot(dplyr::filter(emissions, grepl("^total_vocs$|^total_ions$|^total_carbonyls$|
                                     |^ec$|^oc$|^grav$|^co$|^ch4$|^co2$", pol)),
         aes(x = id, y = mass_carbon, fill = pol), na.rm = TRUE) +
    geom_bar(stat = "identity")+
    coord_flip() +
    theme_minimal() +
    ylab("test id") + 
    ylab("mass emitted") +
    theme(legend.position = "top")
```

## mass emitted (bar)

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=TRUE, fig.width=10, fig.height=40, eval=TRUE} 
  ggplot(dplyr::filter(emissions, grepl("^total_vocs$|^total_ions$|^total_carbonyls$|
                                     |^ec$|^oc$|^grav$|^co$|^ch4$|^co2$", pol)),
         aes(x = id, y = mass_emitted, fill = pol), na.rm = TRUE) +
    geom_bar(stat = "identity")+
    coord_flip() +
    theme_minimal() +
    ylab("test id") + 
    ylab("mass emitted") + 
    theme(legend.position = "top")
```
