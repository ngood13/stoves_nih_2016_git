---
title: "Grav QAQC Plots"
author: "KB"
date: "February 3, 2017"
output: html_document
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
  library(forcats)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  source("../r_scripts/R_tidy.R")
```

## Load pollutant data

The grav data is contain in one file. Units are micrograms. 

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  load("../r_files/emissions.Rda")  # load pollutant emissions data
  load("../r_files/grav_merged.Rda")  # load pollutant emissions data
  load("../r_files/samples.Rda")  # load sample meta data
  load("../r_files/fuel_burnt.Rda")  # fuel use meta data
```

* The column `pol` contains the individual pollutant names. The column `mass_emitted` contains the total mass of each pollutant emitted per firepower sweep test (excluding startup and shutdown periods). Units are in $\mu g$.

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  colnames(emissions)
```

**The `samples.Rda` file contains metadata related to the test IDs, such as what stove and fuel type was burned. The `fuel_burnt.Rda` file contains data on the total mass of fuel burned during each test.**

* The columns `stove` and `fuel` contain the exact stove and fuel type (e.g., "Ceramic Charcoal (Artisan), Coconut Charcoal") that corresponds with the number of the `id` (3 replicates per id number, specified by A, B, and C (sometimes additional replicates, [i.e. D or E], is also included). The columns `stovecat` and `fuelcat` contain broader categories of stoves and fuels (e.g., "improved, charcoal").

## Filter out pollutant of interest merge sample data

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}  
  pol <- dplyr::left_join(emissions, 
           dplyr::select(samples, id, stove, fuelcat, stovecat),
                              by = "id") %>%
           dplyr::left_join(fuel_burnt, by = "id") %>% 
           dplyr::left_join(dplyr::select(grav_merged, id, qc), by = "id") %>%
           dplyr::filter(pol == "grav")
  pol_name <- "pm2.5"
```

## Filter out bad tests

Filter out bad tests

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  pol <- dplyr::filter(pol, qc != "bad")
```

## Calculate Emissions Factor

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  pol_p <- dplyr::mutate(pol, mass_ef = 
                           (mass_emitted * 1e-3) / (mass_fuel*1e-3)) %>% # mg/kg
           dplyr::mutate(energy_ef = (mass_ef*1e-3)*(lhv*1e-3)) %>% # g/MJ
           dplyr::mutate(stove_fuel = paste(stove, ":", fuel))
           
```

* The `pol_p` now contains a subset of the emissions data for `r pol_name` pollutants of interest. A summary of the dataset is below:  

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  summary(pol_p)
```

## Calculate Emissions Factor

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  pol_p <- dplyr::mutate(pol_p, mass_ef = 
                           (mass_emitted) / (mass_fuel * 1e-3)) %>% # g/kg
           dplyr::mutate(energy_ef = (mass_ef * 1e-3)*(lhv * 1e-3)) %>% # g/MJ
           dplyr::mutate(stove_fuel = paste(stove, ":", fuel))
           
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  summary(pol_p$mass_ef)
  summary(pol_p$energy_ef)
```

* units: miligram of pollutant emitted per kilogram of fuel burned 

# Mass based emissions factor plots 

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width = 12}
  ggplot(pol_p, aes(x = id, mass_ef, colour = fuelcat)) +
    geom_point() +
    ggtitle(paste(pol_name, "ef by test id")) +
    xlab("test id") +
    ylab("g emitted / kg fuel burned") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width = 12}
  ggplot(pol_p, aes(x = stove_fuel, mass_ef, colour = stove)) +
    geom_point() +
    ggtitle(paste(pol_name, "ef by replicate categories")) +
    xlab("test id") +
    ylab("g emitted / kg fuel burned") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width = 10}
  ggplot(pol_p, aes(x = stove, mass_ef, colour = fuel)) +
    geom_point() +
    ggtitle(paste(pol_name, "ef by stove")) +
    xlab("stove type") +
    ylab("g emitted / kg fuel burned") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width = 10}
  ggplot(pol_p, aes(x = stove, mass_ef, colour = fuel)) +
    geom_point() +
    facet_grid( ~ stovecat, scales = 'free') +
    ggtitle(paste(pol_name, "ef by stove")) +
    xlab("stove type") +
    ylab("g emitted / kg fuel burned") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width = 10}
  ggplot(pol_p, aes(x = stove, mass_ef, colour = stovecat)) +
    geom_point() +
    facet_grid( ~ fuelcat, scales = 'free') +
    ggtitle(paste(pol_name, "ef by fuel and stove")) +
    xlab("stove type") +
    ylab("g emitted / kg fuel burned") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45,  hjust = 0.9))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width = 10}
  ggplot(filter(pol_p, fuelcat == 'wood'), aes(x = id, mass_ef, colour = fuel)) +
    geom_point() +
    facet_grid( ~ stove, scales = 'free') +
    ggtitle(paste(pol_name, "ef by stove type (wood only)")) +
    xlab("stove type") +
    ylab("g emitted / kg fuel burned") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width = 10}
  ggplot(filter(pol_p, fuelcat == 'charcoal'), aes(x = id, mass_ef, colour = fuel)) +
    geom_point() +
    facet_grid( ~ stove, scales = 'free') +
    ggtitle(paste(pol_name, "ef by stove type (charcoal only)")) +
    xlab("stove type") +
    ylab("g emitted / kg fuel burned") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

# Energy based emissions factor plots 

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width = 12}
  ggplot(pol_p, aes(x = id, energy_ef, colour = fuelcat)) +
    geom_point() +
    ggtitle(paste(pol_name, "ef by test id")) +
    xlab("test id") +
    ylab("g emitted / MJ fuel burned") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width = 12}
  ggplot(pol_p, aes(x = stove_fuel, energy_ef, colour = stove)) +
    geom_point() +
    ggtitle(paste(pol_name, "ef by replicate categories")) +
    xlab("test id") +
    ylab("g emitted / MJ fuel burned") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width = 10}
  ggplot(pol_p, aes(x = stove, energy_ef, colour = fuel)) +
    geom_point() +
    ggtitle(paste(pol_name, "ef by stove")) +
    xlab("stove type") +
    ylab("g emitted / MJ fuel burned") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width = 10}
  ggplot(pol_p, aes(x = stove, energy_ef, colour = fuel)) +
    geom_point() +
    facet_grid( ~ stovecat, scales = 'free') +
    ggtitle(paste(pol_name, "ef by stove")) +
    xlab("stove type") +
    ylab("g emitted / MJ fuel burned") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width = 10}
  ggplot(pol_p, aes(x = stove, energy_ef, colour = stovecat)) +
    geom_point() +
    facet_grid( ~ fuelcat, scales = 'free') +
    ggtitle(paste(pol_name, "ef by fuel and stove")) +
    xlab("stove type") +
    ylab("g emitted / MJ fuel burned") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45,  hjust = 0.9))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width = 10}
  ggplot(filter(pol_p, fuelcat == 'wood'), aes(x = id, energy_ef, colour = fuel)) +
    geom_point() +
    facet_grid( ~ stove, scales = 'free') +
    ggtitle(paste(pol_name, "ef by stove type (wood only)")) +
    xlab("stove type") +
    ylab("g emitted / MJ fuel burned") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width = 10}
  ggplot(filter(pol_p, fuelcat == 'charcoal'), aes(x = id, energy_ef, colour = fuel)) +
    geom_point() +
    facet_grid( ~ stove, scales = 'free') +
    ggtitle(paste(pol_name, "ef by stove type (charcoal only)")) +
    xlab("stove type") +
    ylab("g emitted / MJ fuel burned") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

## Additional plots (hidden)

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width = 10, fig.show = 'hide'}
  ggplot(pol_p, aes(x = id, mass_ef, colour = fuel)) +
    geom_point() +
    facet_wrap(fuelcat ~ stovecat) +
    ggtitle(paste(pol_name, "ef by stove and fuel categories")) +
    xlab("stove type") +
    ylab("mg emitted / kg fuel burned") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

