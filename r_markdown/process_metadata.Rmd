---
title: "Process test metadata"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r load_libraries, echo=FALSE, include=FALSE}
  library(tidyverse)
  library(GGally)
  library(gridExtra)
```


```{r global_options, include=FALSE}
  knitr::opts_chunk$set(fig.path = 'figures/',
                        warning = FALSE,
                        message = FALSE,
                        fig.width = 10, fig.height = 4,
                        cache = FALSE)
```

```{r}
  source("../r_scripts/R_functions.R")
  source("../r_scripts/R_plots.R")
  source("../r_scripts/R_tidy.R")
```  
 
# Load data

```{r load_files}
  tester_one <- readRDS("../r_files/data_tester_one.RDS")

  tester_two <- readRDS("../r_files/data_tester_two.RDS")

  cal_two <- readRDS("../r_files/data_cal_two.RDS")

  test_log <- readRDS(file = "../r_files/mc_test_log.RDS")
  
  fuel <- readRDS("../r_files/data_fuel_prep.RDS")
```

# Sample data

```{r}
  test_log <- test_log %>%
              dplyr::mutate(type = ifelse(grepl("^L", id), "lab", "field")) %>%
              dplyr::mutate(type = ifelse(grepl("^B", id), "bg", type)) %>%
              dplyr::mutate(mc_level = ifelse(grepl("^LL|^FL", id), "low", "med")) %>%
              dplyr::mutate(mc_level = ifelse(grepl("^LH|^FH", id), "high", mc_level)) %>%
              dplyr::mutate(mc_level = ifelse(grepl("^B", id), NA, mc_level))
```

```{r, message=FALSE, warning=FALSE}
  samples <- test_log %>%
             dplyr::select(id, date, stove, fuel, type, mc_level, notes) %>%
             dplyr::mutate(mc_level = as.factor(mc_level),
                           mc_level = forcats::fct_relevel(mc_level,"low","med","high")) 
```

Plot test IDs:

```{r, echo=FALSE}
  test_list <- samples %>%
               dplyr::group_by(mc_level, type) %>%
               dplyr::summarise(id = paste(id, collapse = ", "))

  ggplot(test_list, aes(y = mc_level, type)) + 
    geom_tile(colour = "white", width = 0.9, height = 0.9, aes(fill = id)) +
    scale_fill_discrete(na.value = 'grey95') +
    theme_bw(base_size = 14) +
    theme(legend.position = "none") +
    geom_text(aes(label = id, size = 6))
```

# Clean and save metadata

## Fuel weights

Remove moisture contents that were calculated in Excel and recalculate.

```{r}
  # Remove values that were calculated in Excel
  df_fuel_prep <- dplyr::select(fuel, id, date, mc_target, order,
                                      mass_kiln_pre, mass_kiln_post, 
                                      mass_start, mass_wet, mass_end) %>%

    # Calculate:
    # 1. The moisture content of the reference piece of fuel (on a dry mass basis).  
    # 2. The dry weight of the test fuel.  
    # 3. The actual moisture content of the test fuel (on a dry mass basis). 
    dplyr::mutate(kiln_mc  = (mass_kiln_pre - mass_kiln_post)/mass_kiln_post, # dry basis
                  mass_dry = mass_start/(kiln_mc + 1),
                  mc_dry   = 100*(mass_end - mass_dry)/mass_dry) %>% # dry basis
  
    # Removed FH2 rep 3 because the fuel was not burned
    dplyr::filter((id=="FH2" & order==3) == FALSE) 
```

Add moisture content data to sample data and save.

```{r}
  
  df_mc <- dplyr::group_by(df_fuel_prep, id) %>%
           dplyr::summarise(mc_target = mean(mc_target),
                            mc_dry    = mean(mc_dry)) 
  
  samples <- dplyr::left_join(samples, df_mc, by=c("id")) %>%
             dplyr::mutate(mc_target = as.factor(mc_target),
                           fuel      = ifelse(type=="bg", NA, as.character(fuel))) %>%
             dplyr::select(id, date, stove, fuel, type, mc_level, mc_target, mc_dry, notes)

  saveRDS(samples, "../r_files/samples.RDS")
```

Select only fuel mass data, sum masses over the test, and plot

```{r, echo=FALSE, fig.height=8}
  p_data <- dplyr::select(df_fuel_prep, id, order, starts_with("mass"))            %>%
            dplyr::select(-mass_wet, -mass_kiln_pre, -mass_kiln_post, -mass_start) %>%
            dplyr::group_by(id)                                                    %>%
            dplyr::summarise_at(vars(starts_with("mass")), funs(sum, first))       %>%
            tidyr::gather("var", "val", 2:5)                                       %>%
            dplyr::left_join(samples, by=c("id"))                                  %>%
            dplyr::filter(!is.na(val))                                             %>%
            dplyr::group_by(var, mc_target)                                        %>%
            dplyr::mutate(value_norm = (val - mean(val)) / sd(val),
                          outlier = ifelse(is_outlier(val), as.character(id), NA))

  p_box <- ggplot(p_data, aes(x = var, y = value_norm)) +
             geom_boxplot() +
             geom_text(aes(label = outlier), na.rm = TRUE, hjust = -0.3, size = 4) +
             theme_bw(base_size = 14) +
             facet_grid(~mc_target) + 
             ylab("z score normalized value") +
             theme(axis.text.x = element_text(angle = 45, hjust=1)) +
             xlab("")

  p_hist <- ggplot(p_data, aes(x = val, fill = mc_target)) +
              geom_histogram(binwidth = 5, alpha = 0.5, color = "black") +
              theme_bw() +
              facet_grid(~var, scales = "free") + 
              theme_bw(base_size = 14) +
              xlab("mass (g)")
  
  grid.arrange(p_hist, p_box, ncol = 1)
```

## batch stove timestamps

```{r}
  test_times <- dplyr::filter(tidy_id_date(test_log, "^time_", "time_"), !is.na(value))

  saveRDS(test_times, file="../r_files/test_times.RDS")
```
  
 * unexpected values:

```{r, echo=FALSE}
  outliers <- dplyr::filter(test_times, value < 60 * 60 * 4 | value > 60 * 60 * 20)

  knitr::kable(outliers, "markdown", digits = 2)
```

## carbonyl flows

```{r}
  carb_flows <- dplyr::filter(tidy_id_date(tester_two, "_carb_.*[^avg]$", "_carb_"), !is.na(value))
  
  carb_flows <- split_flows(carb_flows)
  
  saveRDS(carb_flows, file="../r_files/carb_flows.RDS")
```

```{r, echo=FALSE}
  p_data <- dplyr::group_by(carb_flows, id, type) %>%
            summarise(value = mean(value, na.rm = TRUE)) %>%
            dplyr::group_by(type) %>%
            dplyr::mutate(value_norm =
                           (value - mean(value)) / sd(value),
                          outlier = ifelse(is_outlier(value),
                                    as.character(id), NA))

  p_box <- ggplot(p_data, aes(x = factor(type), y = value_norm)) +
           geom_boxplot() +
           geom_text(aes(label = outlier), na.rm = TRUE, hjust = -0.3, size = 4) +
           theme_bw(base_size = 14) +
           ylab("z score normalized value") +
           xlab("")
 
  p_hist <- ggplot(p_data, aes(x = value)) +
            geom_histogram(binwidth = 0.1, alpha = 0.5, color = "black") +
            theme_bw() +
            facet_grid(~type) + 
            theme_bw(base_size = 14) +
            xlab("flow (lpm)")
  
  grid.arrange(p_hist, p_box, ncol = 2)
```

## carbonyl timestamps

```{r}
  carb_times <- dplyr::filter(tidy_id_date(tester_two, "^time_.*carb$", "^time_"), !is.na(value))
  
  carb_times <- split_times(carb_times)
  
  saveRDS(carb_times, file="../r_files/carb_times.RDS")
```

* unexpected values:

```{r, echo=FALSE}
  outliers <- dplyr::filter(test_times, value < 60 * 60 * 8 | value > 60 * 60 * 20)

  knitr::kable(outliers, "markdown", digits = 2)
```

## isokinetic sampler flows

```{r}
  iso_flows <- dplyr::filter(tidy_id_date(tester_two, "_iso_.*[^avg]$", "_iso_"), !is.na(value))
  
  iso_flows <- split_flows(iso_flows)
  
  saveRDS(iso_flows, file="../r_files/iso_flows.RDS")
```

```{r, echo=FALSE}
  p_data <- dplyr::group_by(iso_flows, id, type) %>%
            summarise(value = mean(value, na.rm = TRUE)) %>%
            dplyr::group_by(type) %>%
            dplyr::mutate(value_norm =
                           (value - mean(value)) / sd(value),
                          outlier = ifelse(is_outlier(value),
                                    as.character(id), NA))

  p_box <- ggplot(p_data, aes(x = factor(type), y = value_norm)) +
             geom_boxplot() +
             geom_text(aes(label = outlier), na.rm = TRUE, hjust = -0.3, size = 4) +
             theme_bw(base_size = 14) +
             ylab("z score normalized value") +
             xlab("")

  p_hist <- ggplot(p_data, aes(x = value)) +
              geom_histogram(binwidth = 0.1, alpha = 0.5, color = "black") +
              theme_bw() +
              facet_grid(~type) + 
              theme_bw(base_size = 14) +
              xlab("flow (lpm)")
  
  grid.arrange(p_hist, p_box, ncol = 2)
```

## filter cartridge flows

```{r}
  filter_flows <- dplyr::filter(tidy_id_date(tester_one,
                                  "^preflow_.*[^avg]$|postflow.*[^avg]$", ""),
                                  !is.na(value))

  filter_flows <- split_filter_flows(filter_flows)

  saveRDS(filter_flows, file="../r_files/filter_flows.RDS")
```

```{r, echo=FALSE}
  p_data <- dplyr::group_by(filter_flows, id, type, colour) %>%
            summarise(value = mean(value, na.rm = TRUE)) %>%
            dplyr::group_by(type) %>%
            dplyr::mutate(value_norm =
                           (value - mean(value)) / sd(value),
                          outlier = ifelse(is_outlier(value),
                                    as.character(id), NA))

  p_box <-  ggplot(p_data, aes(x = factor(type), y = value_norm)) +
               geom_boxplot() +
               geom_text(aes(label = outlier), na.rm = TRUE, hjust = -0.3, size = 4) +
               theme_bw(base_size = 14) +
               ylab("z score normalized value") +
               facet_wrap(~colour) +
               xlab("") + 
               facet_wrap(~colour, scales = "free")

  p_hist <- ggplot(p_data, aes(x = value)) +
              geom_histogram(binwidth = 0.1, alpha = 0.5, color = "black") +
              theme_bw() +
              facet_grid(~type) + 
              theme_bw(base_size = 14) +
              xlab("flow (lpm)")
  
  grid.arrange(p_hist, p_box, ncol = 2)
```

## filter cartridge timestamps

```{r}
  filter_times <- dplyr::filter(tidy_id_date(tester_one, "^time_.*cart", "time_"), !is.na(value))

  filter_times <- split_filter_times(filter_times)

  saveRDS(filter_times, file="../r_files/filter_times.RDS")
```

 * unexpected values:

```{r, echo=FALSE}
  outliers <- dplyr::filter(filter_times,
                            value < 60 * 60 * 4 | value > 60 * 60 * 20)

  knitr::kable(outliers, "markdown", digits = 2)
```

## co2 (dilution) calibration

* tidy zero conc variable

```{r}
  cal_two <- dplyr::rename(cal_two,
                           zero_1_conc = zero_1,
                           zero_2_conc = zero_2) %>%
             dplyr::mutate(zero_1_conc = 0,
                           zero_2_conc = 0)
```


```{r}
  co2_lab_cal <- dplyr::filter(tidy_date(cal_two, "^zero_1|^co2_1", "_1"), !is.na(value))

  co2_lab_cal <- split_co2_cal(co2_lab_cal)

  co2_lab_cal <- dplyr::mutate(co2_lab_cal, value = as.numeric(value))

  saveRDS(co2_lab_cal, file="../r_files/co2_lab_cal.RDS")
```

```{r, echo=FALSE}
  p_data <- dplyr::group_by(co2_lab_cal, type, pol) %>%
            dplyr::mutate(value_norm = (value - mean(value)) / sd(value),
                          outlier = ifelse(is_outlier(value), as.character(date), NA))

  p_box <- ggplot(p_data, aes(x = factor(type), y = value_norm)) +
             geom_boxplot() +
             geom_text(aes(label = outlier), na.rm = TRUE, hjust = -0.3, size = 4) +
             theme_bw(base_size = 14) +
             facet_wrap(~pol) +
             ylab("z score normalized value") +
             xlab("") +
             ggtitle("lab")

  p_hist <- ggplot(p_data, aes(x = value, color = type)) +
              geom_histogram(alpha = 0.5) +
              theme_bw() +
              facet_grid(~pol, scales = "free") + 
              theme_bw(base_size = 14) +
              xlab("conc (ppm)") +
              ggtitle("lab")

  grid.arrange(p_hist, p_box, ncol = 2)
```

```{r}
  co2_sample_cal <- dplyr::filter(tidy_date(cal_two, "^zero_2|^co2_2", "_2"), !is.na(value))

  co2_sample_cal <- split_co2_cal(co2_sample_cal)

  co2_sample_cal <- dplyr::mutate(co2_sample_cal, value = as.numeric(value))

  saveRDS(co2_sample_cal, file="../r_files/co2_sample_cal.RDS")
```

```{r, echo=FALSE}
  p_data <- dplyr::group_by(co2_sample_cal, type) %>%
            dplyr::mutate(value_norm = (value - mean(value)) / sd(value),
                          outlier = ifelse(is_outlier(value), as.character(date), NA))

  p_box <- ggplot(p_data, aes(x = factor(type), y = value_norm)) +
              geom_boxplot() +
              geom_text(aes(label = outlier), na.rm = TRUE, hjust = -0.3, size = 4) +
              theme_bw(base_size = 16) +
              ylab("z score normalized value") +
              xlab("") +
              ggtitle("sample line")
  
  p_hist <- ggplot(p_data, aes(x = value)) +
              geom_histogram(alpha = 0.5, color = "black") +
              theme_bw() +
              facet_grid(~pol, scales = "free") + 
              theme_bw(base_size = 14) +
              xlab("conc (ppm)") +
              ggtitle("sample")

  grid.arrange(p_hist, p_box, ncol = 2)
```

## pax flows

```{r}
  pax_flows <- dplyr::filter(tidy_date(cal_two, "^pax", ""),
                             !is.na(value))
  
  pax_flows <- split_pax_flows(pax_flows)
  
  saveRDS(pax_flows, file="../r_files/pax_flows.RDS")
```

```{r, echo=FALSE}
  p_data <- dplyr::group_by(pax_flows, date, type) %>%
            dplyr::filter(loc == "inlet") %>%
            summarise(value = mean(value, na.rm = TRUE)) %>%
           # dplyr::group_by(date) %>%
            dplyr::mutate(value_norm =
                           (value - mean(value)) / sd(value),
                          outlier = ifelse(is_outlier(value),
                                    as.character(date), NA))

  p_box <- ggplot(p_data, aes(x = factor(type), y = value_norm)) +
            geom_boxplot() +
            geom_text(aes(label = outlier), na.rm = TRUE, hjust = -0.3, size = 4) +
            theme_bw(base_size = 14) +
            ylab("z score normalized value") +
            xlab("")

  p_hist <- ggplot(p_data, aes(x = value)) +
              geom_histogram(binwidth = 0.01, alpha = 0.5, color = "black") +
              theme_bw() +
              facet_grid(~type, scales = "free") + 
              theme_bw(base_size = 14) +
              xlab("flow (lpm)")

  grid.arrange(p_hist, p_box, ncol = 2)
```

## smps flows

```{r}
  smps_flows <- dplyr::filter(tidy_date(cal_two, "^smps", ""),
                              !is.na(value))

  smps_flows <- split_flows(smps_flows)
  
  saveRDS(smps_flows, file="../r_files/smps_flows.RDS")
```

```{r, echo=FALSE}
  p_data <- dplyr::group_by(smps_flows, type) %>%
            dplyr::mutate(value_norm = (value - mean(value)) / sd(value),
                          outlier = ifelse(is_outlier(value), as.character(date), NA))

  p_box <- ggplot(p_data, aes(x = factor(type), y = value_norm)) +
              geom_boxplot() +
              geom_text(aes(label = outlier), na.rm = TRUE, hjust = -0.3, size = 4) +
              theme_bw(base_size = 14) +
              ylab("z score normalized value") +
              xlab("")

  p_hist <- ggplot(p_data, aes(x = value)) +
              geom_histogram(binwidth = 0.1, alpha = 0.5, color = "black") +
              theme_bw() +
              facet_grid(~type, scales = "free") + 
              theme_bw(base_size = 14) +
              xlab("flow (lpm)")

  grid.arrange(p_hist, p_box, ncol = 2)
```

## dusttrak flows

```{r}
  dust_flows <- dplyr::filter(tidy_date(cal_two, "^dust", ""),
                              !is.na(value))

  dust_flows <- split_flows(dust_flows)

  saveRDS(dust_flows, file="../r_files/dust_flows.RDS")
```

```{r, echo=FALSE}
  p_data <- dplyr::group_by(dust_flows, type) %>%
            dplyr::mutate(value_norm = (value - mean(value)) / sd(value),
                          outlier = ifelse(is_outlier(value), as.character(date), NA))

  p_box <- ggplot(p_data, aes(x = factor(type), y = value_norm)) +
              geom_boxplot() +
              geom_text(aes(label = outlier), na.rm = TRUE, hjust = -0.3, size = 4) +
              theme_bw(base_size = 14) +
              ylab("z score normalized value") +
              xlab("")

  p_hist <- ggplot(p_data, aes(x = value)) +
              geom_histogram(binwidth = 0.1, alpha = 0.5, color = "black") +
              theme_bw() +
              facet_grid(~type, scales = "free") + 
              theme_bw(base_size = 14) +
              xlab("flow (lpm)")

  grid.arrange(p_hist, p_box, ncol = 2)
```

## smps / pax times

```{r}
  smps_pax_bg_times <- dplyr::filter(tidy_id_date(tester_two,
                                                  "^time_.*smps.*", "^time_"),
                                                  !is.na(value))

  smps_pax_bg_times <- split_times_smps_pax(smps_pax_bg_times)

  saveRDS(smps_pax_bg_times, file="../r_files/smps_pax_bg_times.RDS")
```

* unexpected values:

```{r}
  outliers <- dplyr::filter(smps_pax_bg_times,
                            value < 60 * 60 * 4 | value > 60 * 60 * 20)

  knitr::kable(outliers, "markdown", digits = 2)
```

## five gas

```{r}
  fivegas_bg_times <- dplyr::filter(tidy_id_date(tester_one,
                                                 "^time_.*fivegas.*", "^time_"),
                                    !is.na(value))

  fivegas_bg_times <- split_times(fivegas_bg_times)

  saveRDS(fivegas_bg_times, file="../r_files/fivegas_bg_times.RDS")
```

* unexpected values:

```{r}
  outliers <- dplyr::filter(fivegas_bg_times,
                            value < 60 * 60 * 4 | value > 60 * 60 * 20)

  knitr::kable(outliers, "markdown", digits = 2)
```

# Summary

```{r, echo=FALSE}
  count_samples <- dplyr::tally(group_by(samples, type))
```

`r as.numeric(count_samples[2,2])` field wood tests, `r as.numeric(count_samples[3,2])` lab wood tests, and `r as.numeric(count_samples[1,2])` background tests were conducted for a total of `r sum(count_samples$n)` tests. The tests were performed between `r min(samples$date)` and `r max(samples$date)`. The `r samples$stove[1]` stove was tested with `r samples$fuel[1]` fuel.
