---
title: "Data file summary"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r load_libraries}
  library(tidyverse)
  library(GGally)
  library(gridExtra)
```


```{r global_options, include=FALSE}
  knitr::opts_chunk$set(fig.path = 'figures/', warning = FALSE, message = FALSE)
```

```{r}
  source("../r_scripts/R_functions.R")
  source("../r_scripts/R_plots.R")
  source("../r_scripts/R_tidy.R")
```  
 
# Load data

```{r load_files}
  tester_one <- readRDS("../r_files/data_tester_one.RDS")
  tester_two <- readRDS("../r_files/data_tester_two.RDS")
 
  cal_two <- readRDS("../r_files/data_cal_two.RDS")
 
  test_log <- readRDS(file = "../r_files/mc_test_log.RDS")
  fuel <- readRDS("../r_files/data_fuel_prep.RDS")
```

# Sample data

```{r}
  test_log <- test_log %>%
              dplyr::mutate(type = ifelse(grepl("^L", id), "lab", "field")) %>%
              dplyr::mutate(type = ifelse(grepl("^B", id), "bg", type)) %>%
              dplyr::mutate(mc_target = ifelse(grepl("^LL|^FL", id), "low", "med")) %>%
              dplyr::mutate(mc_target = ifelse(grepl("^LH|^FH", id), "high", mc_target)) %>%
              dplyr::mutate(mc_target = ifelse(grepl("^B", id), NA, mc_target))
```

```{r}
  # rename variable
  fuel <- dplyr::rename(fuel, id = fuel_id, date = date_test)
```


```{r}
  samples <-   test_log %>%
               dplyr::select(id, stove, fuel, type, mc_target) %>%
               dplyr::mutate(mc_target = as.factor(mc_target))

  saveRDS(samples, "../r_files/samples.RDS")
```




## Plot test ids

```{r, echo=FALSE, fig.width=20, fig.height=12}
  test_list <- samples %>%
               dplyr::group_by(mc_target, type) %>%
               dplyr::summarise(id = paste(id, collapse = ","))

  ggplot(test_list, aes(y = mc_target, type)) + 
    geom_tile(colour = "white", width = 0.9, height = 0.9, aes(fill = id)) +
    scale_fill_discrete(na.value = 'grey95') +
    theme_bw() +
    theme(legend.position = "none") +
    theme(axis.text = element_text(size = 14)) +
    geom_text(aes(label = id, size = 14))
```

# Clean and save metadata

## fuel weights

```{r}
  fuel_wgts <- dplyr::filter(tidy_id_date(fuel, "^mass_", "mass_"), !is.na(value))

  saveRDS(fuel_wgts, file="../r_files/fuel_wgts.RDS")
```

```{r, echo=FALSE, fig.width=20, fig.height=12}
  p_data <- dplyr::group_by(fuel_wgts, var) %>%
            dplyr::left_join(samples, by = "id") %>%
            dplyr::mutate(value_norm = (value - mean(value)) / sd(value),
                          outlier = ifelse(is_outlier(value), as.character(id), NA))

  ggplot(p_data, aes(x = factor(var), y = value_norm)) +
    geom_boxplot() +
    geom_text(aes(label = outlier), na.rm = TRUE, hjust = -0.3, size = 4) +
    theme_bw() +
    facet_grid(~mc_target) + 
    ylab("z score normalized value") +
    xlab("") +
    theme(axis.text.x = element_text(angle = 35, hjust = 0.95, size = 30)) +
    theme(axis.text.y = element_text(size = 30),
          axis.title=element_text(size=40))
```

## batch stove timestamps

```{r}
  batch_times <- dplyr::filter(tidy_id_date(test_log, "^time_", "time_"), !is.na(value))

  saveRDS(batch_times, file="../r_files/batch_times.RDS")
```
  
 * unexpected values:

```{r, echo=FALSE}
  outliers <- dplyr::filter(batch_times, value < 60 * 60 * 4 | value > 60 * 60 * 20)

  knitr::kable(outliers, "markdown", digits = 2)
```

## batch lab conditions

```{r, echo=TRUE}
  # lab_cond <- dplyr::filter(tidy_id_date(test_log, "^lab_", "lab_"), !is.na(value))
  # 
  # saveRDS(lab_cond, file="../r_files/batch_lab.RDS")
```

KB: Currently no data is recorded in the test log

```{r, echo=FALSE, fig.width=12, fig.height=6}
  # p_data <- dplyr::group_by(lab_cond, var) %>%
  #           dplyr::mutate(value_norm =
  #                        (value - mean(value, na.rm = TRUE)) / sd(value, na.rm = TRUE),
  #                         outlier = ifelse(is_outlier(value), as.character(id), NA))
  # 
  # p_box <- ggplot(p_data, aes(x = factor(var), y = value_norm)) +
  #          geom_boxplot() +
  #          geom_text(aes(label = outlier), na.rm = TRUE, hjust = -0.3, size = 8) +
  #          theme_bw() +
  #          ylab("z score normalized value") +
  #          xlab("") +
  #          theme(axis.text.x = element_text(angle = 35, hjust = 0.95, size = 30)) +
  #          theme(axis.text.y = element_text(size = 30),
  #          axis.title=element_text(size=40))
  # 
  # p_hist <- ggplot(p_data, aes(x = value)) +
  #           geom_histogram(binwidth = 15) +
  #           theme_bw() +
  #           facet_wrap(~var, scales = "free") +
  #           xlab("")
  # 
  # grid.arrange(p_hist, p_box, ncol = 2)
```

## pot mass

```{r}
  # pot_mass <- dplyr::filter(tidy_id_date(wood, "^pot_", "pot_"),
  #                            !is.na(as.numeric(value))) %>%
  #              dplyr::mutate(value = as.factor(value)) %>%
  #              dplyr::rename(pot = value, rep = var)
  # 
  # wood_pot$pot <- forcats::fct_recode(wood_pot$pot,
  #                                  a = "1", b = "2", c = "3", d = "4")
  # 
  # saveRDS(wood_pot, file="../r_files/wood_pot.RDS")
```

## carbonyl flows

```{r}
  carb_flows <- dplyr::filter(tidy_id_date(tester_two, "_carb_.*[^avg]$", "_carb_"), !is.na(value))
  
  carb_flows <- split_flows(carb_flows)
  
  saveRDS(carb_flows, file="../r_files/carb_flows.RDS")
```

```{r, echo=FALSE, fig.width=20, fig.height=12}
  p_data <- dplyr::group_by(carb_flows, type) %>%
            dplyr::mutate(value_norm =
                           (value - mean(value)) / sd(value),
                          outlier = ifelse(is_outlier(value),
                                    as.character(id), NA))

  ggplot(p_data, aes(x = factor(type), y = value_norm)) +
    geom_boxplot() +
    geom_text(aes(label = outlier), na.rm = TRUE, hjust = -0.3, size = 8) +
    theme_bw() +
    ylab("z score normalized value") +
    xlab("") +
    theme(axis.text.x = element_text(angle = 35, hjust = 0.95, size = 30)) +
    theme(axis.text.y = element_text(size = 30),
          axis.title=element_text(size=40))
```

## carbonyl timestamps

```{r}
  carb_times <- dplyr::filter(tidy_id_date(tester_two, "^time_.*carb$", "^time_"), !is.na(value))
  
  carb_times <- split_times(carb_times)
  
  saveRDS(carb_times, file="../r_files/carb_times.RDS")
```

* unexpected values:

```{r, echo=FALSE}
  outliers <- dplyr::filter(batch_times, value < 60 * 60 * 4 | value > 60 * 60 * 20)

  knitr::kable(outliers, "markdown", digits = 2)
```

## isokinetic sampler flows

```{r}
  iso_flows <- dplyr::filter(tidy_id_date(tester_two, "_iso_.*[^avg]$", "_iso_"), !is.na(value))
  
  iso_flows <- split_flows(iso_flows)
  
  saveRDS(iso_flows, file="../r_files/iso_flows.RDS")
```

```{r, echo=FALSE, fig.width=20, fig.height=12}
  p_data <- dplyr::group_by(iso_flows, type) %>%
            dplyr::mutate(value_norm = (value - mean(value)) / sd(value),
                          outlier = ifelse(is_outlier(value), as.character(id), NA))

  ggplot(p_data, aes(x = factor(type), y = value_norm)) +
    geom_boxplot() +
    geom_text(aes(label = outlier), na.rm = TRUE, hjust = -0.3, size = 8) +
    theme_bw() +
    ylab("z score normalized value") +
    xlab("") +
    theme(axis.text.x = element_text(angle = 35, hjust = 0.95, size = 30)) +
    theme(axis.text.y = element_text(size = 30),
          axis.title=element_text(size=40))
```

## filter cartridge flows

```{r}
  filter_flows <- dplyr::filter(tidy_id_date(tester_one,
                                  "^preflow_.*[^avg]$|postflow.*[^avg]$", ""),
                                  !is.na(value))

  filter_flows <- split_filter_flows(filter_flows)

  saveRDS(filter_flows, file="../r_files/filter_flows.RDS")
```

```{r, echo=FALSE, fig.width=20, fig.height=16}
  p_data <- dplyr::group_by(filter_flows, type, colour) %>%
            dplyr::mutate(value_norm = (value - mean(value)) / sd(value),
                          outlier = ifelse(is_outlier(value), as.character(date), NA))

  ggplot(p_data, aes(x = factor(type), y = value_norm)) +
    geom_boxplot() +
    geom_text(aes(label = outlier), na.rm = TRUE, hjust = -0.3, size = 8) +
    theme_bw() +
    ylab("z score normalized value") +
    facet_wrap(~colour) +
    xlab("") +
    theme(axis.text.x = element_text(angle = 35, hjust = 0.95, size = 30)) +
    theme(axis.text.y = element_text(size = 30),
          axis.title=element_text(size=40)) +
    facet_wrap(~colour, scales = "free")
```

## filter cartridge timestamps

```{r}
  filter_times <- dplyr::filter(tidy_id_date(tester_one, "^time_.*cart", "time_"), !is.na(value))

  filter_times <- split_filter_times(filter_times)

  saveRDS(filter_times, file="../r_files/filter_times.RDS")
```

 * unexpected values:

```{r, echo=FALSE}
  outliers <- dplyr::filter(filter_times,
                            value < 60 * 60 * 4 | value > 60 * 60 * 20)

  knitr::kable(outliers, "markdown", digits = 2)
```

## co2 (dilution) calibration

```{r}
  # co2_lab_cal <- dplyr::filter(tidy_date(cal_two, "_1", "_1_"), !is.na(value))
  # 
  # co2_lab_cal <- split_co2_cal(co2_lab_cal)
  # 
  # saveRDS(co2_lab_cal, file="../r_files/co2_lab_cal.RDS")
```

```{r, echo=FALSE, fig.width=20, fig.height=12}
  # p_data <- dplyr::group_by(co2_lab_cal, type) %>%
  #           dplyr::mutate(value_norm = (value - mean(value)) / sd(value),
  #                         outlier = ifelse(is_outlier(value), as.character(date), NA))
  # 
  # ggplot(p_data, aes(x = factor(type), y = value_norm)) +
  #   geom_boxplot() +
  #   geom_text(aes(label = outlier), na.rm = TRUE, hjust = -0.3, size = 8) +
  #   theme_bw() +
  #   ylab("z score normalized value") +
  #   xlab("") +
  #   theme(axis.text.x = element_text(angle = 35, hjust = 0.95, size = 30)) +
  #   theme(axis.text.y = element_text(size = 30),
  #         axis.title=element_text(size=40)) +
  #   ggtitle("lab")
```

```{r}
  # co2_sample_cal <- dplyr::filter(tidy_date(cal_2, "^sensor_2", "sensor_2_"), !is.na(value))
  # 
  # co2_sample_cal <- split_co2_cal(co2_sample_cal)
  # 
  # saveRDS(co2_sample_cal, file="../r_files/co2_sample_cal.RDS")
```

```{r, echo=FALSE, fig.width=20, fig.height=12}
  # p_data <- dplyr::group_by(co2_sample_cal, type) %>%
  #           dplyr::mutate(value_norm = (value - mean(value)) / sd(value),
  #                         outlier = ifelse(is_outlier(value), as.character(date), NA))
  # 
  # ggplot(p_data, aes(x = factor(type), y = value_norm)) +
  #   geom_boxplot() +
  #   geom_text(aes(label = outlier), na.rm = TRUE, hjust = -0.3, size = 8) +
  #   theme_bw() +
  #   ylab("z score normalized value") +
  #   xlab("") +
  #   theme(axis.text.x = element_text(angle = 35, hjust = 0.95, size = 30)) +
  #   theme(axis.text.y = element_text(size = 30),
  #         axis.title=element_text(size=40)) +
  #   ggtitle("sample line")
```

## pax flows

```{r}
  pax_flows <- dplyr::filter(tidy_date(cal_two, "^pax", ""),
                             !is.na(value))
  
  pax_flows <- split_pax_flows(pax_flows)
  
  saveRDS(pax_flows, file="../r_files/pax_flows.RDS")
```

```{r, echo=FALSE, fig.width=20, fig.height=12}
  p_data <- dplyr::filter(pax_flows, loc == "inlet") %>%
            dplyr::group_by(type) %>%
            dplyr::mutate(value_norm = (value - mean(value)) / sd(value),
                          outlier = ifelse(is_outlier(value), as.character(date), NA))

  ggplot(p_data, aes(x = factor(type), y = value_norm)) +
    geom_boxplot() +
    geom_text(aes(label = outlier), na.rm = TRUE, hjust = -0.3, size = 8) +
    theme_bw() +
    ylab("z score normalized value") +
    xlab("") +
    theme(axis.text.x = element_text(angle = 35, hjust = 0.95, size = 30)) +
    theme(axis.text.y = element_text(size = 30),
          axis.title=element_text(size=40))
```

## smps flows

```{r}
  smps_flows <- dplyr::filter(tidy_date(cal_two, "^smps", ""),
                              !is.na(value))

  smps_flows <- split_flows(smps_flows)
  
  saveRDS(smps_flows, file="../r_files/smps_flows.RDS")
```

```{r, echo=FALSE, fig.width=20, fig.height=12}
  p_data <- dplyr::group_by(smps_flows, type) %>%
            dplyr::mutate(value_norm = (value - mean(value)) / sd(value),
                          outlier = ifelse(is_outlier(value), as.character(date), NA))

  ggplot(p_data, aes(x = factor(type), y = value_norm)) +
    geom_boxplot() +
    geom_text(aes(label = outlier), na.rm = TRUE, hjust = -0.3, size = 8) +
    theme_bw() +
    ylab("z score normalized value") +
    xlab("") +
    theme(axis.text.x = element_text(angle = 35, hjust = 0.95, size = 30)) +
    theme(axis.text.y = element_text(size = 30),
          axis.title=element_text(size=40))
```

## dusttrak flows

```{r}
  dust_flows <- dplyr::filter(tidy_date(cal_two, "^dust", ""),
                              !is.na(value))

  dust_flows <- split_flows(dust_flows)
  
  saveRDS(dust_flows, file="../r_files/dust_flows.RDS")
```

```{r, echo=FALSE, fig.width=20, fig.height=12}
  p_data <- dplyr::group_by(dust_flows, type) %>%
            dplyr::mutate(value_norm = (value - mean(value)) / sd(value),
                          outlier = ifelse(is_outlier(value), as.character(date), NA))

  ggplot(p_data, aes(x = factor(type), y = value_norm)) +
    geom_boxplot() +
    geom_text(aes(label = outlier), na.rm = TRUE, hjust = -0.3, size = 8) +
    theme_bw() +
    ylab("z score normalized value") +
    xlab("") +
    theme(axis.text.x = element_text(angle = 35, hjust = 0.95, size = 30)) +
    theme(axis.text.y = element_text(size = 30),
          axis.title=element_text(size=40))
```

## smps / pax times

```{r}
  smps_pax_bg_times <- dplyr::filter(tidy_id_date(tester_two,
                                                  "^time_.*smps.*", "^time_"),
                                                  !is.na(value))

  smps_pax_bg_times <- split_times_smps_pax(smps_pax_bg_times)

  saveRDS(smps_pax_bg_times, file="../r_files/smps_pax_bg_times.RDS")
```

* unexpected values:

```{r}
  outliers <- dplyr::filter(smps_pax_bg_times,
                            value < 60 * 60 * 4 | value > 60 * 60 * 20)

  knitr::kable(outliers, "markdown", digits = 2)
```

# Summary

```{r, echo=FALSE}
  count_samples <- dplyr::tally(group_by(samples, type))

  count_stoves <- dplyr::tally(group_by(samples, stove)) 
  
  count_fuels <- dplyr::tally(group_by(samples, fuel))
```

A total of `r (as.numeric(count_samples[1,2]) + as.numeric(count_samples[2,2]))` tests were performed between `r min(samples$date)` and `r max(samples$date)`. A total of `r nrow(count_stoves)` stoves types were tested. A total of  `r nrow(count_fuels)` fuels were tested (on the appropriate stove).
