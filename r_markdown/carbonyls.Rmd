---
title: "Carbonyls"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  source("../r_scripts/R_load_data.R")
  source("../r_scripts/R_load_metadata.R")
  source("../r_scripts/R_tidy.R")
```

# Load data

Test metadata: 

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  samples <- readRDS("../r_files/samples.RDS")
  times   <- readRDS("../r_files/test_times_all.RDS")
  flows   <- readRDS("../r_files/flow_rates.RDS")
  notes <- readRDS("../r_files/notes.RDS")
  
```

Carbonyls: 

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  carbonyls <- readRDS("../r_files/carbonyls.RDS")
```

# Combine data

### Flow rates

```{r}
  df_flows <- dplyr::filter(flows, instrument == "carbonyls") %>%
              dplyr::select(id, flow)
```

### Timestamps

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  df_times <- dplyr::filter(times, var %in% c("start_carb", "end_carb")) %>%
              dplyr::select(-date)      %>%
              tidyr::spread(var, value) %>%
              dplyr::rename(start = start_carb,
                            end   = end_carb)
```

### Notes

Select relevant notes: 

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  df_notes <- dplyr::filter(notes, grepl("carb|carbonyl|carbonyls|all", inst) == TRUE)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  knitr::kable(dplyr::filter(df_notes, grepl(".*carb.*", inst)) %>% 
               dplyr::select(-inst, -date),
               "markdown", digits = 2)
```

Apply flags: `bad` preceeds `maybe` preceeds `ok`.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  df_flags <- dplyr::select(df_notes, id, qc) %>%
              group_by(id) %>%
              arrange(qc) %>%
              summarise(qc = first(qc))
```

### Combine 

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  df_carb <- dplyr::left_join(carbonyls, df_flows, by=c("id")) %>%
             dplyr::left_join(df_times, by=c("id")) %>%
             dplyr::left_join(df_flags, by=c("id")) %>%
             dplyr::mutate(qc = ifelse(is.na(qc), "ok", qc))
```

Convert to longer format: 

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=12, fig.height=8}
  df_carb <- tidyr::gather(df_carb, "pol", "mass_ug",
                          -id, -flow, -start, -end, -qc)
```

# Calculate concentration

```{r}
   df_carb <- dplyr::mutate(df_carb, dur = (end - start) / 60, # minutes
                            conc = mass_ug / ((flow * dur) / 1000)) # ug/m3
```

# Background analysis

Select background tests and calculate average concentration ($\mu$g/m^3^)

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  df_bg <- dplyr::filter(df_carb, grepl("^BG", id), qc != "bad") %>%
           dplyr::group_by(pol) %>%
           dplyr::summarise(mean = mean(conc),
                            sd   = sd(conc),
                            min  = min(conc),
                            max  = max(conc),
                            n    = n())
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  knitr::kable(df_bg, "markdown", digits = 2)
```

Add background concentrations to main data frame. 

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  df_bg <- dplyr::select(df_bg, pol, mean) %>%
           dplyr::rename(conc_bg = mean)  

  df_carb <- dplyr::left_join(df_carb, df_bg, by = "pol") %>%
             dplyr::mutate(conc_bg = ifelse(is.na(conc_bg), 0, conc_bg)) %>%
             dplyr::filter(grepl("^BG", id) == FALSE) %>%
             dplyr::select(id, qc, flow, start, end, dur, pol, mass_ug, conc, conc_bg)
```

# Save merged file

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  saveRDS(df_carb, file = "../r_files/carbonyls_conc.RDS")
```

Carbonyl data was collected during `r length(unique(df_carb$id))` experiments. There are no carbonyl data for tests: `r setdiff(as.character(samples$id), as.character(df_carb$id))`.  
